# =============================================================================
# DOCKER COMPOSE TEMPLATE - REVERIE HOUSE PRODUCTION STACK
# =============================================================================
# This is a TEMPLATE file. Copy to docker-compose.yml and configure.
#
# SECURITY NOTE: docker-compose.yml is gitignored - it contains production
# secrets and internal network configuration.
#
# Setup:
#   1. cp docker-compose.yml.example docker-compose.yml
#   2. Update secret file paths in volumes
#   3. Configure environment variables
#   4. Review network configuration
# =============================================================================

networks:
  reverie_network:
    driver: bridge
    name: reverie_network

services:
  # ===========================================================================
  # DATABASE
  # ===========================================================================
  
  reverie_db:
    image: postgres:15-alpine
    container_name: reverie_db
    restart: unless-stopped
    networks:
      - reverie_network
    volumes:
      - reverie_db_data:/var/lib/postgresql/data
      - ./sql/init/03_schema_corrected.sql:/docker-entrypoint-initdb.d/01_schema.sql:ro
      - ./data/backups:/backups
      # CONFIGURE: Point to your secrets directory
      - /path/to/secrets:/secrets:ro
      - /path/to/cert:/certs:ro
    environment:
      - POSTGRES_DB=reverie_house
      - POSTGRES_USER=reverie
      - POSTGRES_PASSWORD_FILE=/secrets/reverie_db_password.txt
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --locale=en_US.UTF-8
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U reverie -d reverie_house"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # WEB & ROUTING
  # ===========================================================================
  
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    networks:
      - reverie_network
    ports:
      - "80:80"
      - "443:443"
      - "2222:2222"
    volumes:
      # CONFIGURE: Point to your Caddyfile location
      - /path/to/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - /path/to/caddy:/srv/caddy:ro
      - /path/to/caddy/data:/data
      - ./cert:/cert
      - ./site:/srv/site:ro

  # ===========================================================================
  # APPLICATION SERVICES
  # ===========================================================================
  
  reverie_api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: reverie_api
    restart: unless-stopped
    networks:
      - reverie_network
    # CONFIGURE: Update internal port if needed
    ports:
      - "127.0.0.1:4444:4444"
    volumes:
      - .:/srv/reverie.house
      - /path/to/secrets:/secrets:ro
    environment:
      - FLASK_ENV=production
      - PYTHONUNBUFFERED=1
      # CONFIGURE: Add your environment variables
    depends_on:
      reverie_db:
        condition: service_healthy

  # Add additional services as needed...

volumes:
  reverie_db_data:
    driver: local
