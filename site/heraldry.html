<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heraldry - Reverie House</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Community Heraldry - Heralds manage their PDS community's heraldry and identity.">
    
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/heraldry.css">
    <link rel="stylesheet" href="css/pages/heraldry.css">
    <link rel="stylesheet" href="css/widgets/header.css">
    <link rel="stylesheet" href="css/widgets/drawer.css">
    <link rel="stylesheet" href="css/widgets/login.css">
    <link rel="stylesheet" href="css/widgets/dialogue.css">
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    
    <!-- Core utilities (must load first) -->
    <script src="js/core/world-config-cache.js"></script>
    <script src="js/core/color-manager.js"></script>
    <script src="js/utils/shadowbox.js"></script>
    <script src="js/utils/heraldry.js"></script>
    
    <!-- Shared widgets -->
    <script src="js/widgets/background.js"></script>
    <script src="js/core/avatar-cache.js" defer></script>
    <script src="js/widgets/header.js" defer></script>
    <script type="module" src="js/widgets/oauth-manager.js"></script>
    <script src="js/widgets/login.js" defer></script>
    <!-- Note: sidebar.js not needed - heraldry has its own interface -->
    <script src="js/widgets/drawer.js" defer></script>
    
    <!-- Heraldry scripts -->
    <script src="js/pages/heraldry.js" defer></script>
</head>
<body class="heraldry-page">
    <div id="header-container"></div>
    <!-- Note: No #search-container here - heraldry page has its own interface -->
    
    <!-- Full-Screen Background Scene (matches dreamers page) -->
    <div class="fullscreen-background">
        <div class="scene-background">
            <img src="souvenirs/residence/phanera.png" alt="Phanera Residence" class="scene-layer background-layer">
        </div>
    </div>

    <!-- Main Content (positioned above background) -->
    <div class="main-content">
        <div class="heraldry-container">
            <!-- Heraldry Modal (centered in page, not overlay) -->
            <div class="heraldry-modal" id="heraldryModal">
                <!-- Search/Browse View (default) -->
                <div class="heraldry-view heraldry-login" id="heraldryLogin">
                    <div class="heraldry-header">
                        <img src="/assets/logo.png" alt="Reverie House" class="heraldry-logo">
                        <h1 class="heraldry-title">Community Heraldry</h1>
                        <p class="heraldry-subtitle">Hang the banners of your community</p>
                    </div>

                    <div class="heraldry-login-form">
                        <div class="form-group">
                            <label class="form-label">Enter Handle</label>
                            <div class="handle-input-wrapper">
                                <span class="handle-prefix">@</span>
                                <input type="text" 
                                       id="heraldHandle" 
                                       class="handle-input"
                                       placeholder="yourname.bsky.social"
                                       autocomplete="off"
                                       autocapitalize="none">
                            </div>
                        </div>

                        <div id="loginStatusMessage" class="heraldry-status-message">
                            <img src="/assets/icon.png" alt="" class="status-icon">
                            <span>Enter your handle to review a community's heraldry</span>
                        </div>

                        <!-- Password field (shown for PDS residents) -->
                        <div id="passwordGroup" class="form-group" style="display: none;">
                            <label class="form-label">App Password</label>
                            <div class="handle-input-wrapper">
                                <span class="handle-prefix password-icon"></span>
                                <input type="password" 
                                       id="appPassword" 
                                       class="handle-input"
                                       placeholder="xxxx-xxxx-xxxx-xxxx"
                                       autocomplete="current-password">
                            </div>
                            <p class="form-hint">Create an app password in your Bluesky settings</p>
                        </div>

                        <div id="loginError" class="heraldry-error" style="display: none;"></div>

                        <div class="heraldry-buttons">
                            <button id="loginBtn" class="heraldry-btn primary" disabled>
                                <span class="btn-text">Review Heraldry</span>
                                <span class="btn-spinner" style="display: none;"></span>
                            </button>
                            
                            <!-- OAuth button for non-residents -->
                            <button id="oauthBtn" class="heraldry-btn secondary" style="display: none;">
                                <span class="btn-text">Sign in with Bluesky</span>
                            </button>
                        </div>

                        <div class="heraldry-info-box">
                            <h4>What is a Community Herald?</h4>
                            <p>Heralds are designated members from different communities from across our wild mindscape who act as representatives within Reverie House and are responsible for the changing of colours and symbols signifying their collective memberships.</p>
                            <p>The first member of each community to proclaim themselves as Herald shall be recognized as such within Reverie House.</p>
                        </div>
                    </div>
                </div>

                <!-- Dashboard View (shown when authenticated as ambassador) -->
                <div class="heraldry-view heraldry-dashboard" id="heraldryDashboard" style="display: none;">
                    <div class="heraldry-dashboard-header">
                        <div class="herald-profile" id="heraldProfile">
                            <!-- Filled dynamically -->
                        </div>
                        <button class="heraldry-signout-btn" id="signOutBtn">
                            Sign Out
                        </button>
                    </div>

                    <div class="heraldry-dashboard-content">
                        <!-- Heraldry Editor Section -->
                        <section class="heraldry-section heraldry-editor">
                            <h2 class="section-title">Community Heraldry</h2>
                            <div class="heraldry-preview" id="heraldryPreview">
                                <!-- Filled dynamically -->
                            </div>
                            
                            <div class="heraldry-controls">
                                <!-- Icon Upload -->
                                <div class="control-group icon-control">
                                    <label class="control-label">Community Icon</label>
                                    <div class="icon-editor">
                                        <img id="heraldryIconPreview" src="/assets/heraldry/default.png" alt="Icon" class="icon-preview-large">
                                        <div class="icon-buttons">
                                            <button id="uploadIconBtn" class="heraldry-btn secondary small">Upload</button>
                                            <button id="clearIconBtn" class="heraldry-btn warning small">Clear</button>
                                            <button id="saveIconBtn" class="heraldry-btn primary small" style="display: none;">Save</button>
                                        </div>
                                        <input type="file" id="iconFileInput" accept="image/png" style="display: none;">
                                        <p class="icon-hint">PNG, max 5MB, resized to 512x512</p>
                                    </div>
                                </div>

                                <!-- Color Picker -->
                                <div class="control-group">
                                    <label class="control-label">Primary Color</label>
                                    <div class="color-picker-row">
                                        <div class="color-swatch" id="colorSwatch"></div>
                                        <input type="text" id="colorHexInput" class="color-hex-input" maxlength="7" placeholder="#000000">
                                    </div>
                                    <div class="color-picker-widget" id="colorPickerWidget">
                                        <div class="color-shade-picker" id="colorShadePicker">
                                            <canvas id="colorShadeCanvas" width="180" height="180"></canvas>
                                            <div class="color-shade-cursor" id="colorShadeCursor"></div>
                                        </div>
                                        <div class="color-hue-slider" id="colorHueSlider">
                                            <canvas id="colorHueCanvas" width="20" height="180"></canvas>
                                            <div class="color-hue-cursor" id="colorHueCursor"></div>
                                        </div>
                                    </div>
                                    <button id="saveColorBtn" class="heraldry-btn secondary">
                                        Save Color
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Herald Actions (Transfer & Step Down) -->
                        <section class="heraldry-section herald-actions">
                            <div class="action-group">
                                <h3>Transfer Herald Role</h3>
                                <p class="action-description">Assign a member of your coterie as the new herald.</p>
                                <div class="transfer-controls">
                                    <select id="transferSelect" class="heraldry-select">
                                        <option value="">Select new herald...</option>
                                    </select>
                                    <button id="transferBtn" class="heraldry-btn warning" disabled>
                                        Transfer Role
                                    </button>
                                </div>
                            </div>

                            <div class="action-group danger-zone">
                                <h3>Step Down</h3>
                                <p class="action-description">Relinquish your role. The most active coterie member will become ambassador.</p>
                                <button id="stepDownBtn" class="heraldry-btn danger">
                                    Step Down as Herald
                                </button>
                            </div>
                        </section>

                        <!-- Coterie Section -->
                        <section class="heraldry-section coterie-stats">
                            <h2 class="section-title">Your Coterie</h2>
                            <div class="coterie-info" id="coterieInfo">
                                <!-- Filled dynamically -->
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal-overlay" style="display: none;">
        <div class="confirm-modal">
            <p id="confirmModalMessage" class="confirm-modal-message"></p>
            <div class="confirm-modal-buttons">
                <button id="confirmModalCancel" class="heraldry-btn secondary">Cancel</button>
                <button id="confirmModalConfirm" class="heraldry-btn danger">Confirm</button>
            </div>
        </div>
    </div>

    <div id="footer-container"></div>
</body>
</html>
