<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Embassy - Reverie House</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Community Embassy - Ambassadors manage their PDS community's heraldry and identity.">
    
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/heraldry.css">
    <link rel="stylesheet" href="css/pages/embassy.css">
    <link rel="stylesheet" href="css/widgets/login.css">
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    
    <!-- Core utilities (must load first) -->
    <script src="js/core/world-config-cache.js"></script>
    <script src="js/core/color-manager.js"></script>
    <script src="js/utils/shadowbox.js"></script>
    <script src="js/utils/heraldry.js"></script>
    
    <!-- Shared widgets -->
    <script src="js/widgets/background.js"></script>
    <script src="js/widgets/header.js" defer></script>
    <script type="module" src="js/widgets/oauth-manager.js"></script>
    <script src="js/widgets/sidebar.js" defer></script>
    <script src="js/widgets/drawer.js" defer></script>
    
    <!-- Embassy scripts -->
    <script src="js/pages/embassy.js" defer></script>
</head>
<body class="embassy-page">
    <div id="header-container"></div>
    
    <!-- Full-Screen Background Scene (matches dreamers page) -->
    <div class="fullscreen-background">
        <div class="scene-background">
            <img src="souvenirs/residence/phanera.png" alt="Phanera Residence" class="scene-layer background-layer">
        </div>
    </div>

    <!-- Main Content (positioned above background) -->
    <div class="main-content">
        <div class="embassy-container">
            <!-- Embassy Modal (centered in page, not overlay) -->
            <div class="embassy-modal" id="embassyModal">
                <!-- Login View -->
                <div class="embassy-view embassy-login" id="embassyLogin">
                    <div class="embassy-header">
                        <img src="/assets/logo.png" alt="Reverie House" class="embassy-logo">
                        <h1 class="embassy-title">Community Embassy</h1>
                        <p class="embassy-subtitle">Ambassadors manage their community's heraldry</p>
                    </div>

                    <div class="embassy-login-form">
                        <div class="form-group">
                            <label class="form-label">Your Handle</label>
                            <div class="handle-input-wrapper">
                                <span class="handle-prefix">@</span>
                                <input type="text" 
                                       id="ambassadorHandle" 
                                       class="handle-input"
                                       placeholder="yourname.bsky.social"
                                       autocomplete="off"
                                       autocapitalize="none">
                            </div>
                        </div>

                        <div id="loginStatusMessage" class="embassy-status-message">
                            <img src="/assets/icon.png" alt="" class="status-icon">
                            <span>Enter your handle to check ambassador status</span>
                        </div>

                        <!-- Password field (shown for PDS residents) -->
                        <div id="passwordGroup" class="form-group" style="display: none;">
                            <label class="form-label">App Password</label>
                            <div class="handle-input-wrapper">
                                <span class="handle-prefix password-icon"></span>
                                <input type="password" 
                                       id="appPassword" 
                                       class="handle-input"
                                       placeholder="xxxx-xxxx-xxxx-xxxx"
                                       autocomplete="current-password">
                            </div>
                            <p class="form-hint">Create an app password in your Bluesky settings</p>
                        </div>

                        <div id="loginError" class="embassy-error" style="display: none;"></div>

                        <div class="embassy-buttons">
                            <button id="loginBtn" class="embassy-btn primary" disabled>
                                <span class="btn-text">Check Status</span>
                                <span class="btn-spinner" style="display: none;"></span>
                            </button>
                            
                            <!-- OAuth button for non-residents -->
                            <button id="oauthBtn" class="embassy-btn secondary" style="display: none;">
                                <span class="btn-text">Sign in with Bluesky</span>
                            </button>
                        </div>

                        <div class="embassy-info-box">
                            <p>Only designated <strong>ambassadors</strong> can access the embassy to manage their community's heraldry.</p>
                        </div>
                    </div>

                    <a href="/" class="embassy-back-link">Return to Reverie House</a>
                </div>

                <!-- Dashboard View (shown when authenticated as ambassador) -->
                <div class="embassy-view embassy-dashboard" id="embassyDashboard" style="display: none;">
                    <div class="embassy-dashboard-header">
                        <div class="ambassador-profile" id="ambassadorProfile">
                            <!-- Filled dynamically -->
                        </div>
                        <button class="embassy-signout-btn" id="signOutBtn">
                            Sign Out
                        </button>
                    </div>

                    <div class="embassy-dashboard-content">
                        <!-- Heraldry Editor Section -->
                        <section class="embassy-section heraldry-editor">
                            <h2 class="section-title">Community Heraldry</h2>
                            <div class="heraldry-preview" id="heraldryPreview">
                                <!-- Filled dynamically -->
                            </div>
                            
                            <div class="heraldry-controls">
                                <!-- Icon Upload -->
                                <div class="control-group icon-control">
                                    <label class="control-label">Community Icon</label>
                                    <div class="icon-editor">
                                        <img id="heraldryIconPreview" src="/assets/heraldry/default.png" alt="Icon" class="icon-preview-large">
                                        <div class="icon-buttons">
                                            <button id="uploadIconBtn" class="embassy-btn secondary small">Upload</button>
                                            <button id="clearIconBtn" class="embassy-btn warning small">Clear</button>
                                            <button id="saveIconBtn" class="embassy-btn primary small" style="display: none;">Save</button>
                                        </div>
                                        <input type="file" id="iconFileInput" accept="image/png" style="display: none;">
                                        <p class="icon-hint">PNG, max 1MB, 256x256</p>
                                    </div>
                                </div>

                                <!-- Color Picker -->
                                <div class="control-group">
                                    <label class="control-label">Primary Color</label>
                                    <div class="color-picker-row">
                                        <div class="color-swatch" id="colorSwatch"></div>
                                        <input type="text" id="colorHexInput" class="color-hex-input" maxlength="7" placeholder="#000000">
                                    </div>
                                    <div class="color-picker-widget" id="colorPickerWidget">
                                        <div class="color-shade-picker" id="colorShadePicker">
                                            <canvas id="colorShadeCanvas" width="180" height="180"></canvas>
                                            <div class="color-shade-cursor" id="colorShadeCursor"></div>
                                        </div>
                                        <div class="color-hue-slider" id="colorHueSlider">
                                            <canvas id="colorHueCanvas" width="20" height="180"></canvas>
                                            <div class="color-hue-cursor" id="colorHueCursor"></div>
                                        </div>
                                    </div>
                                    <button id="saveColorBtn" class="embassy-btn secondary">
                                        Save Color
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Coterie Stats Section -->
                        <section class="embassy-section coterie-stats">
                            <h2 class="section-title">Your Coterie</h2>
                            <div class="coterie-info" id="coterieInfo">
                                <!-- Filled dynamically -->
                            </div>
                        </section>

                        <!-- Ambassador Actions Section -->
                        <section class="embassy-section ambassador-actions">
                            <h2 class="section-title">Ambassador Actions</h2>
                            
                            <div class="action-group">
                                <h3>Transfer Ambassadorship</h3>
                                <p class="action-description">Assign a member of your coterie as the new ambassador.</p>
                                <div class="transfer-controls">
                                    <select id="transferSelect" class="embassy-select">
                                        <option value="">Select new ambassador...</option>
                                    </select>
                                    <button id="transferBtn" class="embassy-btn warning" disabled>
                                        Transfer Role
                                    </button>
                                </div>
                            </div>

                            <div class="action-group danger-zone">
                                <h3>Step Down</h3>
                                <p class="action-description">Relinquish your role. The most active coterie member will become ambassador.</p>
                                <button id="stepDownBtn" class="embassy-btn danger">
                                    Step Down as Ambassador
                                </button>
                            </div>
                        </section>
                    </div>

                    <a href="/" class="embassy-back-link">Return to Reverie House</a>
                </div>
            </div>
        </div>
    </div>

    <div id="footer-container"></div>
</body>
</html>
