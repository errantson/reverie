<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reverie House - Canon Stories</title>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/heraldry.css">
    <link rel="stylesheet" href="/css/pages/story2.css">
    <link rel="stylesheet" href="/css/widgets/login.css">
    <link rel="stylesheet" href="/css/widgets/createdreamer.css">
    <link rel="stylesheet" href="/css/widgets/dialogue.css">
    <link rel="stylesheet" href="/css/widgets/dreamer-hover.css">
    <link rel="stylesheet" href="/css/widgets/profile.css">
    
    <!-- Favicon -->
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    
    <!-- Core utilities -->
    <script src="/js/core/world-config-cache.js"></script>
    <script src="/js/core/color-manager.js"></script>
    <script src="/js/utils/shadowbox.js"></script>
    <script src="/js/utils/heraldry.js"></script>
    <script src="/js/utils/atproto-interactions.js"></script>
    <script src="/js/widgets/background.js"></script>
    
    <!-- Scripts -->
    <script src="/js/widgets/header.js" defer></script>
    <script type="module" src="/js/widgets/oauth-manager.js"></script>
    <script src="/js/widgets/login.js" defer></script>
    <script src="/js/widgets/createdreamer.js" defer></script>
    <script src="/js/widgets/drawer.js" defer></script>
    <script src="/js/widgets/konami.js" defer></script>
    <script src="/js/widgets/dreamer-hover.js" defer></script>
    <script src="/js/widgets/howtolore.js" defer></script>
    <script src="/js/utils/user-status.js" defer></script>
    <script src="/js/pages/story2.js" defer></script>
    <script>
        // Safe login trigger that shows login popup
        async function triggerLogin() {
            // Check if already logged in
            if (window.oauthManager) {
                const session = window.oauthManager.getSession();
                if (session && session.profile?.handle) {
                    return; // Already logged in
                }
            }
            
            // Show login popup
            if (window.loginWidget && typeof window.loginWidget.showLoginPopup === 'function') {
                window.loginWidget.showLoginPopup();
            } else {
                console.error('Login widget not available');
            }
        }
    </script>
</head>
<body class="story2-page">
    <div id="header-container"></div>
    
    <!-- Fullscreen Background -->
    <div class="fullscreen-background">
        <div class="scene-background">
            <img src="souvenirs/residence/phanera.png" alt="Phanera Residence" class="scene-layer background-layer">
        </div>
    </div>

    <!-- Main Content -->
    <div class="story2-container">
        <!-- Left Sidebar -->
        <aside class="story2-sidebar">
            <!-- Branding -->
            <div class="sidebar-header">
                <img src="/assets/logo.png" alt="Reverie House Logo" class="sidebar-logo">
                <div class="sidebar-title">
                    <img src="/assets/icon.png" alt="" class="title-icon">
                    <h1>LIVING STORY</h1>
                    <img src="/assets/icon_face.png" alt="" class="title-icon">
                </div>
                <p class="sidebar-subtitle">Adventures archived as collective lore.</p>
            </div>

            <!-- User Status Section -->
            <div id="sidebar-user-section" class="sidebar-user-section">
                <!-- Loading State -->
                <div id="sidebar-loading" class="sidebar-loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Checking session...</div>
                </div>

                <!-- Guest State -->
                <div id="sidebar-guest" class="sidebar-guest" style="display: none;">
                    <div class="guest-message">
                        <p>Login to share your stories</p>
                    </div>
                    <button class="sidebar-login-btn" onclick="triggerLogin()">
                        Dreamweaver Login
                    </button>
                </div>

                <!-- User Logged In -->
                <div id="sidebar-user" class="sidebar-user" style="display: none;">
                    <div class="sidebar-avatar-container">
                        <img id="sidebar-avatar" src="/assets/icon_face.png" alt="Avatar" class="sidebar-avatar">
                    </div>
                    <div class="sidebar-user-info">
                        <div id="sidebar-user-name" class="sidebar-user-name">Loading...</div>
                        <div id="sidebar-user-handle" class="sidebar-user-handle">@...</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="sidebar-actions">
                <button class="share-story-btn" onclick="window.StoryViewer?.handleShareClick()">
                    <span>Share Your <span class="rotating-word"></span></span>
                </button>
                <button class="learn-more-btn" onclick="window.StoryViewer?.showHowItWorks()">
                    How It Works
                </button>
            </div>

            <!-- Filters -->
            <div class="sidebar-section">
                <div class="section-label">
                    <span>VIEW</span>
                    <span class="section-stats">
                        <strong id="total-stories">0</strong> stories
                        (<strong id="current-index">0</strong> of <strong id="filtered-count">0</strong>)
                    </span>
                </div>
                <div class="filter-group filter-group-row">
                    <button class="filter-btn active" data-filter="canon" onclick="window.StoryViewer?.setFilter('canon')">
                        <span>Show Canon</span>
                        <span class="filter-count" id="canon-count">0</span>
                    </button>
                    <button class="filter-btn" data-filter="all" onclick="window.StoryViewer?.setFilter('all')">
                        <span>Show Lore</span>
                        <span class="filter-count" id="all-count">0</span>
                    </button>
                </div>
            </div>

            <!-- Sort -->
            <div class="sidebar-section">
                <div class="section-label">SORT</div>
                <div class="filter-group">
                    <button class="sort-btn active" data-sort="newest" onclick="window.StoryViewer?.setSort('newest')">
                        <span>Newest First</span>
                    </button>
                    <button class="sort-btn" data-sort="oldest" onclick="window.StoryViewer?.setSort('oldest')">
                        <span>Oldest First</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Viewer -->
        <main class="story2-viewer">
            <!-- Loading State -->
            <div class="viewer-loading" id="viewer-loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">Restoring Canon...</div>
            </div>

            <!-- Empty State -->
            <div class="viewer-empty" id="viewer-empty" style="display: none;">
                <div class="empty-icon">ðŸ“–</div>
                <div class="empty-text">No stories found</div>
                <div class="empty-hint">Try changing your filters</div>
            </div>

            <!-- Story Display -->
            <div class="viewer-content" id="viewer-content" style="display: none;">
                <!-- Story Card -->
                <article class="story-card" id="story-card" role="article" aria-live="polite">
                    <!-- Story Header - Attribution -->
                    <header class="story-header">
                        <div class="header-primary">
                            <figure class="author-portrait">
                                <img class="author-avatar" id="author-avatar" src="/assets/icon_face.png" alt="">
                            </figure>
                            <div class="author-metadata">
                                <div class="author-name" id="author-name">Loading...</div>
                                <div class="author-context">
                                    <span class="author-handle" id="author-handle">@...</span>
                                    <span class="metadata-separator">Â·</span>
                                    <time class="story-date" id="story-date" datetime="">...</time>
                                </div>
                            </div>
                        </div>
                        
                        <div class="header-secondary">
                            <div class="story-badges" id="story-badges" role="list"></div>
                            <a class="source-link" id="view-original" href="#" target="_blank" rel="noopener noreferrer" aria-label="View original on Bluesky">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                    <polyline points="15 3 21 3 21 9"/>
                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                                <span>Source</span>
                            </a>
                        </div>
                    </header>

                    <!-- Story Body -->
                    <div class="story-body">
                        <div class="story-content" id="story-content-main">
                            <!-- Image with overlay OR text will be rendered here -->
                        </div>
                    </div>

                    <!-- Engagement Metrics & Navigation -->
                    <footer class="story-engagement" role="complementary">
                        <div class="story-actions" id="story-actions">
                            <button class="story-action-btn like-btn" 
                                    id="like-btn"
                                    data-uri=""
                                    data-cid=""
                                    data-liked="false"
                                    title="Like this post">
                                <span>Like</span>
                                <span class="action-count" id="like-count">0</span>
                            </button>
                            <button class="story-action-btn repost-btn" 
                                    id="repost-btn"
                                    data-uri=""
                                    data-cid=""
                                    data-reposted="false"
                                    title="Repost to your timeline">
                                <span>Repost</span>
                                <span class="action-count" id="repost-count">0</span>
                            </button>
                            <button class="story-action-btn reply-btn" 
                                    id="reply-btn"
                                    data-uri=""
                                    data-cid=""
                                    data-handle=""
                                    data-displayname=""
                                    data-text=""
                                    title="Reply to this post">
                                <span>Reply</span>
                                <span class="action-count" id="reply-count">0</span>
                            </button>
                        </div>
                        
                        <nav class="engagement-nav" aria-label="Story navigation">
                            <button class="nav-btn nav-prev" id="nav-prev" onclick="window.StoryViewer?.prev()" aria-label="Previous story">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="15 18 9 12 15 6"/>
                                </svg>
                            </button>
                            <button class="nav-btn nav-next" id="nav-next" onclick="window.StoryViewer?.next()" aria-label="Next story">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="9 18 15 12 9 6"/>
                                </svg>
                            </button>
                        </nav>
                    </footer>
                </article>

                <!-- Timeline Preview -->
                <aside class="timeline-preview" id="carousel-preview" role="complementary" aria-label="Story timeline">
                    <div class="timeline-track" id="carousel-track" role="list">
                        <!-- Preview items will be rendered here -->
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <div id="footer-container"></div>
</body>
</html>
