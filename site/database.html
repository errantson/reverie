<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reverie House — Database</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Pour over the details of our shared canon and the history of Reverie House.">
    <meta name="keywords" content="database, archive, lore, dreamers, stories, locations, reverie house, worldbuilding">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://reverie.house/database.html">
    <meta property="og:title" content="Database - Reverie House">
    <meta property="og:description" content="Pour over the details of our shared canon and the history of Reverie House.">
    <meta property="og:image" content="https://reverie.house/assets/og-image.png">
    <meta property="og:site_name" content="Reverie House">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Database - Reverie House">
    <meta name="twitter:description" content="Pour over the details of our shared canon and the history of Reverie House.">
    <meta name="twitter:image" content="https://reverie.house/assets/og-image.png">
    
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/widgets/header.css">
    <link rel="stylesheet" href="/css/pages/database.css">
    <link rel="stylesheet" href="/css/roles.css">
    <link rel="stylesheet" href="/css/octants.css">
    <link rel="stylesheet" href="/css/color-rows.css?v=20260210c">
    <link rel="stylesheet" href="/css/souvenirs.css">
    <link rel="stylesheet" href="/css/widgets/dialogue.css">
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    
    <!-- Core utilities (must load first) -->
    <script src="/js/core/world-config-cache.js"></script>
    <script src="/js/core/color-manager.js"></script>
    <script src="/js/core/rowstyle-registry.js?v=20260210c"></script>
    <script src="/js/core/rowstyle-engine.js?v=20260209"></script>
    <script src="/js/utils/shadowbox.js"></script>
    <script src="/js/widgets/showpost.js"></script>
    <script src="/js/widgets/eventstack.js?v=20260210d"></script>
    <script src="/js/core/avatar-cache.js" defer></script>
    <script src="/js/widgets/header.js" defer></script>
    <script type="module" src="/js/widgets/oauth-manager.js"></script>
    <script src="/js/widgets/login.js" defer></script>
    <script src="/js/widgets/drawer.js" defer></script>
</head>
<body class="database-page">
    <div id="header-container"></div>
    
    <div class="database-layout">
        <!-- Left Sidebar: Stats Panel -->
        <aside class="database-left-column">
            <section class="left-column-section mindscape-section">
                <h2 class="section-title" style="text-align: center; border-bottom: none; margin-bottom: 12px; font-size: 1.1em; letter-spacing: 1px;">OUR WILD MINDSCAPE</h2>
                <div class="mindscape-stat-box large">
                    <div class="mindscape-stat-count" id="idle-dreamers-count">---</div>
                    <div class="mindscape-stat-label">Idle Dreamers</div>
                </div>
                <div class="mindscape-stats-row">
                    <div class="mindscape-stat-box">
                        <div class="mindscape-stat-count" id="dreamweavers-count">---</div>
                        <div class="mindscape-stat-label">Dreamweavers</div>
                    </div>
                    <div class="mindscape-stat-box">
                        <div class="mindscape-stat-count" id="residents-count">---</div>
                        <div class="mindscape-stat-label">Residents</div>
                    </div>
                </div>
            </section>
            
            <section class="left-column-section">
                <div class="stat-item">
                    <span class="stat-label">Total Events</span>
                    <span class="stat-value" id="stat-events">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Canon Events</span>
                    <span class="stat-value" id="stat-canon">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Lore Events</span>
                    <span class="stat-value" id="stat-lore">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">Kindred</span>
                    <span class="stat-value" id="stat-kindred">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Souvenirs</span>
                    <span class="stat-value" id="stat-souvenirs">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Dreams</span>
                    <span class="stat-value" id="stat-dreams">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Workers</span>
                    <span class="stat-value" id="stat-workers">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Readers</span>
                    <span class="stat-value" id="stat-readers">0</span>
                </div>
                <div class="stat-divider"></div>
            </section>
            
            <section class="left-column-section">
                <div class="stat-item">
                    <span class="stat-label">Dream Storage</span>
                    <span class="operations-status">
                        <span class="operations-text" id="ops-pds-text">---</span>
                        <div class="operations-light" id="ops-pds-light"></div>
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Dreamer Routing</span>
                    <span class="operations-status">
                        <span class="operations-text" id="ops-caddy-text">---</span>
                        <div class="operations-light" id="ops-caddy-light"></div>
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Dreaming Monitor</span>
                    <span class="operations-status">
                        <span class="operations-text" id="ops-firehose-text">---</span>
                        <div class="operations-light" id="ops-firehose-light"></div>
                    </span>
                </div>
            </section>
        </aside>
        
        <!-- Main Content: Event History -->
        <main class="database-main-content">
            <header class="page-header-fixed">
                <div class="filter-group">
                    <button class="db-btn db-btn-icon" onclick="resetFilters()" title="Reset filters and refresh">
                        <svg class="db-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                    <select id="filter-type" onchange="applyFilters()" class="db-filter-dropdown">
                        <option value="all">All Events</option>
                        <option value="type:arrival">Arrivals</option>
                        <option value="key:dissipate">Departures</option>
                        <option disabled>──────────</option>
                        <option value="key:canon">Canon Events</option>
                        <option value="type:lore">Lore Additions</option>
                        <option value="type:souvenir">— Souvenirs</option>
                        <option value="type:dream">Dreams</option>
                        <option value="type:nightmare">Nightmares</option>
                        <option disabled>──────────</option>
                        <option value="type:kindred">Kindred</option>
                        <option value="type:guardian">Guardianship</option>
                        <option value="type:order">Orders</option>
                        <option value="type:work">Workers</option>
                        <option disabled>──────────</option>
                        <option value="type:name">Name Changes</option>
                        <option value="type:spectrum">Spectrum</option>
                    </select>
                </div>
                <div class="search-group">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="search" placeholder="Search events..." class="db-search-input" oninput="applyFilters()">
                </div>
                <div class="header-epoch" id="current-epoch">---</div>
            </header>
            
            <div id="rows-container">
                <!-- Event rows rendered by EventStack -->
            </div>
        </main>
    </div>

    <script>
        // Global state
        let allData = {};
        let filteredData = {};
        let guardianRules = null;
        let aggregateBarred = null;
        const searchFields = ['name', 'event', 'uri', 'type', 'key'];

        // Pagination state
        const PAGE_SIZE = 50;
        let currentDisplayEvents = [];
        let currentDisplayLimit = PAGE_SIZE;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize RowStyleEngine if not already done
            if (!window.rowStyleEngine && window.RowStyleEngine) {
                window.rowStyleEngine = new RowStyleEngine();
            }
            
            setupSearch();
            await loadGuardianRules();
            await loadAllData();
            applyFilters(); // Apply guardian filtering on initial render
            
            // Start epoch counter
            updateCurrentEpoch();
            setInterval(updateCurrentEpoch, 1000);
        });
        
        // Load guardian filtering rules
        async function loadGuardianRules() {
            try {
                const token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                
                if (token) {
                    // Logged-in user: get their specific guardian rules
                    const response = await fetch('/api/guardian/my-rules', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        guardianRules = await response.json();
                    }
                    
                    // Check if user has community shield enabled
                    let shieldEnabled = true; // Default to ON
                    try {
                        const shieldResponse = await fetch('/api/user/shield', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (shieldResponse.ok) {
                            const shieldData = await shieldResponse.json();
                            shieldEnabled = shieldData.community_shield !== false;
                        }
                    } catch (e) {
                        console.warn('Failed to check shield status:', e);
                    }
                    
                    // If shield is enabled, also load aggregate barred list
                    if (shieldEnabled) {
                        const aggregateResponse = await fetch('/api/guardian/aggregate-barred');
                        if (aggregateResponse.ok) {
                            aggregateBarred = await aggregateResponse.json();
                        }
                    } else {
                        aggregateBarred = null;
                    }
                } else {
                    // Guest: load aggregate barred list
                    guardianRules = null;
                    const response = await fetch('/api/guardian/aggregate-barred');
                    if (response.ok) {
                        aggregateBarred = await response.json();
                    }
                }
            } catch (error) {
                console.warn('Failed to load guardian rules:', error);
                guardianRules = null;
                aggregateBarred = null;
            }
        }

        // Reload data when page becomes visible (tab switching)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                loadAllData().then(() => applyFilters());
            }
        });

        // Update current epoch display
        function updateCurrentEpoch() {
            const epochEl = document.getElementById('current-epoch');
            if (epochEl) {
                epochEl.textContent = Math.floor(Date.now() / 1000);
            }
        }

        // Fetch idle dreamers with caching
        async function fetchIdleDreamers() {
            const CACHE_KEY = 'reverie_idle_dreamers';
            const CACHE_TTL = 10 * 60 * 1000; // 10 minutes
            
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const data = JSON.parse(cached);
                    if (Date.now() - data.timestamp < CACHE_TTL) {
                        return data.count;
                    }
                }
            } catch (err) {
                console.warn('Cache read error:', err);
            }
            
            try {
                const response = await fetch('/api/bsky-stats', {
                    signal: AbortSignal.timeout(5000)
                });
                
                if (!response.ok) throw new Error('API error');
                
                const data = await response.json();
                const count = data.last_user_count;
                
                if (count && typeof count === 'number') {
                    try {
                        localStorage.setItem(CACHE_KEY, JSON.stringify({
                            count,
                            timestamp: Date.now()
                        }));
                    } catch (err) {}
                    return count;
                }
            } catch (err) {
                console.error('Error fetching idle dreamers:', err);
            }
            
            return null;
        }

        // Fetch operations status
        async function fetchOperationsStatus() {
            try {
                const response = await fetch('/api/operations-status');
                const status = await response.json();
                
                const updateStatus = (id, isActive) => {
                    const textEl = document.getElementById('ops-' + id + '-text');
                    const lightEl = document.getElementById('ops-' + id + '-light');
                    if (textEl) textEl.textContent = isActive ? '(active)' : '(felled)';
                    if (lightEl) lightEl.className = 'operations-light ' + (isActive ? 'active' : 'inactive');
                };
                
                updateStatus('pds', status.pds?.active);
                updateStatus('caddy', status.caddy?.active);
                updateStatus('firehose', status.firehose?.active);
            } catch (error) {
                console.warn('Could not fetch operations status:', error);
            }
        }

        // Fetch active workers count from work table
        async function fetchActiveWorkers() {
            try {
                const response = await fetch('/api/work/active-roles');
                const workers = await response.json();
                const workersEl = document.getElementById('stat-workers');
                if (workersEl) {
                    workersEl.textContent = workers.length.toLocaleString();
                }
            } catch (error) {
                console.warn('Could not fetch active workers:', error);
                const workersEl = document.getElementById('stat-workers');
                if (workersEl) workersEl.textContent = '?';
            }
        }

        // Load all data from API
        async function loadAllData() {
            try {
                const response = await fetch('/api/database/all');
                const data = await response.json();
                
                allData = data.tables || {};
                
                // Update idle dreamers
                const idleDreamers = await fetchIdleDreamers();
                const idleEl = document.getElementById('idle-dreamers-count');
                if (idleEl) idleEl.textContent = idleDreamers ? idleDreamers.toLocaleString() : '???';
                
                // Update dreamweavers count
                const dreamweaversEl = document.getElementById('dreamweavers-count');
                if (dreamweaversEl && allData.dreamers) {
                    dreamweaversEl.textContent = allData.dreamers.length.toLocaleString();
                }
                
                // Update residents count
                const residentsEl = document.getElementById('residents-count');
                if (residentsEl && allData.dreamers) {
                    const residents = allData.dreamers.filter(d => 
                        d.server && d.server.includes('reverie.house')
                    ).length;
                    residentsEl.textContent = residents.toLocaleString();
                }
                
                // Calculate and update statistics
                const stats = data.stats || {};
                const events = allData.events || [];
                
                document.getElementById('stat-events').textContent = (stats.events || 0).toLocaleString();
                document.getElementById('stat-canon').textContent = events.filter(e => e.canon === 1 || e.key === 'canon').length.toLocaleString();
                document.getElementById('stat-lore').textContent = events.filter(e => e.type === 'lore').length.toLocaleString();
                
                // Count kindred connections (reciprocal bonds)
                document.getElementById('stat-kindred').textContent = (stats.kindred || 0).toLocaleString();
                
                // Count souvenir events (awards given)
                document.getElementById('stat-souvenirs').textContent = events.filter(e => e.type === 'souvenir').length.toLocaleString();
                
                // Count dream events (times dreamers have dreamed)
                const dreamEvents = events.filter(e => e.type === 'dream' || e.type === 'nightmare');
                document.getElementById('stat-dreams').textContent = dreamEvents.length.toLocaleString();
                
                // Fetch active workers from work table
                fetchActiveWorkers();
                
                // Count unique readers (unique DIDs with order events)
                const orderEvents = events.filter(e => e.type === 'order');
                const uniqueReaders = new Set(orderEvents.map(e => e.did).filter(Boolean));
                document.getElementById('stat-readers').textContent = uniqueReaders.size.toLocaleString();
                
                // Fetch operations status
                fetchOperationsStatus();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Unable to connect to database API.');
            }
        }

        // Render events using EventStack (with pagination)
        function renderEvents(eventsToRender = null) {
            const container = document.getElementById('rows-container');
            currentDisplayEvents = eventsToRender || allData.events || [];
            currentDisplayLimit = PAGE_SIZE; // reset on each new filter/render
            renderPage(container);
        }

        // Render the current page slice; re-called on Load More
        function renderPage(container) {
            if (currentDisplayEvents.length === 0) {
                container.innerHTML = '<div class="empty-state">No events found matching your criteria.</div>';
                return;
            }

            if (!window.EventStack) {
                container.innerHTML = '<div class="empty-state">EventStack widget not loaded. Please refresh the page.</div>';
                return;
            }

            const eventStack = new EventStack();
            eventStack.render(currentDisplayEvents, container, { limit: currentDisplayLimit });

            // Append Load More button if more rows remain
            const totalTop = currentDisplayEvents.filter(e => !e.reaction_to).length;
            if (totalTop > currentDisplayLimit) {
                const remaining = totalTop - currentDisplayLimit;
                const btn = document.createElement('button');
                btn.className = 'load-more-btn';
                btn.textContent = `Load ${Math.min(PAGE_SIZE, remaining)} more (${remaining} remaining)`;
                btn.addEventListener('click', () => {
                    currentDisplayLimit += PAGE_SIZE;
                    renderPage(container);
                });
                container.appendChild(btn);
            }
        }

        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('search');
            let searchTimeout;
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    applyFilters();
                }, 300);
            });
        }

        // Apply filters and search
        function applyFilters() {
            const filterValue = document.getElementById('filter-type').value;
            const searchQuery = document.getElementById('search').value.toLowerCase().trim();
            
            let events = allData.events || [];
            
            // Apply type/key filter
            if (filterValue !== 'all') {
                if (filterValue.includes(':')) {
                    const [field, value] = filterValue.split(':');
                    events = events.filter(row => row[field] === value);
                } else {
                    events = events.filter(row => row.type === filterValue || row.key === filterValue);
                }
            }
            
            // Apply search filter - include base events and reactions when either matches
            if (searchQuery) {
                // Build a set of event IDs to include
                const matchingIds = new Set();
                const reactionFields = ['reaction_name', 'reaction_event', 'reaction_type', 'reaction_key'];
                
                events.forEach(row => {
                    // Check if base event matches
                    const baseMatches = searchFields.some(field => {
                        const value = row[field];
                        return value && String(value).toLowerCase().includes(searchQuery);
                    });
                    
                    // Check if reaction matches
                    const reactionMatches = reactionFields.some(field => {
                        const value = row[field];
                        return value && String(value).toLowerCase().includes(searchQuery);
                    });
                    
                    if (baseMatches || reactionMatches) {
                        matchingIds.add(row.id);
                    }
                });
                
                // Also include parent events if their reaction matched
                events.forEach(row => {
                    if (row.reaction_to && matchingIds.has(row.id)) {
                        matchingIds.add(row.reaction_to);
                    }
                    if (row.reaction_id && matchingIds.has(row.id)) {
                        matchingIds.add(row.reaction_id);
                    }
                });
                
                events = events.filter(row => matchingIds.has(row.id));
            }
            
            // Apply guardian filtering for logged-in wards/charges
            if (guardianRules?.has_guardian) {
                if (guardianRules.filter_mode === 'whitelist') {
                    const allowedDids = new Set(guardianRules.filter_dids || []);
                    const allowedUris = new Set(guardianRules.filter_uris || []);
                    events = events.filter(row => allowedDids.has(row.did) || allowedUris.has(row.uri));
                } else if (guardianRules.filter_mode === 'blacklist') {
                    const barredDids = new Set(guardianRules.filter_dids || []);
                    const barredUris = new Set(guardianRules.filter_uris || []);
                    events = events.filter(row => !barredDids.has(row.did) && !barredUris.has(row.uri));
                }
            }
            
            // Apply aggregate barred filtering (for guests AND logged-in users with Community Shield ON)
            if (aggregateBarred) {
                const barredDids = new Set(aggregateBarred.barred_dids || []);
                const barredUris = new Set(aggregateBarred.barred_uris || []);
                if (barredDids.size > 0 || barredUris.size > 0) {
                    events = events.filter(row => !barredDids.has(row.did) && !barredUris.has(row.uri));
                }
            }
            
            renderEvents(events);
        }

        // Reset all filters
        function resetFilters() {
            document.getElementById('filter-type').value = 'all';
            document.getElementById('search').value = '';
            filteredData = {};
            loadAllData().then(() => applyFilters());
        }

        // Show error message
        function showError(message) {
            const error = document.createElement('div');
            error.className = 'error-toast';
            error.innerHTML = '<strong>⚠️ Error:</strong> ' + message;
            document.body.appendChild(error);
            setTimeout(() => error.remove(), 5000);
        }

        // Copy to clipboard utility
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const msg = document.createElement('div');
                msg.className = 'copy-toast';
                msg.textContent = '✓ Copied to clipboard';
                document.body.appendChild(msg);
                setTimeout(() => msg.remove(), 1500);
            }).catch(err => console.error('Failed to copy:', err));
        }
    </script>
    
    <style>
        /* Additional inline styles for toasts and empty state */
        .empty-state {
            text-align: center;
            color: var(--text-dim);
            padding: 40px 20px;
            font-family: monospace;
            font-style: italic;
        }
        
        .error-toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger, #F44336);
            color: white;
            padding: 12px 24px;
            font-size: 0.9em;
            font-family: monospace;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .copy-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--success, #28a745);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            z-index: 10000;
            font-size: 0.9em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .stat-divider {
            border-top: 1px solid var(--border);
            margin: 12px 0;
        }
    </style>
</body>
</html>
