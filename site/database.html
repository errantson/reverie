<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reverie House — Database</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Pour over the details of our shared canon and the history of Reverie House.">
    <meta name="keywords" content="database, archive, lore, dreamers, stories, locations, reverie house, worldbuilding">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://reverie.house/database.html">
    <meta property="og:title" content="Database - Reverie House">
    <meta property="og:description" content="Pour over the details of our shared canon and the history of Reverie House.">
    <meta property="og:image" content="https://reverie.house/assets/og-image.png">
    <meta property="og:site_name" content="Reverie House">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Database - Reverie House">
    <meta name="twitter:description" content="Pour over the details of our shared canon and the history of Reverie House.">
    <meta name="twitter:image" content="https://reverie.house/assets/og-image.png">
    
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/widgets/header.css">
    <link rel="stylesheet" href="/css/pages/database.css">
    <link rel="stylesheet" href="/css/roles.css">
    <link rel="stylesheet" href="/css/octants.css">
    <link rel="stylesheet" href="/css/color-rows.css">
    <link rel="stylesheet" href="/css/souvenirs.css">
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    
    <!-- Core utilities (must load first) -->
    <script src="/js/core/world-config-cache.js"></script>
    <script src="/js/core/color-manager.js"></script>
    <script src="/js/core/rowstyle-registry.js?v=1765642342"></script>
    <script src="/js/core/rowstyle-engine.js"></script>
    <script src="/js/utils/shadowbox.js"></script>
    <script src="/js/widgets/showpost.js"></script>
    <script src="/js/widgets/eventstack.js?v=1765642847"></script>
    <script src="/js/widgets/header.js" defer></script>
    <script type="module" src="/js/widgets/oauth-manager.js"></script>
    <script src="/js/widgets/login.js" defer></script>
    <script src="/js/widgets/drawer.js" defer></script>
</head>
<body class="database-page">
    <div id="header-container"></div>
    
    <div class="database-layout">
        <!-- Left Sidebar: Stats Panel -->
        <aside class="database-left-column">
            <section class="left-column-section mindscape-section">
                <h2 class="section-title" style="text-align: center; border-bottom: none; margin-bottom: 12px; font-size: 1.1em; letter-spacing: 1px;">OUR WILD MINDSCAPE</h2>
                <div class="mindscape-stat-box large">
                    <div class="mindscape-stat-count" id="idle-dreamers-count">---</div>
                    <div class="mindscape-stat-label">Idle Dreamers</div>
                </div>
                <div class="mindscape-stats-row">
                    <div class="mindscape-stat-box">
                        <div class="mindscape-stat-count" id="dreamweavers-count">---</div>
                        <div class="mindscape-stat-label">Dreamweavers</div>
                    </div>
                    <div class="mindscape-stat-box">
                        <div class="mindscape-stat-count" id="residents-count">---</div>
                        <div class="mindscape-stat-label">Residents</div>
                    </div>
                </div>
            </section>
            
            <section class="left-column-section">
                <div class="stat-item">
                    <span class="stat-label">Total Events</span>
                    <span class="stat-value" id="stat-events">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Canon Events</span>
                    <span class="stat-value" id="stat-canon">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Lore Events</span>
                    <span class="stat-value" id="stat-lore">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">Souvenirs</span>
                    <span class="stat-value" id="stat-souvenirs">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Dreams</span>
                    <span class="stat-value" id="stat-dreams">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Workers</span>
                    <span class="stat-value" id="stat-workers">0</span>
                </div>
            </section>
            
            <section class="left-column-section">
                <div class="stat-item">
                    <span class="stat-label">Dream Storage</span>
                    <span class="operations-status">
                        <span class="operations-text" id="ops-pds-text">---</span>
                        <div class="operations-light" id="ops-pds-light"></div>
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Dreamer Routing</span>
                    <span class="operations-status">
                        <span class="operations-text" id="ops-caddy-text">---</span>
                        <div class="operations-light" id="ops-caddy-light"></div>
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Dreaming Monitor</span>
                    <span class="operations-status">
                        <span class="operations-text" id="ops-firehose-text">---</span>
                        <div class="operations-light" id="ops-firehose-light"></div>
                    </span>
                </div>
            </section>
        </aside>
        
        <!-- Main Content: Event History -->
        <main class="database-main-content">
            <header class="page-header-fixed">
                <button class="db-btn" onclick="resetFilters()" title="Reset filters and refresh" style="padding:6px 8px;">
                    <svg class="db-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px; height:16px;">
                        <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                </button>
                <select id="filter-type" onchange="applyFilters()" class="db-filter-dropdown">
                    <option value="all">All Events</option>
                    <optgroup label="Arrivals & Departures">
                        <option value="type:arrival">Arrivals</option>
                        <option value="key:dissipate">Departed</option>
                    </optgroup>
                    <optgroup label="Canon Events">
                        <option value="key:canon">Canon Events</option>
                        <option value="type:dream">Dreams</option>
                        <option value="type:nightmare">Nightmares</option>
                    </optgroup>
                    <optgroup label="Achievements">
                        <option value="type:souvenir">Souvenirs</option>
                        <option value="type:order">Orders</option>
                    </optgroup>
                    <optgroup label="Other">
                        <option value="type:work">Workers</option>
                        <option value="type:name">Name Changes</option>
                    </optgroup>
                </select>
                <input type="text" id="search" placeholder="Search database..." class="db-search-input" oninput="applyFilters()">
                <div id="current-epoch" style="margin-left: auto; font-family: monospace; font-size: 0.95em; font-weight: 700; color: #9ca3af; letter-spacing: -1px; white-space: nowrap;">---</div>
            </header>
            
            <div id="rows-container">
                <!-- Event rows rendered by EventStack -->
            </div>
        </main>
    </div>

    <script>
        // Global state
        let allData = {};
        let filteredData = {};
        const searchFields = ['name', 'event', 'uri', 'type', 'key'];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize RowStyleEngine if not already done
            if (!window.rowStyleEngine && window.RowStyleEngine) {
                window.rowStyleEngine = new RowStyleEngine();
            }
            
            setupSearch();
            await loadAllData();
            renderEvents();
            
            // Start epoch counter
            updateCurrentEpoch();
            setInterval(updateCurrentEpoch, 1000);
        });

        // Reload data when page becomes visible (tab switching)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                loadAllData().then(() => renderEvents());
            }
        });

        // Update current epoch display
        function updateCurrentEpoch() {
            const epochEl = document.getElementById('current-epoch');
            if (epochEl) {
                epochEl.textContent = Math.floor(Date.now() / 1000);
            }
        }

        // Fetch idle dreamers with caching
        async function fetchIdleDreamers() {
            const CACHE_KEY = 'reverie_idle_dreamers';
            const CACHE_TTL = 10 * 60 * 1000; // 10 minutes
            
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const data = JSON.parse(cached);
                    if (Date.now() - data.timestamp < CACHE_TTL) {
                        return data.count;
                    }
                }
            } catch (err) {
                console.warn('Cache read error:', err);
            }
            
            try {
                const response = await fetch('/api/bsky-stats', {
                    signal: AbortSignal.timeout(5000)
                });
                
                if (!response.ok) throw new Error('API error');
                
                const data = await response.json();
                const count = data.last_user_count;
                
                if (count && typeof count === 'number') {
                    try {
                        localStorage.setItem(CACHE_KEY, JSON.stringify({
                            count,
                            timestamp: Date.now()
                        }));
                    } catch (err) {}
                    return count;
                }
            } catch (err) {
                console.error('Error fetching idle dreamers:', err);
            }
            
            return null;
        }

        // Fetch operations status
        async function fetchOperationsStatus() {
            try {
                const response = await fetch('/api/operations-status');
                const status = await response.json();
                
                const updateStatus = (id, isActive) => {
                    const textEl = document.getElementById('ops-' + id + '-text');
                    const lightEl = document.getElementById('ops-' + id + '-light');
                    if (textEl) textEl.textContent = isActive ? '(active)' : '(felled)';
                    if (lightEl) lightEl.className = 'operations-light ' + (isActive ? 'active' : 'inactive');
                };
                
                updateStatus('pds', status.pds?.active);
                updateStatus('caddy', status.caddy?.active);
                updateStatus('firehose', status.firehose?.active);
            } catch (error) {
                console.warn('Could not fetch operations status:', error);
            }
        }

        // Load all data from API
        async function loadAllData() {
            try {
                const response = await fetch('/api/database/all');
                const data = await response.json();
                
                allData = data.tables || {};
                
                // Update idle dreamers
                const idleDreamers = await fetchIdleDreamers();
                const idleEl = document.getElementById('idle-dreamers-count');
                if (idleEl) idleEl.textContent = idleDreamers ? idleDreamers.toLocaleString() : '???';
                
                // Update dreamweavers count
                const dreamweaversEl = document.getElementById('dreamweavers-count');
                if (dreamweaversEl && allData.dreamers) {
                    dreamweaversEl.textContent = allData.dreamers.length.toLocaleString();
                }
                
                // Update residents count
                const residentsEl = document.getElementById('residents-count');
                if (residentsEl && allData.dreamers) {
                    const residents = allData.dreamers.filter(d => 
                        d.server && d.server.includes('reverie.house')
                    ).length;
                    residentsEl.textContent = residents.toLocaleString();
                }
                
                // Calculate and update statistics
                const stats = data.stats || {};
                const events = allData.events || [];
                
                document.getElementById('stat-events').textContent = (stats.events || 0).toLocaleString();
                document.getElementById('stat-canon').textContent = events.filter(e => e.canon === 1 || e.key === 'canon').length.toLocaleString();
                document.getElementById('stat-lore').textContent = events.filter(e => e.type === 'lore').length.toLocaleString();
                document.getElementById('stat-souvenirs').textContent = events.filter(e => e.type === 'souvenir').length.toLocaleString();
                
                // Count unique dreams
                const uniqueDreams = new Set(events.filter(e => e.type === 'dream' && e.key).map(e => e.key));
                document.getElementById('stat-dreams').textContent = uniqueDreams.size.toLocaleString();
                
                // Count active workers
                if (allData.dreamers) {
                    const workers = allData.dreamers.filter(d => 
                        d.status === 'working' || d.status === 'retiring'
                    ).length;
                    document.getElementById('stat-workers').textContent = workers.toLocaleString();
                }
                
                // Fetch operations status
                fetchOperationsStatus();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Unable to connect to database API.');
            }
        }

        // Render events using EventStack
        function renderEvents(eventsToRender = null) {
            const container = document.getElementById('rows-container');
            const events = eventsToRender || allData.events || [];
            
            if (events.length === 0) {
                container.innerHTML = '<div class="empty-state">No events found matching your criteria.</div>';
                return;
            }
            
            // Use EventStack widget for consistent rendering
            if (window.EventStack) {
                const eventStack = new EventStack();
                eventStack.render(events, container);
            } else {
                container.innerHTML = '<div class="empty-state">EventStack widget not loaded. Please refresh the page.</div>';
            }
        }

        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('search');
            let searchTimeout;
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    applyFilters();
                }, 300);
            });
        }

        // Apply filters and search
        function applyFilters() {
            const filterValue = document.getElementById('filter-type').value;
            const searchQuery = document.getElementById('search').value.toLowerCase().trim();
            
            let events = allData.events || [];
            
            // Apply type/key filter
            if (filterValue !== 'all') {
                if (filterValue.includes(':')) {
                    const [field, value] = filterValue.split(':');
                    events = events.filter(row => row[field] === value);
                } else {
                    events = events.filter(row => row.type === filterValue || row.key === filterValue);
                }
            }
            
            // Apply search filter
            if (searchQuery) {
                events = events.filter(row => {
                    return searchFields.some(field => {
                        const value = row[field];
                        return value && String(value).toLowerCase().includes(searchQuery);
                    });
                });
            }
            
            renderEvents(events);
        }

        // Reset all filters
        function resetFilters() {
            document.getElementById('filter-type').value = 'all';
            document.getElementById('search').value = '';
            filteredData = {};
            loadAllData().then(() => renderEvents());
        }

        // Show error message
        function showError(message) {
            const error = document.createElement('div');
            error.className = 'error-toast';
            error.innerHTML = '<strong>⚠️ Error:</strong> ' + message;
            document.body.appendChild(error);
            setTimeout(() => error.remove(), 5000);
        }

        // Copy to clipboard utility
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const msg = document.createElement('div');
                msg.className = 'copy-toast';
                msg.textContent = '✓ Copied to clipboard';
                document.body.appendChild(msg);
                setTimeout(() => msg.remove(), 1500);
            }).catch(err => console.error('Failed to copy:', err));
        }
    </script>
    
    <style>
        /* Additional inline styles for toasts and empty state */
        .empty-state {
            text-align: center;
            color: var(--text-dim);
            padding: 40px 20px;
            font-family: monospace;
            font-style: italic;
        }
        
        .error-toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger, #F44336);
            color: white;
            padding: 12px 24px;
            font-size: 0.9em;
            font-family: monospace;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .copy-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--success, #28a745);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            z-index: 10000;
            font-size: 0.9em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .stat-divider {
            border-top: 1px solid var(--border);
            margin: 12px 0;
        }
    </style>
</body>
</html>
