<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reverie House â€” Souvenirs</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Collect souvenirs as mementoes of your journey through our wild mindscape, marking your adventures and unlocking more.">
    <meta name="keywords" content="souvenirs, badges, achievements, collectibles, dreamweaving, reverie house">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://reverie.house/souvenirs.html">
    <meta property="og:title" content="Souvenirs - Reverie House">
    <meta property="og:description" content="Collect souvenirs as mementoes of your journey through our wild mindscape, marking your adventures and unlocking more.">
    <meta property="og:image" content="https://reverie.house/assets/og-image.png">
    <meta property="og:site_name" content="Reverie House">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Souvenirs - Reverie House">
    <meta name="twitter:description" content="Collect souvenirs as mementoes of your journey through our wild mindscape, marking your adventures and unlocking more.">
    <meta name="twitter:image" content="https://reverie.house/assets/og-image.png">
    
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/pages/souvenirs-desktop.css">
    <link rel="stylesheet" href="css/pages/database.css">
    <link rel="stylesheet" href="css/roles.css">
    <link rel="stylesheet" href="css/octants.css">
    <link rel="stylesheet" href="css/souvenirs.css">
    <link rel="stylesheet" href="css/color-rows.css">
    <link rel="stylesheet" href="css/widgets/login.css">
    <link rel="stylesheet" href="css/widgets/dialogue.css">
    <link rel="stylesheet" href="css/widgets/dreamer-hover.css">
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <!-- Core utilities (must load first) -->
    <script src="js/core/world-config-cache.js"></script>
    <script src="js/core/color-manager.js"></script>
    <script src="js/utils/shadowbox.js"></script>
    <script src="js/widgets/showpost.js"></script>
    <script src="js/widgets/background.js"></script>
    <script src="js/utils/num_nom.js"></script>
    <script src="js/widgets/souvenirs.js"></script>
    <script src="js/widgets/header.js" defer></script>
    <script type="module" src="js/widgets/oauth-manager.js"></script>
    <script src="js/widgets/login.js" defer></script>
    <script src="js/widgets/dreamer-hover.js" defer></script>
    <script src="js/widgets/drawer.js" defer></script>
    <script src="js/widgets/konami.js" defer></script>
    <!-- Souvenir widgets -->
    <script src="js/widgets/eventstack.js"></script>
    <script src="js/widgets/bouncerbox.js"></script>
</head>
<body class="souvenir-page">
    <div id="header-container"></div>
    
    <!-- Full-Screen Background Scene -->
    <div class="fullscreen-background">
        <div class="scene-background">
            <img src="" alt="Souvenir Background" class="scene-layer background-layer">
        </div>
    </div>

    <!-- Main Content Layout -->
    <div id="souvenir-page-container">
        <div class="souvenir-frame" id="souvenir-frame">
            <!-- Souvenir Info Section -->
            <div class="souvenir-info-section">
                <div class="souvenir-icon-bubble" id="souvenir-icon"></div>
                <div class="souvenir-text">
                    <h1 class="souvenir-name" id="souvenir-title">Loading...</h1>
                    <p class="souvenir-description" id="souvenir-description"></p>
                    <p class="souvenir-details" id="souvenir-details"></p>
                </div>
            </div>
            
            <!-- Tab Controls -->
            <div class="souvenir-face-controls">
                <button class="souvenir-face-btn active" data-face="events">
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span>Events</span>
                </button>
                <button class="souvenir-face-btn" data-face="keepers">
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>Keepers</span>
                </button>
                <button class="souvenir-face-btn" data-face="explore">
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon>
                    </svg>
                    <span>Explore More</span>
                </button>
            </div>
            
            <!-- Content Faces -->
            <div class="souvenir-content-faces">
                <!-- Events Face - Timeline of canon events -->
                <div class="souvenir-events-face active" id="souvenir-events-face"></div>
                
                <!-- Keepers Face - List of profile holders -->
                <div class="souvenir-keepers-face" id="souvenir-keepers-face">
                    <div class="souvenir-keepers-list" id="keepers-list"></div>
                </div>
                
                <!-- Explore Face - BouncerBox with one of each souvenir -->
                <div class="souvenir-bouncer-face" id="souvenir-bouncer-face"></div>
            </div>
        </div>
        
        <!-- Toggle Visibility Button -->
        <button class="toggle-details-btn" id="toggle-details-btn" aria-label="Toggle details visibility">
            <svg class="eye-icon eye-open" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
            <svg class="eye-icon eye-closed" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
        </button>
    </div>

    <script>
        // Get query parameter 'key'
        const params = new URLSearchParams(window.location.search);
        let souvenirKey = params.get('key') || 'residence';
        
        let allSouvenirs = {};
        let currentSouvenir = null;
        
        // Function to update URL without reloading
        function updateURL(key) {
            const url = new URL(window.location);
            url.searchParams.set('key', key);
            window.history.pushState({ souvenirKey: key }, '', url);
        }
        
        // Function to load and render a specific souvenir
        async function loadAndRenderSouvenir(key) {
            console.log('ðŸŽ [Souvenirs] Loading souvenir for key:', key);
            
            souvenirKey = key;
            currentSouvenir = allSouvenirs[souvenirKey];
            
            if (!currentSouvenir) {
                console.error('âŒ [Souvenirs] Souvenir not found:', souvenirKey);
                return;
            }
            
            // Get the souvenir frame for animation
            const souvenirFrame = document.getElementById('souvenir-frame');
            const souvenirIcon = document.getElementById('souvenir-icon');
            const souvenirInfo = document.querySelector('.souvenir-info-section');
            
            // Fade out current content
            if (souvenirFrame) {
                souvenirFrame.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                souvenirFrame.style.opacity = '0';
                souvenirFrame.style.transform = 'scale(0.98) translateY(-5px)';
            }
            
            // Wait for fade out
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // Update URL
            updateURL(souvenirKey);
            
            // Update background
            if (window.background && currentSouvenir.phanera) {
                const phaneraUrl = currentSouvenir.phanera || 'souvenirs/residence/phanera.png';
                // Use the full path for phanera
                const fullPhaneraUrl = phaneraUrl.startsWith('/') ? phaneraUrl : `/souvenirs/${souvenirKey}/phanera.png`;
                window.background.showPhaneraBackgroundUrl(fullPhaneraUrl);
            }
            
            // Render souvenir content
            renderSouvenirPage();
            
            // Fade in new content
            await new Promise(resolve => setTimeout(resolve, 50));
            if (souvenirFrame) {
                souvenirFrame.style.opacity = '1';
                souvenirFrame.style.transform = 'scale(1) translateY(0)';
            }
            
            // Add a little bounce to the icon
            if (souvenirIcon) {
                souvenirIcon.style.animation = 'none';
                setTimeout(() => {
                    souvenirIcon.style.animation = 'souvenir-pop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                }, 100);
            }
        }
        
        // Load souvenir data
        async function loadSouvenirData() {
            console.log('ðŸŽ [Souvenirs] Loading souvenir data for key:', souvenirKey);
            try {
                const response = await fetch('/api/souvenirs');
                allSouvenirs = await response.json();
                
                if (allSouvenirs[souvenirKey]) {
                    currentSouvenir = allSouvenirs[souvenirKey];
                    renderSouvenirPage();
                } else {
                    console.error('âŒ [Souvenirs] Souvenir not found:', souvenirKey);
                }
            } catch (error) {
                console.error('âŒ [Souvenirs] Error loading souvenirs:', error);
            }
        }
        
        // Handle browser back/forward buttons
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.souvenirKey) {
                loadAndRenderSouvenir(event.state.souvenirKey);
            }
        });
        
        async function renderSouvenirPage() {
            if (!currentSouvenir) return;
            
            // Background is now handled by the Background widget in souvenirs.js
            // No need to set it here
            
            // Set user color for the souvenir
            const souvenirColor = window.ColorManager?.currentColor || '#734ba1';
            document.documentElement.style.setProperty('--user-color', souvenirColor);
            
            // Render souvenir icon
            const iconBubble = document.getElementById('souvenir-icon');
            iconBubble.innerHTML = `<img src="${currentSouvenir.icon || '/assets/icon_face.png'}" alt="${currentSouvenir.name}" class="souvenir-icon">`;
            
            // Render text content
            document.getElementById('souvenir-title').textContent = currentSouvenir.name;
            document.getElementById('souvenir-description').textContent = currentSouvenir.description || '';
            
            // Render keeper count
            const keeperCount = currentSouvenir.keepers?.length || 0;
            document.getElementById('souvenir-details').textContent = getKeeperText(keeperCount, currentSouvenir.keepers);
            
            // Render event stack (Events face) - fetch ALL events with this key
            fetchEventsForKey(currentSouvenir.key).then(events => {
                const eventStack = new EventStack();
                eventStack.render(events, document.getElementById('souvenir-events-face'), {
                    colorMode: 'souvenir',
                    colorKey: currentSouvenir.key,
                    colorIntensity: 'highlight'
                });
            });
            
            // Render keepers list (Keepers face)
            renderKeepersList(currentSouvenir.keepers || []);
            
            // Initialize BouncerBox (Explore More face) - one of each souvenir type
            const bouncerContainer = document.getElementById('souvenir-bouncer-face');
            if (bouncerContainer) {
                new BouncerBox(bouncerContainer, {
                    displayMode: 'onePerType',
                    width: 470,
                    height: 272,
                    showWidget: false,
                    initialKey: souvenirKey,
                    widgetCallback: (bubble) => {
                        // Dynamically load the new souvenir without page reload
                        loadAndRenderSouvenir(bubble.key);
                        // Switch back to events tab to see the new souvenir
                        switchToFace('events');
                    }
                });
            }
        }
        
        async function fetchEventsForKey(souvenirKey) {
            try {
                const response = await fetch('/api/canon');
                const allEvents = await response.json();
                
                // Filter events that have matching key (including dream events)
                const matchingEvents = allEvents.filter(event => event.key === souvenirKey);
                
                console.log(`[Souvenirs] Found ${matchingEvents.length} events with key: ${souvenirKey}`);
                return matchingEvents;
            } catch (error) {
                console.error('[Souvenirs] Error fetching events:', error);
                return [];
            }
        }
        
        async function renderKeepersList(keepers) {
            const keepersList = document.getElementById('keepers-list');
            if (!keepersList) return;
            
            if (keepers.length === 0) {
                keepersList.innerHTML = '<div style="text-align: center; color: #999; padding: 40px; font-style: italic;">No keepers yet</div>';
                return;
            }
            
            // Fetch dreamer data for each keeper
            try {
                const response = await fetch('/api/dreamers');
                const dreamers = await response.json();
                
                const keeperItems = keepers.map(keeper => {
                    const dreamer = dreamers.find(d => d.did === keeper.did);
                    if (!dreamer) return '';
                    
                    const avatarUrl = dreamer.avatar || '/assets/icon_face.png';
                    const octant = dreamer.spectrum?.octant || 'unknown';
                    const octantClass = octant !== 'unknown' ? `octant-${octant}` : '';
                    const userColor = dreamer.color_hex || '#734ba1';
                    
                    // Get spectrum scores
                    const intentional = dreamer.spectrum?.intentional || 0;
                    const expressive = dreamer.spectrum?.expressive || 0;
                    const skeptic = dreamer.spectrum?.skeptic || 0;
                    const receptive = dreamer.spectrum?.receptive || 0;
                    const creative = dreamer.spectrum?.creative || 0;
                    const reactive = dreamer.spectrum?.reactive || 0;
                    
                    const total = Math.abs(intentional) + Math.abs(expressive) + Math.abs(skeptic) + 
                                  Math.abs(receptive) + Math.abs(creative) + Math.abs(reactive);
                    
                    const oblivionWidth = total > 0 ? (Math.abs(intentional) / total * 100) : 0;
                    const authorityWidth = total > 0 ? (Math.abs(expressive) / total * 100) : 0;
                    const skepticWidth = total > 0 ? (Math.abs(skeptic) / total * 100) : 0;
                    const receptiveWidth = total > 0 ? (Math.abs(receptive) / total * 100) : 0;
                    const libertyWidth = total > 0 ? (Math.abs(creative) / total * 100) : 0;
                    const entropyWidth = total > 0 ? (Math.abs(reactive) / total * 100) : 0;
                    
                    // Determine status
                    let status = 'Dreamer';
                    if (dreamer.known_dreamer) {
                        status = 'Known';
                    }
                    if (dreamer.status === 'resident') {
                        status = 'Resident';
                    }
                    
                    const earnedTime = timeAgo(keeper.epoch);
                    
                    return `
                        <div class="keeper-card ${octantClass}" style="--user-color: ${userColor};\" onclick="window.location.href='/dreamer?did=${encodeURIComponent(dreamer.did)}'">
                            <img src="${avatarUrl}" alt="${dreamer.name}" class="keeper-card-avatar" onerror="this.src='/assets/icon_face.png'">
                            <div class="keeper-card-info">
                                <div class="keeper-card-name">${dreamer.name}</div>
                                <div class="keeper-card-handle">@${dreamer.handle}</div>
                                ${octant !== 'unknown' ? `<div class="keeper-badge-octant octant-bg-${octant}">${octant.toUpperCase()}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                keepersList.innerHTML = keeperItems;
            } catch (error) {
                console.error('[Souvenirs] Error loading keepers:', error);
                keepersList.innerHTML = '<div style="text-align: center; color: #d9534f; padding: 40px;">Failed to load keepers</div>';
            }
        }
        
        function getKeeperText(count, keepers) {
            if (count === 0) return "no keepers";
            
            // Use NumNom utility for number to word conversion
            const numberToWord = window.NumNom?.numberToWord || ((n) => n.toString());
            
            const nominativeCall = (num) => {
                if (num === 0) return "zero keepers";
                if (num === 1) return "one keeper";
                return `${numberToWord(num)} keepers`;
            };
            
            // Get earliest keeper timestamp
            if (keepers && keepers.length > 0) {
                const earliestEpoch = Math.min(...keepers.map(k => k.epoch));
                const timeText = timeAgo(earliestEpoch);
                const nomCall = nominativeCall(count);
                return `${nomCall} of ${timeText}`;
            }
            
            return nominativeCall(count);
        }
        
        function timeAgo(timestamp) {
            const now = Date.now() / 1000;
            const diff = now - timestamp;
            const days = Math.floor(diff / (24 * 60 * 60));
            
            if (days <= 45) return "about a month";
            if (days <= 60) return "two months";
            if (days <= 90) return "some months";
            
            const months = Math.floor(days / 30);
            if (months < 12) return `${months} months`;
            
            const years = Math.floor(days / 365);
            return years === 1 ? "about a year" : `about ${years} years`;
        }
        
        // Initialize on load
        window.addEventListener('load', async () => {
            console.log('ðŸŽ [Souvenirs] Page fully loaded...');
        });
        
        // Initialize souvenir data on DOM ready
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸŽ [Souvenirs] DOM ready, starting load...');
            
            loadSouvenirData();
            
            // Setup toggle button
            const toggleBtn = document.getElementById('toggle-details-btn');
            const souvenirFrame = document.getElementById('souvenir-frame');
            let isVisible = true;
            
            toggleBtn.addEventListener('click', () => {
                isVisible = !isVisible;
                
                if (isVisible) {
                    souvenirFrame.classList.remove('hidden');
                    toggleBtn.classList.remove('details-hidden');
                } else {
                    souvenirFrame.classList.add('hidden');
                    toggleBtn.classList.add('details-hidden');
                }
            });
            
            // Setup tab switching
            const tabButtons = document.querySelectorAll('.souvenir-face-btn');
            const eventsFace = document.getElementById('souvenir-events-face');
            const keepersFace = document.getElementById('souvenir-keepers-face');
            const bouncerFace = document.getElementById('souvenir-bouncer-face');
            
            // Restore last selected tab from localStorage
            const lastSelectedFace = localStorage.getItem('souvenir-selected-face') || 'events';
            console.log('ðŸŽ [Souvenirs] Restoring tab:', lastSelectedFace);
            
            // Function to switch to a specific face
            function switchToFace(face) {
                // Update button states
                tabButtons.forEach(b => b.classList.remove('active'));
                const targetBtn = document.querySelector(`.souvenir-face-btn[data-face="${face}"]`);
                if (targetBtn) targetBtn.classList.add('active');
                
                // Fade out all faces first
                eventsFace.classList.remove('active');
                keepersFace.classList.remove('active');
                bouncerFace.classList.remove('active');
                
                // Small delay for smooth transition, then fade in target
                setTimeout(() => {
                    if (face === 'events') {
                        eventsFace.classList.add('active');
                    } else if (face === 'keepers') {
                        keepersFace.classList.add('active');
                    } else if (face === 'explore') {
                        bouncerFace.classList.add('active');
                    }
                }, 50);
                
                // Save selection to localStorage
                localStorage.setItem('souvenir-selected-face', face);
            }
            
            // Restore the last selected face on load
            switchToFace(lastSelectedFace);
            
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const face = btn.dataset.face;
                    switchToFace(face);
                });
            });
        });
    </script>
</body>
</html>
