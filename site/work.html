<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/">
    <title>Reverie House ‚Äî Workshop</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Become a self-appointed worker at Reverie House by taking on a role that will help its survival or enrich our wild mindscape. Retire whenever you please!">
    <meta name="keywords" content="workshop, creative writing, collaboration, worldbuilding, storytelling, reverie house">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://reverie.house/work.html">
    <meta property="og:title" content="Workshop - Reverie House">
    <meta property="og:description" content="Become a self-appointed worker at Reverie House by taking on a role that will enrich our wild mindscape.">
    <meta property="og:image" content="https://reverie.house/assets/og-image.png">
    <meta property="og:site_name" content="Reverie House">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Workshop - Reverie House">
    <meta name="twitter:description" content="Become a self-appointed worker at Reverie House by taking on a role that will help its survival or enrich our wild mindscape. Retire whenever you please!">
    <meta name="twitter:image" content="https://reverie.house/assets/og-image.png">
    
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/heraldry.css">
    <link rel="stylesheet" href="/css/pages/work.css">
    <link rel="stylesheet" href="/css/pages/dreamer.css">
    <link rel="stylesheet" href="/css/pages/database.css">
    <link rel="stylesheet" href="/css/widgets/login.css">
    <link rel="stylesheet" href="/css/widgets/createdreamer.css">
    <link rel="stylesheet" href="/css/widgets/dialogue.css">
    <link rel="stylesheet" href="/css/widgets/dreamer-hover.css">
    <link rel="stylesheet" href="/css/widgets/showdreamer.css">
    <link rel="stylesheet" href="/css/color-rows.css">
    <link rel="preload" href="/css/octants.css" as="style">
    <link rel="preload" href="/css/roles.css" as="style">
    <link rel="preload" href="/css/souvenirs.css" as="style">
    <link rel="stylesheet" href="/css/octants.css">
    <link rel="stylesheet" href="/css/roles.css">
    <link rel="stylesheet" href="/css/souvenirs.css">
    
    <!-- Favicon and Icons -->
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    
    <!-- Core utilities -->
    <script src="/js/core/world-config-cache.js"></script>
    <script src="/js/core/color-manager.js"></script>
    <script src="/js/core/rowstyle-registry.js?v=1765642342"></script>
    <script src="/js/core/rowstyle-engine.js"></script>
    <script src="/js/utils/shadowbox.js"></script>
    <script src="/js/utils/heraldry.js"></script>
    <script src="/js/widgets/showdreamer.js"></script>
    <script src="/js/widgets/showpost.js"></script>
    <script src="/js/widgets/background.js"></script>
    <script src="/js/widgets/bubble.js"></script>
    
    <!-- Work utilities -->
    <script src="/js/utils/work-api.js"></script>
    <script src="/js/utils/work-events.js"></script>
    
    <!-- Work widgets -->
    <script type="module" src="/js/widgets/spectrumpreview.js?v=1763454411"></script>
    <script src="/js/widgets/eventstack.js?v=1765642847"></script>
    
    <!-- Header and drawer widgets -->
    <script src="/js/widgets/header.js" defer></script>
    <script type="module" src="/js/widgets/oauth-manager.js"></script>
    <script src="/js/widgets/login.js" defer></script>
    <script src="/js/widgets/createdreamer.js" defer></script>
    <script src="/js/widgets/drawer.js" defer></script>
    <script src="/js/widgets/konami.js" defer></script>
    <script src="/js/widgets/dreamer-hover.js" defer></script>
    <script src="/js/widgets/wink.js" defer></script>
    <script src="/js/widgets/stepdown.js" defer></script>
    <script src="/js/widgets/upload_avatar.js" defer onerror="console.error('Failed to load upload_avatar.js')"></script>
    <script src="/js/widgets/apppassreq.js" defer></script>
</head>
<body>
    <div id="header-container"></div>

    <!-- Full-Screen Background Scene -->
    <div class="fullscreen-background">
        <div class="scene-background">
            <img src="souvenirs/residence/phanera.png" alt="Phanera Residence" class="scene-layer background-layer">
        </div>
    </div>

    <!-- Main Content -->
    <div class="work-page-container">
        <!-- Left Sidebar -->
        <div class="work-sidebar">
            <!-- Header Section -->
            <div class="sidebar-header">
                <img src="/assets/logo.png" alt="Reverie House Logo" class="sidebar-logo">
                <div class="sidebar-title">
                    <img src="/assets/icon.png" alt="" class="title-icon">
                    <h1>WORKSHOP</h1>
                    <img src="/assets/icon_face.png" alt="" class="title-icon">
                </div>
                <p class="sidebar-subtitle">Do those for which you care.</p>
            </div>

            <!-- User Status Section -->
            <div id="sidebar-user-section" class="sidebar-user-section">
                <!-- Loading State -->
                <div id="sidebar-loading" class="sidebar-loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Checking session...</div>
                </div>

                <!-- Guest State -->
                <div id="sidebar-guest" class="sidebar-guest" style="display: none;">
                    <div class="guest-message">
                        <p>Login to take on work</p>
                    </div>
                    <button class="sidebar-login-btn" onclick="triggerLogin()">
                        Dreamweaver Login
                    </button>
                </div>

                <!-- User Logged In -->
                <div id="sidebar-user" class="sidebar-user" style="display: none;">
                    <div class="sidebar-avatar-container">
                        <img id="sidebar-avatar" src="/assets/icon_face.png" alt="Avatar" class="sidebar-avatar">
                    </div>
                    <div class="sidebar-user-info">
                        <div id="sidebar-user-name" class="sidebar-user-name">Loading...</div>
                        <div id="sidebar-user-handle" class="sidebar-user-handle">@...</div>
                    </div>
                    <!-- Work Status -->
                    <div class="sidebar-work-status">
                        <div class="status-label">Work Status</div>
                        <div id="sidebar-status-content" class="status-content">
                            <span class="status-badge not-working">DREAMWEAVER</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Work Philosophy -->
            <div class="sidebar-philosophy">
                <p>There are no jobs, no managers, no orders.</p>
                <p>Yet, there are always things needing done.</p>
                <p>Work is self-assigned and voluntary.</p>
                <p>You may step down or retire as you please.</p>
            </div>
        </div>

        <!-- Right Content Area -->
        <div class="work-content">
            <!-- Role Content Card -->
            <div class="role-card">
                <!-- Role Tabs (moved inside card) -->
                <div class="role-tabs">
                    <button class="role-tab active" data-role="greeter" onclick="selectRole('greeter')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="role-tab-icon">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <span class="role-tab-name">Greeter</span>
                    </button>
                    <button class="role-tab" data-role="mapper" onclick="selectRole('mapper')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="role-tab-icon">
                            <circle cx="12" cy="12" r="10"/>
                            <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>
                        </svg>
                        <span class="role-tab-name">Mapper</span>
                    </button>
                    <button class="role-tab" data-role="cogitarian" onclick="selectRole('cogitarian')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="role-tab-icon">
                            <path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"></path>
                            <path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"></path>
                        </svg>
                        <span class="role-tab-name">Cogitarian</span>
                    </button>
                    <button class="role-tab" data-role="provisioner" onclick="selectRole('provisioner')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="role-tab-icon">
                            <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path>
                            <path d="M7 2v20"></path>
                            <path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path>
                        </svg>
                        <span class="role-tab-name">Provisioner</span>
                    </button>
                </div>

                <!-- Mobile Role Selector -->
                <div class="role-selector-mobile">
                    <select id="role-selector-mobile" onchange="selectRole(this.value)">
                        <option value="greeter" selected>Greeter</option>
                        <option value="mapper">Mapper</option>
                        <option value="cogitarian">Cogitarian</option>
                        <option value="provisioner">Provisioner</option>
                    </select>
                </div>

                <!-- Role Card Body -->
                <div class="role-card-body">
                    <!-- Left: Role Title & Description -->
                    <div class="role-main-section">
                        <h2 class="role-title" id="role-title">Greeter of Reveries</h2>
                        
                        <!-- Greeter Description (default) -->
                        <div id="greeter-description" class="role-desc-content">
                            <p class="role-description">
                                Newcomers to <b>Reverie House</b> often need someone to show them the way, and a <b>Greeter</b> is usually the one to do it. It doesn't take much, but when someone new arrives they'll have <u><span id="you-link">you</span></u> to introduce and guide them.
                            </p>
                            <p class="role-description">
                                As <b>Greeter</b> you will automatically provide newcomers with their name, and offer them a friendly human hand to help them, should they need one.
                            </p>
                        </div>

                        <!-- Cogitarian Description -->
                        <div id="cogitarian-description" class="role-desc-content" style="display: none;">
                            <p class="role-description">
                                Our <b>Cogitarian</b> is a humanizing authority who helps codify human elements within our shared technical foundation and help deter dehumanizations.
                            </p>
                            <p class="role-description">
                                You will work closely with the current <b>Keeper(s)</b> to take responsibility for defining the immutably human aspects of our environment, in effort to keep our wild mindscape a more dependable place for real <span onclick="window.wink && window.wink(event)" style="cursor: pointer;">dreamrs</span>.
                            </p>
                        </div>
                        
                        <!-- Mapper Description -->
                        <div id="mapper-description" class="role-desc-content" style="display: none;">
                            <p class="role-description">
                                Every dream exists somewhere on a complex spectrum that can be measured. Knowing these coordinates can be incredibly helpful for dreamweavers looking to find (or avoid) particular reveries and nightmares.
                            </p>
                            <p class="role-description">
                                As <b>Spectrum Mapper</b> you will automatically reply the origin coordinates for all dreamers who reveal their beginnings within our wild mindscape.
                            </p>
                        </div>
                        
                        <!-- Provisioner Description -->
                        <div id="provisioner-description" class="role-desc-content" style="display: none;">
                            <p class="role-description">
                                Provisioners are dreamweavers who understand that ease of rest in the waking world eases all manner of dreams across our wild mindscape.
                            </p>
                            <p class="role-description">
                                When another dreamer at <b>Reverie House</b> feels the real pangs of hunger, it is <b>Head of Pantry</b> who will remotely try to ease their burden with food.
                            </p>
                        </div>
                    </div>

                    <!-- Right: Current Worker Card -->
                    <div class="role-worker-card">
                        <div class="worker-card-header">
                            <span class="worker-label" id="worker-label">CURRENT HOLDER</span>
                        </div>
                        <div id="worker-display" class="worker-details">
                            <span style="color: #999; font-style: italic; font-size: 0.8rem;">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Role Separator -->
                <hr class="role-separator">
                
                <!-- Mapper Content Section -->
                <div id="mapper-content-section" class="mapper-content-container" style="display: none;">
                    <!-- Two-column mapper layout: left (40%) with calculator, right (60%) empty reserved column -->
                    <div class="mapper-columns">
                        <div class="mapper-column-left">
                            <!-- Origin Calculator -->
                            <div id="spectrum-preview-container"></div>
                        </div>
                        <div class="mapper-column-right">
                            <!-- Reserved empty column for future controls / form -->
                            <!-- Persistent preview frame (empty until image is generated) -->
                            <div class="origin-preview-box placeholder">
                                <div class="origin-preview-inner">
                                        <div class="origin-preview-media">
                                            <div class="origin-preview-empty">No preview yet</div>
                                        </div>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Role-specific content area -->
                <div class="role-content-area">
                    <!-- Greeter Event Stack Section -->
                    <div id="greeter-eventstack-section" class="greeter-eventstack-container">
                        <div class="greeter-content-grid">
                            <!-- Left: Event Stack -->
                            <div class="greeter-eventstack-section">
                                <h3 class="eventstack-title">Greeter's Guestbook</h3>
                                <div id="greeter-eventstack" class="greeter-eventstack"></div>
                            </div>
                            
                            <!-- Right: Greetings and Intro -->
                            <div class="greeter-right-section">
                                <!-- Current Greetings -->
                                <div class="greeter-examples-carousel">
                                    <div class="example-nav">
                                        <button class="example-nav-btn" onclick="previousGreeting()">‚Äπ</button>
                                        <div class="example-label">Current Greetings</div>
                                        <button class="example-nav-btn" onclick="nextGreeting()">‚Ä∫</button>
                                    </div>
                                    <div id="greeter-greetings-display" class="greetings-display">
                                        <div class="greeting-text">Loading greetings...</div>
                                    </div>
                                </div>
                                
                                <!-- Introduce Yourself Section -->
                                <div class="introduce-section">
                                    <div class="introduce-header">
                                        Are you a dreamweaver?
                                    </div>
                                    <button class="introduce-btn" onclick="window.open('https://bsky.app/profile/reverie.house/post/3lljjzcydwc25', '_blank')">Introduce Yourself</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Cogitarian Content Section -->
                <div id="cogitarian-content-section" class="cogitarian-content-container" style="display: none;">
                    <div class="cogitarian-content-grid">
                        <!-- Left: Repo Card -->
                        <div class="repo-card">
                            <div class="repo-card-header">
                                <div class="repo-card-title">Keeper's Repository</div>
                            </div>
                            <div class="repo-card-actions">
                                <a href="https://github.com/errantson/reverie" target="_blank" class="repo-action-btn repo-btn-primary">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                                    </svg>
                                    View Repository
                                </a>
                                <a href="https://github.com/errantson/reverie/issues" target="_blank" class="repo-action-btn">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="8" x2="12" y2="12"></line>
                                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                    </svg>
                                    Issues
                                </a>
                                <a href="https://github.com/errantson/reverie/blob/main/CONTRIBUTING.md" target="_blank" class="repo-action-btn">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="18" cy="18" r="3"></circle>
                                        <circle cx="6" cy="6" r="3"></circle>
                                        <path d="M13 6h3a2 2 0 0 1 2 2v7"></path>
                                        <line x1="6" y1="9" x2="6" y2="21"></line>
                                    </svg>
                                    Contribution Guide
                                </a>
                                
                            </div>
                            <div id="repo-info" class="repo-info">
                                <div class="repo-info-item">
                                    <span class="repo-info-label">Languages:</span>
                                    <span class="repo-info-value">Loading...</span>
                                </div>
                                <div class="repo-info-item">
                                    <span class="repo-info-label">Updated:</span>
                                    <span class="repo-info-value">Loading...</span>
                                </div>
                                <div class="repo-info-item">
                                    <span class="repo-info-label">Watchers:</span>
                                    <span class="repo-info-value">Loading...</span>
                                </div>
                                <div class="repo-info-item">
                                    <span class="repo-info-label">File Size:</span>
                                    <span class="repo-info-value">Loading...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right: Commit History -->
                        <div class="repo-data-box">
                            <h3 class="repo-data-header">History of Improvement</h3>
                            <div id="repo-data-content" class="repo-data-content">
                                <div class="commits-section">
                                    <div class="commit-row loading-placeholder">
                                        <span class="commit-message">Loading...</span>
                                        <span class="commit-meta">...</span>
                                    </div>
                                    <div class="commit-row loading-placeholder">
                                        <span class="commit-message">Loading...</span>
                                        <span class="commit-meta">...</span>
                                    </div>
                                    <div class="commit-row loading-placeholder">
                                        <span class="commit-message">Loading...</span>
                                        <span class="commit-meta">...</span>
                                    </div>
                                    <div class="commit-row loading-placeholder">
                                        <span class="commit-message">Loading...</span>
                                        <span class="commit-meta">...</span>
                                    </div>
                                    <div class="commit-row loading-placeholder">
                                        <span class="commit-message">Loading...</span>
                                        <span class="commit-meta">...</span>
                                    </div>
                                </div>
                                <div class="contributors-section">
                                    <div class="contributors-label">Contributors</div>
                                    <div class="contributors-list">...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Provisioner Content Section -->
                <div id="provisioner-content-section" class="provisioner-content-container" style="display: none;">
                    <div class="provisioner-content-grid">
                        <!-- Left Box -->
                        <div class="provisioner-box">
                            <h3 class="provisioner-box-title">Feeding Dreamweavers</h3>
                            <p class="provisioner-box-text">
                                If you are a hungry dreamweaver and having some free food would help you dream better, then let our <b>Head of Pantry</b> know and they will try to arrange you a free food pickup through <a href="http://toogoodtogo.com">TooGoodToGo</a></b>
                            </p>
                            <p class="provisioner-box-text">
                                <i>Most pickups will be for next-day.</i>
                            </p>
                            <button class="provisioner-box-button" onclick="requestFoodPickup()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                                Request Food Pickup
                            </button>
                        </div>
                        
                        <!-- Right Box -->
                        <div class="provisioner-box">
                            <h3 class="provisioner-box-title">Being Provisioner</h3>
                            <p class="provisioner-box-text">
                                This is an experiment in effective altruism. Please accept that this is a human relationship, and both parties will need to be available to communicate.<br>
                                <i>Everyone will do their best!</i>
                            </p>
                            <p class="provisioner-box-text">
                                If you need reliable or long-term assistance, seek food banks or programs in your area.
                            </p>
                            <button class="provisioner-box-button" onclick="window.open('https://www.feedingamerica.org/find-your-local-foodbank/all-food-banks', '_blank')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                Food Banks
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- City Input Modal -->
    <div id="cityInputModal" class="modal">
        <div class="modal-content city-modal-content">
            <div class="city-modal-title">Request Food Pickup</div>
            
            <div class="city-modal-header">
                <span class="city-modal-label">Current City:</span>
                <input type="text" id="cityInput" placeholder="Toronto, New York, London..." autocomplete="off">
            </div>
            
            <div class="city-modal-preview">
                <div class="preview-label">Message Preview:</div>
                <div id="messagePreview" class="preview-text">
                    Hey @<span class="preview-handle">provisioner</span>, if you're around to help, I'm in <span class="preview-city">...</span> and could use some free food whenever it's available. Thanks in advance!
                </div>
            </div>
            
            <div class="city-modal-actions">
                <button class="city-modal-btn city-send-btn" onclick="submitCityAndSendRequest()">
                    Send Request
                </button>
                <button class="city-modal-btn city-cancel-btn" onclick="closeCityModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Confirming your status...</div>
        </div>
    </div>

    <!-- Work sidebar extension script -->
    <script src="/js/pages/work.js" defer></script>

    <script>
        let currentSession = null;
        let roleStatuses = {
            greeter: null,
            mapper: null,
            cogitarian: null,
            provisioner: null
        };
        let currentTab = 'greeter';
        let spectrumPreviewWidget = null; // Global spectrum preview widget instance
        
        // Restore tab from localStorage on page load
        const savedTab = localStorage.getItem('work_current_tab');
        if (savedTab && ['greeter', 'mapper', 'cogitarian'].includes(savedTab)) {
            currentTab = savedTab;
        }
        let currentRole = 'greeter'; // Track selected role
        let sessionCheckComplete = false;
        let isInitializing = false; // Prevent duplicate initialization
        let profileLoaded = false; // Track if profile is ready

        // Hide provisioner UI unless user is an admin (admin login stores `admin_token` in localStorage).
        function enforceProvisionerVisibility() {
            const hasAdmin = !!localStorage.getItem('admin_token');
            const provButton = document.querySelector('.role-tab[data-role="provisioner"]');
            const provOption = document.querySelector('#role-selector-mobile option[value="provisioner"]');
            const provContent = document.getElementById('provisioner-content-section');
            const provDesc = document.getElementById('provisioner-description');

            if (!hasAdmin) {
                if (provButton) provButton.style.display = 'none';
                if (provOption) provOption.remove();
                if (provContent) provContent.style.display = 'none';
                if (provDesc) provDesc.style.display = 'none';
                if (currentRole === 'provisioner') {
                    // fallback to greeter if provisioner was selected
                    selectRole('greeter');
                }
            } else {
                if (provButton) provButton.style.display = '';
                // Ensure the mobile selector has the option (if it was removed earlier)
                if (provOption === null) {
                    const mobileSelector = document.getElementById('role-selector-mobile');
                    if (mobileSelector) {
                        const exists = Array.from(mobileSelector.options).some(o => o.value === 'provisioner');
                        if (!exists) {
                            const opt = document.createElement('option');
                            opt.value = 'provisioner';
                            opt.text = 'Provisioner';
                            mobileSelector.appendChild(opt);
                        }
                    }
                }
            }
        }

        // React to cross-tab changes and OAuth profile events
        window.addEventListener('storage', (ev) => {
            if (ev.key === 'admin_token') enforceProvisionerVisibility();
        });
        window.addEventListener('oauth:profile-loaded', () => enforceProvisionerVisibility());
        // Run once at load
        enforceProvisionerVisibility();

        // Role selection function
        function selectRole(role) {
            currentRole = role;
            
            // Set data attribute on body for CSS role-specific styling
            document.body.setAttribute('data-current-role', role);
            
            // Save current role to localStorage
            localStorage.setItem('work_current_tab', role);
            
            // Update tab button states
            document.querySelectorAll('.role-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeButton = document.querySelector(`.role-tab[data-role="${role}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Update dropdown value (mobile)
            const mobileSelector = document.getElementById('role-selector-mobile');
            if (mobileSelector) {
                mobileSelector.value = role;
            }
            
            // Update role content with context-aware descriptions
            document.querySelectorAll('.role-desc-content').forEach(desc => {
                desc.style.display = 'none';
            });
            
            const descriptionDiv = document.getElementById(`${role}-description`);
            descriptionDiv.style.display = 'block';
            
            // Update title
            // Update title from roleConfigs
            const config = roleConfigs[role];
            document.getElementById('role-title').textContent = config ? config.title : role;
            
            // Update worker label
            const labels = {
                'greeter': 'CURRENT GREETER:',
                'mapper': 'CURRENT MAPPER:',
                'cogitarian': 'CURRENT COGITARIAN:',
                'provisioner': 'CURRENT PROVISIONER:'
            };
            document.getElementById('worker-label').textContent = labels[role];
            
            // Update current worker display based on role
            if (role === 'cogitarian') {
                // Load role status for cogitarian
                loadRoleStatus(role);
                // Hide spectrum preview widget for cogitarian
                hideSpectrumPreview();
                // Hide eventstack for cogitarian
                hideEventStack();
                // Hide mapper content for cogitarian
                hideMapperContent();
                // Hide provisioner content for cogitarian
                hideProvisionerContent();
                // Show cogitarian content
                showCogitarianContent();
            } else if (role === 'mapper') {
                // Load role status for mapper and THEN update spectrum preview
                loadRoleStatus(role).then(() => {
                    // After role status is loaded, update spectrum preview with correct mapper status
                    updateSpectrumPreview(role);
                });
                // Generate random origin coordinates
                updateOriginCoordinateExample();
                // Hide eventstack for mapper
                hideEventStack();
                // Hide cogitarian content for mapper
                hideCogitarianContent();
                // Hide provisioner content for mapper
                hideProvisionerContent();
                // Show mapper content
                showMapperContent();
            } else if (role === 'greeter') {
                // Load role status for greeter
                loadRoleStatus(role);
                // Load greeting events for eventstack
                loadGreetingEvents();
                // Show eventstack for greeter
                showEventStack();
                // Hide spectrum preview widget for greeter
                hideSpectrumPreview();
                // Hide mapper content for greeter
                hideMapperContent();
                // Hide cogitarian content for greeter
                hideCogitarianContent();
                // Hide provisioner content for greeter
                hideProvisionerContent();
            } else if (role === 'provisioner') {
                // Load role status for provisioner
                loadRoleStatus(role);
                // Hide all role-specific content for provisioner
                hideEventStack();
                hideSpectrumPreview();
                hideMapperContent();
                hideCogitarianContent();
                // Show provisioner content
                showProvisionerContent();
                // Populate food request form with user data
                populateFoodRequestForm();
            } else {
                // Load role status for the selected role
                loadRoleStatus(role);
                // Hide spectrum preview widget for non-mapper roles
                hideSpectrumPreview();
                // Hide eventstack for other roles
                hideEventStack();
            }
            
            // Update modal and actions based on role
            updateRoleActions(role);
            
            // Update the bottom volunteer card to reflect the selected role
            updateUI();
        }
        
        // Generate random origin coordinates
        function updateOriginCoordinateExample() {
            const coordinateElement = document.getElementById('origin-coordinate-example');
            if (coordinateElement) {
                const O = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                const A = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                const S = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                const R = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                const L = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                const E = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                coordinateElement.textContent = `O${O} A${A} S${S} R${R} L${L} E${E}`;
            }
        }
        
        // Spectrum Preview Widget Management
        function updateSpectrumPreview(role) {
            if (role !== 'mapper') {
                hideSpectrumPreview();
                return;
            }
            
            const container = document.getElementById('spectrum-preview-container');
            const mapperSection = document.getElementById('mapper-content-section');
            if (!container) return;
            
            // Always enable the calculator (removed mapper check)
            const hasActiveMapper = true;
            
            console.log('üîç [SPECTRUM] updateSpectrumPreview called');
            console.log('üîç [SPECTRUM] hasActiveMapper:', hasActiveMapper);
            
            // Initialize widget if not already created
            if (!spectrumPreviewWidget && window.SpectrumPreview) {
                spectrumPreviewWidget = new window.SpectrumPreview(container, {
                    isMapper: hasActiveMapper
                });
            } else if (spectrumPreviewWidget) {
                // Update mapper status if widget exists
                spectrumPreviewWidget.setMapperStatus(hasActiveMapper);
            } else {
                // SpectrumPreview not loaded yet, try again after delay
                setTimeout(() => updateSpectrumPreview(role), 200);
                return;
            }
            
            // Show the mapper content section
            if (mapperSection) {
                mapperSection.style.display = 'block';
            }
        }
        
        function hideSpectrumPreview() {
            const mapperSection = document.getElementById('mapper-content-section');
            if (mapperSection) {
                mapperSection.style.display = 'none';
            }
        }
        
        function showEventStack() {
            const container = document.getElementById('greeter-eventstack-section');
            if (container) {
                container.style.display = 'block';
            }
        }
        
        function hideEventStack() {
            const container = document.getElementById('greeter-eventstack-section');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        function showMapperContent() {
            const container = document.getElementById('mapper-content-section');
            if (container) {
                container.style.display = 'block';
            }
        }
        
        function hideMapperContent() {
            const container = document.getElementById('mapper-content-section');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        function showCogitarianContent() {
            const container = document.getElementById('cogitarian-content-section');
            if (container) {
                container.style.display = 'block';
                // Load repo data when showing
                loadRepoData();
            }
        }
        
        function hideCogitarianContent() {
            const container = document.getElementById('cogitarian-content-section');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        function showProvisionerContent() {
            const container = document.getElementById('provisioner-content-section');
            if (container) {
                container.style.display = 'block';
            }
        }
        
        function hideProvisionerContent() {
            const container = document.getElementById('provisioner-content-section');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        function populateFoodRequestForm() {
            const userDisplay = document.getElementById('food-request-user-display');
            if (!userDisplay) return;
            
            if (!currentSession || !currentSession.profile) {
                // Logged out state - show placeholder
                userDisplay.innerHTML = `
                    <div class="user-display-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="user-display-info">
                        <div class="user-display-name">Not logged in</div>
                        <div class="user-display-handle"></div>
                    </div>
                `;
                return;
            }
            
            // Logged in state - show avatar and profile info
            const profile = currentSession.profile;
            const displayName = profile.displayName || profile.handle || 'Anonymous';
            const handle = profile.handle || '';
            const avatar = profile.avatar || '';
            
            let avatarHTML;
            if (avatar) {
                avatarHTML = `<img src="${avatar}" alt="${displayName}">`;
            } else {
                avatarHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                `;
            }
            
            userDisplay.innerHTML = `
                <div class="user-display-icon">
                    ${avatarHTML}
                </div>
                <div class="user-display-info">
                    <div class="user-display-name">${displayName}</div>
                    <div class="user-display-handle">${handle ? '@' + handle : ''}</div>
                </div>
            `;
        }
        
        // Store provisioner DID for the modal
        let pendingRequestProvisionerDid = null;
        
        async function requestFoodPickup() {
            console.log('üçΩÔ∏è [Provisioner] Request food pickup clicked');
            
            // Check if user is logged in
            if (!currentSession || !currentSession.profile) {
                showCelebration('Please log in to request', 'error');
                return;
            }
            
            // Check if there's an active provisioner
            const provisionerStatus = roleStatuses.provisioner;
            if (!provisionerStatus || !provisionerStatus.current_worker) {
                showCelebration('There is currently no active Head of Pantry.\n\nPlease check back later or volunteer for the role yourself!', 'error');
                return;
            }
            
            // Get current provisioner DID
            const provisionerDid = provisionerStatus.current_worker.did;
            const userDid = currentSession.sub || currentSession.did;
            
            // Don't allow provisioner to request from themselves
            if (provisionerDid === userDid) {
                showCelebration('You cannot request food from yourself!\n\nStep down as provisioner first if you need assistance.', 'error');
                return;
            }
            
            // Check if user has stored app password for DM access
            let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
            if (!token && currentSession && currentSession.accessJwt) {
                token = currentSession.accessJwt;
            }
            
            if (!token) {
                console.error('‚ùå [Food Request] No authentication token found');
                console.error('   - oauth_token:', localStorage.getItem('oauth_token') ? 'exists' : 'missing');
                console.error('   - admin_token:', localStorage.getItem('admin_token') ? 'exists' : 'missing');
                console.error('   - currentSession:', currentSession ? 'exists' : 'missing');
                showCelebration('Session expired - please refresh and try again', 'error');
                return;
            }
            
            console.log('üîê [Food Request] Using token:', token.substring(0, 20) + '...');
            
            const headers = { 'Authorization': `Bearer ${token}` };
            
            try {
                console.log('üîç [Food Request] Checking for stored app password...');
                console.log('   - Endpoint: /api/user/credentials/status');
                console.log('   - Headers:', JSON.stringify(headers));
                
                const credResponse = await fetch('/api/user/credentials/status', { headers });
                
                console.log('üìä [Food Request] Credentials check response:', credResponse.status, credResponse.statusText);
                console.log('   - OK:', credResponse.ok);
                console.log('   - Headers:', Object.fromEntries(credResponse.headers.entries()));
                
                if (credResponse.ok) {
                    const credData = await credResponse.json();
                    console.log('üìä [Food Request] Credentials data received:');
                    console.log('   - Full response:', JSON.stringify(credData, null, 2));
                    console.log('   - connected field:', credData.connected, '(type:', typeof credData.connected, ')');
                    console.log('   - valid field:', credData.valid, '(type:', typeof credData.valid, ')');
                    
                    // Check if user has valid credentials stored
                    if (credData && (credData.connected === true || credData.valid === true)) {
                        console.log('‚úÖ [Food Request] User has stored credentials, proceeding with city modal');
                        console.log('   - Storing provisioner DID:', provisionerDid);
                        // User has credentials, proceed with city modal
                        pendingRequestProvisionerDid = provisionerDid;
                        showCityModal();
                    } else {
                        console.log('‚ö†Ô∏è [Food Request] No stored credentials found, showing app password widget');
                        console.log('   - connected:', credData?.connected);
                        console.log('   - valid:', credData?.valid);
                        console.log('   - Full data:', JSON.stringify(credData));
                        // No credentials, show app password widget
                        showAppPasswordWidgetForFoodRequest(provisionerDid);
                    }
                } else {
                    console.error('‚ùå [Food Request] Credentials check failed');
                    console.error('   - Status:', credResponse.status, credResponse.statusText);
                    const errorText = await credResponse.text();
                    console.error('   - Error response:', errorText);
                    console.error('   - Falling back to app password widget');
                    showAppPasswordWidgetForFoodRequest(provisionerDid);
                }
            } catch (error) {
                console.error('‚ùå [Food Request] Exception during credential check');
                console.error('   - Error type:', error.constructor.name);
                console.error('   - Error message:', error.message);
                console.error('   - Stack trace:', error.stack);
                showAppPasswordWidgetForFoodRequest(provisionerDid);
            }
        }
        
        function showAppPasswordWidgetForFoodRequest(provisionerDid) {
            console.log('üîë [App Password Widget] Initializing for food request');
            console.log('   - Provisioner DID:', provisionerDid);
            console.log('   - Widget available:', !!window.appPasswordRequest);
            
            if (!window.appPasswordRequest) {
                console.error('‚ùå [App Password Widget] AppPasswordRequest widget not loaded');
                console.error('   - window.appPasswordRequest:', window.appPasswordRequest);
                console.error('   - Available window properties:', Object.keys(window).filter(k => k.includes('app') || k.includes('password')));
                showCelebration('Widget not loaded - please refresh the page', 'error');
                return;
            }
            
            console.log('üìù [App Password Widget] Showing widget with config:');
            const config = {
                title: 'Enable Direct Messages',
                description: 'To request food from the Head of Pantry, you need to create an app password that allows sending direct messages on Bluesky.',
                featureName: 'food requests',
                roleColor: 'provisioner'
            };
            console.log('   - Config:', JSON.stringify(config, null, 2));
            
            window.appPasswordRequest.show(config, async (appPassword) => {
                console.log('üîë [App Password Widget] App password received from widget');
                console.log('   - Password length:', appPassword ? appPassword.length : 'null');
                console.log('   - Password format:', appPassword ? appPassword.substring(0, 4) + '-****-****-****' : 'null');
                
                // Store the credentials
                try {
                    let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                    if (!token && currentSession && currentSession.accessJwt) {
                        token = currentSession.accessJwt;
                    }
                    
                    console.log('üîê [App Password Widget] Retrieved auth token for storage');
                    console.log('   - Token source:', localStorage.getItem('oauth_token') ? 'oauth_token' : 
                                                      localStorage.getItem('admin_token') ? 'admin_token' : 
                                                      'currentSession.accessJwt');
                    console.log('   - Token preview:', token ? token.substring(0, 20) + '...' : 'null');
                    
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    };
                    
                    console.log('üì§ [App Password Widget] Sending credential storage request');
                    console.log('   - Endpoint: POST /api/user/credentials/connect');
                    console.log('   - Headers:', JSON.stringify(headers));
                    console.log('   - Body: { app_password: "****-****-****-****" }');
                    
                    const response = await fetch('/api/user/credentials/connect', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ app_password: appPassword })
                    });
                    
                    console.log('üì® [App Password Widget] Storage response received');
                    console.log('   - Status:', response.status, response.statusText);
                    console.log('   - OK:', response.ok);
                    
                    if (response.ok) {
                        const responseData = await response.json();
                        console.log('‚úÖ [App Password Widget] Credentials stored successfully');
                        console.log('   - Response data:', JSON.stringify(responseData, null, 2));
                        console.log('   - Now proceeding with food request modal');
                        console.log('   - Setting pendingRequestProvisionerDid to:', provisionerDid);
                        
                        // Now proceed with the food request
                        pendingRequestProvisionerDid = provisionerDid;
                        showCityModal();
                    } else {
                        const error = await response.json();
                        console.error('‚ùå [App Password Widget] Failed to store credentials');
                        console.error('   - Status:', response.status);
                        console.error('   - Error data:', JSON.stringify(error, null, 2));
                        showCelebration(error.error || 'Failed to store credentials', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå [App Password Widget] Exception during credential storage');
                    console.error('   - Error type:', error.constructor.name);
                    console.error('   - Error message:', error.message);
                    console.error('   - Stack trace:', error.stack);
                    showCelebration('Failed to store credentials. Please try again.', 'error');
                }
            });
        }
        
        async function showCityModal() {
            const modal = document.getElementById('cityInputModal');
            const input = document.getElementById('cityInput');
            const cityPreview = document.querySelector('.preview-city');
            const handlePreview = document.querySelector('.preview-handle');
            
            // Get provisioner handle from current status
            const provisionerStatus = roleStatuses.provisioner;
            if (provisionerStatus && provisionerStatus.current_worker) {
                const provisionerDid = provisionerStatus.current_worker.did;
                
                // Fetch provisioner's handle
                try {
                    const response = await fetch(`/api/dreamers/${provisionerDid}`);
                    if (response.ok) {
                        const dreamer = await response.json();
                        handlePreview.textContent = dreamer.handle || 'provisioner';
                    }
                } catch (error) {
                    console.error('Error fetching provisioner handle:', error);
                    handlePreview.textContent = 'provisioner';
                }
            }
            
            // Update preview as user types
            input.addEventListener('input', function() {
                const city = this.value.trim();
                cityPreview.textContent = city || '...';
                cityPreview.style.fontStyle = city ? 'normal' : 'italic';
            });
            
            modal.classList.add('show');
            document.body.setAttribute('data-current-role', 'provisioner');
            // Focus input after animation
            setTimeout(() => input.focus(), 300);
        }
        
        function closeCityModal() {
            const modal = document.getElementById('cityInputModal');
            const input = document.getElementById('cityInput');
            const preview = document.querySelector('.preview-city');
            
            modal.classList.remove('show');
            input.value = '';
            preview.textContent = '...';
            preview.style.fontStyle = 'italic';
            pendingRequestProvisionerDid = null;
        }
        
        async function submitCityAndSendRequest() {
            const cityInput = document.getElementById('cityInput');
            const city = cityInput.value.trim();
            
            if (!city) {
                showCelebration('Please enter your city', 'error');
                return;
            }
            
            if (!pendingRequestProvisionerDid) {
                showCelebration('Request session expired. Please try again.', 'error');
                closeCityModal();
                return;
            }
            
            // Store the DID before closing modal
            const provisionerDid = pendingRequestProvisionerDid;
            
            // Close modal and show loading
            closeCityModal();
            showCelebration('Sending request...', 'info');
            
            console.log('üì® Sending request with:', {
                city: city,
                provisioner_did: provisionerDid
            });
            
            try {
                // Get auth token - same priority as other work endpoints
                let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                if (!token && currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                }
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const payload = {
                    city: city,
                    provisioner_did: provisionerDid
                };
                
                console.log('üì§ Request payload:', payload);
                
                const response = await fetch('/api/work/provisioner/send-request', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showCelebration('Request sent successfully!\n\nThe Head of Pantry will respond via DM.', 'success');
                } else {
                    if (data.needs_credentials) {
                        showCelebration('You need to activate a work role first to send direct messages.\n\nPlease activate any role (like Provisioner) to enable DM functionality.', 'error');
                    } else {
                        showCelebration(data.error || 'Failed to send request', 'error');
                    }
                }
            } catch (error) {
                console.error('Error sending food request:', error);
                showCelebration('Network error. Please try again.', 'error');
            } finally {
                pendingRequestProvisionerDid = null;
            }
        }
        
        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            const cityInput = document.getElementById('cityInput');
            if (cityInput) {
                cityInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitCityAndSendRequest();
                    }
                });
            }
        });
        
        function sendFoodRequest() {
            console.log('üçΩÔ∏è [Provisioner] Send food request clicked');
            
            const city = document.getElementById('food-request-city')?.value?.trim();
            const details = document.getElementById('food-request-details')?.value?.trim();
            
            if (!city) {
                showCelebration('Please enter your current city', 'error');
                return;
            }
            
            if (!currentSession || !currentSession.profile) {
                showCelebration('Please log in to send a request', 'error');
                return;
            }
            
            // Placeholder for DM functionality
            showCelebration('Food request functionality coming soon!\n\nYour request will be sent via DM to the current Head of Pantry.', 'info');
            
            console.log('Food request:', {
                name: currentSession.profile.displayName,
                handle: currentSession.profile.handle,
                city: city,
                details: details
            });
        }
        
        function updateRoleActions(role) {
            const activateBtn = document.getElementById('activate-btn');
            if (!activateBtn) return;
            
            // Check if user has a different role
            let userCurrentRole = null;
            if (roleStatuses.greeter && roleStatuses.greeter.is_worker) userCurrentRole = 'greeter';
            else if (roleStatuses.mapper && roleStatuses.mapper.is_worker) userCurrentRole = 'mapper';
            else if (roleStatuses.cogitarian && roleStatuses.cogitarian.is_worker) userCurrentRole = 'cogitarian';
            else if (roleStatuses.provisioner && roleStatuses.provisioner.is_worker) userCurrentRole = 'provisioner';
            
            // If user has a different role, disable the button
            if (userCurrentRole && userCurrentRole !== role) {
                activateBtn.textContent = 'Step Down First';
                activateBtn.disabled = true;
                activateBtn.style.opacity = '0.5';
                activateBtn.style.cursor = 'not-allowed';
            } else {
                // Allow volunteering
                activateBtn.textContent = 'Volunteer Now';
                activateBtn.disabled = false;
                activateBtn.style.opacity = '1';
                activateBtn.style.cursor = 'pointer';
            }
        }

        // Listen for profile loaded event - this guarantees we have all session data
        window.addEventListener('oauth:profile-loaded', async (event) => {
            if (isInitializing) {
                console.log('‚è≠Ô∏è Work: Already initializing, skipping duplicate profile-loaded event');
                return;
            }
            
            isInitializing = true;
            console.log('üîê Work: Profile loaded event received');
            currentSession = event.detail.session;
            profileLoaded = true;
            sessionCheckComplete = true;
            
            // Now we have complete profile data, load all role statuses and update UI
            console.log('üîÑ [FLOW] oauth:profile-loaded ‚Üí Loading all role statuses');
            await loadRoleStatus('greeter');
            await loadRoleStatus('mapper');
            await loadRoleStatus('cogitarian');
            await loadRoleStatus('provisioner');
            console.log('üîÑ [FLOW] oauth:profile-loaded ‚Üí updateUI()');
            updateUI();
            isInitializing = false;
        });

        // Listen for OAuth login events (fired first, before profile loads)
        document.addEventListener('oauth:login', async (event) => {
            console.log('üîê Work: Login event received');
            // Just store the session - we'll wait for profile-loaded to update UI
            currentSession = event.detail.session;
            
            // Don't reload greeter status here - profile-loaded will do it
            // This prevents duplicate API calls
        });

        window.addEventListener('oauth:logout', async () => {
            console.log('üîì Work: User logged out');
            currentSession = null;
            roleStatuses = {
                greeter: null,
                mapper: null,
                cogitarian: null
            };
            sessionCheckComplete = true;
            profileLoaded = false;
            
            // Reload current role status to show current state
            console.log('üîÑ Work: Refreshing role status after logout...');
            await loadRoleStatus(currentRole);
            updateUI();
        });

        // Check for session - simplified since we rely on events
        async function checkSession() {
            if (isInitializing) {
                return true;
            }
            
            if (window.oauthManager) {
                const session = window.oauthManager.getSession();
                if (session) {
                    // Check if profile is already loaded
                    if (session.profile?.handle) {
                        isInitializing = true;
                        currentSession = session;
                        profileLoaded = true;
                        sessionCheckComplete = true;
                        
                        // Profile already loaded, load all role statuses
                        await loadRoleStatus('greeter');
                        await loadRoleStatus('mapper');
                        await loadRoleStatus('cogitarian');
                        await loadRoleStatus('provisioner');
                        updateUI();
                        
                        isInitializing = false;
                        return true;
                    } else {
                        // Profile not loaded yet, events will handle it
                        currentSession = session;
                        return false; // Keep checking
                    }
                }
            }
            return false;
        }

        // Check if already logged in on page load - with retries
        document.addEventListener('DOMContentLoaded', () => {
            let attempts = 0;
            const maxAttempts = 5; // Reduced from 10 to 5
            
            console.log('üîÑ [FLOW] DOMContentLoaded ‚Üí Page initialization');
            
            // Check URL path for direct role navigation (e.g., /work/greeter, /work/mapper)
            const pathParts = window.location.pathname.split('/');
            const urlRole = pathParts[pathParts.length - 1]; // Get last part of path
            
            // Also check for hash fragment (e.g., #greeter, #mapper, #cogitarian)
            const hashRole = window.location.hash.replace('#', '');
            
            // Build allowed roles list
            let allowedRoles = ['greeter', 'mapper', 'cogitarian', 'provisioner'];
            
            let initialTab = null;
            
            // Priority 1: Hash fragment (from redirects)
            if (allowedRoles.includes(hashRole)) {
                console.log('üîÑ [FLOW] Hash specifies role:', hashRole);
                initialTab = hashRole;
            }
            // Priority 2: URL path
            else if (allowedRoles.includes(urlRole)) {
                console.log('üîÑ [FLOW] URL specifies role:', urlRole);
                initialTab = urlRole;
            } 
            // Priority 3: Saved tab
            else {
                // Restore saved tab if any
                const savedTab = localStorage.getItem('work_current_tab');
                if (savedTab && allowedRoles.includes(savedTab)) {
                    console.log('üîÑ [FLOW] Restoring saved tab:', savedTab);
                    initialTab = savedTab;
                }
            }
            
            if (initialTab) {
                currentRole = initialTab;
                // Update the UI to show the correct tab as active (desktop)
                document.querySelectorAll('.role-button').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-role') === initialTab) {
                        btn.classList.add('active');
                    }
                });
                // Update the dropdown (mobile)
                const mobileSelector = document.getElementById('role-selector-mobile');
                if (mobileSelector) {
                    mobileSelector.value = initialTab;
                }
                // Update the role display
                selectRole(initialTab);
            } else {
                // Set default role if none specified
                document.body.setAttribute('data-current-role', currentRole);
            }
            
            // Load greeting templates immediately
            loadGreetingTemplates();
            
            // Initialize origin coordinate example with random values
            updateOriginCoordinateExample();
            
            // Load all role statuses immediately (works without login)
            console.log('üîÑ [FLOW] DOMContentLoaded ‚Üí Loading all role statuses');
            loadRoleStatus('greeter');
            loadRoleStatus('mapper');
            loadRoleStatus('cogitarian');
            loadRoleStatus('provisioner');
            
            // Load greeting events for greeter tab
            loadGreetingEvents();
            
            // Add global click handler for dreamer-link elements to show Bluesky profile popups
            // Use capture phase to intercept clicks before EventStack row handlers
            document.addEventListener('click', (e) => {
                const dreamerLink = e.target.closest('.dreamer-link');
                if (dreamerLink) {
                    console.log('üîç [Work] Dreamer link clicked:', {
                        element: dreamerLink,
                        dataset: dreamerLink.dataset,
                        'data-dreamer-did': dreamerLink.getAttribute('data-dreamer-did'),
                        'data-did': dreamerLink.getAttribute('data-did'),
                        href: dreamerLink.getAttribute('href'),
                        showDreamer: !!window.showDreamer
                    });
                    
                    // Try both data-dreamer-did and data-did attributes
                    const did = dreamerLink.dataset.dreamerDid || dreamerLink.dataset.did;
                    
                    if (!did) {
                        console.warn('[Work] Dreamer link has no DID attribute');
                        return;
                    }
                    
                    // Check if the link has a bsky.app href (external profile link)
                    const href = dreamerLink.getAttribute('href');
                    if (href && href.includes('bsky.app/profile')) {
                        console.log('[Work] External bsky link, allowing default navigation');
                        // Don't prevent default for external bsky links
                        return;
                    }
                    
                    // Prevent default navigation to /dreamer page
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log(`‚ú® [Work] Showing dreamer popup for DID: ${did}`);
                    
                    // Show dreamer popup
                    if (window.showDreamer) {
                        window.showDreamer(did);
                    } else {
                        console.warn('[Work] showDreamer not available, falling back to navigation');
                        window.location.href = `/dreamer?did=${encodeURIComponent(did)}`;
                    }
                }
            }, true); // USE CAPTURE PHASE to intercept before row handlers
            
            
            // Setup work event listeners for cross-page synchronization
            const setupWorkEvents = () => {
                if (!window.WorkEvents) {
                    console.log('‚è≥ Work: WorkEvents not ready, retrying in 100ms...');
                    setTimeout(setupWorkEvents, 100);
                    return;
                }
                
                console.log('üéØ Work: Setting up WorkEvents listeners');
                
                // Listen for greeter activation from dashboard
                window.WorkEvents.on(window.WorkEvents.EVENTS.GREETER_ACTIVATED, async (data) => {
                    console.log('üéØ Work: Received GREETER_ACTIVATED event', data);
                    await loadRoleStatus('greeter');
                    updateUI();
                });
                
                // Listen for greeter step-down from dashboard
                window.WorkEvents.on(window.WorkEvents.EVENTS.GREETER_STEPPED_DOWN, async (data) => {
                    console.log('üéØ Work: Received GREETER_STEPPED_DOWN event', data);
                    await loadRoleStatus('greeter');
                    updateUI();
                });
                
                // Listen for general status changes
                window.WorkEvents.on(window.WorkEvents.EVENTS.GREETER_STATUS_CHANGED, async (data) => {
                    console.log('üéØ Work: Received GREETER_STATUS_CHANGED event', data);
                    await loadRoleStatus('greeter');
                    updateUI();
                });
            };
            
            // Start setup (will retry if not ready)
            setupWorkEvents();
            
            // Set initial loading state
            document.getElementById('loading-state-text').textContent = 'Checking session...';
            
            // Check immediately first
            checkSession().then(found => {
                if (found) {
                    console.log('‚úÖ [FLOW] Session found immediately!');
                    return;
                }
                
                // If not found, start interval checks
                const checkInterval = setInterval(async () => {
                    attempts++;
                    
                    console.log(`üîç Work: Session check attempt ${attempts}/${maxAttempts}`);
                    const found = await checkSession();
                    if (found) {
                        console.log('‚úÖ Work: Session found!');
                        clearInterval(checkInterval);
                    } else if (attempts >= maxAttempts) {
                        // No session found after max attempts
                        console.log('‚ö†Ô∏è Work: No session found after max attempts');
                        sessionCheckComplete = true;
                        updateUI();
                        clearInterval(checkInterval);
                    }
                }, 300); // Increased to 300ms to reduce frequency
            });
            
            const checkInterval = setInterval(async () => {
                attempts++;
                
                console.log(`üîç Work: Session check attempt ${attempts}/${maxAttempts}`);
                const found = await checkSession();
                if (found) {
                    console.log('‚úÖ Work: Session found!');
                    clearInterval(checkInterval);
                } else if (attempts >= maxAttempts) {
                    // No session found after max attempts
                    console.log('‚ö†Ô∏è Work: No session found after max attempts');
                    sessionCheckComplete = true;
                    updateUI();
                    clearInterval(checkInterval);
                }
            }, 200); // Check every 200ms
        });

        // Safe login trigger that double-checks session before showing popup
        async function triggerLogin() {
            // Double-check if user is actually logged in before showing popup
            if (window.oauthManager) {
                const session = window.oauthManager.getSession();
                if (session && session.profile?.handle) {
                    // Already have complete profile
                    currentSession = session;
                    profileLoaded = true;
                    sessionCheckComplete = true;
                    await loadGreeterStatus();
                    updateUI();
                    return;
                }
            }
            
            // Actually show login popup
            if (window.loginWidget && typeof window.loginWidget.showLoginPopup === 'function') {
                window.loginWidget.showLoginPopup();
            } else {
                console.error('Login widget not available');
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Save current tab to localStorage
            localStorage.setItem('work_current_tab', tab);
            
            // Update tab buttons
            document.querySelectorAll('.work-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // For now, only Greeter is implemented
            if (tab !== 'greeter') {
                alert(`${tab.charAt(0).toUpperCase() + tab.slice(1)} work is coming soon!`);
                return;
            }

            // Reload the appropriate content
            updateUI();
            if (currentSession) {
                loadRoleStatus(tab);
            }
        }

        function updateUI() {
            const loadingState = document.getElementById('loading-state');
            const userStatus = document.getElementById('user-status');
            const guestPrompt = document.getElementById('guest-prompt');
            const userActions = document.getElementById('user-actions');
            const activateBtn = document.getElementById('activate-btn');
            const deactivateBtn = document.getElementById('deactivate-btn');
            const setRetiringBtn = document.getElementById('set-retiring-btn');
            const setWorkingBtn = document.getElementById('set-working-btn');
            const youLink = document.getElementById('you-link');

            // Update "you" link
            if (currentSession && profileLoaded) {
                const userDid = currentSession.sub || currentSession.did;
                const userHandle = currentSession.profile?.handle || currentSession.handle;
                
                const youLink = document.getElementById('you-link');
                if (youLink) {
                    if (userHandle && userHandle !== 'Unknown') {
                        youLink.innerHTML = `<a href="/dreamer.html?did=${userDid}" class="dreamer-link" data-did="${userDid}" target="_blank" style="color: inherit; text-decoration: none;">you</a>`;
                    } else {
                        youLink.textContent = 'you';
                    }
                }
            } else {
                const youLink = document.getElementById('you-link');
                if (youLink) {
                    youLink.textContent = 'you';
                }
            }

            // Check if we're using the old work.html structure or new work.html structure
            // work.html doesn't have these elements, so skip if they don't exist
            if (!loadingState || !userStatus || !guestPrompt) {
                console.log('‚ÑπÔ∏è [updateUI] Using work.html sidebar structure, skipping legacy UI updates');
                return;
            }

            // Show loading state if session check not complete
            if (!sessionCheckComplete) {
                loadingState.style.display = 'block';
                const loadingText = document.getElementById('loading-state-text');
                if (loadingText) loadingText.textContent = 'Checking session...';
                userStatus.style.display = 'none';
                if (userActions) userActions.style.display = 'none';
                guestPrompt.style.display = 'none';
                return;
            }

            // If we have a session but profile not loaded yet
            if (currentSession && !profileLoaded) {
                loadingState.style.display = 'block';
                const loadingText = document.getElementById('loading-state-text');
                if (loadingText) loadingText.textContent = 'Loading your profile...';
                userStatus.style.display = 'none';
                if (userActions) userActions.style.display = 'none';
                guestPrompt.style.display = 'none';
                return;
            }

            // Hide loading state - we're ready
            loadingState.style.display = 'none';

            // Don't show guest prompt until we've completed session check
            if (!currentSession || !profileLoaded) {
                userStatus.style.display = 'none';
                if (userActions) userActions.style.display = 'none';
                guestPrompt.style.display = 'block';
                return;
            }

            guestPrompt.style.display = 'none';
            if (userActions) userActions.style.display = 'block';

            // Get handle from session - ensure we have valid data
            const userHandle = currentSession.profile?.handle || currentSession.handle;
            if (!userHandle || userHandle === 'Unknown') {
                // Profile data not ready yet, wait for it
                console.warn('‚ö†Ô∏è Profile data not ready, waiting...');
                loadingState.style.display = 'block';
                const loadingText = document.getElementById('loading-state-text');
                if (loadingText) loadingText.textContent = 'Loading profile data...';
                return;
            }

            // Build user status card
            // Find which role the user actually has (not just the selected tab)
            let actualUserRole = null;
            console.log('üîç [DEBUG] Checking roleStatuses for user role:');
            console.log('   roleStatuses.greeter:', roleStatuses.greeter);
            console.log('   roleStatuses.mapper:', roleStatuses.mapper);
            console.log('   roleStatuses.cogitarian:', roleStatuses.cogitarian);
            console.log('   roleStatuses.provisioner:', roleStatuses.provisioner);
            
            if (roleStatuses.greeter && roleStatuses.greeter.is_worker) actualUserRole = 'greeter';
            else if (roleStatuses.mapper && roleStatuses.mapper.is_worker) actualUserRole = 'mapper';
            else if (roleStatuses.cogitarian && roleStatuses.cogitarian.is_worker) actualUserRole = 'cogitarian';
            else if (roleStatuses.provisioner && roleStatuses.provisioner.is_worker) actualUserRole = 'provisioner';
            
            console.log('   ‚Üí actualUserRole determined:', actualUserRole);
            
            // Check if viewing own role vs different role
            const viewingOwnRole = actualUserRole && actualUserRole === currentRole;
            const hasRole = actualUserRole !== null;
            
            // Get status for the selected tab role
            const selectedRoleStatus = roleStatuses[currentRole];
            const isWorkerForSelectedRole = selectedRoleStatus && selectedRoleStatus.is_worker;
            const status = selectedRoleStatus?.status;
            
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üéØ [UI UPDATE] Called at', new Date().toISOString());
            console.log('üîß [UI UPDATE] currentRole (selected tab):', currentRole);
            console.log('üîß [UI UPDATE] actualUserRole:', actualUserRole);
            console.log('üîß [UI UPDATE] viewingOwnRole:', viewingOwnRole);
            console.log('üîß [UI UPDATE] hasRole:', hasRole);
            console.log('üîß [UI UPDATE] isWorkerForSelectedRole:', isWorkerForSelectedRole);
            console.log('üîß [UI UPDATE] selectedRoleStatus:', selectedRoleStatus);
            console.log('üîß [UI UPDATE] status:', status);
            console.log('üîß [UI UPDATE] currentSession DID:', currentSession.sub || currentSession.did);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // Show worker status card ONLY if viewing own role
            if (isWorkerForSelectedRole && viewingOwnRole) {
                console.log('‚úÖ [UI] Showing worker status card for', currentRole);
                
                // Skip if elements don't exist (work.html uses different structure)
                if (!userStatus || !activateBtn) {
                    console.log('‚ÑπÔ∏è [UI] Using work.html structure - worker UI managed by sidebar');
                    return;
                }
                
                const displayName = currentSession.profile?.displayName || userHandle;
                const avatar = currentSession.profile?.avatar || '/assets/icon.png';
                
                // Status display - just show the actual status value
                const statusValue = status === 'working' ? 'working' : 'retiring';
                
                // Get role title from config
                const currentRoleConfig = roleConfigs[currentRole];
                const roleTitle = currentRoleConfig ? currentRoleConfig.title : currentRole;
                
                // Build card matching the not-volunteering style
                userStatus.innerHTML = `
                    <div class="user-status-card not-volunteering">
                        <div class="profile-section">
                            <img src="${avatar}" alt="${displayName}" class="user-avatar">
                            <div class="user-info">
                                <h3 class="user-display-name">${displayName}</h3>
                                <p class="user-handle">@${userHandle}</p>
                            </div>
                            <div class="user-stats">
                                <div class="stat-item">
                                    <div class="stat-label">Roles</div>
                                    <div class="stat-value">${roleTitle}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Status</div>
                                    <div class="stat-value">${statusValue}</div>
                                </div>
                            </div>
                        </div>
                        <div class="volunteer-section">
                            <div class="volunteer-prompt">
                                <h4>You are currently ${roleTitle}</h4>
                                <p>Thank you for working!</p>
                                <p>${status === 'working' 
                                    ? 'You may begin retiring, or step down immediately.' 
                                    : 'You are already marked as retiring.<br>You will be replaced when someone new volunteers.'}</p>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                ${status === 'working' 
                                    ? `<button class="action-button" onclick="setRoleRetiring('${currentRole}')" style="background: #8b7355; border-color: #8b7355;">Begin Retiring</button>
                                       <button class="action-button" onclick="deactivateRole('${currentRole}')" style="background: #5d4a37; border-color: #5d4a37;">Step Down</button>`
                                    : `<button class="action-button" onclick="showAlreadyWorkingMessage()" style="background: #999; border-color: #999; opacity: 0.6; cursor: not-allowed;">Continue Working</button>
                                       <button class="action-button" onclick="deactivateRole('${currentRole}')" style="background: #5d4a37; border-color: #5d4a37;">Step Down</button>`
                                }
                            </div>
                        </div>
                    </div>
                `;
                userStatus.style.display = 'block';

                // Hide the separate action buttons
                activateBtn.style.display = 'none';
                deactivateBtn.style.display = 'none';
                setRetiringBtn.style.display = 'none';
                setWorkingBtn.style.display = 'none';
            } else {
                // Not volunteering for THIS role - show integrated profile + volunteer card
                
                // Skip if elements don't exist (work.html uses different structure)
                if (!userStatus || !activateBtn) {
                    console.log('‚ÑπÔ∏è [UI] Using work.html structure - non-worker UI managed by sidebar');
                    return;
                }
                
                const displayName = currentSession.profile?.displayName || userHandle;
                const avatar = currentSession.profile?.avatar || '/assets/icon.png';
                const isReverieHouse = userHandle.endsWith('.reverie.house');
                
                // Determine current efforts
                let currentEfforts = 'idle dreamer';
                if (isReverieHouse) {
                    currentEfforts = 'dreamweaver';
                }
                // If user has ANY role, show it
                if (hasRole) {
                    const userRoleConfig = roleConfigs[actualUserRole];
                    currentEfforts = userRoleConfig ? userRoleConfig.title : actualUserRole;
                }
                
                // Role configurations (use main roleConfigs as source of truth for titles)
                const roleConfig = {
                    'greeter': {
                        title: roleConfigs.greeter.title,
                        description: 'Welcomes every newcomer to Reverie House, offers their name, and provides them a helping hand in exploring our wild mindscape.',
                        buttonText: 'BECOME GREETER',
                        replaceText: 'REPLACE GREETER',
                        onclickHandler: 'openGreeterModal()',
                        workerNamePlaceholder: 'greeter-name-placeholder',
                        activeNamePlaceholder: 'greeter-name-placeholder-active',
                        retiringText: 'is ready to retire, if you\'re ready to replace them.',
                        notRetiredText: 'is not yet ready to retire.',
                        comingSoon: false
                    },
                    'mapper': {
                        title: roleConfigs.mapper.title,
                        description: 'Assists dreamers in deducing their origin coordinates when they reveal their beginnings within our wild mindscape.',
                        buttonText: 'BECOME MAPPER',
                        replaceText: 'REPLACE MAPPER',
                        onclickHandler: 'openMapperModal()',
                        workerNamePlaceholder: 'mapper-name-placeholder',
                        activeNamePlaceholder: 'mapper-name-placeholder-active',
                        retiringText: 'is ready to retire, if you\'re ready to replace them.',
                        notRetiredText: 'is not yet ready to retire.',
                        comingSoon: false
                    },
                    'cogitarian': {
                        title: roleConfigs.cogitarian.title,
                        description: 'Helps codify and immunize any inhuman elements of our foundations as this dream settles itself.',
                        buttonText: 'BECOME COGITARIAN',
                        replaceText: 'REPLACE COGITARIAN',
                        onclickHandler: 'openCogitarianModal()',
                        workerNamePlaceholder: 'cogitarian-name-placeholder',
                        activeNamePlaceholder: 'cogitarian-name-placeholder-active',
                        retiringText: 'is ready to retire, if you\'re ready to replace them.',
                        notRetiredText: 'is not yet ready to retire.',
                        comingSoon: false
                    },
                    'provisioner': {
                        title: roleConfigs.provisioner.title,
                        description: 'Helps ease the hunger of dreamers in need by managing food assistance remotely.',
                        buttonText: 'BECOME PROVISIONER',
                        replaceText: 'REPLACE PROVISIONER',
                        onclickHandler: 'openWorkerModal(\'provisioner\')',
                        workerNamePlaceholder: 'provisioner-name-placeholder',
                        activeNamePlaceholder: 'provisioner-name-placeholder-active',
                        retiringText: 'is ready to retire, if you\'re ready to replace them.',
                        notRetiredText: 'is not yet ready to retire.',
                        comingSoon: false
                    }
                };
                
                const config = roleConfig[currentRole] || roleConfig['greeter'];
                
                // Check current worker status for the SELECTED role (not user's role)
                const selectedRoleData = roleStatuses[currentRole];
                const currentWorker = selectedRoleData?.current_worker;
                const isRetiringWorker = currentWorker && currentWorker.status === 'retiring';
                const isActiveWorker = currentWorker && currentWorker.status === 'working';
                
                // Get worker name for replacement notice
                let workerName = '';
                let replacementNotice = '';
                
                if (isRetiringWorker && selectedRoleData?.role_info?.workers?.length > 0) {
                    const workerDid = selectedRoleData.role_info.workers[0].did;
                    // Fetch worker name from dreamers (we'll need to do this async)
                    // For now, use a placeholder - we'll update this after fetching
                    replacementNotice = `
                        <div class="replacement-notice retiring" style="margin-top: 0.75rem; text-align: center; font-size: 0.9rem; color: white;">
                            <span id="${config.workerNamePlaceholder}">Loading...</span> ${config.retiringText}
                        </div>
                    `;
                } else if (isActiveWorker && selectedRoleData?.role_info?.workers?.length > 0) {
                    const workerDid = selectedRoleData.role_info.workers[0].did;
                    // Simple white text for active worker
                    replacementNotice = `
                        <div class="replacement-notice active" style="margin-top: 0.75rem; text-align: center; font-size: 0.9rem; color: white;">
                            <span id="${config.activeNamePlaceholder}">Loading...</span> ${config.notRetiredText}
                        </div>
                    `;
                }
                
                // Check if user has a different role and create subtitle
                let hasConflictingRole = hasRole && !viewingOwnRole;
                let buttonSubtitle = '';
                if (hasConflictingRole) {
                    const userRoleConfig = roleConfigs[actualUserRole];
                    const userRoleTitle = userRoleConfig ? userRoleConfig.title : actualUserRole;
                    buttonSubtitle = `<div style="margin-top: 0.5rem; text-align: center; font-size: 0.85rem; color: #999; font-style: italic;">You are already ${userRoleTitle}</div>`;
                }
                
                // For coming soon roles or conflicting roles, show disabled button
                const isDisabled = config.comingSoon || isActiveWorker || hasConflictingRole;
                const disabledStyles = isDisabled ? 'disabled style="opacity: 0.6; cursor: not-allowed; background: #999; border-color: #999;"' : '';
                const buttonOnclick = (config.comingSoon || hasConflictingRole) ? '' : `onclick="${config.onclickHandler}"`;
                
                userStatus.innerHTML = `
                    <div class="user-status-card not-volunteering">
                        <div class="profile-section">
                            <img src="${avatar}" alt="${displayName}" class="user-avatar">
                            <div class="user-info">
                                <h3 class="user-display-name">${displayName}</h3>
                                <p class="user-handle">@${userHandle}</p>
                            </div>
                            <div class="user-stats">
                                <div class="stat-item">
                                    <div class="stat-label">Current Efforts</div>
                                    <div class="stat-value">${currentEfforts}</div>
                                </div>
                            </div>
                        </div>
                        <div class="volunteer-section">
                            <div class="volunteer-prompt">
                                <h4>${config.title}</h4>
                                <p>${config.description}</p>
                            </div>
                            <button class="action-button volunteer-now-btn" ${buttonOnclick} ${disabledStyles}>
                                <span class="btn-text">${isRetiringWorker ? config.replaceText : config.buttonText}</span>
                            </button>
                            ${buttonSubtitle}
                            ${replacementNotice}
                            ${config.comingSoon ? '<div style="margin-top: 0.5rem; text-align: center; font-size: 0.85rem; color: #ccc; font-style: italic;">Coming Soon</div>' : ''}
                        </div>
                    </div>
                `;
                userStatus.style.display = 'block';
                
                // Fetch and update worker name if there's a current worker
                if ((isRetiringWorker || isActiveWorker) && selectedRoleData?.role_info?.workers?.length > 0) {
                    const workerDid = selectedRoleData.role_info.workers[0].did;
                    updateGreeterNameInNotice(workerDid);

                }
                
                // Hide the action buttons since they're now in the card
                activateBtn.style.display = 'none';
                deactivateBtn.style.display = 'none';
                setRetiringBtn.style.display = 'none';
                setWorkingBtn.style.display = 'none';
            }
        }

        async function updateGreeterNameInNotice(greeterDid) {
            try {
                const response = await fetch(`/api/dreamers/${greeterDid}`);
                if (response.ok) {
                    const dreamer = await response.json();
                    const displayName = dreamer.display_name || dreamer.handle || 'The current greeter';
                    
                    // Update all possible placeholders (handles different roles)
                    const placeholderIds = [
                        'greeter-name-placeholder',
                        'greeter-name-placeholder-active',
                        'mapper-name-placeholder',
                        'mapper-name-placeholder-active',
                        'cogitarian-name-placeholder',
                        'cogitarian-name-placeholder-active'
                    ];
                    
                    placeholderIds.forEach(id => {
                        const placeholder = document.getElementById(id);
                        if (placeholder) {
                            placeholder.textContent = displayName;
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to fetch greeter name:', error);
                
                // Update all possible placeholders with fallback
                const placeholderIds = [
                    'greeter-name-placeholder',
                    'greeter-name-placeholder-active',
                    'mapper-name-placeholder',
                    'mapper-name-placeholder-active',
                    'cogitarian-name-placeholder',
                    'cogitarian-name-placeholder-active'
                ];
                
                placeholderIds.forEach(id => {
                    const placeholder = document.getElementById(id);
                    if (placeholder) {
                        placeholder.textContent = 'The current worker';
                    }
                });
            }
        }

        async function loadRoleStatus(role) {
            try {
                const startTime = performance.now();
                console.log(`üåê [API] Starting ${role} status fetch at`, new Date().toISOString());
                
                // Get token - use same priority as credentials check and activation
                // Priority: backend session token > PDS accessJwt
                let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                let tokenSource = 'backend';
                
                if (!token && currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                    tokenSource = 'pds-jwt';
                }

                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                    console.log(`üîë Work: Using ${tokenSource} token for ${role} auth`);
                } else {
                    console.info(`Work: No token found, ${role} API will return public info only`);
                }

                console.log(`üîÑ Work: Loading ${role} status...`);
                const fetchStart = performance.now();
                const response = await fetch(`/api/work/${role}/status`, {
                    headers: headers
                });
                const fetchDuration = performance.now() - fetchStart;
                console.log(`‚è±Ô∏è [API] ${role} status fetch took ${fetchDuration.toFixed(0)}ms (status: ${response.status})`);

                if (response.ok) {
                    const data = await response.json();
                    const totalDuration = performance.now() - startTime;
                    console.log(`‚úÖ [API] ${role} status loaded (total: ${totalDuration.toFixed(0)}ms):`, data);
                    console.log(`üìù [STATE] Setting ${role}Status:`, data);
                    roleStatuses[role] = data;
                    
                    // Update worker display if this is the current role and we got role_info
                    if (role === currentRole && data.role_info) {
                        console.log(`üë§ [FLOW] Calling updateWorkerDisplay() for ${role}`);
                        updateWorkerDisplay(data.role_info, role);
                    } else if (role === currentRole) {
                        console.log(`‚ö†Ô∏è [STATE] No role_info in ${role} response`);
                        // No role_info in response, show None
                        const workerDisplay = document.getElementById('worker-display');
                        if (workerDisplay) {
                            workerDisplay.innerHTML = '<span style="color: #666;">None</span>';
                        }
                    }
                } else {
                    const errorText = await response.text();
                    console.error(`‚ùå [API] ${role} status endpoint failed: ${response.status}`, errorText.substring(0, 200));
                    console.log(`üìù [STATE] Setting ${role}Status to default (failed response)`);
                    roleStatuses[role] = { is_worker: false, status: null };
                    if (role === currentRole) {
                        const workerDisplay = document.getElementById('worker-display');
                        if (workerDisplay) {
                            workerDisplay.innerHTML = '<span style="color: #666;">None</span>';
                        }
                    }
                }
            } catch (error) {
                console.error(`‚ùå [API] Failed to load ${role} status:`, error);
                console.log(`üìù [STATE] Setting ${role}Status to default (exception)`);
                roleStatuses[role] = { is_worker: false, status: null };
                if (role === currentRole) {
                    const workerDisplay = document.getElementById('worker-display');
                    if (workerDisplay) {
                        workerDisplay.innerHTML = '<span style="color: #666;">None</span>';
                    }
                }
            }
        }

        // Maintain backward compatibility - loadGreeterStatus now calls loadRoleStatus
        async function loadGreeterStatus() {
            return loadRoleStatus('greeter');
        }

        async function updateWorkerDisplay(roleInfo, role = 'greeter') {
            const workerDisplay = document.getElementById('worker-display');
            
            console.log('üîß Work: updateWorkerDisplay called with:', roleInfo);
            
            if (!roleInfo.workers || roleInfo.workers.length === 0) {
                console.log('‚ö†Ô∏è Work: No workers found in role_info');
                const roleTitle = role === 'greeter' ? 'Greeter' : role === 'mapper' ? 'Mapper' : role === 'cogitarian' ? 'Cogitarian' : 'Provisioner';
                
                // Reset worker card borders to default when no worker
                const workerCard = document.querySelector('.role-worker-card');
                const workerCardHeader = document.querySelector('.worker-card-header');
                if (workerCard) {
                    workerCard.style.borderColor = '';
                }
                if (workerCardHeader) {
                    workerCardHeader.style.borderColor = '';
                }
                
                // Get role color for button
                const roleColors = {
                    'greeter': 'var(--role-greeter)',
                    'mapper': 'var(--role-mapper)',
                    'cogitarian': 'var(--role-cogitarian)',
                    'provisioner': 'var(--role-provisioner)'
                };
                const roleColor = roleColors[role] || 'var(--role-greeter)';
                
                workerDisplay.innerHTML = `
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="1.5" style="margin: 0 auto; display: block;">
                        <circle cx="12" cy="12" r="10" />
                        <circle cx="12" cy="10" r="3" />
                        <path d="M6.168 18.849A4 4 0 0 1 10 16h4a4 4 0 0 1 3.834 2.855" />
                    </svg>
                    <div style="text-align: center; margin-top: 0.5rem;">
                        <span style="color: #999; font-size: 0.75rem; display: block; margin-bottom: 0.5rem;">No Current Worker</span>
                        <button class="become-role-btn" onclick="openWorkerModal('${role}')" style="
                            background: ${roleColor};
                            color: white;
                            border: none;
                            padding: 0.4rem 0.8rem;
                            font-size: 0.75rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        ">Become ${roleTitle}</button>
                    </div>
                `;
                return;
            }

            const worker = roleInfo.workers[0];
            console.log('üë§ Work: Fetching dreamer info for:', worker.did);
            
            // Fetch dreamer info to get handle and avatar
            try {
                const fetchStart = performance.now();
                console.log('üåê [API] Starting dreamer fetch at', new Date().toISOString());
                const dreamerResponse = await fetch(`/api/dreamers/${worker.did}`);
                const fetchDuration = performance.now() - fetchStart;
                console.log(`‚è±Ô∏è [API] Dreamer fetch took ${fetchDuration.toFixed(0)}ms (status: ${dreamerResponse.status})`);
                
                if (dreamerResponse.ok) {
                    const dreamer = await dreamerResponse.json();
                    console.log('‚úÖ Work: Dreamer info received:', dreamer);
                    const userColor = dreamer.color_hex || '#8b7355';
                    const statusText = worker.status === 'retiring' ? ` <span style="color: ${userColor}; font-weight: 400; font-size: 0.85rem;">(retiring)</span>` : worker.status === 'working' ? ` <span style="color: ${userColor}; font-weight: 400; font-size: 0.85rem;">(working)</span>` : '';
                    const handle = dreamer.handle || 'unknown';
                    const displayName = dreamer.display_name || handle;
                    const avatar = dreamer.avatar || '/assets/default-avatar.png';
                    
                    // Apply worker color to the worker card border
                    const workerCard = document.querySelector('.role-worker-card');
                    const workerCardHeader = document.querySelector('.worker-card-header');
                    if (workerCard) {
                        workerCard.style.borderColor = userColor;
                    }
                    if (workerCardHeader) {
                        workerCardHeader.style.borderColor = userColor;
                    }
                    
                    workerDisplay.innerHTML = `
                        <img src="${avatar}" 
                             alt="${handle}" 
                             class="greeter-avatar"
                             style="width: 48px; height: 48px; border-radius: 50%; border: 2px solid ${userColor}; object-fit: cover;">
                        <a href="/dreamer.html?did=${worker.did}" 
                           class="worker-link dreamer-link" 
                           data-did="${worker.did}"
                           style="font-size: 1.1rem; font-weight: 600; color: ${userColor}; text-decoration: none;">
                            ${displayName} <span style="color: #999; font-weight: 400;">@${handle}</span>${statusText}
                        </a>
                    `;
                    
                    console.log('‚úÖ Work: Worker display updated');
                    
                    // Initialize dreamer-hover for the link after DOM updates
                    setTimeout(() => {
                        if (window.DreamerHover) {
                            window.DreamerHover.init();
                        }
                    }, 100);
                } else {
                    console.error('‚ùå Work: Dreamer API failed:', dreamerResponse.status);
                    // Fallback if API fails - show DID
                    workerDisplay.innerHTML = `
                        <a href="/dreamer.html?did=${worker.did}" 
                           style="font-size: 1rem; color: #8b7355; text-decoration: none;">
                            ${worker.did.substring(0, 20)}...
                        </a>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Work: Failed to fetch dreamer info:', error);
                // Fallback if network error - show DID
                workerDisplay.innerHTML = `
                    <a href="/dreamer.html?did=${worker.did}" 
                       style="font-size: 1rem; color: #8b7355; text-decoration: none;">
                        ${worker.did.substring(0, 20)}...
                    </a>
                `;
            }
        }

        // LEGACY: Wrapper for backward compatibility
        async function openGreeterModal() {
            await openWorkerModal('greeter');
        }
        
        // LEGACY: Wrapper for backward compatibility
        async function activateWithExistingCredentials() {
            await activateWorkerWithExistingCredentials('greeter');
        }

        // LEGACY: Wrapper for mapper
        async function openMapperModal() {
            await openWorkerModal('mapper');
        }
        
        // LEGACY: Wrapper for cogitarian
        async function openCogitarianModal() {
            await openWorkerModal('cogitarian');
        }
        
        // LEGACY: Wrapper for mapper
        async function activateMapperWithExistingCredentials() {
            await activateWorkerWithExistingCredentials('mapper');
        }

        // Loading overlay helpers
        function showLoadingOverlay(message = 'Processing...') {
            const overlay = document.getElementById('loading-overlay');
            const textElement = overlay.querySelector('.loading-text');
            if (textElement) {
                textElement.textContent = message;
            }
            overlay.style.display = 'flex';
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'none';
        }

        // Example greeting posts - loaded from API
        let greetingExamples = [];
        
        // Example mapper posts - origin declarations
        let mapperExamples = [
            {
                text: '<div style="text-align: center; letter-spacing: 2px; font-weight: 600; font-family: \'Courier New\', monospace;">O22 A11 S05 R88 L63 E71</div>'
            }
        ];

        // Role configuration for universal modal (defined early so selectRole can use it)
        const roleConfigs = {
            greeter: {
                title: 'Greeter of Reveries',
                description: 'You are one who wishes to welcome newcomers to Reverie House and help them find their way through our wild mindscape.<br><br>As Greeter you will automatically provide newcomers with their name, and offer them a friendly helping hand should they need one.',
                exampleLabel: 'Welcome Greetings',
                appPasswordName: 'Greeter of Reveries',
                passwordPurpose: 'for posting greetings',
                roleName: 'Greeter of Reveries',
                roleNameLower: 'greeter',
                buttonText: 'BECOME GREETER',
                confirmTitle: 'Become Greeter of Reveries?',
                confirmMessage: 'As Greeter, you will automatically welcome new dreamers to Reverie House.',
                activationMessage: 'You are now the active greeter!',
                showExamples: true,
                getExamples: () => greetingExamples
            },
            mapper: {
                title: 'Spectrum Mapper',
                description: 'You are one who wishes to chart the origins of dreamers in our wild mindscape, mapping their outsets within the reverie spectrum.<br><br>As <b>Spectrum Mapper</b> you will automatically deduce and declare the starting coordinates of those who reveal their origins in our wild mindscape.',
                exampleLabel: 'Origin Declarations',
                appPasswordName: 'Spectrum Mapper',
                passwordPurpose: 'for posting origin declarations',
                roleName: 'Spectrum Mapper',
                roleNameLower: 'mapper',
                buttonText: 'BECOME MAPPER',
                confirmTitle: 'Become Spectrum Mapper?',
                confirmMessage: 'As Spectrum Mapper, you will automatically deduce and declare the starting coordinates of those who reveal their origins in our wild mindscape.',
                activationMessage: 'You are now Spectrum Mapper of Reverie House\nThank you for working!\nPlease stop if it feels like work.',
                showExamples: true,
                getExamples: () => mapperExamples
            },
            cogitarian: {
                title: 'Cogitarian (Prime)',
                description: 'Our Cogitarian is a humanizing authority who helps codify human elements within our shared technical foundation and help deter dehumanizations.<br><br>You will work closely with the current Keeper(s) to take responsibility for defining the immutably human aspects of our environment, in effort to keep our wild mindscape a more dependable place for real dreamrs.',
                exampleLabel: 'Discourse Examples',
                appPasswordName: 'Cogitarian (Prime)',
                passwordPurpose: 'for fostering discourse',
                roleName: 'Cogitarian (Prime)',
                roleNameLower: 'cogitarian',
                buttonText: 'BECOME COGITARIAN',
                confirmTitle: 'Become Cogitarian (Prime)?',
                confirmMessage: 'As Cogitarian, you will help foster thoughtful discourse in Reverie House.',
                activationMessage: 'You are now the active cogitarian!',
                showExamples: false,
                getExamples: () => []
            },
            provisioner: {
                title: 'Head of Pantry',
                description: 'Provisioners are dreamweavers who understand that ease of rest in the waking world eases all manner of dreams across our wild mindscape.<br><br>When another dreamer at Reverie House feels the real pangs of hunger, it is <b>Head of Pantry</b> who will remotely try to ease their burden with food.',
                exampleLabel: 'Pantry Examples',
                appPasswordName: 'Head of Pantry',
                passwordPurpose: 'for managing food assistance',
                roleName: 'Head of Pantry',
                roleNameLower: 'provisioner',
                buttonText: 'BECOME PROVISIONER',
                confirmTitle: 'Become Head of Pantry?',
                confirmMessage: 'As Head of Pantry, you will help ease the hunger of dreamers in need.',
                activationMessage: 'You are now Head of Pantry\nThank you for working!\nPlease stop if it feels like work.',
                showExamples: false,
                getExamples: () => []
            }
        };

        // Store greeting templates for carousel
        let greetingTemplates = [];
        let currentGreetingIndex = 0;

        // Load greeting templates from API for the carousel
        async function loadGreetingTemplates() {
            try {
                const response = await fetch('/api/work/greeter/templates');
                if (response.ok) {
                    const data = await response.json();
                    if (data.templates && data.templates.length > 0) {
                        // Convert templates to display format with placeholder handle
                        greetingTemplates = data.templates.map(template => 
                            template.replace(/@\{handle\}/g, '<a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>')
                                    .replace(/\n/g, '<br>')
                        );
                        
                        // Also populate greetingExamples for modal compatibility
                        greetingExamples = data.templates.map(template => ({
                            text: template.replace(/@\{handle\}/g, '<a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>')
                                         .replace(/\n/g, '<br>')
                        }));
                        
                        // Update both displays after loading templates
                        updateGreetingsDisplay();
                        updateExamplePost();
                    } else {
                        // Fallback templates if API fails
                        useGreetingFallbackTemplates();
                    }
                } else {
                    useGreetingFallbackTemplates();
                }
            } catch (error) {
                console.error('Failed to load greeting templates:', error);
                useGreetingFallbackTemplates();
            }
        }

        function useGreetingFallbackTemplates() {
            greetingTemplates = [
                'Welcome to Reverie House, <a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>!<br><br>I\'m here to help if you have any questions.',
                'Hello <a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>, glad to meet you.<br><br>Feel free to ask for anything if you need it.',
                'Welcome, <a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>! Glad you found your way.<br><br>Let me know if you have questions?',
                'Greetings <a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>! Welcome to Reverie House.<br><br>I\'m here to help you settle in.',
                'Welcome to Reverie House <a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>!<br><br>Let me know if you have any questions?'
            ];
            
            greetingExamples = greetingTemplates.map(text => ({ text }));
            updateGreetingsDisplay();
            updateExamplePost();
        }

        // Load greeting events for eventstack display
        async function loadGreetingEvents() {
            try {
                const response = await fetch('/api/canon');
                if (response.ok) {
                    const allEvents = await response.json();
                    
                    // Group events: parent events with their reactions embedded
                    // First, separate reactions from parent events
                    const parentEvents = [];
                    const reactions = {};
                    
                    allEvents.forEach(event => {
                        if (event.key === 'name' || event.key === 'greeter') {
                            if (event.reaction_to) {
                                // This is a reaction - group by parent URI
                                if (!reactions[event.reaction_to]) {
                                    reactions[event.reaction_to] = [];
                                }
                                reactions[event.reaction_to].push(event);
                            } else {
                                // This is a parent event
                                parentEvents.push(event);
                            }
                        }
                    });
                    
                    // Attach reactions to their parent events
                    parentEvents.forEach(parent => {
                        if (parent.uri && reactions[parent.uri]) {
                            parent.reactions = reactions[parent.uri];
                        }
                    });
                    
                    console.log(`[Work] Found ${parentEvents.length} greeting events with reactions`);
                    
                    // Render with EventStack (auto mode uses database color_source and color_hex)
                    if (window.EventStack) {
                        const eventStack = new EventStack();
                        eventStack.render(parentEvents, document.getElementById('greeter-eventstack'), {
                            colorMode: 'auto',
                            colorIntensity: 'highlight',
                            limit: 20,
                            sortOrder: 'desc',
                            emptyMessage: 'No greeting events yet',
                            showReactions: true,
                            dateFormat: 'date',
                            columns: {
                                type: false,
                                key: false,
                                uri: false
                            }
                        });
                    } else {
                        console.warn('[Work] EventStack not available yet');
                    }
                } else {
                    console.error('Failed to load events:', response.status);
                }
            } catch (error) {
                console.error('Failed to load greeting events:', error);
            }
        }

        // Load repository data from GitHub
        async function loadRepoData() {
            const contentDiv = document.getElementById('repo-data-content');
            const repoInfoDiv = document.getElementById('repo-info');
            if (!contentDiv) return;
            
            try {
                // Fetch repo info for languages
                const repoResponse = await fetch('https://api.github.com/repos/errantson/reverie');
                const repoData = await repoResponse.json();
                
                // Fetch languages
                const languagesResponse = await fetch('https://api.github.com/repos/errantson/reverie/languages');
                const languagesData = await languagesResponse.json();
                const topLanguages = Object.keys(languagesData).slice(0, 3).map(lang => {
                    // Change JavaScript to JS for display
                    return lang === 'JavaScript' ? 'JS' : lang;
                }).join(', ');
                const lastUpdated = new Date(repoData.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                // Update repo info if available
                    if (repoInfoDiv) {
                    // Convert GitHub 'size' (KB) to human-readable string
                    function humanFileSizeFromKB(kb) {
                        if (kb === null || kb === undefined) return 'N/A';
                        const bytes = kb * 1024;
                        const thresh = 1024;
                        if (Math.abs(bytes) < thresh) return bytes + ' B';
                        const units = ['KB','MB','GB','TB'];
                        let u = -1;
                        let value = bytes;
                        do {
                            value /= thresh;
                            ++u;
                        } while (Math.abs(value) >= thresh && u < units.length - 1);
                        return value.toFixed(1) + ' ' + units[u];
                    }

                    const fileSize = humanFileSizeFromKB(repoData.size);
                    const openIssues = repoData.open_issues_count ?? 'N/A';
                    const watchers = repoData.watchers_count ?? repoData.subscribers_count ?? 'N/A';

                    repoInfoDiv.innerHTML = `
                        <div class="repo-info-item">
                            <span class="repo-info-label">Languages:</span>
                            <span class="repo-info-value">${topLanguages || 'N/A'}</span>
                        </div>
                        <div class="repo-info-item">
                            <span class="repo-info-label">Updated:</span>
                            <span class="repo-info-value">${lastUpdated || 'N/A'}</span>
                        </div>
                        <div class="repo-info-item">
                            <span class="repo-info-label">Watchers:</span>
                            <span class="repo-info-value">${watchers}</span>
                        </div>
                        <div class="repo-info-item">
                            <span class="repo-info-label">File Size:</span>
                            <span class="repo-info-value">${fileSize}</span>
                        </div>
                    `;

                    // Update the Issues button to include the open issues count
                    try {
                        const issuesBtn = document.querySelector('a[href="https://github.com/errantson/reverie/issues"]');
                        if (issuesBtn) {
                            const svg = issuesBtn.querySelector('svg');
                            const svgHtml = svg ? svg.outerHTML : '';
                            const countText = (typeof openIssues === 'number') ? openIssues : openIssues;
                            issuesBtn.innerHTML = `\n                                ${svgHtml}\n                                Open Issues: ${countText}\n                            `;
                        }
                    } catch (e) {
                        console.warn('Failed to update issues button:', e);
                    }
                }
                
                // Fetch all commits (max 100 per page, fetch multiple pages)
                let allCommits = [];
                let page = 1;
                let hasMore = true;
                
                while (hasMore && page <= 3) { // Limit to 3 pages (300 commits) for performance
                    const commitsResponse = await fetch(`https://api.github.com/repos/errantson/reverie/commits?per_page=100&page=${page}`);
                    if (!commitsResponse.ok) throw new Error('Failed to fetch commits');
                    const commits = await commitsResponse.json();
                    
                    if (commits.length === 0) {
                        hasMore = false;
                    } else {
                        allCommits = allCommits.concat(commits);
                        page++;
                    }
                }
                
                // Fetch contributors
                const contributorsResponse = await fetch('https://api.github.com/repos/errantson/reverie/contributors');
                if (!contributorsResponse.ok) throw new Error('Failed to fetch contributors');
                const contributors = await contributorsResponse.json();
                
                // Format commit rows
                const commitRows = allCommits.map(commit => {
                    const date = new Date(commit.commit.committer.date);
                    const timeAgo = formatTimeAgo(date);
                    const message = commit.commit.message.split('\n')[0];
                    const commitUrl = commit.html_url;
                    
                    return `
                        <a href="${commitUrl}" target="_blank" class="commit-row">
                            <span class="commit-message">${message}</span>
                            <span class="commit-meta">${timeAgo}</span>
                        </a>
                    `;
                }).join('');
                
                // Format contributors
                const contributorsList = contributors.slice(0, 5).map(contrib => `
                    <a href="${contrib.html_url}" target="_blank" class="contributor-link" title="${contrib.login} - ${contrib.contributions} contributions">
                        <img src="${contrib.avatar_url}" alt="${contrib.login}" class="contributor-avatar">
                    </a>
                `).join('');
                
                contentDiv.innerHTML = `
                    <div class="commits-section">
                        ${commitRows}
                    </div>
                    <div class="contributors-section">
                        <div class="contributors-label">Contributors</div>
                        <div class="contributors-list">
                            ${contributorsList}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load repo data:', error);
                contentDiv.innerHTML = '<div class="repo-error">Failed to load repository data</div>';
            }
        }
        
        // Format time ago helper
        function formatTimeAgo(date) {
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            if (seconds < 2592000) return `${Math.floor(seconds / 604800)}w ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Update greetings carousel display
        function updateGreetingsDisplay() {
            const greetingsDisplay = document.getElementById('greeter-greetings-display');
            if (!greetingsDisplay) return;
            
            if (greetingTemplates.length === 0) {
                greetingsDisplay.innerHTML = '<div class="greeting-text" style="color: #999; font-style: italic;">Loading templates...</div>';
                return;
            }
            
            const template = greetingTemplates[currentGreetingIndex];
            greetingsDisplay.innerHTML = `<div class="greeting-text">${template}</div>`;
        }

        function nextGreeting() {
            if (greetingTemplates.length === 0) return;
            currentGreetingIndex = (currentGreetingIndex + 1) % greetingTemplates.length;
            updateGreetingsDisplay();
        }

        function previousGreeting() {
            if (greetingTemplates.length === 0) return;
            currentGreetingIndex = (currentGreetingIndex - 1 + greetingTemplates.length) % greetingTemplates.length;
            updateGreetingsDisplay();
        }

        let currentExampleIndex = 0;

        function updateExamplePost() {
            // Update modal example based on current role
            const examplePost = document.getElementById('example-post');
            if (examplePost && currentModalRole) {
                const config = roleConfigs[currentModalRole];
                if (config) {
                    const examples = config.getExamples();
                    if (examples.length > 0) {
                        examplePost.innerHTML = `<div class="post-text">${examples[currentExampleIndex].text}</div>`;
                    }
                }
            }
            
            // Update greeter role description example (legacy)
            const examplePostGreeter = document.getElementById('example-post-greeter');
            if (examplePostGreeter && greetingExamples.length > 0) {
                examplePostGreeter.innerHTML = `<div class="post-text">${greetingExamples[currentExampleIndex].text}</div>`;
            }
            
            // Update greeter carousel example
            const greeterExampleDisplay = document.getElementById('greeter-example-display');
            if (greeterExampleDisplay) {
                if (greetingExamples.length > 0) {
                    greeterExampleDisplay.innerHTML = `<div class="example-text">${greetingExamples[currentExampleIndex].text}</div>`;
                } else {
                    greeterExampleDisplay.innerHTML = `<div class="example-text" style="color: #999; font-style: italic;">Loading examples...</div>`;
                }
            }
        }

        function nextExample() {
            if (currentModalRole) {
                const config = roleConfigs[currentModalRole];
                const examples = config ? config.getExamples() : greetingExamples;
                currentExampleIndex = (currentExampleIndex + 1) % examples.length;
            } else {
                currentExampleIndex = (currentExampleIndex + 1) % greetingExamples.length;
            }
            updateExamplePost();
        }

        function previousExample() {
            if (currentModalRole) {
                const config = roleConfigs[currentModalRole];
                const examples = config ? config.getExamples() : greetingExamples;
                currentExampleIndex = (currentExampleIndex - 1 + examples.length) % examples.length;
            } else {
                currentExampleIndex = (currentExampleIndex - 1 + greetingExamples.length) % greetingExamples.length;
            }
            updateExamplePost();
        }

        // ====== UNIVERSAL WORKER MODAL SYSTEM ======
        
        let currentModalRole = null;

        // Universal worker modal opener
        async function openWorkerModal(role) {
            if (!currentSession) {
                showCelebration('Please log in first', 'error');
                return;
            }
            
            const config = roleConfigs[role];
            if (!config) {
                console.error('Unknown role:', role);
                return;
            }
            
            // Check if user has a different role first
            // Check if user has a different role
            let userCurrentRole = null;
            if (roleStatuses.greeter && roleStatuses.greeter.is_worker) userCurrentRole = 'greeter';
            else if (roleStatuses.mapper && roleStatuses.mapper.is_worker) userCurrentRole = 'mapper';
            else if (roleStatuses.cogitarian && roleStatuses.cogitarian.is_worker) userCurrentRole = 'cogitarian';
            else if (roleStatuses.provisioner && roleStatuses.provisioner.is_worker) userCurrentRole = 'provisioner';
            
            if (userCurrentRole && userCurrentRole !== role) {
                const currentRoleConfig = roleConfigs[userCurrentRole];
                const currentRoleTitle = currentRoleConfig ? currentRoleConfig.title : userCurrentRole;
                showCelebration(`You are currently ${currentRoleTitle}.\n\nStep down first to take on a new role.`, 'error');
                return;
            }
            
            currentModalRole = role;
            
            // Check if there's already an active worker for this role
            const statusResponse = await fetch(`/api/work/${role}/status`);
            if (statusResponse.ok) {
                const statusData = await statusResponse.json();
                if (statusData.activeWorker && statusData.activeWorker !== currentSession.did) {
                    showCelebration(`There is already an active ${config.roleNameLower}`, 'error');
                    return;
                }
            }
            
            // Check if user already has app password stored
            // Priority: backend session token > PDS accessJwt > localStorage tokens
            let token = null;
            
            // First try to get the backend session token (most reliable)
            token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
            
            // Fall back to PDS accessJwt if no backend token
            if (!token && currentSession && currentSession.accessJwt) {
                token = currentSession.accessJwt;
                console.log('üîë Using accessJwt from session (no backend token found)');
            } else if (token) {
                console.log('üîë Using backend session token from localStorage');
            }
            
            if (!token) {
                console.warn('‚ö†Ô∏è No token available for credentials check - showing password widget');
                // No token means we can't verify - show the widget to collect password
            } else {
                const headers = {};
                headers['Authorization'] = `Bearer ${token}`;
                
                console.log(`üîç Checking credentials for ${role}...`);
                try {
                    const credResponse = await fetch('/api/user/credentials/status', { headers });
                    console.log(`üîç Credentials check response: ${credResponse.status}`);
                    
                    if (credResponse.ok) {
                        const credData = await credResponse.json();
                        console.log('üîç Credentials data:', credData);
                        if (credData.connected && credData.valid) {
                            // User already has valid credentials, activate directly
                            console.log(`‚úÖ Using existing credentials for ${role} activation`);
                            activateWorkerWithExistingCredentials(role);
                            return;
                        } else {
                            console.log(`‚ö†Ô∏è Credentials not valid: connected=${credData.connected}, valid=${credData.valid}`);
                        }
                    } else if (credResponse.status === 401) {
                        // Token is invalid/expired - still allow them to proceed with password entry
                        console.warn('‚ö†Ô∏è Session token expired or invalid - user will need to enter app password');
                        const errorData = await credResponse.json().catch(() => ({}));
                        console.log('Token validation error:', errorData);
                    } else {
                        console.error('‚ùå Credentials check failed:', await credResponse.text());
                    }
                } catch (error) {
                    console.error('‚ùå Credentials check exception:', error);
                    // Continue to show the widget even if the check fails
                }
            }
            
            // Show AppPasswordRequest widget with role-specific configuration
            if (!window.appPasswordRequest) {
                console.error('‚ùå AppPasswordRequest widget not loaded');
                showCelebration('Widget not loaded - please refresh the page', 'error');
                return;
            }
            
            window.appPasswordRequest.show({
                title: config.title,
                description: config.description,
                featureName: config.roleNameLower,
                roleColor: role  // Pass role for color theming
            }, async (appPassword) => {
                // Callback receives validated 16-char app password
                console.log('üîë App password received from widget');
                
                // Show confirmation popup before activating
                showWorkerConfirmation(role, () => performWorkerActivation(role, appPassword, null));
            });
        }

        async function activateWorkerWithExistingCredentials(role) {
            const config = roleConfigs[role];
            if (!config) return;
            
            try {
                // Get token for authorization - use same priority as credentials check
                // Priority: backend session token > PDS accessJwt
                let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                
                if (!token && currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                    console.log('üîë [Activation] Using accessJwt from session (no backend token found)');
                } else if (token) {
                    console.log('üîë [Activation] Using backend session token from localStorage');
                }
                
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                } else {
                    console.error('‚ùå [Activation] No valid token found!');
                    showCelebration('Session expired - please refresh and try again', 'error');
                    return;
                }
                
                const response = await fetch(`/api/work/${role}/activate`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ use_existing_credentials: true })
                });

                if (response.ok) {
                    const data = await response.json();
                    showCelebration(config.activationMessage, 'success');
                    
                    // Reload page to update UI
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const error = await response.json();
                    showCelebration(error.error || `Failed to activate ${config.roleNameLower}`, 'error');
                }
            } catch (error) {
                console.error('Activation error:', error);
                showCelebration(`Failed to activate ${config.roleNameLower}`, 'error');
            }
        }

        // Worker confirmation popup (called from AppPasswordRequest widget callback)
        function showWorkerConfirmation(role, onConfirm) {
            const config = roleConfigs[role];
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'worker-confirmation-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.75);
                backdrop-filter: blur(4px);
                z-index: 10002;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'worker-confirmation-popup';
            popup.style.cssText = `
                background: linear-gradient(135deg, #2c1810 0%, #4a3428 100%);
                padding: 2.5rem;
                border: 3px solid var(--reverie-core-color, #734ba1);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 
                           0 0 40px rgba(115, 75, 161, 0.3);
                max-width: 500px;
                text-align: center;
                transform: scale(0.9);
                opacity: 0;
                transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            `;
            
            popup.innerHTML = `
                <div style="color: #e8d5c4; font-size: 1.4rem; font-weight: 700; margin-bottom: 1rem; 
                           text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                    ${config.confirmTitle}
                </div>
                <div style="color: #c9b8a8; font-size: 1rem; line-height: 1.6; margin-bottom: 2rem;">
                    ${config.confirmMessage}
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="confirm-btn" style="
                        background: linear-gradient(135deg, #734ba1 0%, #9d6ec9 100%);
                        color: white;
                        border: none;
                        padding: 0.75rem 2rem;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                        box-shadow: 0 4px 12px rgba(115, 75, 161, 0.4);
                        transition: all 0.2s ease;
                    ">Yes, I Accept</button>
                    <button class="cancel-btn" style="
                        background: rgba(255, 255, 255, 0.1);
                        color: #e8d5c4;
                        border: 2px solid rgba(255, 255, 255, 0.2);
                        padding: 0.75rem 2rem;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    ">Cancel</button>
                </div>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Animate in
            requestAnimationFrame(() => {
                overlay.style.opacity = '1';
                popup.style.transform = 'scale(1)';
                popup.style.opacity = '1';
            });
            
            // Add hover effects
            const confirmBtn = popup.querySelector('.confirm-btn');
            const cancelBtn = popup.querySelector('.cancel-btn');
            
            confirmBtn.addEventListener('mouseenter', () => {
                confirmBtn.style.transform = 'translateY(-2px)';
                confirmBtn.style.boxShadow = '0 6px 16px rgba(115, 75, 161, 0.5)';
            });
            confirmBtn.addEventListener('mouseleave', () => {
                confirmBtn.style.transform = 'translateY(0)';
                confirmBtn.style.boxShadow = '0 4px 12px rgba(115, 75, 161, 0.4)';
            });
            
            cancelBtn.addEventListener('mouseenter', () => {
                cancelBtn.style.background = 'rgba(255, 255, 255, 0.15)';
                cancelBtn.style.borderColor = 'rgba(255, 255, 255, 0.3)';
            });
            cancelBtn.addEventListener('mouseleave', () => {
                cancelBtn.style.background = 'rgba(255, 255, 255, 0.1)';
                cancelBtn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            });
            
            // Handle confirm
            confirmBtn.addEventListener('click', () => {
                overlay.style.opacity = '0';
                popup.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    onConfirm();
                }, 300);
            });
            
            // Handle cancel
            cancelBtn.addEventListener('click', () => {
                overlay.style.opacity = '0';
                popup.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                }, 300);
            });
        }
        
        async function performWorkerActivation(role, appPassword, submitBtn) {
            const config = roleConfigs[role];
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'CONNECTING...';
            }

            try {
                // STEP 1: First, save the app password to credentials table
                console.log('üîë Step 1: Connecting app password...');
                
                // Get auth token
                let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                if (!token && currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                }
                
                if (!token) {
                    showCelebration('Session expired - please refresh and try again', 'error');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = config.buttonText;
                    }
                    return;
                }
                
                const connectResponse = await fetch('/api/user/credentials/connect', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ app_password: appPassword })
                });
                
                if (!connectResponse.ok) {
                    const connectError = await connectResponse.json();
                    showCelebration(connectError.error || 'Invalid app password', 'error');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = config.buttonText;
                    }
                    return;
                }
                
                console.log('‚úÖ App password connected successfully');
                
                // STEP 2: Now activate the role
                if (submitBtn) {
                    submitBtn.textContent = 'ACTIVATING...';
                }
                
                console.log(`üîë Step 2: Activating as ${role}...`);
                
                const response = await fetch(`/api/work/${role}/activate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ use_existing_credentials: true })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Close the modal
                    const modal = document.getElementById('auth-modal');
                    if (modal) {
                        modal.classList.remove('active');
                        setTimeout(() => modal.style.display = 'none', 300);
                    }
                    
                    showCelebration(config.activationMessage, 'success');
                    
                    // Reload page to update UI
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const error = await response.json();
                    showCelebration(error.error || `Failed to activate ${config.roleNameLower}`, 'error');
                    
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = config.buttonText;
                    }
                }
            } catch (error) {
                console.error('Activation error:', error);
                showCelebration(`Failed to activate ${config.roleNameLower}: ${error.message}`, 'error');
                
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = config.buttonText;
                }
            }
        }
        
        // ====== END UNIVERSAL WORKER MODAL SYSTEM ======

        // LEGACY: Keep old greeter function for backward compatibility
        async function submitGreeterActivation() {
            const appPasswordInput = document.getElementById('app-password');
            const submitBtn = document.querySelector('.authorize-btn');
            
            if (!currentSession) {
                showCelebration('Please log in first', 'error');
                return;
            }

            const appPassword = appPasswordInput ? appPasswordInput.value.replace(/-/g, '').trim() : '';
            
            // Validate app password is provided
            if (!appPassword || appPassword.length !== 16) {
                showCelebration('Please provide a valid 16-character app password', 'error');
                if (appPasswordInput) {
                    appPasswordInput.focus();
                    appPasswordInput.parentElement.classList.add('error-shake');
                    setTimeout(() => appPasswordInput.parentElement.classList.remove('error-shake'), 500);
                }
                return;
            }

            // Show confirmation popup before activating
            showGreeterConfirmation(() => performGreeterActivation(appPassword, submitBtn));
        }
        
        function showGreeterConfirmation(onConfirm) {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'greeter-confirmation-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.75);
                backdrop-filter: blur(4px);
                z-index: 10002;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'greeter-confirmation-popup';
            popup.style.cssText = `
                background: linear-gradient(135deg, #2c1810 0%, #4a3428 100%);
                padding: 2.5rem;
                border: 3px solid var(--reverie-core-color, #734ba1);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 
                           0 0 40px rgba(115, 75, 161, 0.3);
                max-width: 500px;
                text-align: center;
                transform: scale(0.9);
                opacity: 0;
                transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            `;
            
            popup.innerHTML = `
                <div style="color: #e8d5c4; font-size: 1.4rem; font-weight: 700; margin-bottom: 1rem; 
                           text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                    Become Greeter of Reveries?
                </div>
                <div style="color: #d4c1b0; font-size: 0.95rem; line-height: 1.6; margin-bottom: 2rem; opacity: 0.9;">
                    You will greet newcomers and welcome them to our world.<br>
                    This role requires care and attention.<br>
                    <strong style="color: #f4e4d4;">Please stop if it feels like work.</strong>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="greeter-confirm-no" 
                            style="padding: 0.85rem 2rem; 
                                   background: rgba(255, 255, 255, 0.1); 
                                   color: #e8d5c4; 
                                   border: 2px solid rgba(255, 255, 255, 0.2); 
                                   font-weight: 600; 
                                   font-size: 0.95rem; 
                                   cursor: pointer; 
                                   transition: all 0.2s;
                                   text-transform: uppercase;
                                   letter-spacing: 0.5px;">
                        Not Yet
                    </button>
                    <button class="greeter-confirm-yes" 
                            style="padding: 0.85rem 2rem; 
                                   background: var(--reverie-core-color, #734ba1); 
                                   color: white; 
                                   border: 2px solid var(--reverie-core-color, #734ba1); 
                                   font-weight: 700; 
                                   font-size: 0.95rem; 
                                   cursor: pointer; 
                                   transition: all 0.2s;
                                   text-transform: uppercase;
                                   letter-spacing: 0.5px;
                                   box-shadow: 0 4px 12px rgba(115, 75, 161, 0.4);">
                        Yes, Begin
                    </button>
                </div>
            `;
            
            // Add hover effects
            const style = document.createElement('style');
            style.textContent = `
                .greeter-confirm-no:hover {
                    background: rgba(255, 255, 255, 0.15) !important;
                    border-color: rgba(255, 255, 255, 0.3) !important;
                    transform: translateY(-1px);
                }
                .greeter-confirm-yes:hover {
                    filter: brightness(1.1);
                    transform: translateY(-1px);
                    box-shadow: 0 6px 16px rgba(115, 75, 161, 0.5) !important;
                }
            `;
            document.head.appendChild(style);
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Trigger animations
            requestAnimationFrame(() => {
                overlay.style.opacity = '1';
                popup.style.opacity = '1';
                popup.style.transform = 'scale(1)';
            });
            
            // Button handlers
            popup.querySelector('.greeter-confirm-no').onclick = () => {
                overlay.style.opacity = '0';
                popup.style.transform = 'scale(0.9)';
                setTimeout(() => overlay.remove(), 300);
            };
            
            popup.querySelector('.greeter-confirm-yes').onclick = () => {
                overlay.style.opacity = '0';
                popup.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    overlay.remove();
                    onConfirm();
                }, 300);
            };
            
            // Close on overlay click
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    overlay.style.opacity = '0';
                    popup.style.transform = 'scale(0.9)';
                    setTimeout(() => overlay.remove(), 300);
                }
            };
        }
        
        async function performGreeterActivation(appPassword, submitBtn) {
            // Update button state to show processing
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'BECOMING...';
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.7';
            submitBtn.style.cursor = 'wait';

            try {
                // Get auth token
                // Get token from current session
                let token = null;
                if (currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                } else {
                    token = localStorage.getItem('oauth_token');
                    if (!token) {
                        token = localStorage.getItem('admin_token');
                    }
                }

                const payload = {
                    appPassword: appPassword  // Provide app password for greeter worker to use
                };
                
                console.log('üîê Activating greeter with app password for posting');

                const response = await fetch('/api/work/greeter/activate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        greeterStatus = await response.json();
                        
                        // Show loading overlay
                        showLoadingOverlay('Confirming your status...');
                        
                        // Refresh UI
                        await loadGreeterStatus();
                        updateUI();
                        
                        // Emit event for cross-page synchronization
                        if (window.WorkEvents) {
                            window.WorkEvents.emit(window.WorkEvents.EVENTS.GREETER_ACTIVATED, {
                                timestamp: new Date().toISOString(),
                                useExistingCredentials: false
                            });
                        }
                        
                        // Hide loading overlay
                        hideLoadingOverlay();
                        
                        // Show celebration
                        showCelebration('You are now Greeter of Reveries\nThank you for working!\nPlease stop if it feels like work.', 'success');
                    } else {
                        const text = await response.text();
                        console.error('‚ö†Ô∏è Work: Non-JSON response:', text);
                        showLoadingOverlay('Confirming your status...');
                        await loadGreeterStatus();
                        updateUI();
                        hideLoadingOverlay();
                        showCelebration('Activation succeeded but received unexpected response format', 'warning');
                    }
                } else {
                    const contentType = response.headers.get('content-type');
                    let errorMessage = 'Unknown error';
                    let userFriendlyMessage = '';
                    
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        errorMessage = error.message || error.error || 'Unknown error';
                        console.error('‚ùå Work: Activation failed (JSON):', error);
                    } else {
                        errorMessage = await response.text();
                        console.error('‚ùå Work: Activation failed (text):', errorMessage);
                    }
                    
                    // Convert error messages to user-friendly versions
                    if (response.status === 429 || errorMessage.includes('Rate limit') || errorMessage.includes('Rate Limit Exceeded')) {
                        userFriendlyMessage = 'Too many authentication attempts.\n\nBluesky is temporarily blocking login attempts. Please wait 10-15 minutes and try again.';
                    } else if (errorMessage.includes('Invalid app password') || 
                        errorMessage.includes('authentication failed') ||
                        errorMessage.includes('Invalid identifier or password') ||
                        errorMessage.includes('AuthenticationRequired') ||
                        response.status === 401) {
                        userFriendlyMessage = 'The app password you entered is incorrect.\n\nPlease check that you copied it correctly from your Bluesky settings.';
                    } else if (errorMessage.includes('Another greeter is currently active') || 
                               response.status === 409) {
                        userFriendlyMessage = 'Another greeter is currently active and working.\n\nThey must mark themselves as retiring before you can volunteer.';
                    } else if (errorMessage.includes('Could not resolve PDS') || 
                               errorMessage.includes('Failed to validate')) {
                        userFriendlyMessage = 'Could not connect to your account server.\n\nPlease check your internet connection and try again.';
                    } else if (errorMessage.includes('DID mismatch')) {
                        userFriendlyMessage = 'The app password belongs to a different account.\n\nPlease make sure you\'re logged in with the correct account.';
                    } else if (response.status === 500) {
                        userFriendlyMessage = 'Something went wrong on our end.\n\nPlease try again in a moment.';
                    } else {
                        // Generic fallback with original error
                        userFriendlyMessage = 'Activation failed.\n\n' + errorMessage;
                    }
                    
                    // Reset button state
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                    
                    showCelebration(userFriendlyMessage, 'error');
                }
            } catch (error) {
                console.error('‚ùå Work: Activation error:', error);
                
                // Hide loading overlay in case it was shown
                hideLoadingOverlay();
                
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                
                // Friendly network error message
                let userMessage = 'Could not connect to the server.\n\nPlease check your internet connection and try again.';
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    userMessage = 'Unable to reach the server.\n\nPlease check your internet connection.';
                } else if (error.message.includes('timeout')) {
                    userMessage = 'The server took too long to respond.\n\nPlease try again.';
                }
                
                showCelebration(userMessage, 'error');
            }
        }

        // ====== UNIVERSAL ROLE MANAGEMENT FUNCTIONS ======
        
        async function deactivateRole(role) {
            if (!window.StepDownWidget) {
                console.error('StepDownWidget not loaded');
                return;
            }

            window.StepDownWidget.show(role, async () => {
                try {
                    // Get token - use same priority as other API calls
                    // Priority: backend session token > PDS accessJwt
                    let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                    
                    if (!token && currentSession && currentSession.accessJwt) {
                        token = currentSession.accessJwt;
                    }

                    const response = await fetch(`/api/work/${role}/step-down`, {
                        method: 'POST',
                        headers: {
                            'Authorization': token ? `Bearer ${token}` : ''
                        }
                    });

                    if (response.ok) {
                        roleStatuses[role] = { is_worker: false, status: null };
                        await loadRoleStatus(role);
                        updateUI();
                        
                        if (window.WorkEvents) {
                            const eventName = `${role.toUpperCase()}_STEPPED_DOWN`;
                            if (window.WorkEvents.EVENTS[eventName]) {
                                window.WorkEvents.emit(window.WorkEvents.EVENTS[eventName], {
                                    timestamp: new Date().toISOString()
                                });
                            }
                        }
                        
                        const config = roleConfigs[role];
                        const roleTitle = config ? config.title : role;
                        showCelebration(`You are no longer ${roleTitle}.\nThank you for your work!\nPlease return if you ever desire.`, 'success');
                    } else {
                        const errorText = await response.text();
                        console.error('‚ùå Work: Step down failed:', response.status, errorText);
                        showCelebration('Failed to step down. Please try again.', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Work: Step down error:', error);
                    showCelebration('Failed to step down: ' + error.message, 'error');
                }
            });
        }
        
        async function setRoleRetiring(role) {
            try {
                // Get token - use same priority as other API calls
                // Priority: backend session token > PDS accessJwt
                let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                
                if (!token && currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                }

                const response = await fetch(`/api/work/${role}/set-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({ status: 'retiring' })
                });

                if (response.ok) {
                    await loadRoleStatus(role);
                    updateUI();
                    
                    if (window.WorkEvents) {
                        const eventName = `${role.toUpperCase()}_STATUS_CHANGED`;
                        if (window.WorkEvents.EVENTS[eventName]) {
                            window.WorkEvents.emit(window.WorkEvents.EVENTS[eventName], {
                                timestamp: new Date().toISOString(),
                                status: 'retiring'
                            });
                        }
                    }
                    
                    showCelebration('Status updated to retiring.\nYou will be replaced when someone new volunteers.', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Work: Status update failed:', response.status, errorText);
                    showCelebration('Failed to update status. Please try again.', 'error');
                }
            } catch (error) {
                console.error('‚ùå Work: Status update error:', error);
                showCelebration('Failed to update status: ' + error.message, 'error');
            }
        }
        
        // ====== LEGACY GREETER-SPECIFIC FUNCTIONS ======

        async function deactivateGreeter() {
            // Use the StepDownWidget for consistent UI
            if (!window.StepDownWidget) {
                console.error('StepDownWidget not loaded');
                return;
            }

            window.StepDownWidget.show('greeter', async () => {
                // Perform the actual step-down
                try {
                    // Get token from current session
                    let token = null;
                    if (currentSession && currentSession.accessJwt) {
                        token = currentSession.accessJwt;
                    } else {
                        token = localStorage.getItem('oauth_token');
                        if (!token) {
                            token = localStorage.getItem('admin_token');
                        }
                    }

                    const response = await fetch('/api/work/greeter/step-down', {
                        method: 'POST',
                        headers: {
                            'Authorization': token ? `Bearer ${token}` : ''
                        }
                    });

                    if (response.ok) {
                        greeterStatus = { is_worker: false, status: null };
                        await loadGreeterStatus();
                        updateUI();
                        
                        // Emit event for cross-page synchronization
                        if (window.WorkEvents) {
                            window.WorkEvents.emit(window.WorkEvents.EVENTS.GREETER_STEPPED_DOWN, {
                                timestamp: new Date().toISOString()
                            });
                        }
                        
                        showCelebration('You are no longer Greeter of Reveries.\nThank you for your work!\nPlease return if you ever desire.', 'success');
                    } else {
                        const errorText = await response.text();
                        console.error('‚ùå Work: Step down failed:', response.status, errorText);
                        showCelebration('Failed to step down. Please try again.', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Work: Step down error:', error);
                    showCelebration('Failed to step down: ' + error.message, 'error');
                }
            });
        }

        async function setRetiring() {
            // Show custom retirement options popup
            showRetirementOptions();
        }

        // Retirement options popup with three buttons
        function showRetirementOptions() {
            // Create popup overlay
            const overlay = document.createElement('div');
            overlay.className = 'retirement-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'retirement-popup';
            popup.style.cssText = `
                background: linear-gradient(135deg, #8b7355 0%, #a0826d 100%);
                padding: 2rem 3rem;
                border: 4px solid #5d4a37;
                border-radius: 0;
                box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6);
                max-width: 550px;
                text-align: center;
                animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                position: relative;
            `;
            
            popup.innerHTML = `
                <div style="color: white; font-size: 1.3rem; font-weight: 700; margin-bottom: 1rem; line-height: 1.5;">
                    Are you ready to retire?
                </div>
                <div style="color: rgba(255,255,255,0.9); font-size: 1rem; margin-bottom: 1.5rem; line-height: 1.6;">
                    When someone else wishes to work as Greeter of Reveries, they will automatically release and replace you when they are ready to do so.<br><br>
                    Or you may step down now if you wish, and leave the work immediately.
                </div>
                <div style="display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap; margin-bottom: 0.75rem;">
                    <button class="retire-now" 
                            style="padding: 0.75rem 1.5rem; background: #a0826d; color: white; border: 2px solid #8b7355; 
                                   font-weight: 700; font-size: 0.95rem; cursor: pointer; border-radius: 0;
                                   box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.2s;">
                        STEP DOWN
                    </button>
                    <button class="retire-ready" 
                            style="padding: 0.75rem 1.5rem; background: #5d4a37; color: white; border: 2px solid #3d2a1f; 
                                   font-weight: 700; font-size: 0.95rem; cursor: pointer; border-radius: 0;
                                   box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.2s;">
                        READY TO RETIRE
                    </button>
                </div>
                <div style="display: flex; justify-content: center;">
                    <button class="retire-close continue-working-btn" 
                            style="padding: 0.9rem 2rem; background: linear-gradient(135deg, #3d8b8b 0%, #2a6b6b 100%); 
                                   color: white; border: 3px solid #2a6b6b; 
                                   font-weight: 700; font-size: 1.05rem; cursor: pointer; border-radius: 0;
                                   box-shadow: 0 6px 20px rgba(61, 139, 139, 0.4); 
                                   transition: all 0.3s ease;
                                   animation: gentlePulse 2s ease-in-out infinite;">
                        CONTINUE WORKING
                    </button>
                </div>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Add CSS animation for the Continue Working button
            if (!document.getElementById('continue-working-styles')) {
                const style = document.createElement('style');
                style.id = 'continue-working-styles';
                style.textContent = `
                    @keyframes gentlePulse {
                        0%, 100% { 
                            transform: scale(1);
                            box-shadow: 0 6px 20px rgba(61, 139, 139, 0.4);
                        }
                        50% { 
                            transform: scale(1.02);
                            box-shadow: 0 7px 24px rgba(61, 139, 139, 0.5);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Button handlers
            popup.querySelector('.retire-ready').onclick = async () => {
                overlay.remove();
                await setRetiringStatus();
            };
            
            popup.querySelector('.retire-now').onclick = async () => {
                overlay.remove();
                await deactivateGreeter();
            };
            
            popup.querySelector('.retire-close').onclick = () => {
                overlay.remove();
            };
        }

        async function setRetiringStatus() {
            try {
                // Get token from current session
                let token = null;
                if (currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                } else {
                    token = localStorage.getItem('oauth_token');
                    if (!token) {
                        token = localStorage.getItem('admin_token');
                    }
                }

                const response = await fetch('/api/work/greeter/set-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({ status: 'retiring' })
                });

                if (response.ok) {
                    greeterStatus.status = 'retiring';
                    await loadGreeterStatus();
                    updateUI();
                    
                    // Emit event for cross-page synchronization
                    if (window.WorkEvents) {
                        window.WorkEvents.emit(window.WorkEvents.EVENTS.GREETER_STATUS_CHANGED, {
                            status: 'retiring',
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    showCelebration('Congratulations on your retirement.\nYou will be replaced as soon as possible.\nThank you for working!\n\nPlease continue operating as you see fit.', 'success', 'OKAY?');
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Work: Set retiring failed:', response.status, errorText);
                    showCelebration('Failed to set status. Please try again.', 'error');
                }
            } catch (error) {
                console.error('‚ùå Work: Set retiring error:', error);
                showCelebration('Failed to set status: ' + error.message, 'error');
            }
        }

        function showAlreadyWorkingMessage() {
            showCelebration('You are already working.\nThank you for working!', 'success');
        }

        async function setWorking() {
            try {
                // Get token from current session
                let token = null;
                if (currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                } else {
                    token = localStorage.getItem('oauth_token');
                    if (!token) {
                        token = localStorage.getItem('admin_token');
                    }
                }

                const response = await fetch('/api/work/greeter/set-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({ status: 'working' })
                });

                if (response.ok) {
                    greeterStatus.status = 'working';
                    await loadGreeterStatus();
                    updateUI();
                    
                    // Emit event for cross-page synchronization
                    if (window.WorkEvents) {
                        window.WorkEvents.emit(window.WorkEvents.EVENTS.GREETER_STATUS_CHANGED, {
                            status: 'working',
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    showCelebration('Welcome back! You are now actively working as Greeter again.', 'success');
                } else {
                    showCelebration('Failed to update status. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Set working error:', error);
                showCelebration('Failed to update status: ' + error.message, 'error');
            }
        }

        // Confirmation popup with two buttons
        function showConfirmation(message, onConfirm) {
            // Create popup overlay
            const overlay = document.createElement('div');
            overlay.className = 'confirmation-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'confirmation-popup';
            popup.style.cssText = `
                background: linear-gradient(135deg, #8b7355 0%, #a0826d 100%);
                padding: 2rem 3rem;
                border: 4px solid #5d4a37;
                border-radius: 0;
                box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6);
                max-width: 500px;
                text-align: center;
                animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                position: relative;
            `;
            
            popup.innerHTML = `
                <div style="color: white; font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; line-height: 1.5;">
                    ${message}
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="confirm-no" 
                            style="padding: 0.75rem 2rem; background: white; color: #8b7355; border: none; 
                                   font-weight: 700; font-size: 1rem; cursor: pointer; border-radius: 0;
                                   box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.2s;">
                        NO NOT YET
                    </button>
                    <button class="confirm-yes" 
                            style="padding: 0.75rem 2rem; background: #5d4a37; color: white; border: none; 
                                   font-weight: 700; font-size: 1rem; cursor: pointer; border-radius: 0;
                                   box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.2s;">
                        STEP DOWN
                    </button>
                </div>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Button handlers
            popup.querySelector('.confirm-no').onclick = () => {
                overlay.remove();
            };
            
            popup.querySelector('.confirm-yes').onclick = () => {
                overlay.remove();
                onConfirm();
            };
        }

        // Celebration popup and bubble system
        function showCelebration(message, type = 'success', buttonText = 'OKAY') {
            // Convert \n to <br> for multi-line messages
            const formattedMessage = message.replace(/\n/g, '<br>');
            
            // Create popup overlay
            const overlay = document.createElement('div');
            overlay.className = 'celebration-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'celebration-popup';
            popup.style.cssText = `
                background: linear-gradient(135deg, #8b7355 0%, #a0826d 100%);
                padding: 2rem 3rem;
                border: 4px solid #5d4a37;
                border-radius: 0;
                box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6);
                max-width: 500px;
                text-align: center;
                animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                position: relative;
            `;
            
            popup.innerHTML = `
                <div style="color: white; font-size: 1.3rem; font-weight: 700; margin-bottom: 1rem; line-height: 1.5;">
                    ${formattedMessage}
                </div>
                <button onclick="this.closest('.celebration-overlay').remove()" 
                        style="padding: 0.75rem 2rem; background: white; color: #8b7355; border: none; 
                               font-weight: 700; font-size: 1rem; cursor: pointer; border-radius: 0;
                               box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.2s;">
                    ${buttonText}
                </button>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Launch bubbles only for success messages
            if (type === 'success') {
                launchBubbles();
            }
            
            // Add CSS animations
            if (!document.getElementById('celebration-styles')) {
                const style = document.createElement('style');
                style.id = 'celebration-styles';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes popIn {
                        0% { transform: scale(0.3); opacity: 0; }
                        50% { transform: scale(1.05); }
                        100% { transform: scale(1); opacity: 1; }
                    }
                    @keyframes bubbleRise {
                        0% { 
                            transform: translateY(0) translateX(0) scale(0);
                            opacity: 0;
                        }
                        10% {
                            opacity: 1;
                            transform: translateY(-10vh) translateX(0) scale(1);
                        }
                        90% {
                            opacity: 1;
                        }
                        100% { 
                            transform: translateY(-100vh) translateX(var(--drift)) scale(0.8);
                            opacity: 0;
                        }
                    }
                    .celebration-overlay button:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 16px rgba(0,0,0,0.4);
                    }
                `;
                document.head.appendChild(style);
            }
        }

        async function launchBubbles() {
            const bubbleCount = 20;
            
            // Get random souvenir icons
            const souvenirIcons = await BubbleFactory.getRandomSouvenirIcons(bubbleCount);
            
            for (let i = 0; i < bubbleCount; i++) {
                setTimeout(() => {
                    const souvenir = souvenirIcons[i % souvenirIcons.length];
                    const randomX = Math.random() * window.innerWidth;
                    const randomDrift = (Math.random() - 0.5) * 200;
                    const randomDuration = 3 + Math.random() * 2;
                    const randomDelay = Math.random() * 0.5;
                    const randomSize = 40 + Math.random() * 40;
                    
                    // Create bubble using standardized factory
                    const bubble = BubbleFactory.createBubble(souvenir.icon, randomSize, {
                        clickable: false,
                        souvenirKey: souvenir.key,
                        souvenirName: souvenir.name
                    });
                    
                    bubble.style.cssText += `
                        position: fixed;
                        bottom: -100px;
                        left: ${randomX}px;
                        z-index: 10002;
                        animation: bubbleRise ${randomDuration}s ease-out ${randomDelay}s forwards;
                        --drift: ${randomDrift}px;
                        opacity: 0.8;
                    `;
                    
                    document.body.appendChild(bubble);
                    
                    // Remove after animation
                    setTimeout(() => {
                        bubble.remove();
                    }, (randomDuration + randomDelay) * 1000);
                }, i * 100);
            }
        }

        // Open introduce yourself modal
        function openIntroduceModal() {
            showCelebration(
                'Introduce yourself feature coming soon!\\n\\nThis will allow new dreamers to share their story with the community.',
                'info',
                'UNDERSTOOD'
            );
        }
    </script>
</body>
</html>
