<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/">
    <title>Reverie House â€” Workshop</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Become a self-appointed worker at Reverie House by taking on a role that will help its survival or enrich our wild mindscape. Retire whenever you please!">
    <meta name="keywords" content="workshop, creative writing, collaboration, worldbuilding, storytelling, reverie house">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://reverie.house/work.html">
    <meta property="og:title" content="Workshop - Reverie House">
    <meta property="og:description" content="Become a self-appointed worker at Reverie House by taking on a role that will enrich our wild mindscape.">
    <meta property="og:image" content="https://reverie.house/assets/og-image.png">
    <meta property="og:site_name" content="Reverie House">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Workshop - Reverie House">
    <meta name="twitter:description" content="Become a self-appointed worker at Reverie House by taking on a role that will help its survival or enrich our wild mindscape. Retire whenever you please!">
    <meta name="twitter:image" content="https://reverie.house/assets/og-image.png">
    
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/heraldry.css">
    <link rel="stylesheet" href="/css/pages/work.css">
    <link rel="stylesheet" href="/css/pages/dreamer.css">
    <link rel="stylesheet" href="/css/pages/database.css">
    <link rel="stylesheet" href="/css/widgets/login.css">
    <link rel="stylesheet" href="/css/widgets/createdreamer.css">
    <link rel="stylesheet" href="/css/widgets/dialogue.css">
    <link rel="stylesheet" href="/css/widgets/dreamer-hover.css">
    <link rel="stylesheet" href="/css/widgets/showdreamer.css">
    <link rel="stylesheet" href="/css/color-rows.css">
    <link rel="preload" href="/css/octants.css" as="style">
    <link rel="preload" href="/css/roles.css" as="style">
    <link rel="preload" href="/css/souvenirs.css" as="style">
    <link rel="stylesheet" href="/css/octants.css">
    <link rel="stylesheet" href="/css/roles.css">
    <link rel="stylesheet" href="/css/souvenirs.css">
    <!-- Ensure role-based colors from roles.css are enforced on this page
         - Keep bursar current box border using roles variables
         - Ensure link text colors follow the active role (bursar here) -->
    <style>
    /* Bursar-specific enforcement when bursar is the current role */
    body[data-current-role="bursar"] .bursar-box,
    body[data-current-role="bursar"] .role-separator,
    body[data-current-role="bursar"] .role-content-separator {
        border-color: var(--role-bursar-medium) !important;
    }
    body[data-current-role="bursar"] .bursar-box {
        border: 2px solid var(--role-bursar-medium) !important;
    }
    /* Note: .role-worker-card and .worker-card-header excluded to allow 
       user's personal color (set via JavaScript) to show through */

    /* Scoped bursar link colors - only within work content, not header */
    body[data-current-role="bursar"] .work-main-content a:not(.header-link):not(.drawer-link):not(.nav-link) {
        color: var(--role-bursar);
    }
    body[data-current-role="bursar"] .work-main-content a:not(.header-link):not(.drawer-link):not(.nav-link):hover,
    body[data-current-role="bursar"] .work-main-content a:not(.header-link):not(.drawer-link):not(.nav-link):focus {
        color: var(--role-bursar-dark);
    }
    
    /* Tangled Dolly icon styling */
    .tangled-dolly-icon {
        width: 16px;
        height: 16px;
        display: inline-block;
        vertical-align: middle;
        margin-right: 4px;
    }
    
    /* Tangled integration note styling */
    .tangled-integration-note {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        margin-top: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        font-size: 0.85em;
        color: var(--text-muted);
    }
    .tangled-integration-note .tangled-text {
        flex: 1;
    }
    .tangled-integration-note code {
        background: rgba(255, 255, 255, 0.1);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
    }
    
    /* Disabled bursar box styling */
    .bursar-box-disabled {
        opacity: 0.5;
        pointer-events: none;
        position: relative;
    }
    .bursar-box-disabled::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(128, 128, 128, 0.1);
        border-radius: inherit;
    }
    .bursar-box-disabled input,
    .bursar-box-disabled button,
    .bursar-box-disabled textarea {
        cursor: not-allowed !important;
    }
    
    /* Cheerful-specific enforcement when cheerful is the current role */
    body[data-current-role="cheerful"] .cheerful-list-card,
    body[data-current-role="cheerful"] .cheerful-stats-box,
    body[data-current-role="cheerful"] .role-separator,
    body[data-current-role="cheerful"] .role-content-separator {
        border-color: var(--role-cheerful-medium) !important;
    }
    
    /* Scoped cheerful link colors - only within work content, not header */
    body[data-current-role="cheerful"] .work-main-content a:not(.header-link):not(.drawer-link):not(.nav-link) {
        color: var(--role-cheerful);
    }
    body[data-current-role="cheerful"] .work-main-content a:not(.header-link):not(.drawer-link):not(.nav-link):hover,
    body[data-current-role="cheerful"] .work-main-content a:not(.header-link):not(.drawer-link):not(.nav-link):focus {
        color: var(--role-cheerful-dark);
    }
    .bursar-box-subtext {
        font-size: 0.85em;
        color: var(--text-muted);
        font-style: italic;
        margin-top: 8px;
    }
    </style>
    
    <!-- Favicon and Icons -->
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    
    <!-- Core utilities -->
    <script src="/js/core/world-config-cache.js"></script>
    <script src="/js/core/color-manager.js"></script>
    <script src="/js/core/rowstyle-registry.js?v=1765642342"></script>
    <script src="/js/core/rowstyle-engine.js"></script>
    <script src="/js/utils/shadowbox.js"></script>
    <script src="/js/utils/heraldry.js"></script>
    <script src="/js/widgets/showdreamer.js"></script>
    <script src="/js/widgets/showpost.js"></script>
    <script src="/js/widgets/background.js"></script>
    <script src="/js/widgets/bubble.js"></script>
    
    <!-- Work utilities -->
    <script src="/js/utils/work-api.js"></script>
    <script src="/js/utils/work-events.js"></script>
    
    <!-- Work widgets -->
    <script type="module" src="/js/widgets/spectrumpreview.js?v=1763454411"></script>
    <script src="/js/widgets/eventstack.js?v=1765642847"></script>
    
    <!-- Header and drawer widgets -->
    <script src="/js/widgets/header.js" defer></script>
    <script type="module" src="/js/widgets/oauth-manager.js"></script>
    <script src="/js/widgets/login.js" defer></script>
    <script src="/js/widgets/createdreamer.js" defer></script>
    <script src="/js/widgets/drawer.js" defer></script>
    <script src="/js/widgets/konami.js" defer></script>
    <script src="/js/widgets/dreamer-hover.js" defer></script>
    <script src="/js/widgets/wink.js" defer></script>
    <script src="/js/widgets/stepdown.js" defer></script>
    <script src="/js/widgets/upload_avatar.js" defer onerror="console.error('Failed to load upload_avatar.js')"></script>
    <script src="/js/widgets/apppassreq.js" defer></script>
    <script src="/js/widgets/changehandle.js" defer></script>
</head>
<body>
    <div id="header-container"></div>

    <!-- Full-Screen Background Scene -->
    <div class="fullscreen-background">
        <div class="scene-background">
            <img src="souvenirs/residence/phanera.png" alt="Phanera Residence" class="scene-layer background-layer">
        </div>
    </div>

    <!-- Main Content -->
    <div class="work-page-container">
        <!-- Left Sidebar -->
        <div class="work-sidebar">
            <!-- Header Section -->
            <div class="sidebar-header">
                <img src="/assets/logo.png" alt="Reverie House Logo" class="sidebar-logo">
                <div class="sidebar-title">
                    <img src="/assets/icon.png" alt="" class="title-icon">
                    <h1>WORKSHOP</h1>
                    <img src="/assets/icon_face.png" alt="" class="title-icon">
                </div>
                <p class="sidebar-subtitle">Do those for which you care.</p>
            </div>

            <!-- User Status Section -->
            <div id="sidebar-user-section" class="sidebar-user-section">
                <!-- Loading State -->
                <div id="sidebar-loading" class="sidebar-loading">
                    <div class="loading-spinner"></div>
                    <div id="loading-state-text" class="loading-text">Checking session...</div>
                </div>

                <!-- Guest State -->
                <div id="sidebar-guest" class="sidebar-guest" style="display: none;">
                    <div class="guest-message">
                        <p>Only dreamweavers of Reverie House may self-elect for workshop roles.</p>
                    </div>
                    <button class="sidebar-login-btn" onclick="triggerLogin()">
                        Dreamweaver Login
                    </button>
                </div>

                <!-- User Logged In -->
                <div id="sidebar-user" class="sidebar-user" style="display: none;">
                    <div class="sidebar-avatar-container">
                        <img id="sidebar-avatar" src="/assets/icon_face.png" alt="Avatar" class="sidebar-avatar">
                    </div>
                    <div class="sidebar-user-info">
                        <div id="sidebar-user-name" class="sidebar-user-name">Loading...</div>
                        <div id="sidebar-user-handle" class="sidebar-user-handle">@...</div>
                    </div>
                    <!-- Work Status -->
                    <div class="sidebar-work-status">
                        <div class="status-label">Work Status</div>
                        <div id="sidebar-status-content" class="status-content">
                            <span class="status-badge not-working">DREAMWEAVER</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Work Philosophy -->
            <div class="sidebar-philosophy">
                <p>There are no jobs, no managers, no orders.</p>
                <p>Yet, there are always things needing done.</p>
                <p>Work is self-assigned and voluntary.</p>
                <p>You may step down or retire as you please.</p>
            </div>
        </div>

        <!-- Right Content Area -->
        <div class="work-content">
            <!-- Role Content Card -->
            <div class="role-card">
                <!-- Role Tabs Container -->
                <div class="role-tabs-carousel">
                    <div id="core-roles-panel" class="role-panel active" data-panel="core">
                        <div class="role-tabs">
                            <button class="role-tab active" data-role="greeter" onclick="selectRole('greeter')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="role-tab-icon">
                                    <path d="M18 11V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2"></path>
                                    <path d="M14 10V4a2 2 0 0 0-2-2a2 2 0 0 0-2 2v2"></path>
                                    <path d="M10 10.5V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2v8"></path>
                                    <path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"></path>
                                </svg>
                                <span class="role-tab-name">Greeter</span>
                            </button>
                            <button class="role-tab" data-role="mapper" onclick="selectRole('mapper')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="role-tab-icon">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>
                                </svg>
                                <span class="role-tab-name">Mapper</span>
                            </button>
                            <button class="role-tab" data-role="cogitarian" onclick="selectRole('cogitarian')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="role-tab-icon">
                                    <path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"></path>
                                    <path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"></path>
                                </svg>
                                <span class="role-tab-name">Cogitarian</span>
                            </button>
                            <button class="role-tab" data-role="provisioner" onclick="selectRole('provisioner')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="role-tab-icon">
                                    <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path>
                                    <path d="M7 2v20"></path>
                                    <path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path>
                                </svg>
                                <span class="role-tab-name">Provisioner</span>
                            </button>
                            <button id="role-tab-bursar" class="role-tab admin-only-role" data-role="bursar" onclick="selectRole('bursar')" style="display: none;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="role-tab-icon">
                                    <rect x="2" y="4" width="20" height="16" rx="2"/>
                                    <path d="M12 8v8"/>
                                    <path d="M8 12h8"/>
                                    <circle cx="12" cy="12" r="2"/>
                                    <path d="M2 10h20"/>
                                </svg>
                                <span class="role-tab-name">Bursar</span>
                            </button>
                            <button id="role-tab-dreamstyler" class="role-tab" data-role="dreamstyler" onclick="selectRole('dreamstyler')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="role-tab-icon">
                                    <path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path>
                                    <path d="M20 3v4"></path>
                                    <path d="M22 5h-4"></path>
                                    <path d="M4 17v2"></path>
                                    <path d="M5 18H3"></path>
                                </svg>
                                <span class="role-tab-name">Dreamstyler</span>
                            </button>
                            <button id="role-tab-cheerful" class="role-tab admin-only-role" data-role="cheerful" onclick="selectRole('cheerful')" style="display: none;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="role-tab-icon">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                                <span class="role-tab-name">Cheerful</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Mobile Role Selector -->
                <div class="role-selector-mobile">
                    <select id="role-selector-mobile" onchange="selectRole(this.value)">
                        <option value="greeter" selected>Greeter</option>
                        <option value="mapper">Mapper</option>
                        <option value="cogitarian">Cogitarian</option>
                        <option value="provisioner">Provisioner</option>
                        <option id="mobile-option-bursar" value="bursar" class="admin-only-role" style="display: none;">Bursar</option>
                        <option id="mobile-option-dreamstyler" value="dreamstyler">Dreamstyler</option>
                        <option id="mobile-option-cheerful" value="cheerful" class="admin-only-role" style="display: none;">Cheerful</option>
                    </select>
                </div>

                <!-- Role Card Body -->
                <div class="role-card-body">
                    <!-- Left: Role Title & Description -->
                    <div class="role-main-section">
                        <h2 class="role-title" id="role-title">Greeter of Reveries</h2>
                        
                        <!-- Greeter Description (default) -->
                        <div id="greeter-description" class="role-desc-content">
                            <p class="role-description">
                                Newcomers to <b>Reverie House</b> often need someone to show them the way, and a <b>Greeter</b> is usually the one to do it. It doesn't take much, but when someone new arrives they'll have <u><span id="you-link">you</span></u> to introduce and guide them.
                            </p>
                            <p class="role-description">
                                As <b>Greeter</b> you will automatically provide newcomers with their name, and offer them a friendly human hand to help them, should they need one.
                            </p>
                        </div>

                        <!-- Cogitarian Description -->
                        <div id="cogitarian-description" class="role-desc-content" style="display: none;">
                            <p class="role-description">
                                Our <b>Cogitarian</b> is a humanizing authority who helps codify human elements within our shared technical foundation and help deter dehumanizations.
                            </p>
                            <p class="role-description">
                                You will work closely with the current <b>Keeper(s)</b> to take responsibility for defining the immutably human aspects of our environment, in effort to keep our wild mindscape a more dependable place for real <span onclick="window.wink && window.wink(event)" style="cursor: pointer;">dreamrs</span>.
                            </p>
                        </div>
                        
                        <!-- Mapper Description -->
                        <div id="mapper-description" class="role-desc-content" style="display: none;">
                            <p class="role-description">
                                Every dream exists somewhere on a complex spectrum that can be measured. Knowing these coordinates can be incredibly helpful for dreamweavers looking to find (or avoid) particular reveries and nightmares.
                            </p>
                            <p class="role-description">
                                As <b>Spectrum Mapper</b> you will automatically reply the origin coordinates for all dreamers who reveal their beginnings within our wild mindscape.
                            </p>
                        </div>
                        
                        <!-- Provisioner Description -->
                        <div id="provisioner-description" class="role-desc-content" style="display: none;">
                            <p class="role-description">
                                Provisioners are dreamweavers who understand that ease of rest in the waking world eases all manner of dreams across our wild mindscape.
                            </p>
                            <p class="role-description">
                                When another dreamer at <b>Reverie House</b> feels the real pangs of hunger, it is <b>Head of Pantry</b> who will remotely try to ease their burden with food.
                            </p>
                        </div>
                        
                        <!-- Dreamstyler Description -->
                        <div id="dreamstyler-description" class="role-desc-content" style="display: none;">
                            <p class="role-description">
                                There is a wide difference between the aesthetics of dreams, and a highly visioned <b class="role-text-dreamstyler">Dreamstyler</b> is versatile enough to help shape the dreams of others.
                            </p>
                            <p class="role-description">
                                Because there are so many tastes, there are many types of <b class="role-text-dreamstyler">Dreamstyler</b> and <b class="role-text-dreamstyler">Reverie House</b> makes no distinction. Let yourself and talent be known to others, but maintain your own designs however you must.
                            </p>
                        </div>
                        
                        <!-- Bursar Description -->
                        <div id="bursar-description" class="role-desc-content" style="display: none;">
                            <p class="role-description">
                                Coordinating the use of scarce resources is a vital and indispensible role (according to the <b class="role-text-bursar">Bursar of Schemes</b>).
                            </p>
                            <p class="role-description">
                                This guardian of transparency works as the connective tissue between various patrons and the amazing dreams that need their support.
                            </p>
                        </div>
                        
                        <!-- Cheerful Description -->
                        <div id="cheerful-description" class="role-desc-content" style="display: none;">
                            <p class="role-description">
                                Uplifting others is both a calling and a labour worthy of recognition. It can be challenging to maintain our positivity, so <b class="role-text-cheerful">The Cheerful</b> lend their optimism as a constant. With trust in community, they surrender themselves to wild support.
                            </p>
                            <p class="role-description">
                                Like buoyant sprites, <b class="role-text-cheerful">The Cheerful of Reverie House</b> are compelled beyond any will to give favor to their community, no matter how quiet their voice.</p>
                        </div>
                    </div>

                    <!-- Right: Current Worker Card -->
                    <div class="role-worker-card">
                        <div class="worker-card-header">
                            <span class="worker-label" id="worker-label">CURRENT HOLDER</span>
                        </div>
                        <div id="worker-display" class="worker-details">
                            <span style="color: #999; font-style: italic; font-size: 0.8rem;">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Role Separator -->
                <hr class="role-separator">
                
                <!-- Mapper Content Section -->
                <div id="mapper-content-section" class="mapper-content-container" style="display: none;">
                    <!-- Two-column mapper layout: left (40%) with calculator, right (60%) empty reserved column -->
                    <div class="mapper-columns">
                        <div class="mapper-column-left">
                            <!-- Origin Calculator -->
                            <div id="spectrum-preview-container"></div>
                        </div>
                        <div class="mapper-column-right">
                            <!-- Reserved empty column for future controls / form -->
                            <!-- Persistent preview frame (empty until image is generated) -->
                            <div class="origin-preview-box placeholder">
                                <div class="origin-preview-inner">
                                        <div class="origin-preview-media">
                                            <div class="origin-preview-empty">No preview yet</div>
                                        </div>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Role-specific content area -->
                <div class="role-content-area">
                    <!-- Greeter Event Stack Section -->
                    <div id="greeter-eventstack-section" class="greeter-eventstack-container">
                        <div class="greeter-content-grid">
                            <!-- Left: Event Stack -->
                            <div class="greeter-eventstack-section">
                                <h3 class="eventstack-title">Greeter's Guestbook</h3>
                                <div id="greeter-eventstack" class="greeter-eventstack"></div>
                            </div>
                            
                            <!-- Right: Greetings and Intro -->
                            <div class="greeter-right-section">
                                <!-- Current Greetings -->
                                <div class="greeter-examples-carousel">
                                    <div class="example-nav">
                                        <button class="example-nav-btn" onclick="previousGreeting()">â€¹</button>
                                        <div class="example-label">Current Greetings</div>
                                        <button class="example-nav-btn" onclick="nextGreeting()">â€º</button>
                                    </div>
                                    <div id="greeter-greetings-display" class="greetings-display">
                                        <div class="greeting-text">Loading greetings...</div>
                                    </div>
                                </div>
                                
                                <!-- Introduce Yourself Section -->
                                <div class="introduce-section">
                                    <div class="introduce-header">
                                        Are you a dreamweaver?
                                    </div>
                                    <button class="introduce-btn" onclick="window.open('https://bsky.app/profile/reverie.house/post/3lljjzcydwc25', '_blank')">Introduce Yourself</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Cogitarian Content Section -->
                <div id="cogitarian-content-section" class="cogitarian-content-container" style="display: none;">
                    <div class="cogitarian-content-grid">
                        <!-- Left: Repo Card -->
                        <div class="repo-card">
                            <div class="repo-card-header">
                                <div class="repo-card-title">Keeper's Repository</div>
                            </div>
                            <div class="repo-card-actions">
                                <a href="https://github.com/errantson/reverie" target="_blank" class="repo-action-btn repo-btn-primary">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                                    </svg>
                                    View Repository
                                </a>
                                <a href="https://github.com/errantson/reverie/issues" target="_blank" class="repo-action-btn">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="8" x2="12" y2="12"></line>
                                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                    </svg>
                                    Issues
                                </a>
                                <a href="https://github.com/errantson/reverie/blob/main/CONTRIBUTING.md" target="_blank" class="repo-action-btn">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="18" cy="18" r="3"></circle>
                                        <circle cx="6" cy="6" r="3"></circle>
                                        <path d="M13 6h3a2 2 0 0 1 2 2v7"></path>
                                        <line x1="6" y1="9" x2="6" y2="21"></line>
                                    </svg>
                                    Contribution Guide
                                </a>
                                
                            </div>
                            <div id="repo-info" class="repo-info">
                                <div class="repo-info-item">
                                    <span class="repo-info-label">Languages:</span>
                                    <span class="repo-info-value">Loading...</span>
                                </div>
                                <div class="repo-info-item">
                                    <span class="repo-info-label">Updated:</span>
                                    <span class="repo-info-value">Loading...</span>
                                </div>
                                <div class="repo-info-item">
                                    <span class="repo-info-label">Watchers:</span>
                                    <span class="repo-info-value">Loading...</span>
                                </div>
                                <div class="repo-info-item">
                                    <span class="repo-info-label">File Size:</span>
                                    <span class="repo-info-value">Loading...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right: Commit History -->
                        <div class="repo-data-box">
                            <h3 class="repo-data-header">History of Improvement</h3>
                            <div id="repo-data-content" class="repo-data-content">
                                <div class="commits-section">
                                    <div class="commit-row loading-placeholder">
                                        <span class="commit-message">Loading...</span>
                                        <span class="commit-meta">...</span>
                                    </div>
                                    <div class="commit-row loading-placeholder">
                                        <span class="commit-message">Loading...</span>
                                        <span class="commit-meta">...</span>
                                    </div>
                                    <div class="commit-row loading-placeholder">
                                        <span class="commit-message">Loading...</span>
                                        <span class="commit-meta">...</span>
                                    </div>
                                    <div class="commit-row loading-placeholder">
                                        <span class="commit-message">Loading...</span>
                                        <span class="commit-meta">...</span>
                                    </div>
                                    <div class="commit-row loading-placeholder">
                                        <span class="commit-message">Loading...</span>
                                        <span class="commit-meta">...</span>
                                    </div>
                                </div>
                                <div class="contributors-section">
                                    <div class="contributors-label">Contributors</div>
                                    <div class="contributors-list">...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Provisioner Content Section -->
                <div id="provisioner-content-section" class="provisioner-content-container" style="display: none;">
                    <div class="provisioner-content-grid">
                        <!-- Left Box -->
                        <div class="provisioner-box">
                            <h3 class="provisioner-box-title">Feeding Dreamweavers</h3>
                            <p class="provisioner-box-text">
                                If you are a hungry dreamweaver and having some free food would help you dream better, then let our <b>Head of Pantry</b> know and they will try to arrange you a free food pickup through <a href="http://toogoodtogo.com">TooGoodToGo</a></b>
                            </p>
                            <p class="provisioner-box-text">
                                <i>Most pickups will be for next-day.</i>
                            </p>
                            <button class="provisioner-box-button" onclick="requestFoodPickup()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                                Request Food Pickup
                            </button>
                        </div>
                        
                        <!-- Right Box -->
                        <div class="provisioner-box">
                            <h3 class="provisioner-box-title">Being Provisioner</h3>
                            <p class="provisioner-box-text">
                                This is an experiment in effective altruism. Please accept that this is a human relationship, and both parties will need to be available to communicate.<br>
                                <i>Everyone will do their best!</i>
                            </p>
                            <p class="provisioner-box-text">
                                If you need reliable or long-term assistance, seek food banks or programs in your area.
                            </p>
                            <button class="provisioner-box-button" onclick="window.open('https://www.feedingamerica.org/find-your-local-foodbank/all-food-banks', '_blank')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                                Food Banks
                            </button>
                        </div>
                    </div>
                    
                    <!-- Provisioner Tools (only visible to active provisioner) -->
                    <div id="provisioner-tools-section" class="provisioner-tools-container" style="display: none; margin-top: 1rem;">
                        <div class="provisioner-box" style="background: rgba(100, 100, 100, 0.1);">
                            <h3 class="provisioner-box-title">ðŸ”§ Provisioner Tools</h3>
                            <p class="provisioner-box-text">
                                <b>Sync Follows:</b> Follow all reverie.house dreamers so they can DM you.
                                <br><i>This runs automatically when you activate, but you can run it manually if needed.</i>
                            </p>
                            <button class="provisioner-box-button" id="sync-follows-btn" onclick="syncProvisionerFollows()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="m3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                                </svg>
                                Sync Follows
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Dreamstyler Content Section -->
                <div id="dreamstyler-content-section" class="dreamstyler-content-container" style="display: none;">
                    <div class="dreamstyler-content-grid">
                        <!-- Left: Find Dreamstylers List -->
                        <div class="repo-card dreamstyler-list-card">
                            <div class="repo-card-header">
                                <div class="repo-card-title">Find Dreamstylers</div>
                            </div>
                            <div id="dreamstyler-list" class="dreamstyler-list">
                                <div class="dreamstyler-loading">Loading dreamstylers...</div>
                            </div>
                            <div class="dreamstyler-footer">
                                <p class="dreamstyler-footer-text">Dreamstylers don't retire.</p>
                                <p class="dreamstyler-footer-text">They just stop.</p>
                                <p class="dreamstyler-footer-text">Appreciate them while here.</p>
                            </div>
                        </div>
                        
                        <!-- Right: Aesthetic Adjustments -->
                        <div class="dreamstyler-right-column">
                            <div class="repo-data-box aesthetic-adjustments-box" style="flex: 1;">
                                <h3 class="repo-data-header">Aesthetic Adjustments</h3>
                                <div id="dreamstyler-commits-list" class="dreamstyler-commits-list">
                                    <!-- Empty placeholder rows with alternating colors -->
                                    <div class="commit-row empty-row even"></div>
                                    <div class="commit-row empty-row odd"></div>
                                    <div class="commit-row empty-row even"></div>
                                    <div class="commit-row empty-row odd"></div>
                                    <div class="commit-row empty-row even"></div>
                                </div>
                            </div>
                            <!-- Tangled integration footer (outside the box) -->
                            <div class="tangled-integration-footer">
                                <img src="/assets/brands/tangled-dolly-black.svg" alt="Tangled" class="tangled-dolly-icon">
                                <span class="tangled-text">Tag commits with <code>#dreamstyler</code> on <a href="https://tangled.org" target="_blank">tangled.org</a></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bursar Content Section -->
                <div id="bursar-content-section" class="bursar-content-container" style="display: none;">
                    <div class="bursar-content-grid">
                        <!-- Left Box: Reverie House Collective -->
                        <div class="bursar-box">
                            <h3 class="bursar-box-title">Reverie House</h3>
                            <p class="bursar-box-text">
                                Our collective treasury on <a href="https://opencollective.com/reverie-house" target="_blank">OpenCollective</a> for infrastructure and development.
                            </p>
                            <div class="bursar-stats">
                                <div class="bursar-stat-row">
                                    <span class="bursar-stat-label">Balance:</span>
                                    <span class="bursar-stat-value" id="oc-balance">$0.00</span>
                                </div>
                                <div class="bursar-stat-row">
                                    <span class="bursar-stat-label">Raised:</span>
                                    <span class="bursar-stat-value" id="oc-total-raised">$0.00</span>
                                </div>
                            </div>
                            <div class="bursar-box-actions">
                                <a href="https://opencollective.com/reverie-house" target="_blank" class="bursar-box-button bursar-btn-secondary">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                    View
                                </a>
                                <a href="https://opencollective.com/reverie-house/donate" target="_blank" class="bursar-box-button">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                    </svg>
                                    Contribute
                                </a>
                            </div>
                        </div>
                        
                        <!-- Right Box: Submit a Scheme -->
                        <div class="bursar-box bursar-box-disabled">
                            <h3 class="bursar-box-title">Submit a Scheme</h3>
                            <p class="bursar-box-text">
                                Have a domain that dreams? Submit it for treasury integration.
                            </p>
                            <div class="bursar-submit-form">
                                <input type="text" class="bursar-domain-input" id="scheme-domain-input" placeholder="yourdream.domain" disabled />
                                <button class="bursar-box-button" disabled title="Coming soon">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                    Coming Soon
                                </button>
                            </div>
                            <p class="bursar-box-subtext">Scheme submissions opening soon</p>
                        </div>
                    </div>
                </div>
                
                <!-- Cheerful Content Section -->
                <div id="cheerful-content-section" class="cheerful-content-container" style="display: none;">
                    <div class="cheerful-content-grid">
                        <!-- Left: The Cheerful List -->
                        <div class="repo-card cheerful-list-card">
                            <div class="repo-card-header">
                                <div class="repo-card-title">The Cheerful</div>
                            </div>
                            <div id="cheerful-list" class="cheerful-list">
                                <div class="cheerful-loading">Loading cheerful members...</div>
                            </div>
                            <div class="cheerful-footer">
                                <p class="cheerful-footer-text">The Cheerful like you!</p>
                            </div>
                        </div>
                        
                        <!-- Right: Spreading Cheer -->
                        <div class="cheerful-right-column">
                            <div class="repo-data-box cheerful-stats-box">
                                <h3 class="repo-data-header">Spreading Cheer</h3>
                                <div class="cheerful-stats-compact">
                                    <div class="cheerful-stat-row">
                                        <span class="cheerful-stat-label">The Cheerful:</span>
                                        <span class="cheerful-stat-value" id="cheerful-total-members">0</span>
                                    </div>
                                    <div class="cheerful-stat-row">
                                        <span class="cheerful-stat-label">Things Liked:</span>
                                        <span class="cheerful-stat-value" id="cheerful-total-likes">0</span>
                                    </div>
                                    <div class="cheerful-stat-row">
                                        <span class="cheerful-stat-label">Folks Cheered:</span>
                                        <span class="cheerful-stat-value" id="cheerful-folks-cheered">0</span>
                                    </div>
                                </div>
                                <div class="cheerful-summary">
                                    <p class="cheerful-summary-text"><b>The Cheerful</b> may automatically like content from residents and other dreamweavers as a show of general support. They  also reinforce each other's likes in cascades of positivity.</p>
                                    <br>
                                    <p class="cheerful-summary-text"><i>Unconditional approval dilutes the weight of appreciation.</i></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- City Input Modal -->
    <div id="cityInputModal" class="modal">
        <div class="modal-content city-modal-content">
            <div class="city-modal-title">Request Food Pickup</div>
            
            <div class="city-modal-header">
                <span class="city-modal-label">Current City:</span>
                <input type="text" id="cityInput" placeholder="Toronto, New York, London..." autocomplete="off">
            </div>
            
            <div class="city-modal-preview">
                <div class="preview-label">Message Preview:</div>
                <div id="messagePreview" class="preview-text">
                    Hey, <span class="preview-handle">Donatella</span>! If you're around to help, I'm in <span class="preview-city">...</span> and could use some free food whenever it's available. Thanks in advance.
                </div>
            </div>
            
            <div class="city-modal-actions">
                <button class="city-modal-btn city-send-btn" onclick="submitCityAndSendRequest()">
                    Send Request
                </button>
                <button class="city-modal-btn city-cancel-btn" onclick="closeCityModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Confirming your status...</div>
        </div>
    </div>

    <!-- Work sidebar extension script -->
    <script src="/js/pages/work.js" defer></script>

    <script>
        let currentSession = null;
        let roleStatuses = {
            greeter: null,
            mapper: null,
            cogitarian: null,
            provisioner: null,
            dreamstyler: null,
            bursar: null,
            cheerful: null
        };
        let currentTab = 'greeter';
        let spectrumPreviewWidget = null; // Global spectrum preview widget instance
        
        // Restore tab from localStorage on page load
        const savedTab = localStorage.getItem('work_current_tab');
        const allowedSavedTabs = ['greeter', 'mapper', 'cogitarian', 'provisioner', 'bursar', 'dreamstyler', 'cheerful'];
        if (savedTab && allowedSavedTabs.includes(savedTab)) {
            currentTab = savedTab;
        }
        let currentRole = 'greeter'; // Track selected role
        let sessionCheckComplete = false;
        let isInitializing = false; // Prevent duplicate initialization
        let profileLoaded = false; // Track if profile is ready
        let isAdminUser = false; // Track if user is admin (via /admin login)
        
        // Check if user is logged in via /admin (admin session)
        async function checkAdminStatus() {
            try {
                const adminToken = localStorage.getItem('admin_token');
                if (!adminToken) {
                    isAdminUser = false;
                    updateAdminRoleVisibility();
                    return;
                }
                
                const response = await fetch('/api/admin/verify', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    isAdminUser = data.valid && data.role === 'superadmin';
                } else {
                    isAdminUser = false;
                }
            } catch (error) {
                console.error('Failed to check admin status:', error);
                isAdminUser = false;
            }
            
            updateAdminRoleVisibility();
        }
        
        // Show or hide admin-only roles (bursar and cheerful - dreamstyler is now public)
        function updateAdminRoleVisibility() {
            const bursarTab = document.getElementById('role-tab-bursar');
            const dreamstylerTab = document.getElementById('role-tab-dreamstyler');
            const cheerfulTab = document.getElementById('role-tab-cheerful');
            const bursarMobile = document.getElementById('mobile-option-bursar');
            const dreamstylerMobile = document.getElementById('mobile-option-dreamstyler');
            const cheerfulMobile = document.getElementById('mobile-option-cheerful');
            
            // Check if current user is a bursar-allowed DID
            const currentUserDid = currentSession?.sub || currentSession?.did;
            const bursarAllowedDids = [
                'did:plc:ujsxisg5ogc2qikdioxw6y4u',  // Original admin
                'did:plc:zdxbourfcbv66iq2xfpb233q'   // dreamer.reverie.house
            ];
            const isBursarAllowedUser = currentUserDid && bursarAllowedDids.includes(currentUserDid);
            
            console.log('ðŸŽ¨ [Visibility] Checking tabs:', {
                bursarTab: !!bursarTab,
                dreamstylerTab: !!dreamstylerTab,
                cheerfulTab: !!cheerfulTab,
                bursarMobile: !!bursarMobile,
                dreamstylerMobile: !!dreamstylerMobile,
                cheerfulMobile: !!cheerfulMobile,
                isAdminUser: isAdminUser,
                isBursarAllowedUser: isBursarAllowedUser,
                currentUserDid: currentUserDid
            });
            
            // Dreamstyler is always visible (public)
            if (dreamstylerTab) {
                dreamstylerTab.style.display = 'flex';
                console.log('âœ¨ [Visibility] Dreamstyler tab shown (public)');
            } else {
                console.error('âŒ [Visibility] Dreamstyler tab not found in DOM!');
            }
            if (dreamstylerMobile) dreamstylerMobile.style.display = '';
            
            if (isAdminUser || isBursarAllowedUser) {
                // Show admin-only roles (bursar, cheerful)
                if (bursarTab) bursarTab.style.display = 'flex';
                if (bursarMobile) bursarMobile.style.display = '';
                if (cheerfulTab) cheerfulTab.style.display = 'flex';
                if (cheerfulMobile) cheerfulMobile.style.display = '';
                console.log('ðŸ”“ [Admin] Showing admin-only roles: bursar, cheerful');
            } else {
                // Hide admin-only roles (bursar, cheerful)
                if (bursarTab) bursarTab.style.display = 'none';
                if (bursarMobile) bursarMobile.style.display = 'none';
                if (cheerfulTab) cheerfulTab.style.display = 'none';
                if (cheerfulMobile) cheerfulMobile.style.display = 'none';
                
                // If user was viewing admin-only role, redirect to greeter
                if (currentRole === 'bursar' || currentRole === 'cheerful') {
                    console.log('ðŸ”’ [Admin] User viewing admin-only role without access, redirecting to greeter');
                    selectRole('greeter');
                }
            }
            
            // DEBUG: Check tabs after visibility update
            setTimeout(() => {
                const allTabs = document.querySelectorAll('.role-tab');
                console.log('ðŸ” [DEBUG] Tabs after visibility update:', allTabs.length);
                allTabs.forEach((t, i) => {
                    console.log(`ðŸ” [DEBUG] Tab ${i}: ${t.dataset.role}, display: ${t.style.display}, computed: ${getComputedStyle(t).display}`);
                });
            }, 100);
        }
        
        // Legacy function name for backward compatibility
        function enforceProvisionerVisibility() {
            // Now handled by updateAdminRoleVisibility
            updateAdminRoleVisibility();
        }

        // Role selection function
        function selectRole(role, options = {}) {
            const skipPushState = options.skipPushState || false;
            currentRole = role;
            
            // Set data attribute on body for CSS role-specific styling
            document.body.setAttribute('data-current-role', role);
            
            // Save current role to localStorage
            localStorage.setItem('work_current_tab', role);
            
            // Update URL with pushState (unless skipped for initial load or popstate)
            if (!skipPushState) {
                const newUrl = `/${role}`;
                history.pushState({ role: role }, '', newUrl);
            }
            
            // Update tab button states
            document.querySelectorAll('.role-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeButton = document.querySelector(`.role-tab[data-role="${role}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Update dropdown value (mobile)
            const mobileSelector = document.getElementById('role-selector-mobile');
            if (mobileSelector) {
                mobileSelector.value = role;
            }
            
            // Update role content with context-aware descriptions
            document.querySelectorAll('.role-desc-content').forEach(desc => {
                desc.style.display = 'none';
            });
            
            const descriptionDiv = document.getElementById(`${role}-description`);
            descriptionDiv.style.display = 'block';
            
            // Update title
            // Update title from roleConfigs
            const config = roleConfigs[role];
            document.getElementById('role-title').textContent = config ? config.title : role;
            
            // Update worker label
            const labels = {
                'greeter': 'CURRENT GREETER:',
                'mapper': 'CURRENT MAPPER:',
                'cogitarian': 'CURRENT COGITARIAN:',
                'provisioner': 'CURRENT PROVISIONER:',
                'dreamstyler': 'ACTIVE DREAMSTYLERS:',
                'bursar': 'CURRENT BURSAR:',
                'cheerful': 'THE CHEERFUL:'
            };
            document.getElementById('worker-label').textContent = labels[role];
            
            // Update current worker display based on role
            if (role === 'cogitarian') {
                // Load role status for cogitarian
                loadRoleStatus(role);
                // Hide spectrum preview widget for cogitarian
                hideSpectrumPreview();
                // Hide eventstack for cogitarian
                hideEventStack();
                // Hide mapper content for cogitarian
                hideMapperContent();
                // Hide provisioner content for cogitarian
                hideProvisionerContent();
                // Hide dreamstyler content for cogitarian
                hideDreamstylerContent();
                // Hide bursar content for cogitarian
                hideBursarContent();
                // Hide cheerful content for cogitarian
                hideCheerfulContent();
                // Show cogitarian content
                showCogitarianContent();
            } else if (role === 'mapper') {
                // Load role status for mapper and THEN update spectrum preview
                loadRoleStatus(role).then(() => {
                    // After role status is loaded, update spectrum preview with correct mapper status
                    updateSpectrumPreview(role);
                });
                // Generate random origin coordinates
                updateOriginCoordinateExample();
                // Hide eventstack for mapper
                hideEventStack();
                // Hide cogitarian content for mapper
                hideCogitarianContent();
                // Hide provisioner content for mapper
                hideProvisionerContent();
                // Hide dreamstyler content for mapper
                hideDreamstylerContent();
                // Hide bursar content for mapper
                hideBursarContent();
                // Hide cheerful content for mapper
                hideCheerfulContent();
                // Show mapper content
                showMapperContent();
            } else if (role === 'greeter') {
                // Load role status for greeter
                loadRoleStatus(role);
                // Load greeting events for eventstack
                loadGreetingEvents();
                // Show eventstack for greeter
                showEventStack();
                // Hide spectrum preview widget for greeter
                hideSpectrumPreview();
                // Hide mapper content for greeter
                hideMapperContent();
                // Hide cogitarian content for greeter
                hideCogitarianContent();
                // Hide provisioner content for greeter
                hideProvisionerContent();
                // Hide dreamstyler content for greeter
                hideDreamstylerContent();
                // Hide bursar content for greeter
                hideBursarContent();
                // Hide cheerful content for greeter
                hideCheerfulContent();
            } else if (role === 'provisioner') {
                // Load role status for provisioner
                loadRoleStatus(role);
                // Hide all role-specific content for provisioner
                hideEventStack();
                hideSpectrumPreview();
                hideMapperContent();
                hideCogitarianContent();
                hideDreamstylerContent();
                hideBursarContent();
                hideCheerfulContent();
                // Show provisioner content
                showProvisionerContent();
                // Populate food request form with user data
                populateFoodRequestForm();
            } else if (role === 'dreamstyler') {
                // Load role status for dreamstyler
                loadRoleStatus(role);
                // Hide all other content
                hideEventStack();
                hideSpectrumPreview();
                hideMapperContent();
                hideCogitarianContent();
                hideProvisionerContent();
                hideBursarContent();
                hideCheerfulContent();
                // Show dreamstyler content
                showDreamstylerContent();
            } else if (role === 'bursar') {
                // Load role status for bursar
                loadRoleStatus(role);
                // Hide all other content
                hideEventStack();
                hideSpectrumPreview();
                hideMapperContent();
                hideCogitarianContent();
                hideProvisionerContent();
                hideDreamstylerContent();
                hideCheerfulContent();
                // Show bursar content
                showBursarContent();
            } else if (role === 'cheerful') {
                // Load role status for cheerful
                loadRoleStatus(role);
                // Hide all other content
                hideEventStack();
                hideSpectrumPreview();
                hideMapperContent();
                hideCogitarianContent();
                hideProvisionerContent();
                hideDreamstylerContent();
                hideBursarContent();
                // Show cheerful content
                showCheerfulContent();
            } else {
                // Load role status for the selected role
                loadRoleStatus(role);
                // Hide spectrum preview widget for non-mapper roles
                hideSpectrumPreview();
                // Hide eventstack for other roles
                hideEventStack();
            }
            
            // Update modal and actions based on role
            updateRoleActions(role);
            
            // Update the bottom volunteer card to reflect the selected role
            updateUI();
        }
        
        // Generate random origin coordinates
        function updateOriginCoordinateExample() {
            const coordinateElement = document.getElementById('origin-coordinate-example');
            if (coordinateElement) {
                const O = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                const A = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                const S = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                const R = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                const L = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                const E = String(Math.floor(Math.random() * 100)).padStart(2, '0');
                coordinateElement.textContent = `O${O} A${A} S${S} R${R} L${L} E${E}`;
            }
        }
        
        // Spectrum Preview Widget Management
        async function updateSpectrumPreview(role) {
            if (role !== 'mapper') {
                hideSpectrumPreview();
                return;
            }
            
            const container = document.getElementById('spectrum-preview-container');
            const mapperSection = document.getElementById('mapper-content-section');
            if (!container) return;
            
            // Always enable the calculator (removed mapper check)
            const hasActiveMapper = true;
            
            console.log('ðŸ” [SPECTRUM] updateSpectrumPreview called');
            console.log('ðŸ” [SPECTRUM] hasActiveMapper:', hasActiveMapper);
            
            // Get the current mapper's handle for the preview image
            let mapperHandle = null;
            const mapperStatus = roleStatuses.mapper;
            if (mapperStatus && mapperStatus.role_info && mapperStatus.role_info.workers && mapperStatus.role_info.workers.length > 0) {
                const mapperDid = mapperStatus.role_info.workers[0].did;
                try {
                    const dreamerResponse = await fetch(`/api/dreamers/${mapperDid}`);
                    if (dreamerResponse.ok) {
                        const dreamer = await dreamerResponse.json();
                        mapperHandle = dreamer.handle;
                    }
                } catch (e) { /* ignore */ }
            }
            
            // Initialize widget if not already created
            if (!spectrumPreviewWidget && window.SpectrumPreview) {
                spectrumPreviewWidget = new window.SpectrumPreview(container, {
                    isMapper: hasActiveMapper,
                    previewHandle: mapperHandle
                });
            } else if (spectrumPreviewWidget) {
                // Update mapper status if widget exists
                spectrumPreviewWidget.setMapperStatus(hasActiveMapper);
            } else {
                // SpectrumPreview not loaded yet, try again after delay
                setTimeout(() => updateSpectrumPreview(role), 200);
                return;
            }
            
            // Show the mapper content section
            if (mapperSection) {
                mapperSection.style.display = 'block';
            }
        }
        
        function hideSpectrumPreview() {
            const mapperSection = document.getElementById('mapper-content-section');
            if (mapperSection) {
                mapperSection.style.display = 'none';
            }
        }
        
        function showEventStack() {
            const container = document.getElementById('greeter-eventstack-section');
            if (container) {
                container.style.display = 'block';
            }
        }
        
        function hideEventStack() {
            const container = document.getElementById('greeter-eventstack-section');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        function showMapperContent() {
            const container = document.getElementById('mapper-content-section');
            if (container) {
                container.style.display = 'block';
            }
        }
        
        function hideMapperContent() {
            const container = document.getElementById('mapper-content-section');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        function showCogitarianContent() {
            const container = document.getElementById('cogitarian-content-section');
            if (container) {
                container.style.display = 'block';
                // Load repo data when showing
                loadRepoData();
            }
        }
        
        function hideCogitarianContent() {
            const container = document.getElementById('cogitarian-content-section');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        function showProvisionerContent() {
            const container = document.getElementById('provisioner-content-section');
            if (container) {
                container.style.display = 'block';
            }
        }
        
        function hideProvisionerContent() {
            const container = document.getElementById('provisioner-content-section');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        function showDreamstylerContent() {
            const container = document.getElementById('dreamstyler-content-section');
            if (container) {
                container.style.display = 'block';
                // Load dreamstyler list, Tangled commits, and phanera
                loadDreamstylerList();
                loadDreamstylerAdjustments();
                loadPhanera();
            }
        }
        
        // Load phanera from ATProto records (house.reverie.dream)
        async function loadPhanera() {
            const listContainer = document.getElementById('unfinished-dreams-list');
            if (!listContainer) return;
            
            try {
                // For MVP: Use known dreamweaver DIDs who might have phanera
                // In production, this would come from a backend indexer
                const knownDreamweavers = [
                    // Add known dreamweavers with their DIDs as we discover them
                    // Format: { did: 'did:plc:...', handle: 'name.reverie.house' }
                ];
                
                // Also check currently logged in user if they're a dreamweaver
                const userHandle = currentSession?.profile?.handle || currentSession?.handle || '';
                const userPds = currentSession?.pds || '';
                const isDreamweaver = userHandle.endsWith('.reverie.house') || userPds.includes('reverie.house');
                
                if (currentSession?.did && isDreamweaver) {
                    knownDreamweavers.push({
                        did: currentSession.did,
                        handle: userHandle
                    });
                }
                
                const allPhanera = [];
                
                for (const dreamer of knownDreamweavers) {
                    if (!dreamer.did) continue;
                    
                    try {
                        // Resolve PDS
                        const didResponse = await fetch(`https://plc.directory/${dreamer.did}`);
                        if (!didResponse.ok) continue;
                        const didDoc = await didResponse.json();
                        
                        const pdsService = didDoc.service?.find(s => s.id === '#atproto_pds');
                        if (!pdsService) continue;
                        const pds = pdsService.serviceEndpoint;
                        
                        // Fetch dream records
                        const recordsResponse = await fetch(
                            `${pds}/xrpc/com.atproto.repo.listRecords?repo=${encodeURIComponent(dreamer.did)}&collection=house.reverie.dream&limit=10`
                        );
                        
                        if (!recordsResponse.ok) continue;
                        const recordsData = await recordsResponse.json();
                        
                        // Include all declared phanera
                        for (const record of recordsData.records || []) {
                            const phanera = record.value;
                            allPhanera.push({
                                domain: phanera.domain,
                                title: phanera.title,
                                tangledRepo: phanera.tangledRepo,
                                creatorDid: dreamer.did,
                                creatorHandle: dreamer.handle
                            });
                        }
                    } catch (e) {
                        // Silently skip failed fetches
                    }
                }
                
                if (allPhanera.length === 0) {
                    // Use fallback phanera when no ATProto records found
                    listContainer.innerHTML = getFallbackPhanera();
                    return;
                }
                
                // Render phanera circles
                const phaneraHTML = allPhanera.slice(0, 8).map(p => {
                    // Create 2-letter abbreviation from domain
                    const parts = p.domain.split('.');
                    const abbr = parts.length >= 2 
                        ? (parts[0][0] + parts[1][0]).toUpperCase()
                        : p.domain.substring(0, 2).toUpperCase();
                    
                    const tangledNote = p.tangledRepo ? ' ðŸ§¶' : '';
                    return `
                        <a href="https://${escapeHtml(p.domain)}" target="_blank" class="dream-circle" title="${escapeHtml(p.title)} (${escapeHtml(p.domain)}) by @${escapeHtml(p.creatorHandle)}${tangledNote}">
                            <span class="dream-circle-text">${escapeHtml(abbr)}</span>
                        </a>
                    `;
                }).join('');
                
                listContainer.innerHTML = phaneraHTML || getFallbackPhanera();
                
            } catch (error) {
                console.warn('Failed to load phanera:', error);
                listContainer.innerHTML = getFallbackPhanera();
            }
        }
        
        // Fallback phanera when ATProto fetch fails
        function getFallbackPhanera() {
            return `
                <a href="https://flawed.center" target="_blank" class="dream-circle" title="flawed.center ðŸ§¶">
                    <span class="dream-circle-text">FC</span>
                </a>
                <a href="https://chaos.observer" target="_blank" class="dream-circle" title="chaos.observer ðŸ§¶">
                    <span class="dream-circle-text">CO</span>
                </a>
            `;
        }
        
        // Load Tangled commits for dreamstylers (Aesthetic Adjustments panel)
        async function loadDreamstylerAdjustments() {
            const commitsList = document.getElementById('dreamstyler-commits-list');
            if (!commitsList) return;
            
            // Show loading state
            commitsList.innerHTML = `
                <div class="commit-row placeholder-row">
                    <span class="commit-message" style="color: #999; font-style: italic;">Loading Tangled commits...</span>
                </div>
            `;
            
            try {
                // Get all active dreamstylers
                const statusResponse = await fetch('/api/work/dreamstyler/status');
                if (!statusResponse.ok) {
                    throw new Error('Failed to fetch dreamstyler status');
                }
                const statusData = await statusResponse.json();
                const workers = statusData.all_workers || [];
                
                if (workers.length === 0) {
                    commitsList.innerHTML = `
                        <div class="commit-row placeholder-row">
                            <span class="commit-message" style="color: #999;">No active dreamstylers yet</span>
                        </div>
                    `;
                    return;
                }
                
                // Fetch Tangled refUpdates for each dreamstyler
                // Filter for commits to reverie.house repos or with dreamstyler-related prefixes
                const allCommits = [];
                
                for (const worker of workers) {
                    try {
                        // Resolve PDS from DID
                        const didResponse = await fetch(`https://plc.directory/${worker.did}`);
                        if (!didResponse.ok) continue;
                        const didDoc = await didResponse.json();
                        
                        const pdsService = didDoc.service?.find(s => s.id === '#atproto_pds');
                        if (!pdsService) continue;
                        const pds = pdsService.serviceEndpoint;
                        
                        // Query for Tangled git refUpdate records
                        // sh.tangled.git.refUpdate tracks pushes
                        const recordsResponse = await fetch(
                            `${pds}/xrpc/com.atproto.repo.listRecords?repo=${encodeURIComponent(worker.did)}&collection=sh.tangled.git.refUpdate&limit=20`
                        );
                        
                        if (!recordsResponse.ok) continue;
                        const recordsData = await recordsResponse.json();
                        
                        // Get worker's handle for display
                        let workerHandle = worker.did.slice(-8);
                        try {
                            const dreamerResponse = await fetch(`/api/dreamers/${worker.did}`);
                            if (dreamerResponse.ok) {
                                const dreamer = await dreamerResponse.json();
                                workerHandle = dreamer.handle || workerHandle;
                            }
                        } catch (e) { /* ignore */ }
                        
                        // Process records - filter for commits with #dreamstyler tag
                        // Dreamstylers must opt-in by including #dreamstyler in commit message
                        // This shows their work on ANY repo, not just phanera
                        for (const record of recordsData.records || []) {
                            const val = record.value;
                            const message = val?.commits?.[0]?.message || val?.message || '';
                            const repoName = val?.repo || '';
                            const ref = val?.ref || '';
                            
                            // Only include commits with #dreamstyler tag
                            const hasDreamstylerTag = message.toLowerCase().includes('#dreamstyler');
                            
                            if (hasDreamstylerTag) {
                                allCommits.push({
                                    did: worker.did,
                                    handle: workerHandle,
                                    message: message.replace(/#dreamstyler/gi, '').trim().split('\n')[0].substring(0, 80),
                                    timestamp: val?.time || val?.createdAt || record.value?.createdAt,
                                    repo: repoName,
                                    ref: ref,
                                    uri: record.uri
                                });
                            }
                        }
                    } catch (e) {
                        console.warn(`Failed to fetch Tangled commits for ${worker.did}:`, e);
                    }
                }
                
                // Sort by timestamp descending
                allCommits.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
                
                // Render commits
                if (allCommits.length === 0) {
                    commitsList.innerHTML = `
                        <div class="commit-row placeholder-row">
                            <span class="commit-message" style="color: #999;">No #dreamstyler tagged commits yet</span>
                        </div>
                    `;
                    return;
                }
                
                // Show up to 10 most recent commits
                const commitRows = allCommits.slice(0, 10).map(commit => {
                    const timeAgo = commit.timestamp ? formatTimeAgo(new Date(commit.timestamp)) : '';
                    return `
                        <div class="commit-row" title="${commit.handle}: ${commit.message}">
                            <span class="commit-message">${escapeHtml(commit.message) || 'Untitled commit'}</span>
                            ${timeAgo ? `<span class="commit-meta">${timeAgo}</span>` : ''}
                        </div>
                    `;
                }).join('');
                
                commitsList.innerHTML = commitRows;
                
            } catch (error) {
                console.error('Failed to load dreamstyler adjustments:', error);
                commitsList.innerHTML = `
                    <div class="commit-row placeholder-row">
                        <span class="commit-message" style="color: #999;">Could not load commits</span>
                    </div>
                `;
            }
        }
        
        // Helper to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function loadDreamstylerList() {
            const listContainer = document.getElementById('dreamstyler-list');
            if (!listContainer) return;
            
            try {
                // Get dreamstyler status to find all workers
                const response = await fetch('/api/work/dreamstyler/status');
                if (!response.ok) {
                    listContainer.innerHTML = '<div class="dreamstyler-empty">Could not load dreamstylers</div>';
                    return;
                }
                
                const data = await response.json();
                const workers = data.all_workers || [];
                
                if (workers.length === 0) {
                    listContainer.innerHTML = '<div class="dreamstyler-empty">No active dreamstylers</div>';
                    return;
                }
                
                // Fetch details for each worker
                const workerDetails = await Promise.all(workers.map(async (worker) => {
                    try {
                        const dreamerResponse = await fetch(`/api/dreamers/${worker.did}`);
                        if (dreamerResponse.ok) {
                            const dreamer = await dreamerResponse.json();
                            return {
                                did: worker.did,
                                handle: dreamer.handle || 'unknown',
                                displayName: dreamer.display_name || dreamer.handle || 'Unknown',
                                avatar: dreamer.avatar || '/assets/default-avatar.png',
                                color: dreamer.color_hex || '#9e75e5'
                            };
                        }
                    } catch (e) {
                        console.error('Failed to fetch dreamer:', e);
                    }
                    return {
                        did: worker.did,
                        handle: 'unknown',
                        displayName: 'Unknown',
                        avatar: '/assets/default-avatar.png',
                        color: '#9e75e5'
                    };
                }));
                
                // Build the list HTML
                const listHTML = workerDetails.map(w => {
                    // Calculate lighter background from user color
                    const bgColor = w.color + '20'; // 20 is hex for ~12% opacity
                    return `
                        <div class="dreamstyler-row" style="background: ${bgColor}; border-left: 3px solid ${w.color};">
                            <a href="/dreamer?did=${encodeURIComponent(w.did)}" class="dreamstyler-link dreamer-link" data-did="${w.did}">
                                <img src="${w.avatar}" alt="${w.handle}" class="dreamstyler-avatar" style="border-color: ${w.color};">
                                <span class="dreamstyler-name" style="color: ${w.color};">${w.displayName}</span>
                            </a>
                            <button class="dreamstyler-entreat-btn" style="background: ${w.color}; border-color: ${w.color};" onclick="entreatDreamstyler('${w.handle}')">ENTREAT</button>
                        </div>
                    `;
                }).join('');
                
                listContainer.innerHTML = listHTML;
                
                // Initialize dreamer hover
                setTimeout(() => {
                    if (window.DreamerHover) window.DreamerHover.init();
                }, 100);
                
            } catch (error) {
                console.error('Failed to load dreamstyler list:', error);
                listContainer.innerHTML = '<div class="dreamstyler-empty">Error loading dreamstylers</div>';
            }
        }
        
        // Cache for user's dreams (to avoid repeated fetches)
        let userDreamsCache = null;
        
        // Fetch user's declared dreams (house.reverie.dream records)
        async function fetchUserDreams() {
            if (userDreamsCache !== null) return userDreamsCache;
            
            if (!currentSession) {
                userDreamsCache = [];
                return userDreamsCache;
            }
            
            const userDid = currentSession.sub || currentSession.did;
            if (!userDid) {
                userDreamsCache = [];
                return userDreamsCache;
            }
            
            try {
                // Resolve user's PDS
                const didResponse = await fetch(`https://plc.directory/${userDid}`);
                if (!didResponse.ok) {
                    userDreamsCache = [];
                    return userDreamsCache;
                }
                const didDoc = await didResponse.json();
                const pdsService = didDoc.service?.find(s => s.id === '#atproto_pds');
                if (!pdsService) {
                    userDreamsCache = [];
                    return userDreamsCache;
                }
                const pds = pdsService.serviceEndpoint;
                
                // Fetch dream records
                const recordsResponse = await fetch(
                    `${pds}/xrpc/com.atproto.repo.listRecords?repo=${encodeURIComponent(userDid)}&collection=house.reverie.dream&limit=50`
                );
                
                if (!recordsResponse.ok) {
                    userDreamsCache = [];
                    return userDreamsCache;
                }
                
                const recordsData = await recordsResponse.json();
                userDreamsCache = (recordsData.records || []).map(r => ({
                    uri: r.uri,
                    domain: r.value.domain,
                    title: r.value.title,
                    tangledRepo: r.value.tangledRepo,
                    description: r.value.description
                }));
                
                return userDreamsCache;
            } catch (e) {
                console.warn('Failed to fetch user phanera:', e);
                userDreamsCache = [];
                return userDreamsCache;
            }
        }
        
        // Check if user can entreat (has a phanera declared)
        async function canUserEntreat() {
            // Must be logged in
            if (!currentSession) return { allowed: false, reason: 'login' };
            
            // Must be a dreamweaver: .reverie.house handle OR using reverie.house PDS
            const handle = currentSession.profile?.handle || currentSession.handle || '';
            const pds = currentSession.pds || '';
            const isDreamweaver = handle.endsWith('.reverie.house') || pds.includes('reverie.house');
            
            if (!isDreamweaver) {
                return { allowed: false, reason: 'not_dreamweaver', handle };
            }
            
            // Must have at least one phanera (house.reverie.dream record)
            // tangledRepo is optional - dreamstylers just need something to consider
            const phanera = await fetchUserDreams();
            
            if (phanera.length === 0) {
                return { allowed: false, reason: 'no_phanera' };
            }
            
            return { allowed: true, phanera };
        }
        
        // Entreat a dreamstyler with a randomized plea
        async function entreatDreamstyler(handle) {
            // Gate: Check if user can entreat
            const entreatStatus = await canUserEntreat();
            
            if (!entreatStatus.allowed) {
                let message = '';
                switch (entreatStatus.reason) {
                    case 'login':
                        if (window.loginWidget && typeof window.loginWidget.showLoginPopup === 'function') {
                            window.loginWidget.showLoginPopup();
                        }
                        return;
                    case 'not_dreamweaver':
                        // Show the changehandle widget to let them switch to a .reverie.house handle
                        if (window.changeHandleWidget) {
                            window.changeHandleWidget.show({
                                reason: 'entreat_dreamstyler',
                                dreamstylerHandle: handle,
                                roleColor: 'var(--role-dreamstyler)',
                                roleColorLight: 'var(--role-dreamstyler-light)',
                                roleClass: 'dreamstyler',
                                onSuccess: () => {
                                    // Retry the entreat after handle change
                                    entreatDreamstyler(handle);
                                }
                            });
                        } else {
                            message = 'Entreating dreamstylers is only available to dreamweavers using their .reverie.house handle.\n\nPlease switch to your Reverie House handle and try again.';
                            showCelebration(message, 'error');
                        }
                        return;
                    case 'no_phanera':
                        message = 'You must declare a phanera before entreating a dreamstyler.\n\nA phanera is a domain you\'re building that you want styled. Create a house.reverie.dream record to declare one.';
                        break;
                    default:
                        message = 'Unable to entreat at this time.';
                }
                if (message) showCelebration(message, 'error');
                return;
            }
            
            // If user has multiple phanera, pick the first one (could add a picker later)
            const phanera = entreatStatus.phanera[0];
            
            const openers = [
                "O magnificent @" + handle + ",",
                "Dearest @" + handle + ", keeper of pixels,",
                "ðŸ™ @" + handle + ", legendary stylist of dreams,",
                "Humble plea to @" + handle + ":",
                "@" + handle + "! Aesthetic oracle!",
                "To the illustrious @" + handle + ",",
                "âš¡ @" + handle + ", CSS wizard extraordinaire,",
                "Most gracious @" + handle + ","
            ];
            
            const pleas = [
                `I beseech thee to grace "${phanera.title}" with thy miraculous touch.`,
                `might you bestow upon ${phanera.domain} the gift of your aesthetic mastery?`,
                `my phanera "${phanera.title}" yearns for the divine intervention of your design sensibilities.`,
                `would you honor me by casting your visionary gaze upon ${phanera.domain}?`,
                `I throw myself at your mercy, hoping for but a crumb of styling genius for ${phanera.domain}.`,
                `please, if it pleases you, consider blessing "${phanera.title}" with your talent.`,
                `I am but a dreamer lost in ${phanera.domain}. Only you can save my gradients.`,
                `my hover states at ${phanera.domain} are a disaster. You are my only hope.`,
                `the shadows at "${phanera.title}"... they are all wrong. I need your wisdom.`,
                `might your legendary skills bring harmony to ${phanera.domain}?`
            ];
            
            const opener = openers[Math.floor(Math.random() * openers.length)];
            const plea = pleas[Math.floor(Math.random() * pleas.length)];
            const message = opener + " " + plea;
            
            // Open Bluesky compose with the message
            const bskyUrl = "https://bsky.app/intent/compose?text=" + encodeURIComponent(message);
            window.open(bskyUrl, '_blank');
        }
        
        function hideDreamstylerContent() {
            const container = document.getElementById('dreamstyler-content-section');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        function showBursarContent() {
            const container = document.getElementById('bursar-content-section');
            if (container) {
                container.style.display = 'block';
                // Load treasury data when showing
                loadTreasuryData();
            }
        }
        
        function hideBursarContent() {
            const container = document.getElementById('bursar-content-section');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        function showCheerfulContent() {
            console.log('ðŸŒ¸ [Cheerful] showCheerfulContent() called');
            const container = document.getElementById('cheerful-content-section');
            console.log('ðŸŒ¸ [Cheerful] Container element:', container);
            if (container) {
                container.style.display = 'block';
                console.log('ðŸŒ¸ [Cheerful] Container shown, loading data...');
                // Load cheerful data when showing
                loadCheerfulList();
                loadCheerfulStats();
            } else {
                console.log('ðŸŒ¸ [Cheerful] Container NOT FOUND!');
            }
        }
        
        function hideCheerfulContent() {
            console.log('ðŸŒ¸ [Cheerful] hideCheerfulContent() called');
            const container = document.getElementById('cheerful-content-section');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        // Load cheerful members list
        async function loadCheerfulList() {
            const listContainer = document.getElementById('cheerful-list');
            console.log('ðŸŒ¸ [Cheerful List] Starting to load cheerful list...');
            console.log('ðŸŒ¸ [Cheerful List] List container element:', listContainer);
            if (!listContainer) {
                console.log('ðŸŒ¸ [Cheerful List] No list container found, returning');
                return;
            }
            
            try {
                console.log('ðŸŒ¸ [Cheerful List] Fetching /api/work/cheerful/status...');
                const response = await fetch('/api/work/cheerful/status');
                console.log('ðŸŒ¸ [Cheerful List] Response status:', response.status);
                if (!response.ok) throw new Error('Failed to fetch cheerful status');
                
                const data = await response.json();
                console.log('ðŸŒ¸ [Cheerful List] Response data:', data);
                const workers = data.role_info?.workers || [];
                console.log('ðŸŒ¸ [Cheerful List] Workers found:', workers.length, workers);
                
                if (workers.length === 0) {
                    console.log('ðŸŒ¸ [Cheerful List] No workers, showing empty message');
                    listContainer.innerHTML = `
                        <div class="cheerful-empty">
                            <div class="cheerful-empty-text">None among The Cheerful yet</div>
                        </div>
                    `;
                    return;
                }
                
                // Fetch all worker details in parallel
                console.log('ðŸŒ¸ [Cheerful List] Fetching worker details...');
                const workerPromises = workers.map(async (worker) => {
                    try {
                        const dreamerRes = await fetch(`/api/dreamers/${worker.did}`);
                        if (dreamerRes.ok) {
                            const dreamer = await dreamerRes.json();
                            return {
                                did: worker.did,
                                handle: dreamer.handle || 'unknown',
                                displayName: dreamer.display_name || dreamer.handle || 'Unknown',
                                avatar: dreamer.avatar || '/assets/default-avatar.png',
                                color: dreamer.color_hex || '#e05ecf'
                            };
                        }
                    } catch (e) {
                        console.error('Failed to fetch dreamer:', e);
                    }
                    return {
                        did: worker.did,
                        handle: 'unknown',
                        displayName: 'Unknown',
                        avatar: '/assets/default-avatar.png',
                        color: '#e05ecf'
                    };
                });
                
                const workerInfos = await Promise.all(workerPromises);
                
                // Build cheerful list HTML
                let html = '';
                for (const w of workerInfos) {
                    // Create lightened background from user color
                    const bgColor = w.color + '15'; // 15 = ~9% opacity in hex
                    html += `
                        <a href="/dreamer?did=${encodeURIComponent(w.did)}" class="cheerful-member-row" style="text-decoration: none; display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; transition: background 0.2s; background: ${bgColor}; margin-bottom: 4px;">
                            <img src="${w.avatar}" alt="${w.handle}" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid ${w.color}; object-fit: cover;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="color: ${w.color}; font-weight: 600; font-size: 0.85rem;">${w.displayName}</div>
                                <div style="color: #999; font-size: 0.7rem;">@${w.handle}</div>
                            </div>
                        </a>
                    `;
                }
                
                listContainer.innerHTML = html;
                
                // Update member count
                const membersEl = document.getElementById('cheerful-total-members');
                if (membersEl) membersEl.textContent = workerInfos.length.toString();
                
            } catch (error) {
                console.error('Failed to load cheerful list:', error);
                listContainer.innerHTML = '<div class="cheerful-empty">Error loading cheerful members</div>';
            }
        }
        
        // Load cheerful statistics with counting animation
        async function loadCheerfulStats() {
            const membersEl = document.getElementById('cheerful-total-members');
            const likesEl = document.getElementById('cheerful-total-likes');
            const cheeredEl = document.getElementById('cheerful-folks-cheered');
            
            console.log('ðŸŒ¸ [Cheerful Stats] Starting to load cheerful statistics...');
            
            try {
                // Get cheerful workers
                console.log('ðŸŒ¸ [Cheerful Stats] Fetching /api/work/cheerful/status...');
                const response = await fetch('/api/work/cheerful/status');
                if (!response.ok) {
                    console.error('ðŸŒ¸ [Cheerful Stats] Failed to fetch status:', response.status);
                    throw new Error('Failed to fetch cheerful status');
                }
                
                const data = await response.json();
                const workers = data.role_info?.workers || [];
                console.log('ðŸŒ¸ [Cheerful Stats] Found', workers.length, 'cheerful workers:', workers);
                
                // Member count is set by loadCheerfulList
                
                // Fetch like counts from PDS directly using com.atproto.repo.listRecords
                // This works for reverie.house accounts that aren't on the public Bluesky relay
                let totalLikes = 0;
                let folksSet = new Set();
                
                for (const worker of workers) {
                    console.log('ðŸŒ¸ [Cheerful Stats] Processing worker:', worker.did);
                    try {
                        // Fetch likes from PDS directly with pagination
                        let cursor = null;
                        let workerLikes = 0;
                        let pageCount = 0;
                        
                        do {
                            // Use com.atproto.repo.listRecords to get like records from the PDS
                            const url = `/xrpc/com.atproto.repo.listRecords?repo=${encodeURIComponent(worker.did)}&collection=app.bsky.feed.like&limit=100${cursor ? '&cursor=' + encodeURIComponent(cursor) : ''}`;
                            console.log('ðŸŒ¸ [Cheerful Stats] Fetching likes page', pageCount + 1, 'for', worker.did);
                            console.log('ðŸŒ¸ [Cheerful Stats] URL:', url);
                            
                            const likesRes = await fetch(url);
                            console.log('ðŸŒ¸ [Cheerful Stats] Response status:', likesRes.status);
                            
                            if (likesRes.ok) {
                                const likesData = await likesRes.json();
                                const records = likesData.records || [];
                                pageCount++;
                                workerLikes += records.length;
                                totalLikes += records.length;
                                
                                console.log('ðŸŒ¸ [Cheerful Stats] Page', pageCount, 'returned', records.length, 'likes');
                                console.log('ðŸŒ¸ [Cheerful Stats] Worker total so far:', workerLikes);
                                console.log('ðŸŒ¸ [Cheerful Stats] Grand total so far:', totalLikes);
                                
                                // Count unique folks cheered by extracting DIDs from subject URIs
                                for (const record of records) {
                                    const subjectUri = record.value?.subject?.uri;
                                    if (subjectUri) {
                                        // Extract DID from AT URI: at://did:plc:xxxx/collection/rkey
                                        const match = subjectUri.match(/^at:\/\/([^\/]+)/);
                                        if (match && match[1]) {
                                            folksSet.add(match[1]);
                                        }
                                    }
                                }
                                console.log('ðŸŒ¸ [Cheerful Stats] Unique folks cheered so far:', folksSet.size);
                                
                                cursor = likesData.cursor;
                                console.log('ðŸŒ¸ [Cheerful Stats] Cursor for next page:', cursor ? cursor : 'none (done)');
                                
                                // Animate count up as we fetch
                                if (likesEl) {
                                    animateCount(likesEl, parseInt(likesEl.textContent) || 0, totalLikes);
                                }
                                if (cheeredEl) {
                                    animateCount(cheeredEl, parseInt(cheeredEl.textContent) || 0, folksSet.size);
                                }
                            } else {
                                const errorText = await likesRes.text();
                                console.error('ðŸŒ¸ [Cheerful Stats] Failed to fetch likes:', likesRes.status, errorText);
                                break;
                            }
                        } while (cursor);
                        
                        console.log('ðŸŒ¸ [Cheerful Stats] Finished worker', worker.did, '- total likes:', workerLikes);
                        
                    } catch (e) {
                        console.error('ðŸŒ¸ [Cheerful Stats] Failed to fetch likes for', worker.did, e);
                    }
                }
                
                // Final update
                console.log('ðŸŒ¸ [Cheerful Stats] FINAL TOTALS - Likes:', totalLikes, 'Folks:', folksSet.size);
                if (likesEl) likesEl.textContent = totalLikes.toString();
                if (cheeredEl) cheeredEl.textContent = folksSet.size.toString();
                
            } catch (error) {
                console.error('ðŸŒ¸ [Cheerful Stats] Failed to load cheerful stats:', error);
            }
        }
        
        // Animate count from start to end
        function animateCount(element, start, end) {
            if (start === end) return;
            const duration = 500;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.floor(start + (end - start) * progress);
                element.textContent = current.toString();
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }
        
        // Load treasury data from OpenCollective API
        async function loadTreasuryData() {
            const balanceEl = document.getElementById('oc-balance');
            const totalRaisedEl = document.getElementById('oc-total-raised');
            
            try {
                const response = await fetch('https://api.opencollective.com/graphql/v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: `query {
                            account(slug: "reverie-house") {
                                name
                                stats {
                                    balance { value currency }
                                    totalAmountReceived { value currency }
                                }
                            }
                        }`
                    })
                });
                
                const data = await response.json();
                
                if (data.data && data.data.account) {
                    const stats = data.data.account.stats;
                    const currency = stats.balance.currency || 'CAD';
                    
                    if (balanceEl) {
                        const balance = parseFloat(stats.balance.value) || 0;
                        balanceEl.textContent = `$${balance.toFixed(2)} ${currency}`;
                        balanceEl.title = 'Current OpenCollective balance';
                    }
                    
                    if (totalRaisedEl) {
                        const totalRaised = parseFloat(stats.totalAmountReceived.value) || 0;
                        totalRaisedEl.textContent = `$${totalRaised.toFixed(2)} ${currency}`;
                        totalRaisedEl.title = 'Total amount received on OpenCollective';
                    }
                } else {
                    throw new Error('No data returned from OpenCollective');
                }
            } catch (error) {
                console.error('Failed to load OpenCollective data:', error);
                if (balanceEl) {
                    balanceEl.textContent = 'Unable to load';
                    balanceEl.title = 'Error loading OpenCollective data';
                }
                if (totalRaisedEl) {
                    totalRaisedEl.textContent = 'Unable to load';
                    totalRaisedEl.title = 'Error loading OpenCollective data';
                }
            }
            
            // Project cards already have static placeholder content
            // When API is connected, we'll dynamically populate #oc-projects
        }
        
        function refreshTreasuryData() {
            loadTreasuryData();
            showCelebration('Treasury data refreshed', 'info');
        }
        
        function submitScheme() {
            const input = document.getElementById('scheme-domain-input');
            const domain = input ? input.value.trim() : '';
            
            if (!domain) {
                showCelebration('Please enter a domain', 'error');
                return;
            }
            
            // For now, just acknowledge - actual submission logic TBD
            showCelebration('Scheme submitted for consideration', 'success');
            if (input) input.value = '';
        }
        
        function populateFoodRequestForm() {
            const userDisplay = document.getElementById('food-request-user-display');
            if (!userDisplay) return;
            
            if (!currentSession || !currentSession.profile) {
                // Logged out state - show placeholder
                userDisplay.innerHTML = `
                    <div class="user-display-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="user-display-info">
                        <div class="user-display-name">Not logged in</div>
                        <div class="user-display-handle"></div>
                    </div>
                `;
                return;
            }
            
            // Logged in state - show avatar and profile info
            const profile = currentSession.profile;
            const displayName = profile.displayName || profile.handle || 'Anonymous';
            const handle = profile.handle || '';
            const avatar = profile.avatar || '';
            
            let avatarHTML;
            if (avatar) {
                avatarHTML = `<img src="${avatar}" alt="${displayName}">`;
            } else {
                avatarHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                `;
            }
            
            userDisplay.innerHTML = `
                <div class="user-display-icon">
                    ${avatarHTML}
                </div>
                <div class="user-display-info">
                    <div class="user-display-name">${displayName}</div>
                    <div class="user-display-handle">${handle ? '@' + handle : ''}</div>
                </div>
            `;
        }
        
        // Store provisioner DID for the modal
        let pendingRequestProvisionerDid = null;
        
        async function requestFoodPickup() {
            console.log('ðŸ½ï¸ [Provisioner] Request food pickup clicked');
            
            // Check if user is logged in
            if (!currentSession || !currentSession.profile) {
                triggerLogin();
                return;
            }
            
            // Gate: Check if user has a .reverie.house handle
            const userHandle = currentSession.profile?.handle || currentSession.handle || '';
            if (!userHandle.endsWith('.reverie.house')) {
                console.log('ðŸš« [Food Request] User does not have a .reverie.house handle:', userHandle);
                
                // Get provisioner handle for the message
                let provisionerHandle = 'the Head of Pantry';
                const provStatus = roleStatuses.provisioner;
                if (provStatus && provStatus.current_worker) {
                    // Try to get the provisioner's handle
                    try {
                        const provResponse = await fetch(`/api/dreamers/${provStatus.current_worker.did}`);
                        if (provResponse.ok) {
                            const provData = await provResponse.json();
                            provisionerHandle = provData.handle || 'the Head of Pantry';
                        }
                    } catch (e) {
                        console.warn('Could not fetch provisioner handle:', e);
                    }
                }
                
                // Show the changehandle widget to let them switch handles
                if (window.changeHandleWidget) {
                    window.changeHandleWidget.show({
                        reason: 'food_request',
                        provisionerHandle: provisionerHandle,
                        roleColor: 'var(--role-provisioner)',
                        roleColorLight: 'var(--role-provisioner-light)',
                        roleClass: 'provisioner',
                        onSuccess: () => {
                            // Retry the food request after handle change
                            requestFoodPickup();
                        }
                    });
                } else {
                    showCelebration('Food requests are only available to dreamweavers using their .reverie.house handle.\n\nPlease switch to your Reverie House handle and try again.', 'error');
                }
                return;
            }
            
            // Check if there's an active provisioner
            const provisionerStatus = roleStatuses.provisioner;
            if (!provisionerStatus || !provisionerStatus.current_worker) {
                showCelebration('There is currently no active Head of Pantry.\n\nPlease check back later or volunteer for the role yourself!', 'error');
                return;
            }
            
            // Get current provisioner DID
            const provisionerDid = provisionerStatus.current_worker.did;
            const userDid = currentSession.sub || currentSession.did;
            
            // Don't allow provisioner to request from themselves
            if (provisionerDid === userDid) {
                showCelebration('You cannot request food from yourself!\n\nStep down as provisioner first if you need assistance.', 'error');
                return;
            }
            
            // Check if user has stored app password for DM access
            let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
            if (!token && currentSession && currentSession.accessJwt) {
                token = currentSession.accessJwt;
            }
            
            if (!token) {
                console.error('âŒ [Food Request] No authentication token found');
                console.error('   - oauth_token:', localStorage.getItem('oauth_token') ? 'exists' : 'missing');
                console.error('   - admin_token:', localStorage.getItem('admin_token') ? 'exists' : 'missing');
                console.error('   - currentSession:', currentSession ? 'exists' : 'missing');
                showCelebration('Session expired - please refresh and try again', 'error');
                return;
            }
            
            console.log('ðŸ” [Food Request] Using token:', token.substring(0, 20) + '...');
            
            const headers = { 'Authorization': `Bearer ${token}` };
            
            try {
                console.log('ðŸ” [Food Request] Checking for stored app password...');
                console.log('   - Endpoint: /api/user/credentials/status');
                console.log('   - Headers:', JSON.stringify(headers));
                
                const credResponse = await fetch('/api/user/credentials/status', { headers });
                
                console.log('ðŸ“Š [Food Request] Credentials check response:', credResponse.status, credResponse.statusText);
                console.log('   - OK:', credResponse.ok);
                console.log('   - Headers:', Object.fromEntries(credResponse.headers.entries()));
                
                if (credResponse.ok) {
                    const credData = await credResponse.json();
                    console.log('ðŸ“Š [Food Request] Credentials data received:');
                    console.log('   - Full response:', JSON.stringify(credData, null, 2));
                    console.log('   - connected field:', credData.connected, '(type:', typeof credData.connected, ')');
                    console.log('   - valid field:', credData.valid, '(type:', typeof credData.valid, ')');
                    
                    // Check if user has valid credentials stored
                    if (credData && (credData.connected === true || credData.valid === true)) {
                        console.log('âœ… [Food Request] User has stored credentials, proceeding with city modal');
                        console.log('   - Storing provisioner DID:', provisionerDid);
                        // User has credentials, proceed with city modal
                        pendingRequestProvisionerDid = provisionerDid;
                        showCityModal();
                    } else {
                        console.log('âš ï¸ [Food Request] No stored credentials found, showing app password widget');
                        console.log('   - connected:', credData?.connected);
                        console.log('   - valid:', credData?.valid);
                        console.log('   - Full data:', JSON.stringify(credData));
                        // No credentials, show app password widget
                        showAppPasswordWidgetForFoodRequest(provisionerDid);
                    }
                } else {
                    console.error('âŒ [Food Request] Credentials check failed');
                    console.error('   - Status:', credResponse.status, credResponse.statusText);
                    const errorText = await credResponse.text();
                    console.error('   - Error response:', errorText);
                    console.error('   - Falling back to app password widget');
                    showAppPasswordWidgetForFoodRequest(provisionerDid);
                }
            } catch (error) {
                console.error('âŒ [Food Request] Exception during credential check');
                console.error('   - Error type:', error.constructor.name);
                console.error('   - Error message:', error.message);
                console.error('   - Stack trace:', error.stack);
                showAppPasswordWidgetForFoodRequest(provisionerDid);
            }
        }
        
        function showAppPasswordWidgetForFoodRequest(provisionerDid) {
            console.log('ðŸ”‘ [App Password Widget] Initializing for food request');
            console.log('   - Provisioner DID:', provisionerDid);
            console.log('   - Widget available:', !!window.appPasswordRequest);
            
            if (!window.appPasswordRequest) {
                console.error('âŒ [App Password Widget] AppPasswordRequest widget not loaded');
                console.error('   - window.appPasswordRequest:', window.appPasswordRequest);
                console.error('   - Available window properties:', Object.keys(window).filter(k => k.includes('app') || k.includes('password')));
                showCelebration('Widget not loaded - please refresh the page', 'error');
                return;
            }
            
            console.log('ðŸ“ [App Password Widget] Showing widget with config:');
            const config = {
                title: 'Enable Direct Messages',
                description: 'To request food from the Head of Pantry, you need to create an app password that allows sending direct messages on Bluesky.',
                featureName: 'food requests',
                roleColor: 'provisioner',
                buttonText: 'ENABLE DIRECT MESSAGES'
            };
            console.log('   - Config:', JSON.stringify(config, null, 2));
            
            window.appPasswordRequest.show(config, async (appPassword) => {
                console.log('ðŸ”‘ [App Password Widget] App password received from widget');
                console.log('   - Password length:', appPassword ? appPassword.length : 'null');
                console.log('   - Password format:', appPassword ? appPassword.substring(0, 4) + '-****-****-****' : 'null');
                
                // Store the credentials
                try {
                    let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                    if (!token && currentSession && currentSession.accessJwt) {
                        token = currentSession.accessJwt;
                    }
                    
                    console.log('ðŸ” [App Password Widget] Retrieved auth token for storage');
                    console.log('   - Token source:', localStorage.getItem('oauth_token') ? 'oauth_token' : 
                                                      localStorage.getItem('admin_token') ? 'admin_token' : 
                                                      'currentSession.accessJwt');
                    console.log('   - Token preview:', token ? token.substring(0, 20) + '...' : 'null');
                    
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    };
                    
                    console.log('ðŸ“¤ [App Password Widget] Sending credential storage request');
                    console.log('   - Endpoint: POST /api/user/credentials/connect');
                    console.log('   - Headers:', JSON.stringify(headers));
                    console.log('   - Body: { app_password: "****-****-****-****" }');
                    
                    const response = await fetch('/api/user/credentials/connect', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ app_password: appPassword })
                    });
                    
                    console.log('ðŸ“¨ [App Password Widget] Storage response received');
                    console.log('   - Status:', response.status, response.statusText);
                    console.log('   - OK:', response.ok);
                    
                    if (response.ok) {
                        const responseData = await response.json();
                        console.log('âœ… [App Password Widget] Credentials stored successfully');
                        console.log('   - Response data:', JSON.stringify(responseData, null, 2));
                        console.log('   - Now proceeding with food request modal');
                        console.log('   - Setting pendingRequestProvisionerDid to:', provisionerDid);
                        
                        // Now proceed with the food request
                        pendingRequestProvisionerDid = provisionerDid;
                        showCityModal();
                    } else {
                        const error = await response.json();
                        console.error('âŒ [App Password Widget] Failed to store credentials');
                        console.error('   - Status:', response.status);
                        console.error('   - Error data:', JSON.stringify(error, null, 2));
                        showCelebration(error.error || 'Failed to store credentials', 'error');
                    }
                } catch (error) {
                    console.error('âŒ [App Password Widget] Exception during credential storage');
                    console.error('   - Error type:', error.constructor.name);
                    console.error('   - Error message:', error.message);
                    console.error('   - Stack trace:', error.stack);
                    showCelebration('Failed to store credentials. Please try again.', 'error');
                }
            });
        }
        
        async function showCityModal() {
            const modal = document.getElementById('cityInputModal');
            const input = document.getElementById('cityInput');
            const cityPreview = document.querySelector('.preview-city');
            const handlePreview = document.querySelector('.preview-handle');
            
            // Get provisioner handle from current status
            const provisionerStatus = roleStatuses.provisioner;
            if (provisionerStatus && provisionerStatus.current_worker) {
                const provisionerDid = provisionerStatus.current_worker.did;
                
                // Fetch provisioner's name
                try {
                    const response = await fetch(`/api/dreamers/${provisionerDid}`);
                    if (response.ok) {
                        const dreamer = await response.json();
                        // Use name (capitalized) for a friendly greeting
                        const name = dreamer.name ? 
                            dreamer.name.charAt(0).toUpperCase() + dreamer.name.slice(1) : 
                            'friend';
                        handlePreview.textContent = name;
                    }
                } catch (error) {
                    console.error('Error fetching provisioner name:', error);
                    handlePreview.textContent = 'friend';
                }
            }
            
            // Update preview as user types
            input.addEventListener('input', function() {
                const city = this.value.trim();
                cityPreview.textContent = city || '...';
                cityPreview.style.fontStyle = city ? 'normal' : 'italic';
            });
            
            modal.classList.add('show');
            document.body.setAttribute('data-current-role', 'provisioner');
            // Focus input after animation
            setTimeout(() => input.focus(), 300);
        }
        
        function closeCityModal() {
            const modal = document.getElementById('cityInputModal');
            const input = document.getElementById('cityInput');
            const preview = document.querySelector('.preview-city');
            
            modal.classList.remove('show');
            input.value = '';
            preview.textContent = '...';
            preview.style.fontStyle = 'italic';
            pendingRequestProvisionerDid = null;
        }
        
        async function submitCityAndSendRequest() {
            const cityInput = document.getElementById('cityInput');
            const city = cityInput.value.trim();
            
            if (!city) {
                showCelebration('Please enter your city', 'error');
                return;
            }
            
            if (!pendingRequestProvisionerDid) {
                showCelebration('Request session expired. Please try again.', 'error');
                closeCityModal();
                return;
            }
            
            // Store the DID before closing modal
            const provisionerDid = pendingRequestProvisionerDid;
            
            // Close modal and show loading
            closeCityModal();
            showCelebration('Sending request...', 'info');
            
            console.log('ðŸ“¨ Sending request with:', {
                city: city,
                provisioner_did: provisionerDid
            });
            
            try {
                // Get auth token - same priority as other work endpoints
                let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                if (!token && currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                }
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const payload = {
                    city: city,
                    provisioner_did: provisionerDid
                };
                
                console.log('ðŸ“¤ Request payload:', payload);
                
                const response = await fetch('/api/work/provisioner/send-request', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showCelebration('Request sent successfully!\n\nThe Head of Pantry will respond via DM.', 'success');
                } else {
                    if (data.needs_credentials) {
                        showCelebration('You need to activate a work role first to send direct messages.\n\nPlease activate any role (like Provisioner) to enable DM functionality.', 'error');
                    } else if (data.dm_restricted) {
                        // Provisioner has DM settings that block incoming messages
                        const provHandle = data.provisioner_handle || 'the provisioner';
                        showCelebration(`The Head of Pantry (@${provHandle}) has DM settings that require them to follow you first.\n\nPlease either:\nâ€¢ Ask them to follow you on Bluesky, or\nâ€¢ Wait for them to update their DM settings\n\nThen try again.`, 'error');
                    } else {
                        showCelebration(data.error || 'Failed to send request', 'error');
                    }
                }
            } catch (error) {
                console.error('Error sending food request:', error);
                showCelebration('Network error. Please try again.', 'error');
            } finally {
                pendingRequestProvisionerDid = null;
            }
        }
        
        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            const cityInput = document.getElementById('cityInput');
            if (cityInput) {
                cityInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitCityAndSendRequest();
                    }
                });
            }
        });
        
        function sendFoodRequest() {
            console.log('ðŸ½ï¸ [Provisioner] Send food request clicked');
            
            const city = document.getElementById('food-request-city')?.value?.trim();
            const details = document.getElementById('food-request-details')?.value?.trim();
            
            if (!city) {
                showCelebration('Please enter your current city', 'error');
                return;
            }
            
            if (!currentSession || !currentSession.profile) {
                if (window.loginWidget && typeof window.loginWidget.showLoginPopup === 'function') {
                    window.loginWidget.showLoginPopup();
                }
                return;
            }
            
            // Placeholder for DM functionality
            showCelebration('Food request functionality coming soon!\n\nYour request will be sent via DM to the current Head of Pantry.', 'info');
            
            console.log('Food request:', {
                name: currentSession.profile.displayName,
                handle: currentSession.profile.handle,
                city: city,
                details: details
            });
        }
        
        async function syncProvisionerFollows() {
            console.log('ðŸ”„ [Provisioner] Sync follows clicked');
            
            const syncBtn = document.getElementById('sync-follows-btn');
            if (syncBtn) {
                syncBtn.disabled = true;
                syncBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="spin">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="m3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                    </svg>
                    Syncing...
                `;
            }
            
            try {
                let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                if (!token && currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                }
                
                const response = await fetch('/api/work/provisioner/sync-follows', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let message = `Follow sync complete!\n\n`;
                    message += `âœ… Followed: ${data.followed}\n`;
                    message += `ðŸ—‘ï¸ Unfollowed: ${data.unfollowed}\n`;
                    message += `ðŸ“‹ Already following: ${data.already_following}`;
                    if (data.errors && data.errors.length > 0) {
                        message += `\nâš ï¸ Errors: ${data.errors.length}`;
                    }
                    showCelebration(message, 'success');
                } else {
                    showCelebration(data.error || 'Failed to sync follows', 'error');
                }
            } catch (error) {
                console.error('Error syncing follows:', error);
                showCelebration('Network error. Please try again.', 'error');
            } finally {
                if (syncBtn) {
                    syncBtn.disabled = false;
                    syncBtn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="m3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                        </svg>
                        Sync Follows
                    `;
                }
            }
        }
        
        function updateProvisionerToolsVisibility() {
            const toolsSection = document.getElementById('provisioner-tools-section');
            if (!toolsSection) return;
            
            // Only show tools if user is the active provisioner
            const provisionerStatus = roleStatuses.provisioner;
            const isActiveProvisioner = provisionerStatus && provisionerStatus.is_worker;
            
            toolsSection.style.display = isActiveProvisioner ? 'block' : 'none';
        }
        
        function updateRoleActions(role) {
            const activateBtn = document.getElementById('activate-btn');
            if (!activateBtn) return;
            
            // Check if user has a different role
            let userCurrentRole = null;
            if (roleStatuses.greeter && roleStatuses.greeter.is_worker) userCurrentRole = 'greeter';
            else if (roleStatuses.mapper && roleStatuses.mapper.is_worker) userCurrentRole = 'mapper';
            else if (roleStatuses.cogitarian && roleStatuses.cogitarian.is_worker) userCurrentRole = 'cogitarian';
            else if (roleStatuses.provisioner && roleStatuses.provisioner.is_worker) userCurrentRole = 'provisioner';
            else if (roleStatuses.dreamstyler && roleStatuses.dreamstyler.is_worker) userCurrentRole = 'dreamstyler';
            else if (roleStatuses.bursar && roleStatuses.bursar.is_worker) userCurrentRole = 'bursar';
            else if (roleStatuses.cheerful && roleStatuses.cheerful.is_worker) userCurrentRole = 'cheerful';
            
            // If user has a different role, disable the button
            if (userCurrentRole && userCurrentRole !== role) {
                activateBtn.textContent = 'Step Down First';
                activateBtn.disabled = true;
                activateBtn.style.opacity = '0.5';
                activateBtn.style.cursor = 'not-allowed';
            } else {
                // Allow volunteering
                activateBtn.textContent = 'Volunteer Now';
                activateBtn.disabled = false;
                activateBtn.style.opacity = '1';
                activateBtn.style.cursor = 'pointer';
            }
        }

        // Listen for profile loaded event - this guarantees we have all session data
        window.addEventListener('oauth:profile-loaded', async (event) => {
            if (isInitializing) {
                console.log('â­ï¸ Work: Already initializing, skipping duplicate profile-loaded event');
                return;
            }
            
            isInitializing = true;
            currentSession = event.detail.session;
            profileLoaded = true;
            sessionCheckComplete = true;
            
            // Now we have complete profile data, load all role statuses and update UI
            await loadRoleStatus('greeter');
            await loadRoleStatus('mapper');
            await loadRoleStatus('cogitarian');
            await loadRoleStatus('provisioner');
            await loadRoleStatus('dreamstyler');
            await loadRoleStatus('bursar');
            await loadRoleStatus('cheerful');
            updateUI();
            updateProvisionerToolsVisibility();
            updateAdminRoleVisibility(); // Re-check now that currentSession is available
            isInitializing = false;
        });

        // Listen for OAuth login events (fired first, before profile loads)
        document.addEventListener('oauth:login', async (event) => {
            // Just store the session - we'll wait for profile-loaded to update UI
            currentSession = event.detail.session;
            
            // Don't reload greeter status here - profile-loaded will do it
            // This prevents duplicate API calls
        });

        window.addEventListener('oauth:logout', async () => {
            currentSession = null;
            roleStatuses = {
                greeter: null,
                mapper: null,
                cogitarian: null,
                provisioner: null,
                dreamstyler: null,
                bursar: null,
                cheerful: null
            };
            sessionCheckComplete = true;
            profileLoaded = false;
            
            // Reload current role status to show current state
            console.log('ðŸ”„ Work: Refreshing role status after logout...');
            await loadRoleStatus(currentRole);
            updateUI();
        });

        // Check for session - simplified since we rely on events
        async function checkSession() {
            if (isInitializing) {
                return true;
            }
            
            if (window.oauthManager) {
                const session = window.oauthManager.getSession();
                if (session) {
                    // Check if profile is already loaded
                    if (session.profile?.handle) {
                        isInitializing = true;
                        currentSession = session;
                        profileLoaded = true;
                        sessionCheckComplete = true;
                        
                        // Profile already loaded, load all role statuses
                        await loadRoleStatus('greeter');
                        await loadRoleStatus('mapper');
                        await loadRoleStatus('cogitarian');
                        await loadRoleStatus('provisioner');
                        await loadRoleStatus('dreamstyler');
                        await loadRoleStatus('bursar');
                        await loadRoleStatus('cheerful');
                        updateUI();
                        updateAdminRoleVisibility(); // Re-check now that currentSession is available
                        
                        isInitializing = false;
                        return true;
                    } else {
                        // Profile not loaded yet, events will handle it
                        currentSession = session;
                        return false; // Keep checking
                    }
                }
            }
            return false;
        }

        // Check if already logged in on page load - with retries
        document.addEventListener('DOMContentLoaded', () => {
            let attempts = 0;
            const maxAttempts = 5;
            
            // Check admin status and show/hide admin-only tabs
            checkAdminStatus();
            
            // Check URL path for direct role navigation (e.g., /greeter, /mapper, /cogitarian)
            const pathParts = window.location.pathname.split('/').filter(p => p); // Filter out empty parts
            const urlRole = pathParts.length > 0 ? pathParts[0] : null; // Get first non-empty part of path
            
            // Also check for hash fragment (e.g., #greeter, #mapper, #cogitarian)
            const hashRole = window.location.hash.replace('#', '');
            
            // Build allowed roles list (admin-only roles handled by updateAdminRoleVisibility)
            let allowedRoles = ['greeter', 'mapper', 'cogitarian', 'provisioner', 'dreamstyler', 'bursar', 'cheerful'];
            
            let initialTab = null;
            
            // Priority 1: Hash fragment (from redirects)
            if (allowedRoles.includes(hashRole)) {
                initialTab = hashRole;
            }
            // Priority 2: URL path
            else if (allowedRoles.includes(urlRole)) {
                initialTab = urlRole;
            } 
            // Priority 3: Saved tab
            else {
                // Restore saved tab if any
                const savedTab = localStorage.getItem('work_current_tab');
                if (savedTab && allowedRoles.includes(savedTab)) {
                    initialTab = savedTab;
                }
            }
            
            if (initialTab) {
                currentRole = initialTab;
                // Update the UI to show the correct tab as active (desktop)
                document.querySelectorAll('.role-button').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-role') === initialTab) {
                        btn.classList.add('active');
                    }
                });
                // Update the dropdown (mobile)
                const mobileSelector = document.getElementById('role-selector-mobile');
                if (mobileSelector) {
                    mobileSelector.value = initialTab;
                }
                // Update the role display (skipPushState to avoid adding history entry on initial load)
                selectRole(initialTab, { skipPushState: true });
                
                // Replace current history state with the role URL
                history.replaceState({ role: initialTab }, '', `/${initialTab}`);
            } else {
                // Set default role if none specified
                document.body.setAttribute('data-current-role', currentRole);
                // Set URL to default role
                history.replaceState({ role: currentRole }, '', `/${currentRole}`);
            }
            
            // Load greeting templates immediately
            loadGreetingTemplates();
            
            // Initialize origin coordinate example with random values
            updateOriginCoordinateExample();
            
            // Load all role statuses immediately (works without login)
            loadRoleStatus('greeter');
            loadRoleStatus('mapper');
            loadRoleStatus('cogitarian');
            loadRoleStatus('provisioner');
            loadRoleStatus('dreamstyler');
            loadRoleStatus('bursar');
            
            // Load greeting events for greeter tab
            loadGreetingEvents();
            
            // Setup work event listeners for cross-page synchronization
            const setupWorkEvents = () => {
                if (!window.WorkEvents) {
                    console.log('â³ Work: WorkEvents not ready, retrying in 100ms...');
                    setTimeout(setupWorkEvents, 100);
                    return;
                }
                
                console.log('ðŸŽ¯ Work: Setting up WorkEvents listeners');
                
                // Listen for greeter activation from dashboard
                window.WorkEvents.on(window.WorkEvents.EVENTS.GREETER_ACTIVATED, async (data) => {
                    console.log('ðŸŽ¯ Work: Received GREETER_ACTIVATED event', data);
                    await loadRoleStatus('greeter');
                    updateUI();
                });
                
                // Listen for greeter step-down from dashboard
                window.WorkEvents.on(window.WorkEvents.EVENTS.GREETER_STEPPED_DOWN, async (data) => {
                    console.log('ðŸŽ¯ Work: Received GREETER_STEPPED_DOWN event', data);
                    await loadRoleStatus('greeter');
                    updateUI();
                });
                
                // Listen for general status changes
                window.WorkEvents.on(window.WorkEvents.EVENTS.GREETER_STATUS_CHANGED, async (data) => {
                    console.log('ðŸŽ¯ Work: Received GREETER_STATUS_CHANGED event', data);
                    await loadRoleStatus('greeter');
                    updateUI();
                });
                
                // Listen for dreamstyler activation - refresh Find Dreamstylers carousel
                window.WorkEvents.on(window.WorkEvents.EVENTS.DREAMSTYLER_ACTIVATED, async (data) => {
                    console.log('ðŸŽ¯ Work: Received DREAMSTYLER_ACTIVATED event', data);
                    await loadRoleStatus('dreamstyler');
                    updateUI();
                    // Refresh the Find Dreamstylers carousel
                    const roleInfo = roleStatuses.dreamstyler;
                    if (roleInfo && roleInfo.role_info) {
                        await updateMultiWorkerDisplay(roleInfo.role_info, 'dreamstyler');
                    }
                });
                
                // Listen for dreamstyler step-down - refresh Find Dreamstylers carousel
                window.WorkEvents.on(window.WorkEvents.EVENTS.DREAMSTYLER_STEPPED_DOWN, async (data) => {
                    console.log('ðŸŽ¯ Work: Received DREAMSTYLER_STEPPED_DOWN event', data);
                    await loadRoleStatus('dreamstyler');
                    updateUI();
                    // Refresh the Find Dreamstylers carousel
                    const roleInfo = roleStatuses.dreamstyler;
                    if (roleInfo && roleInfo.role_info) {
                        await updateMultiWorkerDisplay(roleInfo.role_info, 'dreamstyler');
                    }
                });
                
                // Listen for dreamstyler status changes
                window.WorkEvents.on(window.WorkEvents.EVENTS.DREAMSTYLER_STATUS_CHANGED, async (data) => {
                    console.log('ðŸŽ¯ Work: Received DREAMSTYLER_STATUS_CHANGED event', data);
                    await loadRoleStatus('dreamstyler');
                    updateUI();
                    // Refresh the Find Dreamstylers carousel
                    const roleInfo = roleStatuses.dreamstyler;
                    if (roleInfo && roleInfo.role_info) {
                        await updateMultiWorkerDisplay(roleInfo.role_info, 'dreamstyler');
                    }
                });
            };
            
            // Start setup (will retry if not ready)
            setupWorkEvents();
            
            // Handle browser back/forward navigation
            window.addEventListener('popstate', (event) => {
                const allowedRoles = ['greeter', 'mapper', 'cogitarian', 'provisioner', 'dreamstyler', 'bursar', 'cheerful'];
                let role = null;
                
                // Check state first
                if (event.state && event.state.role && allowedRoles.includes(event.state.role)) {
                    role = event.state.role;
                } else {
                    // Fallback to parsing URL path
                    const path = window.location.pathname.replace('/', '');
                    if (allowedRoles.includes(path)) {
                        role = path;
                    }
                }
                
                if (role) {
                    selectRole(role, { skipPushState: true });
                }
            });
            
            // Set initial loading state
            const loadingStateText = document.getElementById('loading-state-text');
            if (loadingStateText) loadingStateText.textContent = 'Checking session...';
            
            // Check immediately first
            checkSession().then(found => {
                if (found) {
                    return;
                }
                
                // If not found, start interval checks
                const sessionCheckInterval = setInterval(async () => {
                    attempts++;
                    
                    const found = await checkSession();
                    if (found) {
                        clearInterval(sessionCheckInterval);
                    } else if (attempts >= maxAttempts) {
                        // No session found after max attempts
                        sessionCheckComplete = true;
                        updateUI();
                        clearInterval(sessionCheckInterval);
                    }
                }, 300); // 300ms interval
            });
        });

        // Safe login trigger that double-checks session before showing popup
        async function triggerLogin() {
            // Double-check if user is actually logged in before showing popup
            if (window.oauthManager) {
                const session = window.oauthManager.getSession();
                if (session && session.profile?.handle) {
                    // Already have complete profile
                    currentSession = session;
                    profileLoaded = true;
                    sessionCheckComplete = true;
                    await loadGreeterStatus();
                    updateUI();
                    return;
                }
            }
            
            // Actually show login popup
            if (window.loginWidget && typeof window.loginWidget.showLoginPopup === 'function') {
                window.loginWidget.showLoginPopup();
            } else {
                console.error('Login widget not available');
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Save current tab to localStorage
            localStorage.setItem('work_current_tab', tab);
            
            // Update tab buttons
            document.querySelectorAll('.work-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // For now, only Greeter is implemented
            if (tab !== 'greeter') {
                alert(`${tab.charAt(0).toUpperCase() + tab.slice(1)} work is coming soon!`);
                return;
            }

            // Reload the appropriate content
            updateUI();
            if (currentSession) {
                loadRoleStatus(tab);
            }
        }

        function updateUI() {
            const loadingState = document.getElementById('loading-state');
            const userStatus = document.getElementById('user-status');
            const guestPrompt = document.getElementById('guest-prompt');
            const userActions = document.getElementById('user-actions');
            const activateBtn = document.getElementById('activate-btn');
            const deactivateBtn = document.getElementById('deactivate-btn');
            const setRetiringBtn = document.getElementById('set-retiring-btn');
            const setWorkingBtn = document.getElementById('set-working-btn');
            const youLink = document.getElementById('you-link');

            // Update "you" link
            if (currentSession && profileLoaded) {
                const userDid = currentSession.sub || currentSession.did;
                
                const youLink = document.getElementById('you-link');
                if (youLink) {
                    if (userDid) {
                        youLink.innerHTML = `<a href="/dreamer?did=${encodeURIComponent(userDid)}" class="dreamer-link" data-did="${userDid}" target="_blank" style="color: inherit; text-decoration: none;">you</a>`;
                    } else {
                        youLink.textContent = 'you';
                    }
                }
            } else {
                const youLink = document.getElementById('you-link');
                if (youLink) {
                    youLink.textContent = 'you';
                }
            }

            // Check if we're using the old work.html structure or new work.html structure
            // work.html doesn't have these elements, so skip if they don't exist
            if (!loadingState || !userStatus || !guestPrompt) {
                return;
            }

            // Show loading state if session check not complete
            if (!sessionCheckComplete) {
                loadingState.style.display = 'block';
                const loadingText = document.getElementById('loading-state-text');
                if (loadingText) loadingText.textContent = 'Checking session...';
                userStatus.style.display = 'none';
                if (userActions) userActions.style.display = 'none';
                guestPrompt.style.display = 'none';
                return;
            }

            // If we have a session but profile not loaded yet
            if (currentSession && !profileLoaded) {
                loadingState.style.display = 'block';
                const loadingText = document.getElementById('loading-state-text');
                if (loadingText) loadingText.textContent = 'Loading your profile...';
                userStatus.style.display = 'none';
                if (userActions) userActions.style.display = 'none';
                guestPrompt.style.display = 'none';
                return;
            }

            // Hide loading state - we're ready
            loadingState.style.display = 'none';

            // Don't show guest prompt until we've completed session check
            if (!currentSession || !profileLoaded) {
                userStatus.style.display = 'none';
                if (userActions) userActions.style.display = 'none';
                guestPrompt.style.display = 'block';
                return;
            }

            guestPrompt.style.display = 'none';
            if (userActions) userActions.style.display = 'block';

            // Get handle from session - ensure we have valid data
            const userHandle = currentSession.profile?.handle || currentSession.handle;
            if (!userHandle || userHandle === 'Unknown') {
                // Profile data not ready yet, wait for it
                console.warn('âš ï¸ Profile data not ready, waiting...');
                loadingState.style.display = 'block';
                const loadingText = document.getElementById('loading-state-text');
                if (loadingText) loadingText.textContent = 'Loading profile data...';
                return;
            }

            // Build user status card
            // Find which role the user actually has (not just the selected tab)
            let actualUserRole = null;
            console.log('ðŸ” [DEBUG] Checking roleStatuses for user role:');
            console.log('   roleStatuses.greeter:', roleStatuses.greeter);
            console.log('   roleStatuses.mapper:', roleStatuses.mapper);
            console.log('   roleStatuses.cogitarian:', roleStatuses.cogitarian);
            console.log('   roleStatuses.provisioner:', roleStatuses.provisioner);
            console.log('   roleStatuses.dreamstyler:', roleStatuses.dreamstyler);
            console.log('   roleStatuses.bursar:', roleStatuses.bursar);
            console.log('   roleStatuses.cheerful:', roleStatuses.cheerful);
            
            if (roleStatuses.greeter && roleStatuses.greeter.is_worker) actualUserRole = 'greeter';
            else if (roleStatuses.mapper && roleStatuses.mapper.is_worker) actualUserRole = 'mapper';
            else if (roleStatuses.cogitarian && roleStatuses.cogitarian.is_worker) actualUserRole = 'cogitarian';
            else if (roleStatuses.provisioner && roleStatuses.provisioner.is_worker) actualUserRole = 'provisioner';
            else if (roleStatuses.dreamstyler && roleStatuses.dreamstyler.is_worker) actualUserRole = 'dreamstyler';
            else if (roleStatuses.bursar && roleStatuses.bursar.is_worker) actualUserRole = 'bursar';
            else if (roleStatuses.cheerful && roleStatuses.cheerful.is_worker) actualUserRole = 'cheerful';
            
            console.log('   â†’ actualUserRole determined:', actualUserRole);
            
            // Check if viewing own role vs different role
            const viewingOwnRole = actualUserRole && actualUserRole === currentRole;
            const hasRole = actualUserRole !== null;
            
            console.log('ðŸ” [DEBUG] Role comparison:');
            console.log('   currentRole (selected tab):', currentRole);
            console.log('   actualUserRole:', actualUserRole);
            console.log('   viewingOwnRole:', viewingOwnRole);
            console.log('   hasRole:', hasRole);
            
            // Get status for the selected tab role
            const selectedRoleStatus = roleStatuses[currentRole];
            const isWorkerForSelectedRole = selectedRoleStatus && selectedRoleStatus.is_worker;
            const status = selectedRoleStatus?.status;
            
            console.log('ðŸ” [DEBUG] Selected role status:');
            console.log('   selectedRoleStatus:', selectedRoleStatus);
            console.log('   isWorkerForSelectedRole:', isWorkerForSelectedRole);
            console.log('   status:', status);
            console.log('   Will show Step Down card?', isWorkerForSelectedRole && viewingOwnRole);
            
            // Show worker status card ONLY if viewing own role
            if (isWorkerForSelectedRole && viewingOwnRole) {
                console.log('âœ… [DEBUG] Showing Step Down card for', currentRole);
                // Skip if elements don't exist (work.html uses different structure)
                if (!userStatus || !activateBtn) {
                    console.log('âš ï¸ [DEBUG] userStatus or activateBtn element not found, skipping');
                    return;
                }
                
                const displayName = currentSession.profile?.displayName || userHandle;
                const avatar = currentSession.profile?.avatar || '/assets/icon.png';
                
                // Get role title from config
                const currentRoleConfig = roleConfigs[currentRole];
                const roleTitle = currentRoleConfig ? currentRoleConfig.title : currentRole;
                const isMultiWorkerRole = currentRoleConfig?.multiWorker === true;
                
                // Status display - multi-worker roles don't have retiring status
                const statusValue = isMultiWorkerRole ? 'active' : (status === 'working' ? 'working' : 'retiring');
                
                // Build card matching the not-volunteering style
                // Multi-worker roles show simpler UI (just Step Down, no retiring)
                const volunteerSectionContent = isMultiWorkerRole 
                    ? `<div class="volunteer-prompt">
                           <h4>You are currently ${roleTitle}</h4>
                           <p>Thank you for working!</p>
                           <p>You may step down at any time.</p>
                       </div>
                       <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                           <button class="action-button" onclick="deactivateRole('${currentRole}')" style="background: #5d4a37; border-color: #5d4a37;">Step Down</button>
                       </div>`
                    : `<div class="volunteer-prompt">
                           <h4>You are currently ${roleTitle}</h4>
                           <p>Thank you for working!</p>
                           <p>${status === 'working' 
                               ? 'You may begin retiring, or step down immediately.' 
                               : 'You are already marked as retiring.<br>You will be replaced when someone new volunteers.'}</p>
                       </div>
                       <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                           ${status === 'working' 
                               ? `<button class="action-button" onclick="setRoleRetiring('${currentRole}')" style="background: #8b7355; border-color: #8b7355;">Begin Retiring</button>
                                  <button class="action-button" onclick="deactivateRole('${currentRole}')" style="background: #5d4a37; border-color: #5d4a37;">Step Down</button>`
                               : `<button class="action-button" onclick="showAlreadyWorkingMessage()" style="background: #999; border-color: #999; opacity: 0.6; cursor: not-allowed;">Continue Working</button>
                                  <button class="action-button" onclick="deactivateRole('${currentRole}')" style="background: #5d4a37; border-color: #5d4a37;">Step Down</button>`
                           }
                       </div>`;
                
                userStatus.innerHTML = `
                    <div class="user-status-card not-volunteering">
                        <div class="profile-section">
                            <img src="${avatar}" alt="${displayName}" class="user-avatar">
                            <div class="user-info">
                                <h3 class="user-display-name">${displayName}</h3>
                                <p class="user-handle">@${userHandle}</p>
                            </div>
                            <div class="user-stats">
                                <div class="stat-item">
                                    <div class="stat-label">Roles</div>
                                    <div class="stat-value">${roleTitle}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Status</div>
                                    <div class="stat-value">${statusValue}</div>
                                </div>
                            </div>
                        </div>
                        <div class="volunteer-section">
                            ${volunteerSectionContent}
                        </div>
                    </div>
                `;
                userStatus.style.display = 'block';

                // Hide the separate action buttons
                activateBtn.style.display = 'none';
                deactivateBtn.style.display = 'none';
                setRetiringBtn.style.display = 'none';
                setWorkingBtn.style.display = 'none';
            } else {
                // Not volunteering for THIS role - show integrated profile + volunteer card
                
                // Skip if elements don't exist (work.html uses different structure)
                if (!userStatus || !activateBtn) {
                    console.log('â„¹ï¸ [UI] Using work.html structure - non-worker UI managed by sidebar');
                    return;
                }
                
                const displayName = currentSession.profile?.displayName || userHandle;
                const avatar = currentSession.profile?.avatar || '/assets/icon.png';
                const isReverieHouse = userHandle.endsWith('.reverie.house');
                
                // Determine current efforts
                let currentEfforts = 'idle dreamer';
                if (isReverieHouse) {
                    currentEfforts = 'dreamweaver';
                }
                // If user has ANY role, show it
                if (hasRole) {
                    const userRoleConfig = roleConfigs[actualUserRole];
                    currentEfforts = userRoleConfig ? userRoleConfig.title : actualUserRole;
                }
                
                // Role configurations (use main roleConfigs as source of truth for titles)
                const roleConfig = {
                    'greeter': {
                        title: roleConfigs.greeter.title,
                        description: 'Welcomes every newcomer to Reverie House, offers their name, and provides them a helping hand in exploring our wild mindscape.',
                        buttonText: 'BECOME GREETER',
                        replaceText: 'REPLACE GREETER',
                        onclickHandler: 'openGreeterModal()',
                        workerNamePlaceholder: 'greeter-name-placeholder',
                        activeNamePlaceholder: 'greeter-name-placeholder-active',
                        retiringText: 'is ready to retire, if you\'re ready to replace them.',
                        notRetiredText: 'is not yet ready to retire.',
                        comingSoon: false
                    },
                    'mapper': {
                        title: roleConfigs.mapper.title,
                        description: 'Assists dreamers in deducing their origin coordinates when they reveal their beginnings within our wild mindscape.',
                        buttonText: 'BECOME MAPPER',
                        replaceText: 'REPLACE MAPPER',
                        onclickHandler: 'openMapperModal()',
                        workerNamePlaceholder: 'mapper-name-placeholder',
                        activeNamePlaceholder: 'mapper-name-placeholder-active',
                        retiringText: 'is ready to retire, if you\'re ready to replace them.',
                        notRetiredText: 'is not yet ready to retire.',
                        comingSoon: false
                    },
                    'cogitarian': {
                        title: roleConfigs.cogitarian.title,
                        description: 'Helps codify and immunize any inhuman elements of our foundations as this dream settles itself.',
                        buttonText: 'BECOME COGITARIAN',
                        replaceText: 'REPLACE COGITARIAN',
                        onclickHandler: 'openCogitarianModal()',
                        workerNamePlaceholder: 'cogitarian-name-placeholder',
                        activeNamePlaceholder: 'cogitarian-name-placeholder-active',
                        retiringText: 'is ready to retire, if you\'re ready to replace them.',
                        notRetiredText: 'is not yet ready to retire.',
                        comingSoon: false
                    },
                    'provisioner': {
                        title: roleConfigs.provisioner.title,
                        description: 'Helps ease the hunger of dreamers in need by managing food assistance remotely.',
                        buttonText: 'BECOME PROVISIONER',
                        replaceText: 'REPLACE PROVISIONER',
                        onclickHandler: 'openWorkerModal(\'provisioner\')',
                        workerNamePlaceholder: 'provisioner-name-placeholder',
                        activeNamePlaceholder: 'provisioner-name-placeholder-active',
                        retiringText: 'is ready to retire, if you\'re ready to replace them.',
                        notRetiredText: 'is not yet ready to retire.',
                        comingSoon: false
                    },
                    'dreamstyler': {
                        title: roleConfigs.dreamstyler.title,
                        description: 'Helps shape the aesthetic elements and translate the dreams of others within our wild mindscape.',
                        buttonText: 'BECOME DREAMSTYLER',
                        replaceText: 'BECOME DREAMSTYLER',  // Same as button - no replacement concept
                        onclickHandler: 'openWorkerModal(\'dreamstyler\')',
                        workerNamePlaceholder: 'dreamstyler-name-placeholder',
                        activeNamePlaceholder: 'dreamstyler-name-placeholder-active',
                        retiringText: '',  // No retiring for multi-worker
                        notRetiredText: '',  // No retiring for multi-worker
                        comingSoon: false,
                        multiWorker: true  // Flag for multi-worker role
                    },
                    'cheerful': {
                        title: roleConfigs.cheerful.title,
                        description: 'Donates positivity to the community through automatic likes.',
                        buttonText: 'JOIN THE CHEERFUL',
                        replaceText: 'JOIN THE CHEERFUL',  // Same as button - no replacement concept
                        onclickHandler: 'openWorkerModal(\'cheerful\')',
                        workerNamePlaceholder: 'cheerful-name-placeholder',
                        activeNamePlaceholder: 'cheerful-name-placeholder-active',
                        retiringText: '',  // No retiring for multi-worker
                        notRetiredText: '',  // No retiring for multi-worker
                        comingSoon: false,
                        multiWorker: true  // Flag for multi-worker role
                    }
                };
                
                const config = roleConfig[currentRole] || roleConfig['greeter'];
                
                // Check current worker status for the SELECTED role (not user's role)
                const selectedRoleData = roleStatuses[currentRole];
                const currentWorker = selectedRoleData?.current_worker;
                const isRetiringWorker = currentWorker && currentWorker.status === 'retiring';
                const isActiveWorker = currentWorker && currentWorker.status === 'working';
                
                // Get worker name for replacement notice
                let workerName = '';
                let replacementNotice = '';
                
                // Skip retiring/active notices for multi-worker roles (dreamstyler)
                const isMultiWorkerRole = config.multiWorker === true;
                
                if (!isMultiWorkerRole) {
                    if (isRetiringWorker && selectedRoleData?.role_info?.workers?.length > 0) {
                        const workerDid = selectedRoleData.role_info.workers[0].did;
                        // Fetch worker name from dreamers (we'll need to do this async)
                        // For now, use a placeholder - we'll update this after fetching
                        replacementNotice = `
                            <div class="replacement-notice retiring" style="margin-top: 0.75rem; text-align: center; font-size: 0.9rem; color: white;">
                                <span id="${config.workerNamePlaceholder}">Loading...</span> ${config.retiringText}
                            </div>
                        `;
                    } else if (isActiveWorker && selectedRoleData?.role_info?.workers?.length > 0) {
                        const workerDid = selectedRoleData.role_info.workers[0].did;
                        // Simple white text for active worker
                        replacementNotice = `
                            <div class="replacement-notice active" style="margin-top: 0.75rem; text-align: center; font-size: 0.9rem; color: white;">
                                <span id="${config.activeNamePlaceholder}">Loading...</span> ${config.notRetiredText}
                            </div>
                        `;
                    }
                }
                
                // Check if user has a different role and create subtitle
                let hasConflictingRole = hasRole && !viewingOwnRole;
                let buttonSubtitle = '';
                if (hasConflictingRole) {
                    const userRoleConfig = roleConfigs[actualUserRole];
                    const userRoleTitle = userRoleConfig ? userRoleConfig.title : actualUserRole;
                    buttonSubtitle = `<div style="margin-top: 0.5rem; text-align: center; font-size: 0.85rem; color: #999; font-style: italic;">You are already ${userRoleTitle}</div>`;
                }
                
                // For coming soon roles or conflicting roles, show disabled button
                // Multi-worker roles (dreamstyler) don't disable when there are active workers
                const shouldDisableForActiveWorker = isActiveWorker && !isMultiWorkerRole;
                const isDisabled = config.comingSoon || shouldDisableForActiveWorker || hasConflictingRole;
                const disabledStyles = isDisabled ? 'disabled style="opacity: 0.6; cursor: not-allowed; background: #999; border-color: #999;"' : '';
                const buttonOnclick = (config.comingSoon || hasConflictingRole) ? '' : `onclick="${config.onclickHandler}"`;
                
                userStatus.innerHTML = `
                    <div class="user-status-card not-volunteering">
                        <div class="profile-section">
                            <img src="${avatar}" alt="${displayName}" class="user-avatar">
                            <div class="user-info">
                                <h3 class="user-display-name">${displayName}</h3>
                                <p class="user-handle">@${userHandle}</p>
                            </div>
                            <div class="user-stats">
                                <div class="stat-item">
                                    <div class="stat-label">Current Efforts</div>
                                    <div class="stat-value">${currentEfforts}</div>
                                </div>
                            </div>
                        </div>
                        <div class="volunteer-section">
                            <div class="volunteer-prompt">
                                <h4>${config.title}</h4>
                                <p>${config.description}</p>
                            </div>
                            <button class="action-button volunteer-now-btn" ${buttonOnclick} ${disabledStyles}>
                                <span class="btn-text">${(isRetiringWorker && !isMultiWorkerRole) ? config.replaceText : config.buttonText}</span>
                            </button>
                            ${buttonSubtitle}
                            ${replacementNotice}
                            ${config.comingSoon ? '<div style="margin-top: 0.5rem; text-align: center; font-size: 0.85rem; color: #ccc; font-style: italic;">Coming Soon</div>' : ''}
                        </div>
                    </div>
                `;
                userStatus.style.display = 'block';
                
                // Fetch and update worker name if there's a current worker (skip for multi-worker roles)
                if (!isMultiWorkerRole && (isRetiringWorker || isActiveWorker) && selectedRoleData?.role_info?.workers?.length > 0) {
                    const workerDid = selectedRoleData.role_info.workers[0].did;
                    updateGreeterNameInNotice(workerDid);

                }
                
                // Hide the action buttons since they're now in the card
                activateBtn.style.display = 'none';
                deactivateBtn.style.display = 'none';
                setRetiringBtn.style.display = 'none';
                setWorkingBtn.style.display = 'none';
            }
        }

        async function updateGreeterNameInNotice(greeterDid) {
            try {
                const response = await fetch(`/api/dreamers/${greeterDid}`);
                if (response.ok) {
                    const dreamer = await response.json();
                    const displayName = dreamer.display_name || dreamer.handle || 'The current greeter';
                    
                    // Update all possible placeholders (handles different roles)
                    const placeholderIds = [
                        'greeter-name-placeholder',
                        'greeter-name-placeholder-active',
                        'mapper-name-placeholder',
                        'mapper-name-placeholder-active',
                        'cogitarian-name-placeholder',
                        'cogitarian-name-placeholder-active'
                    ];
                    
                    placeholderIds.forEach(id => {
                        const placeholder = document.getElementById(id);
                        if (placeholder) {
                            placeholder.textContent = displayName;
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to fetch greeter name:', error);
                
                // Update all possible placeholders with fallback
                const placeholderIds = [
                    'greeter-name-placeholder',
                    'greeter-name-placeholder-active',
                    'mapper-name-placeholder',
                    'mapper-name-placeholder-active',
                    'cogitarian-name-placeholder',
                    'cogitarian-name-placeholder-active'
                ];
                
                placeholderIds.forEach(id => {
                    const placeholder = document.getElementById(id);
                    if (placeholder) {
                        placeholder.textContent = 'The current worker';
                    }
                });
            }
        }

        async function loadRoleStatus(role) {
            try {
                // Get token - use same priority as credentials check and activation
                // Priority: backend session token > PDS accessJwt
                let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                
                if (!token && currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                }
                
                console.log(`ðŸ” [${role}] loadRoleStatus - token found: ${!!token}, source: ${localStorage.getItem('oauth_token') ? 'oauth_token' : localStorage.getItem('admin_token') ? 'admin_token' : currentSession?.accessJwt ? 'currentSession.accessJwt' : 'none'}`);

                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(`/api/work/${role}/status`, {
                    headers: headers
                });

                if (response.ok) {
                    const data = await response.json();
                    roleStatuses[role] = data;
                    console.log(`âœ… [${role}] Status loaded - is_worker: ${data.is_worker}, status: ${data.status}`);
                    
                    // Update worker display if this is the current role and we got role_info
                    if (role === currentRole && data.role_info) {
                        updateWorkerDisplay(data.role_info, role);
                    } else if (role === currentRole) {
                        // No role_info in response, show None
                        const workerDisplay = document.getElementById('worker-display');
                        if (workerDisplay) {
                            workerDisplay.innerHTML = '<span style="color: #666;">None</span>';
                        }
                    }
                } else {
                    const errorText = await response.text();
                    console.error(`âŒ [API] ${role} status endpoint failed: ${response.status}`, errorText.substring(0, 200));
                    console.log(`ðŸ“ [STATE] Setting ${role}Status to default (failed response)`);
                    roleStatuses[role] = { is_worker: false, status: null };
                    if (role === currentRole) {
                        const workerDisplay = document.getElementById('worker-display');
                        if (workerDisplay) {
                            workerDisplay.innerHTML = '<span style="color: #666;">None</span>';
                        }
                    }
                }
            } catch (error) {
                console.error(`âŒ [API] Failed to load ${role} status:`, error);
                console.log(`ðŸ“ [STATE] Setting ${role}Status to default (exception)`);
                roleStatuses[role] = { is_worker: false, status: null };
                if (role === currentRole) {
                    const workerDisplay = document.getElementById('worker-display');
                    if (workerDisplay) {
                        workerDisplay.innerHTML = '<span style="color: #666;">None</span>';
                    }
                }
            }
        }

        // Maintain backward compatibility - loadGreeterStatus now calls loadRoleStatus
        async function loadGreeterStatus() {
            return loadRoleStatus('greeter');
        }

        async function updateWorkerDisplay(roleInfo, role = 'greeter') {
            const workerDisplay = document.getElementById('worker-display');
            
            if (!roleInfo.workers || roleInfo.workers.length === 0) {
                const roleTitle = role === 'greeter' ? 'Greeter' : role === 'mapper' ? 'Mapper' : role === 'cogitarian' ? 'Cogitarian' : role === 'provisioner' ? 'Provisioner' : role === 'bursar' ? 'Bursar' : role === 'cheerful' ? 'Cheerful' : 'Dreamstyler';
                
                // Reset worker card borders to default when no worker
                const workerCard = document.querySelector('.role-worker-card');
                const workerCardHeader = document.querySelector('.worker-card-header');
                if (workerCard) {
                    workerCard.style.borderColor = '';
                }
                if (workerCardHeader) {
                    workerCardHeader.style.borderColor = '';
                }
                
                // Get role color for button
                const roleColors = {
                    'greeter': 'var(--role-greeter)',
                    'mapper': 'var(--role-mapper)',
                    'cogitarian': 'var(--role-cogitarian)',
                    'provisioner': 'var(--role-provisioner)',
                    'dreamstyler': 'var(--role-dreamstyler)',
                    'bursar': 'var(--role-bursar)',
                    'cheerful': 'var(--role-cheerful)'
                };
                const roleColor = roleColors[role] || 'var(--role-greeter)';
                
                // Different empty messages for special roles
                const emptyMessage = role === 'dreamstyler' ? 'No Active Dreamstylers' : role === 'bursar' ? 'No Current Bursar' : role === 'cheerful' ? 'No Current Cheerful' : 'No Current Worker';
                
                workerDisplay.innerHTML = `
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="1.5" style="margin: 0 auto; display: block;">
                        <circle cx="12" cy="12" r="10" />
                        <circle cx="12" cy="10" r="3" />
                        <path d="M6.168 18.849A4 4 0 0 1 10 16h4a4 4 0 0 1 3.834 2.855" />
                    </svg>
                    <div style="text-align: center; margin-top: 0.5rem;">
                        <span style="color: #999; font-size: 0.75rem; display: block; margin-bottom: 0.5rem;">${emptyMessage}</span>
                        <button class="become-role-btn" onclick="openWorkerModal('${role}')" style="
                            background: ${roleColor};
                            color: white;
                            border: none;
                            padding: 0.4rem 0.8rem;
                            font-size: 0.75rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        ">Become ${roleTitle}</button>
                    </div>
                `;
                return;
            }

            // Special handling for multi-worker roles (dreamstyler, cheerful)
            if (role === 'dreamstyler' || role === 'cheerful') {
                await updateMultiWorkerDisplay(roleInfo, role);
                return;
            }

            const worker = roleInfo.workers[0];
            console.log('ðŸ‘¤ Work: Fetching dreamer info for:', worker.did);
            
            // Fetch dreamer info to get handle and avatar
            try {
                const fetchStart = performance.now();
                console.log('ðŸŒ [API] Starting dreamer fetch at', new Date().toISOString());
                const dreamerResponse = await fetch(`/api/dreamers/${worker.did}`);
                const fetchDuration = performance.now() - fetchStart;
                console.log(`â±ï¸ [API] Dreamer fetch took ${fetchDuration.toFixed(0)}ms (status: ${dreamerResponse.status})`);
                
                if (dreamerResponse.ok) {
                    const dreamer = await dreamerResponse.json();
                    console.log('âœ… Work: Dreamer info received:', dreamer);
                    const userColor = dreamer.color_hex || '#8b7355';
                    
                    // Extract handle first - needed for challenge button and display
                    const rawHandle = dreamer.handle || 'unknown';
                    const handle = String(rawHandle).replace(/^@/, '');
                    const displayName = dreamer.display_name || handle;
                    const avatar = dreamer.avatar || '/assets/default-avatar.png';
                    
                    // Cogitarian Challenge button - always show for cogitarian, handle auth in onclick
                    let statusText = '';
                    let showChallengeButton = false;
                    
                    if (role === 'cogitarian' && worker.status === 'working') {
                        // Fetch current cogitarian rank for button text
                        let currentRankForButton = 'Prime';
                        try {
                            const historyResp = await fetch('/api/cogitarian/history');
                            if (historyResp.ok) {
                                const historyData = await historyResp.json();
                                currentRankForButton = historyData.current_rank || 'Prime';
                            }
                        } catch (e) {
                            console.warn('Could not fetch cogitarian rank:', e);
                        }
                        
                        // Always show challenge button (auth handled in openCogitarianChallenge)
                        showChallengeButton = true;
                        statusText = `
                            <button onclick="openCogitarianChallenge('${worker.did}', '${handle}')" 
                                class="challenge-btn"
                                style="
                                    margin-top: 0.25rem;
                                    background: var(--role-cogitarian);
                                    color: #fff;
                                    border: 1px solid var(--role-cogitarian-dark);
                                    padding: 0.25rem 0.5rem;
                                    font-size: 0.75rem;
                                    font-weight: 600;
                                    cursor: pointer;
                                    border-radius: 0;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    transition: all 0.2s ease;
                                    font-family: 'Courier New', monospace;
                                "
                                onmouseover="this.style.background='var(--role-cogitarian-dark)'"
                                onmouseout="this.style.background='var(--role-cogitarian)'"
                            >Challenge Cogitarian (${currentRankForButton})</button>
                        `;
                    } else if (worker.status === 'retiring') {
                        statusText = ` <span onclick="event.stopPropagation(); openWorkerModal('${role}');" role="button" style="color: ${userColor}; font-weight: 400; font-size: 0.85rem; text-decoration: none; cursor: pointer;">(retiring)</span>`;
                    } else if (worker.status === 'working') {
                        statusText = ` <span style="color: ${userColor}; font-weight: 400; font-size: 0.85rem;">(working)</span>`;
                    }
                    
                    // Apply worker color to the worker card border
                    const workerCard = document.querySelector('.role-worker-card');
                    const workerCardHeader = document.querySelector('.worker-card-header');
                    if (workerCard) {
                        workerCard.style.borderColor = userColor;
                    }
                    if (workerCardHeader) {
                        workerCardHeader.style.borderColor = userColor;
                    }
                    
                    // Use DID for Bluesky link to avoid PDS handle resolution issues
                    // (handles for users on external PDS won't resolve via local PDS)
                    workerDisplay.innerHTML = `
                        <a href="/dreamer?did=${worker.did}" style="display:block; text-align:center;">
                            <img src="${avatar}" 
                                 alt="${handle}" 
                                 class="greeter-avatar"
                                 style="width: 48px; height: 48px; border-radius: 50%; border: 2px solid ${userColor}; object-fit: cover; display:block; margin: 0 auto;">
                        </a>
                        <div style="text-align: center; margin-top: 0.5rem;">
                            <a href="/dreamer?did=${worker.did}" class="worker-name" style="font-size: 1.1rem; font-weight: 600; color: ${userColor}; text-decoration: none; display:block;">${displayName}</a>
                            <a href="https://bsky.app/profile/${worker.did}" target="_blank" rel="noopener noreferrer" class="worker-handle" style="color: #999; font-weight: 400; font-size: 0.85rem; text-decoration: none;">@${handle}</a>
                            <div style="margin-top: 0.25rem;">${statusText}</div>
                        </div>
                    `;
                    
                    console.log('âœ… Work: Worker display updated');
                    
                    // Initialize dreamer-hover for the link after DOM updates
                    setTimeout(() => {
                        if (window.DreamerHover) {
                            window.DreamerHover.init();
                        }
                    }, 100);
                } else {
                    console.error('âŒ Work: Dreamer API failed:', dreamerResponse.status);
                    // Fallback if API fails - show DID
                    workerDisplay.innerHTML = `
                        <a href="/dreamer?did=${worker.did}" 
                           style="font-size: 1rem; color: #8b7355; text-decoration: none;">
                            ${worker.did.substring(0, 20)}...
                        </a>
                    `;
                }
            } catch (error) {
                console.error('âŒ Work: Failed to fetch dreamer info:', error);
                // Fallback if network error - show DID
                workerDisplay.innerHTML = `
                    <a href="/dreamer?did=${worker.did}" 
                       style="font-size: 1rem; color: #8b7355; text-decoration: none;">
                        ${worker.did.substring(0, 20)}...
                    </a>
                `;
            }
        }

        // Display multiple workers for multi-worker roles (like dreamstyler, cheerful)
        async function updateMultiWorkerDisplay(roleInfo, role) {
            const workerDisplay = document.getElementById('worker-display');
            const workers = roleInfo.workers || [];
            const roleColor = role === 'cheerful' ? 'var(--role-cheerful)' : 'var(--role-dreamstyler)';
            const defaultColor = role === 'cheerful' ? '#e05ecf' : '#9e75e5';
            const buttonText = role === 'cheerful' ? 'Join The Cheerful' : 'Become Dreamstyler';
            const emptyMessage = role === 'cheerful' ? 'No Current Cheerful' : 'No Active Dreamstylers';
            
            // Set card border color
            const workerCard = document.querySelector('.role-worker-card');
            const workerCardHeader = document.querySelector('.worker-card-header');
            if (workerCard) workerCard.style.borderColor = roleColor;
            if (workerCardHeader) workerCardHeader.style.borderColor = roleColor;
            
            // Handle empty workers array
            if (workers.length === 0) {
                workerDisplay.innerHTML = `
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="1.5" style="margin: 0 auto; display: block;">
                        <circle cx="12" cy="12" r="10" />
                        <circle cx="12" cy="10" r="3" />
                        <path d="M6.168 18.849A4 4 0 0 1 10 16h4a4 4 0 0 1 3.834 2.855" />
                    </svg>
                    <div style="text-align: center; margin-top: 0.5rem;">
                        <span style="color: #999; font-size: 0.75rem; display: block; margin-bottom: 0.5rem;">${emptyMessage}</span>
                        <button class="become-role-btn" onclick="openWorkerModal('${role}')" style="
                            background: ${roleColor};
                            color: white;
                            border: none;
                            padding: 0.4rem 0.8rem;
                            font-size: 0.75rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        ">${buttonText}</button>
                    </div>
                `;
                return;
            }
            
            // Check if current user is already a worker for this role
            const currentUserDID = currentSession?.sub || currentSession?.did;
            const isCurrentUserWorker = currentUserDID && workers.some(w => w.did === currentUserDID);
            
            // Fetch all worker info in parallel
            const workerInfoPromises = workers.map(async (worker) => {
                try {
                    const response = await fetch(`/api/dreamers/${worker.did}`);
                    if (response.ok) {
                        const dreamer = await response.json();
                        return {
                            did: worker.did,
                            handle: dreamer.handle || 'unknown',
                            displayName: dreamer.display_name || dreamer.handle || 'Unknown',
                            avatar: dreamer.avatar || '/assets/default-avatar.png',
                            color: dreamer.color_hex || defaultColor
                        };
                    }
                } catch (e) {
                    console.error('Failed to fetch dreamer:', e);
                }
                return {
                    did: worker.did,
                    handle: 'unknown',
                    displayName: 'Unknown',
                    avatar: '/assets/default-avatar.png',
                    color: defaultColor
                };
            });
            
            const workerInfos = await Promise.all(workerInfoPromises);
            
            // Randomize order of workers in carousel
            const shuffledWorkers = [...workerInfos].sort(() => Math.random() - 0.5);
            
            // Button for becoming a member of this role
            const becomeButton = `
                    <button class="become-role-btn" onclick="openWorkerModal('${role}')" style="
                        background: ${isCurrentUserWorker ? '#ddd' : roleColor};
                        color: ${isCurrentUserWorker ? '#999' : 'white'};
                        border: none;
                        padding: 0.5rem 1rem;
                        font-size: 0.7rem;
                        font-weight: 600;
                        cursor: ${isCurrentUserWorker ? 'not-allowed' : 'pointer'};
                        transition: all 0.2s ease;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        width: 100%;
                        margin-top: 0.5rem;
                        opacity: ${isCurrentUserWorker ? '0.6' : '1'};
                    " ${isCurrentUserWorker ? 'disabled' : ''}>${buttonText}</button>`;
            
            // Build carousel-style display with arrows (simpler, smaller)
            workerDisplay.innerHTML = `
                <div class="dreamstyler-carousel" data-current="0" data-total="${shuffledWorkers.length}" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <button class="carousel-arrow carousel-prev" style="background: none; border: none; color: #ccc; font-size: 1.2rem; cursor: pointer; padding: 0.25rem; opacity: ${shuffledWorkers.length > 1 ? '1' : '0.3'};" ${shuffledWorkers.length <= 1 ? 'disabled' : ''} onclick="(function(btn){
                        const carousel = btn.closest('.dreamstyler-carousel');
                        let current = parseInt(carousel.dataset.current) || 0;
                        const total = parseInt(carousel.dataset.total) || 1;
                        const slides = carousel.querySelectorAll('.dreamstyler-slide');
                        slides[current].style.display = 'none';
                        current = (current - 1 + total) % total;
                        slides[current].style.display = 'block';
                        carousel.dataset.current = current;
                    })(this)">â—€</button>
                    <div class="carousel-slides" style="flex: 1; min-width: 0;">
                        ${shuffledWorkers.map((w, i) => {
                            return `
                            <div class="dreamstyler-slide" data-index="${i}" style="display: ${i === 0 ? 'block' : 'none'}; text-align: center;">
                                <a href="/dreamer?did=${encodeURIComponent(w.did)}" class="dreamer-link" data-did="${w.did}" style="text-decoration: none;">
                                    <img src="${w.avatar}" alt="${w.handle}" 
                                         style="width: 36px; height: 36px; border-radius: 50%; border: 2px solid ${w.color}; object-fit: cover; margin: 0 auto 0.35rem; display: block;">
                                    <div style="color: ${w.color}; font-weight: 600; font-size: 0.8rem;">${w.displayName}</div>
                                    <div style="color: #999; font-size: 0.65rem;">@${w.handle}</div>
                                </a>
                            </div>
                        `}).join('')}
                    </div>
                    <button class="carousel-arrow carousel-next" style="background: none; border: none; color: #ccc; font-size: 1.2rem; cursor: pointer; padding: 0.25rem; opacity: ${shuffledWorkers.length > 1 ? '1' : '0.3'};" ${shuffledWorkers.length <= 1 ? 'disabled' : ''} onclick="(function(btn){
                        const carousel = btn.closest('.dreamstyler-carousel');
                        let current = parseInt(carousel.dataset.current) || 0;
                        const total = parseInt(carousel.dataset.total) || 1;
                        const slides = carousel.querySelectorAll('.dreamstyler-slide');
                        slides[current].style.display = 'none';
                        current = (current + 1) % total;
                        slides[current].style.display = 'block';
                        carousel.dataset.current = current;
                    })(this)">â–¶</button>
                </div>
                ${becomeButton}
            `;
            
            // Initialize dreamer-hover
            setTimeout(() => {
                if (window.DreamerHover) window.DreamerHover.init();
            }, 100);
        }

        // LEGACY: Wrapper for backward compatibility
        async function openGreeterModal() {
            await openWorkerModal('greeter');
        }
        
        // LEGACY: Wrapper for backward compatibility
        async function activateWithExistingCredentials() {
            await activateWorkerWithExistingCredentials('greeter');
        }

        // LEGACY: Wrapper for mapper
        async function openMapperModal() {
            await openWorkerModal('mapper');
        }
        
        // LEGACY: Wrapper for cogitarian
        async function openCogitarianModal() {
            await openWorkerModal('cogitarian');
        }
        
        // LEGACY: Wrapper for mapper
        async function activateMapperWithExistingCredentials() {
            await activateWorkerWithExistingCredentials('mapper');
        }

        // Loading overlay helpers
        function showLoadingOverlay(message = 'Processing...') {
            const overlay = document.getElementById('loading-overlay');
            const textElement = overlay.querySelector('.loading-text');
            if (textElement) {
                textElement.textContent = message;
            }
            overlay.style.display = 'flex';
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'none';
        }

        // Example greeting posts - loaded from API
        let greetingExamples = [];
        
        // Example mapper posts - origin declarations
        let mapperExamples = [
            {
                text: '<div style="text-align: center; letter-spacing: 2px; font-weight: 600; font-family: \'Courier New\', monospace;">O22 A11 S05 R88 L63 E71</div>'
            }
        ];

        // Role configuration for universal modal (defined early so selectRole can use it)
        const roleConfigs = {
            greeter: {
                title: 'Greeter of Reveries',
                description: 'You are one who wishes to welcome newcomers to Reverie House and help them find their way through our wild mindscape.<br><br>As Greeter you will automatically provide newcomers with their name, and offer them a friendly helping hand should they need one.',
                exampleLabel: 'Welcome Greetings',
                appPasswordName: 'Greeter of Reveries',
                passwordPurpose: 'for posting greetings',
                roleName: 'Greeter of Reveries',
                roleNameLower: 'greeter',
                buttonText: 'BECOME GREETER',
                confirmTitle: 'Become Greeter of Reveries?',
                confirmMessage: 'As Greeter, you will automatically message new dreamers with a personalized welcome to Reverie House.',
                activationMessage: 'You are now the active greeter!',
                showExamples: true,
                getExamples: () => greetingExamples
            },
            mapper: {
                title: 'Spectrum Mapper',
                description: 'You are one who wishes to chart the origins of dreamers in our wild mindscape, mapping their outsets within the reverie spectrum.<br><br>As <b>Spectrum Mapper</b> you will automatically deduce and declare the starting coordinates of those who reveal their origins in our wild mindscape.',
                exampleLabel: 'Origin Declarations',
                appPasswordName: 'Spectrum Mapper',
                passwordPurpose: 'for posting origin declarations',
                roleName: 'Spectrum Mapper',
                roleNameLower: 'mapper',
                buttonText: 'BECOME MAPPER',
                confirmTitle: 'Become Spectrum Mapper?',
                confirmMessage: 'As Spectrum Mapper, you will automatically deduce and declare the starting coordinates of those who reveal their origins in our wild mindscape.',
                activationMessage: 'You are now Spectrum Mapper of Reverie House\nThank you for working!\nPlease stop if it feels like work.',
                showExamples: true,
                getExamples: () => mapperExamples
            },
            cogitarian: {
                title: 'Cogitarian (Prime)',
                description: 'Our Cogitarian is a humanizing authority who helps codify human elements within our shared technical foundation and help deter dehumanizations.<br><br>You will work closely with the current Keeper(s) to take responsibility for defining the immutably human aspects of our environment, in effort to keep our wild mindscape a more dependable place for real dreamrs.',
                exampleLabel: 'Discourse Examples',
                appPasswordName: 'Cogitarian (Prime)',
                passwordPurpose: 'for fostering discourse',
                roleName: 'Cogitarian (Prime)',
                roleNameLower: 'cogitarian',
                buttonText: 'BECOME COGITARIAN',
                confirmTitle: 'Become Cogitarian (Prime)?',
                confirmMessage: 'As Cogitarian, you will help foster thoughtful discourse in Reverie House.',
                activationMessage: 'You are now the active cogitarian!',
                showExamples: false,
                getExamples: () => []
            },
            provisioner: {
                title: 'Head of Pantry',
                description: 'Provisioners are dreamweavers who understand that ease of rest in the waking world eases all manner of dreams across our wild mindscape.<br><br>When another dreamer at Reverie House feels the real pangs of hunger, it is <b>Head of Pantry</b> who will remotely try to ease their burden with food.',
                exampleLabel: 'Pantry Examples',
                appPasswordName: 'Head of Pantry',
                passwordPurpose: 'for managing food assistance',
                roleName: 'Head of Pantry',
                roleNameLower: 'provisioner',
                buttonText: 'BECOME PROVISIONER',
                confirmTitle: 'Become Head of Pantry?',
                confirmMessage: 'As Head of Pantry, you will help ease the hunger of dreamers in need.',
                activationMessage: 'You are now Head of Pantry\nThank you for working!\nPlease stop if it feels like work.',
                showExamples: false,
                getExamples: () => []
            },
            dreamstyler: {
                title: 'Dreamstyler',
                description: 'There is a wide difference between the aesthetics of dreams, and a highly visioned Dreamstyler is versatile enough to help shape or translate the dreams of others.<br><br>Because there are so many tastes, there are many types of Dreamstyler and Reverie House makes no distinction. Let yourself be known to others, and maintain your own designs.',
                exampleLabel: 'Style Examples',
                appPasswordName: 'Dreamstyler',
                passwordPurpose: 'for aesthetic work',
                roleName: 'Dreamstyler',
                roleNameLower: 'dreamstyler',
                buttonText: 'BECOME DREAMSTYLER',
                confirmTitle: 'Become Dreamstyler?',
                confirmMessage: 'As a <strong>Dreamstyler</strong>, other dreamweavers may entreat you for help shaping aesthetic elements of their dreams. Respond as you please, and use your own discretion when collaborating.<br><br>Contact help@reverie.house if necessary.',
                activationMessage: 'You are now a Dreamstyler\nThank you for working!\nPlease stop if it feels like work.',
                showExamples: false,
                requiresAppPassword: false,
                getExamples: () => []
            },
            bursar: {
                title: 'Bursar of Schemes',
                description: 'Coordinating the use of scarce resources is a vital and indispensible role (according to the Bursar of Schemes)<br><br>This guardian of transparency works as the connective tissue between various patrons and the amazing dreams that need their support.',
                exampleLabel: 'Treasury Updates',
                appPasswordName: null, // Bursar holds no app password
                passwordPurpose: null,
                roleName: 'Bursar of Schemes',
                roleNameLower: 'bursar',
                buttonText: 'BECOME BURSAR',
                confirmTitle: 'Become Bursar of Schemes?',
                confirmMessage: 'As Bursar, you will maintain financial transparency and serve as the community\'s point of contact for OpenCollective matters. This role requires no app password.',
                activationMessage: 'You are now Bursar of Schemes\nMay your stewardship be transparent and true.\nScheme openly.',
                showExamples: false,
                requiresAppPassword: false,
                getExamples: () => []
            },
            cheerful: {
                title: 'The Cheerful',
                description: 'The Cheerful surrender their positivity to the collective, and trust the community\'s intention.<br><br>By taking this role, you authorize Reverie House to influence our wild mindscape with your inherent positivity.',
                exampleLabel: 'Positivity Network',
                appPasswordName: 'The Cheerful',
                passwordPurpose: 'for spreading positivity',
                roleName: 'The Cheerful',
                roleNameLower: 'cheerful',
                buttonText: 'BECOME CHEERFUL',
                confirmTitle: 'Join The Cheerful?',
                confirmMessage: 'The Cheerful surrender their positivity to the collective, and trust the community\'s intention.<br><br>By taking this role, you authorize Reverie House to influence our wild mindscape with your inherent positivity.',
                activationMessage: 'You have joined The Cheerful\nYour positivity will ripple outward.\nA welcome mat that never sleeps.',
                showExamples: false,
                requiresAppPassword: true,
                multiWorker: true,
                getExamples: () => []
            }
        };

        // Store greeting templates for carousel
        let greetingTemplates = [];
        let currentGreetingIndex = 0;

        // Load greeting templates from API for the carousel
        async function loadGreetingTemplates() {
            try {
                const response = await fetch('/api/work/greeter/templates');
                if (response.ok) {
                    const data = await response.json();
                    if (data.templates && data.templates.length > 0) {
                        // Convert templates to display format with placeholder handle
                        greetingTemplates = data.templates.map(template => 
                            template.replace(/@\{handle\}/g, '<a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>')
                                    .replace(/\n/g, '<br>')
                        );
                        
                        // Also populate greetingExamples for modal compatibility
                        greetingExamples = data.templates.map(template => ({
                            text: template.replace(/@\{handle\}/g, '<a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>')
                                         .replace(/\n/g, '<br>')
                        }));
                        
                        // Update both displays after loading templates
                        updateGreetingsDisplay();
                        updateExamplePost();
                    } else {
                        // Fallback templates if API fails
                        useGreetingFallbackTemplates();
                    }
                } else {
                    useGreetingFallbackTemplates();
                }
            } catch (error) {
                console.error('Failed to load greeting templates:', error);
                useGreetingFallbackTemplates();
            }
        }

        function useGreetingFallbackTemplates() {
            greetingTemplates = [
                'Welcome to Reverie House, <a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>!<br><br>I\'m here to help if you have any questions.',
                'Hello <a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>, glad to meet you.<br><br>Feel free to ask for anything if you need it.',
                'Welcome, <a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>! Glad you found your way.<br><br>Let me know if you have questions?',
                'Greetings <a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>! Welcome to Reverie House.<br><br>I\'m here to help you settle in.',
                'Welcome to Reverie House <a href="/dreamer.html?handle=dreamer.reverie.house" class="mention-link">@dreamer.reverie.house</a>!<br><br>Let me know if you have any questions?'
            ];
            
            greetingExamples = greetingTemplates.map(text => ({ text }));
            updateGreetingsDisplay();
            updateExamplePost();
        }

        // Load greeting events for eventstack display
        async function loadGreetingEvents() {
            try {
                const response = await fetch('/api/canon');
                if (response.ok) {
                    const allEvents = await response.json();
                    
                    // Group events: parent events with their reactions embedded
                    // First, separate reactions from parent events
                    const parentEvents = [];
                    const reactions = {};
                    
                    allEvents.forEach(event => {
                        if (event.key === 'name' || event.key === 'greeter') {
                            if (event.reaction_to) {
                                // This is a reaction - group by parent URI
                                if (!reactions[event.reaction_to]) {
                                    reactions[event.reaction_to] = [];
                                }
                                reactions[event.reaction_to].push(event);
                            } else {
                                // This is a parent event
                                parentEvents.push(event);
                            }
                        }
                    });
                    
                    // Attach reactions to their parent events
                    parentEvents.forEach(parent => {
                        if (parent.uri && reactions[parent.uri]) {
                            parent.reactions = reactions[parent.uri];
                        }
                    });
                    
                    console.log(`[Work] Found ${parentEvents.length} greeting events with reactions`);
                    
                    // Render with EventStack (auto mode uses database color_source and color_hex)
                    if (window.EventStack) {
                        const eventStack = new EventStack();
                        eventStack.render(parentEvents, document.getElementById('greeter-eventstack'), {
                            colorMode: 'auto',
                            colorIntensity: 'highlight',
                            limit: 20,
                            sortOrder: 'desc',
                            emptyMessage: 'No greeting events yet',
                            showReactions: true,
                            dateFormat: 'date',
                            columns: {
                                type: false,
                                key: false,
                                uri: false
                            }
                        });
                    } else {
                        console.warn('[Work] EventStack not available yet');
                    }
                } else {
                    console.error('Failed to load events:', response.status);
                }
            } catch (error) {
                console.error('Failed to load greeting events:', error);
            }
        }

        // Load repository data from GitHub
        async function loadRepoData() {
            const contentDiv = document.getElementById('repo-data-content');
            const repoInfoDiv = document.getElementById('repo-info');
            if (!contentDiv) return;
            
            try {
                // Fetch repo info for languages
                const repoResponse = await fetch('https://api.github.com/repos/errantson/reverie');
                const repoData = await repoResponse.json();
                
                // Fetch languages
                const languagesResponse = await fetch('https://api.github.com/repos/errantson/reverie/languages');
                const languagesData = await languagesResponse.json();
                const topLanguages = Object.keys(languagesData).slice(0, 3).map(lang => {
                    // Change JavaScript to JS for display
                    return lang === 'JavaScript' ? 'JS' : lang;
                }).join(', ');
                const lastUpdated = new Date(repoData.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                // Update repo info if available
                    if (repoInfoDiv) {
                    // Convert GitHub 'size' (KB) to human-readable string
                    function humanFileSizeFromKB(kb) {
                        if (kb === null || kb === undefined) return 'N/A';
                        const bytes = kb * 1024;
                        const thresh = 1024;
                        if (Math.abs(bytes) < thresh) return bytes + ' B';
                        const units = ['KB','MB','GB','TB'];
                        let u = -1;
                        let value = bytes;
                        do {
                            value /= thresh;
                            ++u;
                        } while (Math.abs(value) >= thresh && u < units.length - 1);
                        return value.toFixed(1) + ' ' + units[u];
                    }

                    const fileSize = humanFileSizeFromKB(repoData.size);
                    const openIssues = repoData.open_issues_count ?? 'N/A';
                    const watchers = repoData.watchers_count ?? repoData.subscribers_count ?? 'N/A';

                    repoInfoDiv.innerHTML = `
                        <div class="repo-info-item">
                            <span class="repo-info-label">Languages:</span>
                            <span class="repo-info-value">${topLanguages || 'N/A'}</span>
                        </div>
                        <div class="repo-info-item">
                            <span class="repo-info-label">Updated:</span>
                            <span class="repo-info-value">${lastUpdated || 'N/A'}</span>
                        </div>
                        <div class="repo-info-item">
                            <span class="repo-info-label">Watchers:</span>
                            <span class="repo-info-value">${watchers}</span>
                        </div>
                        <div class="repo-info-item">
                            <span class="repo-info-label">File Size:</span>
                            <span class="repo-info-value">${fileSize}</span>
                        </div>
                    `;

                    // Update the Issues button to include the open issues count
                    try {
                        const issuesBtn = document.querySelector('a[href="https://github.com/errantson/reverie/issues"]');
                        if (issuesBtn) {
                            const svg = issuesBtn.querySelector('svg');
                            const svgHtml = svg ? svg.outerHTML : '';
                            const countText = (typeof openIssues === 'number') ? openIssues : openIssues;
                            issuesBtn.innerHTML = `\n                                ${svgHtml}\n                                Open Issues: ${countText}\n                            `;
                        }
                    } catch (e) {
                        console.warn('Failed to update issues button:', e);
                    }
                }
                
                // Fetch all commits (max 100 per page, fetch multiple pages)
                let allCommits = [];
                let page = 1;
                let hasMore = true;
                
                while (hasMore && page <= 3) { // Limit to 3 pages (300 commits) for performance
                    const commitsResponse = await fetch(`https://api.github.com/repos/errantson/reverie/commits?per_page=100&page=${page}`);
                    if (!commitsResponse.ok) throw new Error('Failed to fetch commits');
                    const commits = await commitsResponse.json();
                    
                    if (commits.length === 0) {
                        hasMore = false;
                    } else {
                        allCommits = allCommits.concat(commits);
                        page++;
                    }
                }
                
                // Fetch contributors
                const contributorsResponse = await fetch('https://api.github.com/repos/errantson/reverie/contributors');
                if (!contributorsResponse.ok) throw new Error('Failed to fetch contributors');
                const contributors = await contributorsResponse.json();
                
                // Format commit rows
                const commitRows = allCommits.map(commit => {
                    const date = new Date(commit.commit.committer.date);
                    const timeAgo = formatTimeAgo(date);
                    const message = commit.commit.message.split('\n')[0];
                    const commitUrl = commit.html_url;
                    
                    return `
                        <a href="${commitUrl}" target="_blank" class="commit-row">
                            <span class="commit-message">${message}</span>
                            <span class="commit-meta">${timeAgo}</span>
                        </a>
                    `;
                }).join('');
                
                // Format contributors
                const contributorsList = contributors.slice(0, 5).map(contrib => `
                    <a href="${contrib.html_url}" target="_blank" class="contributor-link" title="${contrib.login} - ${contrib.contributions} contributions">
                        <img src="${contrib.avatar_url}" alt="${contrib.login}" class="contributor-avatar">
                    </a>
                `).join('');
                
                contentDiv.innerHTML = `
                    <div class="commits-section">
                        ${commitRows}
                    </div>
                    <div class="contributors-section">
                        <div class="contributors-label">Contributors</div>
                        <div class="contributors-list">
                            ${contributorsList}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load repo data:', error);
                contentDiv.innerHTML = '<div class="repo-error">Failed to load repository data</div>';
            }
        }
        
        // Format time ago helper
        function formatTimeAgo(date) {
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            if (seconds < 2592000) return `${Math.floor(seconds / 604800)}w ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Update greetings carousel display
        function updateGreetingsDisplay() {
            const greetingsDisplay = document.getElementById('greeter-greetings-display');
            if (!greetingsDisplay) return;
            
            if (greetingTemplates.length === 0) {
                greetingsDisplay.innerHTML = '<div class="greeting-text" style="color: #999; font-style: italic;">Loading templates...</div>';
                return;
            }
            
            const template = greetingTemplates[currentGreetingIndex];
            greetingsDisplay.innerHTML = `<div class="greeting-text">${template}</div>`;
        }

        function nextGreeting() {
            if (greetingTemplates.length === 0) return;
            currentGreetingIndex = (currentGreetingIndex + 1) % greetingTemplates.length;
            updateGreetingsDisplay();
        }

        function previousGreeting() {
            if (greetingTemplates.length === 0) return;
            currentGreetingIndex = (currentGreetingIndex - 1 + greetingTemplates.length) % greetingTemplates.length;
            updateGreetingsDisplay();
        }

        let currentExampleIndex = 0;

        function updateExamplePost() {
            // Update modal example based on current role
            const examplePost = document.getElementById('example-post');
            if (examplePost && currentModalRole) {
                const config = roleConfigs[currentModalRole];
                if (config) {
                    const examples = config.getExamples();
                    if (examples.length > 0) {
                        examplePost.innerHTML = `<div class="post-text">${examples[currentExampleIndex].text}</div>`;
                    }
                }
            }
            
            // Update greeter role description example (legacy)
            const examplePostGreeter = document.getElementById('example-post-greeter');
            if (examplePostGreeter && greetingExamples.length > 0) {
                examplePostGreeter.innerHTML = `<div class="post-text">${greetingExamples[currentExampleIndex].text}</div>`;
            }
            
            // Update greeter carousel example
            const greeterExampleDisplay = document.getElementById('greeter-example-display');
            if (greeterExampleDisplay) {
                if (greetingExamples.length > 0) {
                    greeterExampleDisplay.innerHTML = `<div class="example-text">${greetingExamples[currentExampleIndex].text}</div>`;
                } else {
                    greeterExampleDisplay.innerHTML = `<div class="example-text" style="color: #999; font-style: italic;">Loading examples...</div>`;
                }
            }
        }

        function nextExample() {
            if (currentModalRole) {
                const config = roleConfigs[currentModalRole];
                const examples = config ? config.getExamples() : greetingExamples;
                currentExampleIndex = (currentExampleIndex + 1) % examples.length;
            } else {
                currentExampleIndex = (currentExampleIndex + 1) % greetingExamples.length;
            }
            updateExamplePost();
        }

        function previousExample() {
            if (currentModalRole) {
                const config = roleConfigs[currentModalRole];
                const examples = config ? config.getExamples() : greetingExamples;
                currentExampleIndex = (currentExampleIndex - 1 + examples.length) % examples.length;
            } else {
                currentExampleIndex = (currentExampleIndex - 1 + greetingExamples.length) % greetingExamples.length;
            }
            updateExamplePost();
        }

        // ====== COGITARIAN CHALLENGE SYSTEM ======
        
        // Cogitarian succession ranks
        const COGITARIAN_RANKS = [
            'Prime', 'Alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Theta',
            'Iota', 'Kappa', 'Lambda', 'Mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho',
            'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'
        ];
        
        // Open the cogitarian challenge popup
        async function openCogitarianChallenge(challengedDid, challengedHandle) {
            // Check if logged in
            if (!currentSession) {
                // Prompt login
                if (window.loginWidget && typeof window.loginWidget.showLoginPopup === 'function') {
                    window.loginWidget.showLoginPopup();
                }
                return;
            }
            
            const challengerDid = currentSession.did || currentSession.sub;
            const challengerHandle = currentSession.profile?.handle || currentSession.handle || '';
            
            // Must have .reverie.house handle - offer to adopt one
            if (!challengerHandle.endsWith('.reverie.house')) {
                // Try to show change handle widget to adopt a .reverie.house handle
                if (window.changeHandleWidget) {
                    window.changeHandleWidget.show({
                        reason: 'cogitarian_challenge',
                        provisionerHandle: 'reverie.house',
                        onSuccess: () => {
                            // Retry the challenge after handle change
                            setTimeout(() => openCogitarianChallenge(challengedDid, challengedHandle), 500);
                        }
                    });
                } else {
                    showCelebration('Only dreamers with a .reverie.house handle may challenge the Cogitarian.\\n\\nPlease contact a Greeter to claim your Reverie House identity.', 'error');
                }
                return;
            }
            
            // Can't challenge yourself
            if (challengerDid === challengedDid) {
                showCelebration('You cannot challenge yourself.', 'error');
                return;
            }
            
            // Fetch cogitarian history from dedicated API
            let cogitarianHistory = [];
            let currentRank = 'Prime';  // First cogitarian is always Prime
            let challengerRank = 'Alpha';  // Challenger would be next in line
            
            try {
                const historyResponse = await fetch('/api/cogitarian/history');
                if (historyResponse.ok) {
                    const historyData = await historyResponse.json();
                    cogitarianHistory = historyData.history || [];
                    currentRank = historyData.current_rank || 'Prime';
                    challengerRank = historyData.next_rank || 'Alpha';
                }
            } catch (e) {
                console.warn('Could not fetch cogitarian history:', e);
            }
            
            // Fetch challenged dreamer details
            let challengedDreamer = null;
            try {
                const dreamerResponse = await fetch(`/api/dreamers/${challengedDid}`);
                if (dreamerResponse.ok) {
                    challengedDreamer = await dreamerResponse.json();
                }
            } catch (e) {
                console.warn('Could not fetch challenged dreamer:', e);
            }
            
            // Fetch challenger dreamer details for color and avatar
            let challengerColor = 'var(--role-cogitarian)';
            let challengerAvatar = '/assets/default-avatar.png';
            let challengerName = challengerHandle;
            try {
                const challengerResponse = await fetch(`/api/dreamers/${challengerDid}`);
                if (challengerResponse.ok) {
                    const challengerDreamer = await challengerResponse.json();
                    challengerColor = challengerDreamer?.color_hex || 'var(--role-cogitarian)';
                    challengerAvatar = challengerDreamer?.avatar || '/assets/default-avatar.png';
                    challengerName = challengerDreamer?.display_name || challengerHandle;
                }
            } catch (e) {
                console.warn('Could not fetch challenger dreamer:', e);
            }
            
            const challengedName = challengedDreamer?.display_name || challengedHandle;
            const challengedAvatar = challengedDreamer?.avatar || '/assets/default-avatar.png';
            const challengedColor = challengedDreamer?.color_hex || 'var(--role-cogitarian)';
            
            // Create the challenge modal - matching existing modal styles
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'cogitarian-challenge-modal';
            modalOverlay.className = 'modal show';
            
            modalOverlay.innerHTML = `
                <div class="modal-content" style="max-width: 520px; border: 3px solid var(--role-cogitarian-medium);">
                    <div class="city-modal-title" style="color: var(--role-cogitarian-dark); border-color: var(--role-cogitarian-light);">
                        Challenge the Cogitarian
                    </div>
                    
                    <!-- Avatars with statement between: Challenger (left) vs Cogitarian (right) -->
                    <div style="display: flex; align-items: stretch; gap: 0.5rem; margin-bottom: 1rem; background: #f8f8f8; padding: 0.75rem; border: 1px solid #ccc;">
                        <!-- Left: Challenger -->
                        <div style="text-align: center; min-width: 100px; background: white; border: 2px solid ${challengerColor}; padding: 0.5rem;">
                            <div style="font-size: 0.6rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.3rem; font-family: 'Courier New', monospace;">
                                Challenger
                            </div>
                            <img src="${challengerAvatar}" alt="${challengerName}" style="
                                width: 44px; height: 44px; border-radius: 50%; border: 2px solid ${challengerColor};
                                object-fit: cover; margin-bottom: 0.3rem;
                            ">
                            <div style="font-weight: 600; color: ${challengerColor}; font-size: 0.8rem;">${challengerName}</div>
                            <div style="color: #666; font-size: 0.65rem; font-family: 'Courier New', monospace;">@${challengerHandle}</div>
                        </div>
                        
                        <!-- Center: Challenge Statement -->
                        <div style="flex: 1; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 0.8rem; color: #333; line-height: 1.6; padding: 0.5rem; background: white; border: 1px solid #ddd;">
                            <div>
                                <div style="font-weight: 600; color: ${challengerColor};">@${challengerHandle}</div>
                                <div style="color: #666; font-size: 0.75rem;">challenges</div>
                                <div style="font-weight: 600; color: ${challengedColor};">@${challengedHandle}</div>
                                <div><strong class="role-text-cogitarian">Cogitarian</strong> (<strong class="role-text-cogitarian">${currentRank}</strong>)</div>
                                <div style="color: #666; font-size: 0.75rem;">of <strong style="color: #704891;">Reverie House</strong></div>
                            </div>
                        </div>
                        
                        <!-- Right: Current Cogitarian (Challenged) -->
                        <div style="text-align: center; min-width: 100px; background: white; border: 2px solid ${challengedColor}; padding: 0.5rem;">
                            <div style="font-size: 0.6rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.3rem; font-family: 'Courier New', monospace;">
                                <strong class="role-text-cogitarian">Cogitarian</strong> (<strong class="role-text-cogitarian">${currentRank}</strong>)
                            </div>
                            <img src="${challengedAvatar}" alt="${challengedName}" style="
                                width: 44px; height: 44px; border-radius: 50%; border: 2px solid ${challengedColor};
                                object-fit: cover; margin-bottom: 0.3rem;
                            ">
                            <div style="font-weight: 600; color: ${challengedColor}; font-size: 0.8rem;">${challengedName}</div>
                            <div style="color: #666; font-size: 0.65rem; font-family: 'Courier New', monospace;">@${challengedHandle}</div>
                        </div>
                    </div>
                    
                    <!-- Reason for Challenge (beneath avatars) -->
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: 600; margin-bottom: 0.4rem; color: var(--role-cogitarian-dark); font-family: 'Courier New', monospace; font-size: 0.8rem;">Reason:</div>
                        <div style="display: flex; gap: 0.5rem;">
                            <label style="flex: 1; display: flex; align-items: center; gap: 0.4rem; cursor: pointer; padding: 0.4rem; background: #f9f9f9; border: 1px solid #ddd;">
                                <input type="radio" name="challenge-reason" value="wish_to_be" checked style="accent-color: var(--role-cogitarian);">
                                <span style="font-size: 0.8rem; color: #333;">I wish to be <strong class="role-text-cogitarian">Cogitarian</strong> (<strong class="role-text-cogitarian">${challengerRank}</strong>)</span>
                            </label>
                            <label style="flex: 1; display: flex; align-items: center; gap: 0.4rem; cursor: pointer; padding: 0.4rem; background: #2a1a2a; border: 1px solid #3d2a3d;">
                                <input type="radio" name="challenge-reason" value="wretched" style="accent-color: #8855aa;">
                                <span style="font-size: 0.8rem; color: #fff;">They have become wretched</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Statement Field (required) -->
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: 600; margin-bottom: 0.3rem; color: var(--role-cogitarian-dark); font-family: 'Courier New', monospace; font-size: 0.8rem;">Statement:</div>
                        <textarea id="challenge-evidence" placeholder="Explain your challenge..." required style="
                            width: 100%; min-height: 60px; padding: 0.5rem;
                            background: #fff; border: 2px solid var(--role-cogitarian-light);
                            font-size: 0.85rem; font-family: inherit;
                            resize: vertical; box-sizing: border-box;
                        "></textarea>
                    </div>
                    
                    <!-- Warning -->
                    <div style="
                        background: #fef8e7;
                        border: 1px solid #e6c65a;
                        padding: 0.5rem;
                        margin-bottom: 1rem;
                        font-size: 0.7rem;
                        color: #8a6d14;
                    ">
                        <strong>This challenge will be public.</strong> A record will be written to your PDS.<br>
                        The challenge will remain open for 14 days.<br>
                        <span id="challenge-oversight-text">It will be overseen by the Keeper.</span>
                    </div>
                    
                    <!-- Actions -->
                    <div class="city-modal-actions">
                        <button onclick="submitCogitarianChallenge('${challengedDid}', '${challengedHandle}', '${currentRank}', '${challengerRank}')" class="city-modal-btn city-send-btn" style="background: var(--role-cogitarian); border-color: var(--role-cogitarian-dark);">
                            Submit Challenge
                        </button>
                        <button onclick="closeCogitarianChallenge()" class="city-modal-btn city-cancel-btn">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // Update oversight text when challenge type changes
            const reasonRadios = modalOverlay.querySelectorAll('input[name="challenge-reason"]');
            const oversightText = document.getElementById('challenge-oversight-text');
            reasonRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'wretched') {
                        oversightText.textContent = 'Other dreamweavers will become involved.';
                    } else {
                        oversightText.textContent = 'It will be overseen by the Keeper.';
                    }
                });
            });
            
            // Close on overlay click
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeCogitarianChallenge();
                }
            });
        }
        
        function closeCogitarianChallenge() {
            const modal = document.getElementById('cogitarian-challenge-modal');
            if (modal) modal.remove();
        }
        
        async function submitCogitarianChallenge(challengedDid, challengedHandle, challengedRank, challengerRank) {
            const reasonInput = document.querySelector('input[name="challenge-reason"]:checked');
            const evidenceInput = document.getElementById('challenge-evidence');
            
            if (!reasonInput) {
                showCelebration('Please select a reason for your challenge.', 'error');
                return;
            }
            
            const challengeType = reasonInput.value;
            const evidence = evidenceInput?.value?.trim() || '';
            
            // Statement is required
            if (!evidence) {
                showCelebration('A statement is required to submit a challenge.', 'error');
                evidenceInput?.focus();
                return;
            }
            
            const submitBtn = document.querySelector('#cogitarian-challenge-modal .city-send-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
            }
            
            try {
                const response = await fetch('/api/cogitarian/challenge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('work_token') || ''}`
                    },
                    body: JSON.stringify({
                        challenged_did: challengedDid,
                        challenged_handle: challengedHandle,
                        challenged_rank: challengedRank,
                        challenger_rank: challengerRank,
                        challenge_type: challengeType,
                        evidence: evidence
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    closeCogitarianChallenge();
                    showCelebration(`Challenge submitted successfully!\\n\\nChallenge ID: ${result.challenge_id}`, 'success');
                    
                    // Optionally redirect to the challenge page
                    if (result.challenge_url) {
                        setTimeout(() => {
                            window.location.href = result.challenge_url;
                        }, 2000);
                    }
                } else {
                    throw new Error(result.error || 'Failed to submit challenge');
                }
            } catch (error) {
                console.error('Challenge submission error:', error);
                showCelebration(`Failed to submit challenge: ${error.message}`, 'error');
                
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Challenge';
                }
            }
        }

        // ====== UNIVERSAL WORKER MODAL SYSTEM ======
        
        let currentModalRole = null;

        // Universal worker modal opener
        async function openWorkerModal(role) {
            if (!currentSession) {
                if (window.loginWidget && typeof window.loginWidget.showLoginPopup === 'function') {
                    window.loginWidget.showLoginPopup();
                }
                return;
            }
            
            const config = roleConfigs[role];
            if (!config) {
                console.error('Unknown role:', role);
                return;
            }
            
            // Check if user has a different role first
            // Check if user has a different role
            let userCurrentRole = null;
            if (roleStatuses.greeter && roleStatuses.greeter.is_worker) userCurrentRole = 'greeter';
            else if (roleStatuses.mapper && roleStatuses.mapper.is_worker) userCurrentRole = 'mapper';
            else if (roleStatuses.cogitarian && roleStatuses.cogitarian.is_worker) userCurrentRole = 'cogitarian';
            else if (roleStatuses.provisioner && roleStatuses.provisioner.is_worker) userCurrentRole = 'provisioner';
            else if (roleStatuses.dreamstyler && roleStatuses.dreamstyler.is_worker) userCurrentRole = 'dreamstyler';
            else if (roleStatuses.bursar && roleStatuses.bursar.is_worker) userCurrentRole = 'bursar';
            else if (roleStatuses.cheerful && roleStatuses.cheerful.is_worker) userCurrentRole = 'cheerful';
            
            if (userCurrentRole && userCurrentRole !== role) {
                const currentRoleConfig = roleConfigs[userCurrentRole];
                const currentRoleTitle = currentRoleConfig ? currentRoleConfig.title : userCurrentRole;
                showCelebration(`You are currently ${currentRoleTitle}.\n\nStep down first to take on a new role.`, 'error');
                return;
            }
            
            // Block if user is already in THIS role
            if (userCurrentRole && userCurrentRole === role) {
                showCelebration(`You are already the active ${config.title}.`, 'error');
                return;
            }
            
            currentModalRole = role;
            
            // Check if there's already an active worker for this role
            // (Skip this check for dreamstyler since it's multi-worker)
            if (role !== 'dreamstyler') {
                const statusResponse = await fetch(`/api/work/${role}/status`);
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    if (statusData.activeWorker && statusData.activeWorker !== currentSession.did) {
                        showCelebration(`There is already an active ${config.roleNameLower}`, 'error');
                        return;
                    }
                }
            }
            
            // Special check for bursar: must be the top patron
            if (role === 'bursar') {
                try {
                    const dreamersResponse = await fetch('/api/dreamers');
                    if (dreamersResponse.ok) {
                        const allDreamers = await dreamersResponse.json();
                        
                        // Find top patron
                        const topPatron = allDreamers
                            .filter(d => (d.patron_score || 0) > 0)
                            .sort((a, b) => (b.patron_score || 0) - (a.patron_score || 0))[0];
                        
                        // Find current user's patron score
                        const currentUser = allDreamers.find(d => d.did === currentSession.did);
                        const userPatronScore = currentUser ? (currentUser.patron_score || 0) : 0;
                        
                        if (!topPatron || userPatronScore === 0) {
                            showCelebration('Only patrons may become Bursar.\n\nSupport Reverie House on OpenCollective to qualify.', 'error');
                            return;
                        }
                        
                        if (topPatron.did !== currentSession.did) {
                            const topPatronName = topPatron.display_name || topPatron.name || topPatron.handle || 'another dreamer';
                            showCelebration(`The Bursar must be our top patron.\n\nCurrently that honor belongs to ${topPatronName}.`, 'error');
                            return;
                        }
                        
                        console.log(`âœ… [bursar] User is top patron with score ${userPatronScore}`);
                    }
                } catch (error) {
                    console.error('Failed to verify patron status:', error);
                    showCelebration('Could not verify patron status. Please try again.', 'error');
                    return;
                }
            }
            
            // Check if this role requires an app password
            // Roles like bursar and dreamstyler don't need one
            if (config.requiresAppPassword === false) {
                console.log(`ðŸ”“ [${role}] Role does not require app password - showing confirmation directly`);
                showWorkerConfirmation(role, () => activateWorkerWithoutAppPassword(role));
                return;
            }
            
            // Check if user already has app password stored
            // Priority: backend session token > PDS accessJwt > localStorage tokens
            let token = null;
            
            // First try to get the backend session token (most reliable)
            token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
            
            // Fall back to PDS accessJwt if no backend token
            if (!token && currentSession && currentSession.accessJwt) {
                token = currentSession.accessJwt;
                console.log('ðŸ”‘ Using accessJwt from session (no backend token found)');
            } else if (token) {
                console.log('ðŸ”‘ Using backend session token from localStorage');
            }
            
            if (!token) {
                console.warn('âš ï¸ No token available for credentials check - showing password widget');
                // No token means we can't verify - show the widget to collect password
            } else {
                const headers = {};
                headers['Authorization'] = `Bearer ${token}`;
                
                console.log(`ðŸ” Checking credentials for ${role}...`);
                try {
                    const credResponse = await fetch('/api/user/credentials/status', { headers });
                    console.log(`ðŸ” Credentials check response: ${credResponse.status}`);
                    
                    if (credResponse.ok) {
                        const credData = await credResponse.json();
                        console.log('ðŸ” Credentials data:', credData);
                        if (credData.connected && credData.valid) {
                            // User already has valid credentials - show confirmation before activating
                            console.log(`âœ… Found existing credentials for ${role} - showing confirmation`);
                            showWorkerConfirmation(role, () => activateWorkerWithExistingCredentials(role));
                            return;
                        } else {
                            console.log(`âš ï¸ Credentials not valid: connected=${credData.connected}, valid=${credData.valid}`);
                        }
                    } else if (credResponse.status === 401) {
                        // Token is invalid/expired - still allow them to proceed with password entry
                        console.warn('âš ï¸ Session token expired or invalid - user will need to enter app password');
                        const errorData = await credResponse.json().catch(() => ({}));
                        console.log('Token validation error:', errorData);
                    } else {
                        console.error('âŒ Credentials check failed:', await credResponse.text());
                    }
                } catch (error) {
                    console.error('âŒ Credentials check exception:', error);
                    // Continue to show the widget even if the check fails
                }
            }
            
            // Show AppPasswordRequest widget with role-specific configuration
            if (!window.appPasswordRequest) {
                console.error('âŒ AppPasswordRequest widget not loaded');
                showCelebration('Widget not loaded - please refresh the page', 'error');
                return;
            }
            
            window.appPasswordRequest.show({
                title: config.title,
                description: config.description,
                featureName: config.roleNameLower,
                roleColor: role,  // Pass role for color theming
                buttonText: `BECOME ${config.title.toUpperCase()}`
            }, async (appPassword) => {
                // Callback receives validated 16-char app password
                console.log('ðŸ”‘ App password received from widget');
                
                // Show confirmation popup before activating
                showWorkerConfirmation(role, () => performWorkerActivation(role, appPassword, null));
            });
        }

        async function activateWorkerWithExistingCredentials(role) {
            const config = roleConfigs[role];
            if (!config) return;
            
            try {
                // Get token for authorization - use same priority as credentials check
                // Priority: backend session token > PDS accessJwt
                let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                
                if (!token && currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                    console.log('ðŸ”‘ [Activation] Using accessJwt from session (no backend token found)');
                } else if (token) {
                    console.log('ðŸ”‘ [Activation] Using backend session token from localStorage');
                }
                
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                } else {
                    console.error('âŒ [Activation] No valid token found!');
                    showCelebration('Session expired - please refresh and try again', 'error');
                    return;
                }
                
                const response = await fetch(`/api/work/${role}/activate`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ use_existing_credentials: true })
                });

                if (response.ok) {
                    const data = await response.json();
                    showCelebration(config.activationMessage, 'success');
                    
                    // Reload page to update UI
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const error = await response.json();
                    showCelebration(error.error || `Failed to activate ${config.roleNameLower}`, 'error');
                }
            } catch (error) {
                console.error('Activation error:', error);
                showCelebration(`Failed to activate ${config.roleNameLower}`, 'error');
            }
        }
        
        // Activate worker for roles that don't require an app password (bursar, dreamstyler)
        async function activateWorkerWithoutAppPassword(role) {
            const config = roleConfigs[role];
            if (!config) return;
            
            try {
                // Get token for authorization
                let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                
                if (!token && currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                    console.log('ðŸ”“ [No-Password Activation] Using accessJwt from session');
                } else if (token) {
                    console.log('ðŸ”“ [No-Password Activation] Using backend session token');
                }
                
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                } else {
                    console.error('âŒ [No-Password Activation] No valid token found!');
                    showCelebration('Session expired - please refresh and try again', 'error');
                    return;
                }
                
                const response = await fetch(`/api/work/${role}/activate`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ no_app_password: true })
                });

                if (response.ok) {
                    const data = await response.json();
                    showCelebration(config.activationMessage, 'success');
                    
                    // Reload page to update UI
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const error = await response.json();
                    showCelebration(error.error || `Failed to activate ${config.roleNameLower}`, 'error');
                }
            } catch (error) {
                console.error('Activation error:', error);
                showCelebration(`Failed to activate ${config.roleNameLower}`, 'error');
            }
        }

        // Worker confirmation popup (called from AppPasswordRequest widget callback)
        function showWorkerConfirmation(role, onConfirm) {
            const config = roleConfigs[role];
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'worker-confirmation-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.75);
                backdrop-filter: blur(4px);
                z-index: 10002;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'worker-confirmation-popup';
            popup.style.cssText = `
                background: linear-gradient(135deg, #2c1810 0%, #4a3428 100%);
                padding: 2.5rem;
                border: 3px solid var(--reverie-core-color, #734ba1);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 
                           0 0 40px rgba(115, 75, 161, 0.3);
                max-width: 500px;
                text-align: center;
                transform: scale(0.9);
                opacity: 0;
                transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            `;
            
            popup.innerHTML = `
                <div style="color: #e8d5c4; font-size: 1.4rem; font-weight: 700; margin-bottom: 1rem; 
                           text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                    ${config.confirmTitle}
                </div>
                <div style="color: #c9b8a8; font-size: 1rem; line-height: 1.6; margin-bottom: 2rem;">
                    ${config.confirmMessage}
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="confirm-btn" style="
                        background: linear-gradient(135deg, #734ba1 0%, #9d6ec9 100%);
                        color: white;
                        border: none;
                        padding: 0.75rem 2rem;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                        box-shadow: 0 4px 12px rgba(115, 75, 161, 0.4);
                        transition: all 0.2s ease;
                    ">Yes, I Accept</button>
                    <button class="cancel-btn" style="
                        background: rgba(255, 255, 255, 0.1);
                        color: #e8d5c4;
                        border: 2px solid rgba(255, 255, 255, 0.2);
                        padding: 0.75rem 2rem;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    ">Cancel</button>
                </div>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Animate in
            requestAnimationFrame(() => {
                overlay.style.opacity = '1';
                popup.style.transform = 'scale(1)';
                popup.style.opacity = '1';
            });
            
            // Add hover effects
            const confirmBtn = popup.querySelector('.confirm-btn');
            const cancelBtn = popup.querySelector('.cancel-btn');
            
            confirmBtn.addEventListener('mouseenter', () => {
                confirmBtn.style.transform = 'translateY(-2px)';
                confirmBtn.style.boxShadow = '0 6px 16px rgba(115, 75, 161, 0.5)';
            });
            confirmBtn.addEventListener('mouseleave', () => {
                confirmBtn.style.transform = 'translateY(0)';
                confirmBtn.style.boxShadow = '0 4px 12px rgba(115, 75, 161, 0.4)';
            });
            
            cancelBtn.addEventListener('mouseenter', () => {
                cancelBtn.style.background = 'rgba(255, 255, 255, 0.15)';
                cancelBtn.style.borderColor = 'rgba(255, 255, 255, 0.3)';
            });
            cancelBtn.addEventListener('mouseleave', () => {
                cancelBtn.style.background = 'rgba(255, 255, 255, 0.1)';
                cancelBtn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            });
            
            // Handle confirm
            confirmBtn.addEventListener('click', () => {
                overlay.style.opacity = '0';
                popup.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    onConfirm();
                }, 300);
            });
            
            // Handle cancel
            cancelBtn.addEventListener('click', () => {
                overlay.style.opacity = '0';
                popup.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                }, 300);
            });
        }
        
        async function performWorkerActivation(role, appPassword, submitBtn) {
            const config = roleConfigs[role];
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'CONNECTING...';
            }

            try {
                // STEP 1: First, save the app password to credentials table
                console.log('ðŸ”‘ Step 1: Connecting app password...');
                
                // Get auth token
                let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                if (!token && currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                }
                
                if (!token) {
                    showCelebration('Session expired - please refresh and try again', 'error');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = config.buttonText;
                    }
                    return;
                }
                
                const connectResponse = await fetch('/api/user/credentials/connect', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ app_password: appPassword })
                });
                
                if (!connectResponse.ok) {
                    const connectError = await connectResponse.json();
                    showCelebration(connectError.error || 'Invalid app password', 'error');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = config.buttonText;
                    }
                    return;
                }
                
                console.log('âœ… App password connected successfully');
                
                // STEP 2: Now activate the role
                if (submitBtn) {
                    submitBtn.textContent = 'ACTIVATING...';
                }
                
                console.log(`ðŸ”‘ Step 2: Activating as ${role}...`);
                
                const response = await fetch(`/api/work/${role}/activate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ use_existing_credentials: true })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Close the modal
                    const modal = document.getElementById('auth-modal');
                    if (modal) {
                        modal.classList.remove('active');
                        setTimeout(() => modal.style.display = 'none', 300);
                    }
                    
                    showCelebration(config.activationMessage, 'success');
                    
                    // Reload page to update UI
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const error = await response.json();
                    showCelebration(error.error || `Failed to activate ${config.roleNameLower}`, 'error');
                    
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = config.buttonText;
                    }
                }
            } catch (error) {
                console.error('Activation error:', error);
                showCelebration(`Failed to activate ${config.roleNameLower}: ${error.message}`, 'error');
                
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = config.buttonText;
                }
            }
        }
        
        // ====== END UNIVERSAL WORKER MODAL SYSTEM ======

        // LEGACY: Keep old greeter function for backward compatibility
        async function submitGreeterActivation() {
            const appPasswordInput = document.getElementById('app-password');
            const submitBtn = document.querySelector('.authorize-btn');
            
            if (!currentSession) {
                if (window.loginWidget && typeof window.loginWidget.showLoginPopup === 'function') {
                    window.loginWidget.showLoginPopup();
                }
                return;
            }

            const appPassword = appPasswordInput ? appPasswordInput.value.replace(/-/g, '').trim() : '';
            
            // Validate app password is provided
            if (!appPassword || appPassword.length !== 16) {
                showCelebration('Please provide a valid 16-character app password', 'error');
                if (appPasswordInput) {
                    appPasswordInput.focus();
                    appPasswordInput.parentElement.classList.add('error-shake');
                    setTimeout(() => appPasswordInput.parentElement.classList.remove('error-shake'), 500);
                }
                return;
            }

            // Show confirmation popup before activating
            showGreeterConfirmation(() => performGreeterActivation(appPassword, submitBtn));
        }
        
        function showGreeterConfirmation(onConfirm) {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'greeter-confirmation-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.75);
                backdrop-filter: blur(4px);
                z-index: 10002;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'greeter-confirmation-popup';
            popup.style.cssText = `
                background: linear-gradient(135deg, #2c1810 0%, #4a3428 100%);
                padding: 2.5rem;
                border: 3px solid var(--reverie-core-color, #734ba1);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 
                           0 0 40px rgba(115, 75, 161, 0.3);
                max-width: 500px;
                text-align: center;
                transform: scale(0.9);
                opacity: 0;
                transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            `;
            
            popup.innerHTML = `
                <div style="color: #e8d5c4; font-size: 1.4rem; font-weight: 700; margin-bottom: 1rem; 
                           text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                    Become Greeter of Reveries?
                </div>
                <div style="color: #d4c1b0; font-size: 0.95rem; line-height: 1.6; margin-bottom: 2rem; opacity: 0.9;">
                    You will greet newcomers and welcome them to our world.<br>
                    This role requires care and attention.<br>
                    <strong style="color: #f4e4d4;">Please stop if it feels like work.</strong>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="greeter-confirm-no" 
                            style="padding: 0.85rem 2rem; 
                                   background: rgba(255, 255, 255, 0.1); 
                                   color: #e8d5c4; 
                                   border: 2px solid rgba(255, 255, 255, 0.2); 
                                   font-weight: 600; 
                                   font-size: 0.95rem; 
                                   cursor: pointer; 
                                   transition: all 0.2s;
                                   text-transform: uppercase;
                                   letter-spacing: 0.5px;">
                        Not Yet
                    </button>
                    <button class="greeter-confirm-yes" 
                            style="padding: 0.85rem 2rem; 
                                   background: var(--reverie-core-color, #734ba1); 
                                   color: white; 
                                   border: 2px solid var(--reverie-core-color, #734ba1); 
                                   font-weight: 700; 
                                   font-size: 0.95rem; 
                                   cursor: pointer; 
                                   transition: all 0.2s;
                                   text-transform: uppercase;
                                   letter-spacing: 0.5px;
                                   box-shadow: 0 4px 12px rgba(115, 75, 161, 0.4);">
                        Yes, Begin
                    </button>
                </div>
            `;
            
            // Add hover effects
            const style = document.createElement('style');
            style.textContent = `
                .greeter-confirm-no:hover {
                    background: rgba(255, 255, 255, 0.15) !important;
                    border-color: rgba(255, 255, 255, 0.3) !important;
                    transform: translateY(-1px);
                }
                .greeter-confirm-yes:hover {
                    filter: brightness(1.1);
                    transform: translateY(-1px);
                    box-shadow: 0 6px 16px rgba(115, 75, 161, 0.5) !important;
                }
            `;
            document.head.appendChild(style);
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Trigger animations
            requestAnimationFrame(() => {
                overlay.style.opacity = '1';
                popup.style.opacity = '1';
                popup.style.transform = 'scale(1)';
            });
            
            // Button handlers
            popup.querySelector('.greeter-confirm-no').onclick = () => {
                overlay.style.opacity = '0';
                popup.style.transform = 'scale(0.9)';
                setTimeout(() => overlay.remove(), 300);
            };
            
            popup.querySelector('.greeter-confirm-yes').onclick = () => {
                overlay.style.opacity = '0';
                popup.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    overlay.remove();
                    onConfirm();
                }, 300);
            };
            
            // Close on overlay click
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    overlay.style.opacity = '0';
                    popup.style.transform = 'scale(0.9)';
                    setTimeout(() => overlay.remove(), 300);
                }
            };
        }
        
        async function performGreeterActivation(appPassword, submitBtn) {
            // Update button state to show processing
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'BECOMING...';
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.7';
            submitBtn.style.cursor = 'wait';

            try {
                // Get auth token
                // Get token from current session
                let token = null;
                if (currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                } else {
                    token = localStorage.getItem('oauth_token');
                    if (!token) {
                        token = localStorage.getItem('admin_token');
                    }
                }

                const payload = {
                    appPassword: appPassword  // Provide app password for greeter worker to use
                };
                
                console.log('ðŸ” Activating greeter with app password for posting');

                const response = await fetch('/api/work/greeter/activate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        greeterStatus = await response.json();
                        
                        // Show loading overlay
                        showLoadingOverlay('Confirming your status...');
                        
                        // Refresh UI
                        await loadGreeterStatus();
                        updateUI();
                        
                        // Emit event for cross-page synchronization
                        if (window.WorkEvents) {
                            window.WorkEvents.emit(window.WorkEvents.EVENTS.GREETER_ACTIVATED, {
                                timestamp: new Date().toISOString(),
                                useExistingCredentials: false
                            });
                        }
                        
                        // Hide loading overlay
                        hideLoadingOverlay();
                        
                        // Show celebration
                        showCelebration('You are now Greeter of Reveries\nThank you for working!\nPlease stop if it feels like work.', 'success');
                    } else {
                        const text = await response.text();
                        console.error('âš ï¸ Work: Non-JSON response:', text);
                        showLoadingOverlay('Confirming your status...');
                        await loadGreeterStatus();
                        updateUI();
                        hideLoadingOverlay();
                        showCelebration('Activation succeeded but received unexpected response format', 'warning');
                    }
                } else {
                    const contentType = response.headers.get('content-type');
                    let errorMessage = 'Unknown error';
                    let userFriendlyMessage = '';
                    
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        errorMessage = error.message || error.error || 'Unknown error';
                        console.error('âŒ Work: Activation failed (JSON):', error);
                    } else {
                        errorMessage = await response.text();
                        console.error('âŒ Work: Activation failed (text):', errorMessage);
                    }
                    
                    // Convert error messages to user-friendly versions
                    if (response.status === 429 || errorMessage.includes('Rate limit') || errorMessage.includes('Rate Limit Exceeded')) {
                        userFriendlyMessage = 'Too many authentication attempts.\n\nBluesky is temporarily blocking login attempts. Please wait 10-15 minutes and try again.';
                    } else if (errorMessage.includes('Invalid app password') || 
                        errorMessage.includes('authentication failed') ||
                        errorMessage.includes('Invalid identifier or password') ||
                        errorMessage.includes('AuthenticationRequired') ||
                        response.status === 401) {
                        userFriendlyMessage = 'The app password you entered is incorrect.\n\nPlease check that you copied it correctly from your Bluesky settings.';
                    } else if (errorMessage.includes('Another greeter is currently active') || 
                               response.status === 409) {
                        userFriendlyMessage = 'Another greeter is currently active and working.\n\nThey must mark themselves as retiring before you can volunteer.';
                    } else if (errorMessage.includes('Could not resolve PDS') || 
                               errorMessage.includes('Failed to validate')) {
                        userFriendlyMessage = 'Could not connect to your account server.\n\nPlease check your internet connection and try again.';
                    } else if (errorMessage.includes('DID mismatch')) {
                        userFriendlyMessage = 'The app password belongs to a different account.\n\nPlease make sure you\'re logged in with the correct account.';
                    } else if (response.status === 500) {
                        userFriendlyMessage = 'Something went wrong on our end.\n\nPlease try again in a moment.';
                    } else {
                        // Generic fallback with original error
                        userFriendlyMessage = 'Activation failed.\n\n' + errorMessage;
                    }
                    
                    // Reset button state
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                    
                    showCelebration(userFriendlyMessage, 'error');
                }
            } catch (error) {
                console.error('âŒ Work: Activation error:', error);
                
                // Hide loading overlay in case it was shown
                hideLoadingOverlay();
                
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                
                // Friendly network error message
                let userMessage = 'Could not connect to the server.\n\nPlease check your internet connection and try again.';
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    userMessage = 'Unable to reach the server.\n\nPlease check your internet connection.';
                } else if (error.message.includes('timeout')) {
                    userMessage = 'The server took too long to respond.\n\nPlease try again.';
                }
                
                showCelebration(userMessage, 'error');
            }
        }

        // ====== UNIVERSAL ROLE MANAGEMENT FUNCTIONS ======
        
        async function deactivateRole(role) {
            if (!window.StepDownWidget) {
                console.error('StepDownWidget not loaded');
                return;
            }

            window.StepDownWidget.show(role, async () => {
                try {
                    // Get token - use same priority as other API calls
                    // Priority: backend session token > PDS accessJwt
                    let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                    
                    if (!token && currentSession && currentSession.accessJwt) {
                        token = currentSession.accessJwt;
                    }

                    const response = await fetch(`/api/work/${role}/step-down`, {
                        method: 'POST',
                        headers: {
                            'Authorization': token ? `Bearer ${token}` : ''
                        }
                    });

                    if (response.ok) {
                        roleStatuses[role] = { is_worker: false, status: null };
                        await loadRoleStatus(role);
                        updateUI();
                        
                        // If stepping down from dreamstyler, refresh the Find Dreamstylers display
                        if (role === 'dreamstyler') {
                            const roleInfo = roleStatuses.dreamstyler;
                            if (roleInfo) {
                                await updateMultiWorkerDisplay(roleInfo, 'dreamstyler');
                            }
                        }
                        
                        if (window.WorkEvents) {
                            const eventName = `${role.toUpperCase()}_STEPPED_DOWN`;
                            if (window.WorkEvents.EVENTS[eventName]) {
                                window.WorkEvents.emit(window.WorkEvents.EVENTS[eventName], {
                                    timestamp: new Date().toISOString()
                                });
                            }
                        }
                        
                        const config = roleConfigs[role];
                        const roleTitle = config ? config.title : role;
                        showCelebration(`You are no longer ${roleTitle}.\nThank you for your work!\nPlease return if you ever desire.`, 'success');
                        
                        // Refresh page after step down to ensure clean state
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000); // Wait for celebration message to show
                    } else {
                        const errorText = await response.text();
                        console.error('âŒ Work: Step down failed:', response.status, errorText);
                        showCelebration('Failed to step down. Please try again.', 'error');
                    }
                } catch (error) {
                    console.error('âŒ Work: Step down error:', error);
                    showCelebration('Failed to step down: ' + error.message, 'error');
                }
            });
        }
        
        async function setRoleRetiring(role) {
            // Multi-worker roles don't support retiring - they just step down
            const config = roleConfigs[role];
            if (config?.multiWorker === true) {
                console.log('âš ï¸ setRoleRetiring called for multi-worker role:', role);
                showCelebration('This role does not support retiring status.', 'error');
                return;
            }
            
            // Confirm retirement
            const roleTitle = config?.roleName || role;
            const confirmed = await showConfirmDialog(
                'Are you ready to retire?',
                `<p>When you retire from <strong>${roleTitle}</strong>, you will remain active until someone else volunteers to take your place.</p><p>Once replaced, you will automatically step down and can volunteer again in the future.</p>`,
                'Begin Retiring',
                'Cancel'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                // Get token - use same priority as other API calls
                // Priority: backend session token > PDS accessJwt
                let token = localStorage.getItem('oauth_token') || localStorage.getItem('admin_token');
                
                if (!token && currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                }

                const response = await fetch(`/api/work/${role}/set-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({ status: 'retiring' })
                });

                if (response.ok) {
                    await loadRoleStatus(role);
                    updateUI();
                    
                    if (window.WorkEvents) {
                        const eventName = `${role.toUpperCase()}_STATUS_CHANGED`;
                        if (window.WorkEvents.EVENTS[eventName]) {
                            window.WorkEvents.emit(window.WorkEvents.EVENTS[eventName], {
                                timestamp: new Date().toISOString(),
                                status: 'retiring'
                            });
                        }
                    }
                    
                    showCelebration('Status updated to retiring.\nYou will be replaced when someone new volunteers.', 'success');
                } else {
                    const errorText = await response.text();
                    console.error('âŒ Work: Status update failed:', response.status, errorText);
                    showCelebration('Failed to update status. Please try again.', 'error');
                }
            } catch (error) {
                console.error('âŒ Work: Status update error:', error);
                showCelebration('Failed to update status: ' + error.message, 'error');
            }
        }
        
        // ====== LEGACY GREETER-SPECIFIC FUNCTIONS ======

        async function deactivateGreeter() {
            // Use the StepDownWidget for consistent UI
            if (!window.StepDownWidget) {
                console.error('StepDownWidget not loaded');
                return;
            }

            window.StepDownWidget.show('greeter', async () => {
                // Perform the actual step-down
                try {
                    // Get token from current session
                    let token = null;
                    if (currentSession && currentSession.accessJwt) {
                        token = currentSession.accessJwt;
                    } else {
                        token = localStorage.getItem('oauth_token');
                        if (!token) {
                            token = localStorage.getItem('admin_token');
                        }
                    }

                    const response = await fetch('/api/work/greeter/step-down', {
                        method: 'POST',
                        headers: {
                            'Authorization': token ? `Bearer ${token}` : ''
                        }
                    });

                    if (response.ok) {
                        greeterStatus = { is_worker: false, status: null };
                        await loadGreeterStatus();
                        updateUI();
                        
                        // Emit event for cross-page synchronization
                        if (window.WorkEvents) {
                            window.WorkEvents.emit(window.WorkEvents.EVENTS.GREETER_STEPPED_DOWN, {
                                timestamp: new Date().toISOString()
                            });
                        }
                        
                        showCelebration('You are no longer Greeter of Reveries.\nThank you for your work!\nPlease return if you ever desire.', 'success');
                    } else {
                        const errorText = await response.text();
                        console.error('âŒ Work: Step down failed:', response.status, errorText);
                        showCelebration('Failed to step down. Please try again.', 'error');
                    }
                } catch (error) {
                    console.error('âŒ Work: Step down error:', error);
                    showCelebration('Failed to step down: ' + error.message, 'error');
                }
            });
        }

        async function setRetiring() {
            // Show custom retirement options popup
            showRetirementOptions();
        }

        // Retirement options popup with three buttons
        function showRetirementOptions() {
            // Create popup overlay
            const overlay = document.createElement('div');
            overlay.className = 'retirement-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'retirement-popup';
            popup.style.cssText = `
                background: linear-gradient(135deg, #8b7355 0%, #a0826d 100%);
                padding: 2rem 3rem;
                border: 4px solid #5d4a37;
                border-radius: 0;
                box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6);
                max-width: 550px;
                text-align: center;
                animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                position: relative;
            `;
            
            popup.innerHTML = `
                <div style="color: white; font-size: 1.3rem; font-weight: 700; margin-bottom: 1rem; line-height: 1.5;">
                    Are you ready to retire?
                </div>
                <div style="color: rgba(255,255,255,0.9); font-size: 1rem; margin-bottom: 1.5rem; line-height: 1.6;">
                    When someone else wishes to work as Greeter of Reveries, they will automatically release and replace you when they are ready to do so.<br><br>
                    Or you may step down now if you wish, and leave the work immediately.
                </div>
                <div style="display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap; margin-bottom: 0.75rem;">
                    <button class="retire-now" 
                            style="padding: 0.75rem 1.5rem; background: #a0826d; color: white; border: 2px solid #8b7355; 
                                   font-weight: 700; font-size: 0.95rem; cursor: pointer; border-radius: 0;
                                   box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.2s;">
                        STEP DOWN
                    </button>
                    <button class="retire-ready" 
                            style="padding: 0.75rem 1.5rem; background: #5d4a37; color: white; border: 2px solid #3d2a1f; 
                                   font-weight: 700; font-size: 0.95rem; cursor: pointer; border-radius: 0;
                                   box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.2s;">
                        READY TO RETIRE
                    </button>
                </div>
                <div style="display: flex; justify-content: center;">
                    <button class="retire-close continue-working-btn" 
                            style="padding: 0.9rem 2rem; background: linear-gradient(135deg, #3d8b8b 0%, #2a6b6b 100%); 
                                   color: white; border: 3px solid #2a6b6b; 
                                   font-weight: 700; font-size: 1.05rem; cursor: pointer; border-radius: 0;
                                   box-shadow: 0 6px 20px rgba(61, 139, 139, 0.4); 
                                   transition: all 0.3s ease;
                                   animation: gentlePulse 2s ease-in-out infinite;">
                        CONTINUE WORKING
                    </button>
                </div>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Add CSS animation for the Continue Working button
            if (!document.getElementById('continue-working-styles')) {
                const style = document.createElement('style');
                style.id = 'continue-working-styles';
                style.textContent = `
                    @keyframes gentlePulse {
                        0%, 100% { 
                            transform: scale(1);
                            box-shadow: 0 6px 20px rgba(61, 139, 139, 0.4);
                        }
                        50% { 
                            transform: scale(1.02);
                            box-shadow: 0 7px 24px rgba(61, 139, 139, 0.5);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Button handlers
            popup.querySelector('.retire-ready').onclick = async () => {
                overlay.remove();
                await setRetiringStatus();
            };
            
            popup.querySelector('.retire-now').onclick = async () => {
                overlay.remove();
                await deactivateGreeter();
            };
            
            popup.querySelector('.retire-close').onclick = () => {
                overlay.remove();
            };
        }

        async function setRetiringStatus() {
            try {
                // Get token from current session
                let token = null;
                if (currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                } else {
                    token = localStorage.getItem('oauth_token');
                    if (!token) {
                        token = localStorage.getItem('admin_token');
                    }
                }

                const response = await fetch('/api/work/greeter/set-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({ status: 'retiring' })
                });

                if (response.ok) {
                    greeterStatus.status = 'retiring';
                    await loadGreeterStatus();
                    updateUI();
                    
                    // Emit event for cross-page synchronization
                    if (window.WorkEvents) {
                        window.WorkEvents.emit(window.WorkEvents.EVENTS.GREETER_STATUS_CHANGED, {
                            status: 'retiring',
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    showCelebration('Congratulations on your retirement.\nYou will be replaced as soon as possible.\nThank you for working!\n\nPlease continue operating as you see fit.', 'success', 'OKAY?');
                } else {
                    const errorText = await response.text();
                    console.error('âŒ Work: Set retiring failed:', response.status, errorText);
                    showCelebration('Failed to set status. Please try again.', 'error');
                }
            } catch (error) {
                console.error('âŒ Work: Set retiring error:', error);
                showCelebration('Failed to set status: ' + error.message, 'error');
            }
        }

        function showAlreadyWorkingMessage() {
            showCelebration('You are already working.\nThank you for working!', 'success');
        }

        async function setWorking() {
            try {
                // Get token from current session
                let token = null;
                if (currentSession && currentSession.accessJwt) {
                    token = currentSession.accessJwt;
                } else {
                    token = localStorage.getItem('oauth_token');
                    if (!token) {
                        token = localStorage.getItem('admin_token');
                    }
                }

                const response = await fetch('/api/work/greeter/set-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({ status: 'working' })
                });

                if (response.ok) {
                    greeterStatus.status = 'working';
                    await loadGreeterStatus();
                    updateUI();
                    
                    // Emit event for cross-page synchronization
                    if (window.WorkEvents) {
                        window.WorkEvents.emit(window.WorkEvents.EVENTS.GREETER_STATUS_CHANGED, {
                            status: 'working',
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    showCelebration('Welcome back! You are now actively working as Greeter again.', 'success');
                } else {
                    showCelebration('Failed to update status. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Set working error:', error);
                showCelebration('Failed to update status: ' + error.message, 'error');
            }
        }

        // Confirmation popup with two buttons
        function showConfirmation(message, onConfirm) {
            // Create popup overlay
            const overlay = document.createElement('div');
            overlay.className = 'confirmation-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'confirmation-popup';
            popup.style.cssText = `
                background: linear-gradient(135deg, #8b7355 0%, #a0826d 100%);
                padding: 2rem 3rem;
                border: 4px solid #5d4a37;
                border-radius: 0;
                box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6);
                max-width: 500px;
                text-align: center;
                animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                position: relative;
            `;
            
            popup.innerHTML = `
                <div style="color: white; font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; line-height: 1.5;">
                    ${message}
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="confirm-no" 
                            style="padding: 0.75rem 2rem; background: white; color: #8b7355; border: none; 
                                   font-weight: 700; font-size: 1rem; cursor: pointer; border-radius: 0;
                                   box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.2s;">
                        NO NOT YET
                    </button>
                    <button class="confirm-yes" 
                            style="padding: 0.75rem 2rem; background: #5d4a37; color: white; border: none; 
                                   font-weight: 700; font-size: 1rem; cursor: pointer; border-radius: 0;
                                   box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.2s;">
                        STEP DOWN
                    </button>
                </div>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Button handlers
            popup.querySelector('.confirm-no').onclick = () => {
                overlay.remove();
            };
            
            popup.querySelector('.confirm-yes').onclick = () => {
                overlay.remove();
                onConfirm();
            };
        }

        // Generic confirmation dialog with Promise support
        function showConfirmDialog(title, message, confirmText = 'Confirm', cancelText = 'Cancel') {
            return new Promise((resolve) => {
                // Remove any existing confirmation overlays
                const existingOverlays = document.querySelectorAll('.confirm-dialog-overlay');
                existingOverlays.forEach(overlay => overlay.remove());
                
                const overlay = document.createElement('div');
                overlay.className = 'confirm-dialog-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 10001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.2s ease;
                `;
                
                const popup = document.createElement('div');
                popup.className = 'confirm-dialog-popup';
                popup.style.cssText = `
                    background: white;
                    padding: 1.5rem 2rem;
                    border: 3px solid #8b7355;
                    border-radius: 0;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
                    max-width: 450px;
                    text-align: center;
                    animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                `;
                
                popup.innerHTML = `
                    <div style="color: #5d4a37; font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem; font-family: monospace;">
                        ${title}
                    </div>
                    <div style="color: #666; font-size: 0.95rem; margin-bottom: 1.5rem; line-height: 1.5; font-family: monospace;">
                        ${message}
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button class="confirm-dialog-cancel" 
                                style="padding: 0.6rem 1.5rem; background: #e5e5e5; color: #666; border: 2px solid #ccc; 
                                       font-weight: 600; font-size: 0.9rem; cursor: pointer; font-family: monospace;">
                            ${cancelText}
                        </button>
                        <button class="confirm-dialog-confirm" 
                                style="padding: 0.6rem 1.5rem; background: #8b7355; color: white; border: 2px solid #5d4a37; 
                                       font-weight: 600; font-size: 0.9rem; cursor: pointer; font-family: monospace;">
                            ${confirmText}
                        </button>
                    </div>
                `;
                
                overlay.appendChild(popup);
                document.body.appendChild(overlay);
                
                // Handle button clicks
                popup.querySelector('.confirm-dialog-cancel').onclick = () => {
                    overlay.remove();
                    resolve(false);
                };
                
                popup.querySelector('.confirm-dialog-confirm').onclick = () => {
                    overlay.remove();
                    resolve(true);
                };
                
                // Close on overlay click
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        resolve(false);
                    }
                };
            });
        }

        // Celebration popup and bubble system
        function showCelebration(message, type = 'success', buttonText = 'OKAY') {
            // Remove any existing celebration overlays to prevent stacking
            const existingOverlays = document.querySelectorAll('.celebration-overlay');
            existingOverlays.forEach(overlay => overlay.remove());
            
            // Convert \n to <br> for multi-line messages
            const formattedMessage = message.replace(/\n/g, '<br>');
            
            // Create popup overlay
            const overlay = document.createElement('div');
            overlay.className = 'celebration-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            // Create popup
            const popup = document.createElement('div');
            popup.className = 'celebration-popup';
            popup.style.cssText = `
                background: linear-gradient(135deg, #8b7355 0%, #a0826d 100%);
                padding: 2rem 3rem;
                border: 4px solid #5d4a37;
                border-radius: 0;
                box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6);
                max-width: 500px;
                text-align: center;
                animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                position: relative;
            `;
            
            popup.innerHTML = `
                <div style="color: white; font-size: 1.3rem; font-weight: 700; margin-bottom: 1rem; line-height: 1.5;">
                    ${formattedMessage}
                </div>
                <button onclick="this.closest('.celebration-overlay').remove()" 
                        style="padding: 0.75rem 2rem; background: white; color: #8b7355; border: none; 
                               font-weight: 700; font-size: 1rem; cursor: pointer; border-radius: 0;
                               box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.2s;">
                    ${buttonText}
                </button>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Launch bubbles only for success messages
            if (type === 'success') {
                launchBubbles();
            }
            
            // Add CSS animations
            if (!document.getElementById('celebration-styles')) {
                const style = document.createElement('style');
                style.id = 'celebration-styles';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes popIn {
                        0% { transform: scale(0.3); opacity: 0; }
                        50% { transform: scale(1.05); }
                        100% { transform: scale(1); opacity: 1; }
                    }
                    @keyframes bubbleRise {
                        0% { 
                            transform: translateY(0) translateX(0) scale(0);
                            opacity: 0;
                        }
                        10% {
                            opacity: 1;
                            transform: translateY(-10vh) translateX(0) scale(1);
                        }
                        90% {
                            opacity: 1;
                        }
                        100% { 
                            transform: translateY(-100vh) translateX(var(--drift)) scale(0.8);
                            opacity: 0;
                        }
                    }
                    .celebration-overlay button:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 16px rgba(0,0,0,0.4);
                    }
                `;
                document.head.appendChild(style);
            }
        }

        async function launchBubbles() {
            const bubbleCount = 20;
            
            // Get random souvenir icons
            const souvenirIcons = await BubbleFactory.getRandomSouvenirIcons(bubbleCount);
            
            for (let i = 0; i < bubbleCount; i++) {
                setTimeout(() => {
                    const souvenir = souvenirIcons[i % souvenirIcons.length];
                    const randomX = Math.random() * window.innerWidth;
                    const randomDrift = (Math.random() - 0.5) * 200;
                    const randomDuration = 3 + Math.random() * 2;
                    const randomDelay = Math.random() * 0.5;
                    const randomSize = 40 + Math.random() * 40;
                    
                    // Create bubble using standardized factory
                    const bubble = BubbleFactory.createBubble(souvenir.icon, randomSize, {
                        clickable: false,
                        souvenirKey: souvenir.key,
                        souvenirName: souvenir.name
                    });
                    
                    bubble.style.cssText += `
                        position: fixed;
                        bottom: -100px;
                        left: ${randomX}px;
                        z-index: 10002;
                        animation: bubbleRise ${randomDuration}s ease-out ${randomDelay}s forwards;
                        --drift: ${randomDrift}px;
                        opacity: 0.8;
                    `;
                    
                    document.body.appendChild(bubble);
                    
                    // Remove after animation
                    setTimeout(() => {
                        bubble.remove();
                    }, (randomDuration + randomDelay) * 1000);
                }, i * 100);
            }
        }

        // Open introduce yourself modal
        function openIntroduceModal() {
            showCelebration(
                'Introduce yourself feature coming soon!\\n\\nThis will allow new dreamers to share their story with the community.',
                'info',
                'UNDERSTOOD'
            );
        }
    </script>
</body>
</html>
