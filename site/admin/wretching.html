<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wretching - Reverie House</title>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/color-rows.css">
    <link rel="stylesheet" href="/css/roles.css">
    
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    
    <script src="/js/core/world-config-cache.js"></script>
    <script src="/js/core/color-manager.js"></script>
    <script src="/js/core/avatar-cache.js" defer></script>
    <script src="/js/widgets/header.js" defer></script>
    <script type="module" src="/js/widgets/oauth-manager.js"></script>
    <script src="/js/widgets/drawer.js" defer></script>
    <script src="/js/widgets/konami.js" defer></script>
    
    <style>
        :root {
            --sidebar-width: 320px;
            --sidebar-bg: #fafafa;
            --sidebar-border: #e5e5e5;
            --card-bg: #ffffff;
            --card-border: #e5e5e5;
            --text-primary: #171717;
            --text-secondary: #6b7280;
            --text-dim: #9ca3af;
            --hover-bg: #f3f4f6;
            --active-bg: #f0f0ff;
            --active-border: #734ba1;
            --danger-color: #dc2626;
            --danger-bg: #fef2f2;
            --success-color: #22c55e;
            --success-bg: #f0fdf4;
        }
        
        * { box-sizing: border-box; }
        
        html, body {
            margin: 0;
            padding: 0;
            background: var(--page-background-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            height: 100%;
            overflow: hidden;
        }
        
        .wretching-layout {
            display: flex;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }
        
        .wretching-sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 1rem;
            border-bottom: 2px solid #f0f0f0;
            background: white;
            text-align: center;
        }
        
        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--active-border);
            margin: 0;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 2px solid #e0e0e0;
            font-size: 0.85rem;
            font-family: inherit;
            background: white;
            transition: all 0.2s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--active-border);
        }
        
        .btn {
            padding: 0.6rem 1rem;
            font-size: 0.8rem;
            border: 2px solid #e0e0e0;
            background: white;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .btn:hover { background: var(--hover-bg); border-color: var(--active-border); }
        .btn-primary { background: var(--active-border); border-color: var(--active-border); color: white; }
        .btn-primary:hover { background: #5d3a85; }
        .btn-danger { background: var(--danger-bg); border-color: var(--danger-color); color: var(--danger-color); }
        .btn-danger:hover { background: var(--danger-color); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #f8f8f8;
        }
        
        .card {
            background: white;
            border: 2px solid var(--card-border);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin: 0 0 1rem 0;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #eee;
            font-weight: 700;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .preview-section h4 {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-dim);
            margin: 0 0 0.5rem 0;
        }
        
        .preview-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #e0e0e0;
            margin-bottom: 0.5rem;
        }
        
        .preview-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .preview-bio {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            border-radius: 3px;
        }
        
        .status-badge.success { background: var(--success-bg); color: var(--success-color); }
        .status-badge.error { background: var(--danger-bg); color: var(--danger-color); }
        .status-badge.warning { background: #fef3c7; color: #d97706; }
        
        .avatars-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
        }
        
        .avatar-item {
            text-align: center;
            padding: 0.75rem;
            background: #fafafa;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .avatar-item:hover { border-color: var(--active-border); }
        .avatar-item.assigned { opacity: 0.5; background: #fff5f5; }
        .avatar-item img { width: 64px; height: 64px; border-radius: 50%; border: 2px solid #e0e0e0; }
        .avatar-item.assigned img { border-color: var(--danger-color); }
        .avatar-item .name { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.5rem; }
        .avatar-item .status { font-size: 0.65rem; margin-top: 0.25rem; }
        .avatar-item .status.available { color: var(--success-color); }
        .avatar-item .status.taken { color: var(--danger-color); }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
        }
        
        .output-box {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            padding: 1rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
            max-height: 200px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    
    <div class="wretching-layout">
        <div class="wretching-sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">üîÆ Wretching</h1>
            </div>
            <div class="sidebar-content">
                <div class="form-group">
                    <label>Handle or DID</label>
                    <input type="text" id="user-input" placeholder="example.reverie.house">
                </div>
                <button class="btn btn-primary" onclick="WretchingPage.preview()">Preview</button>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e0e0e0;">
                
                <div class="form-group">
                    <label>Reason</label>
                    <select id="wretch-reason">
                        <option value="banished">Banished (Community)</option>
                        <option value="false_accuser">False Accuser</option>
                        <option value="challenge_lost">Lost Cogitarian Challenge</option>
                    </select>
                </div>
                
                <button class="btn btn-danger" id="execute-btn" onclick="WretchingPage.execute()" disabled>
                    ‚ö†Ô∏è Execute Wretch
                </button>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e0e0e0;">
                
                <div class="form-group">
                    <label>Restore (DID)</label>
                    <input type="text" id="restore-did" placeholder="did:plc:...">
                </div>
                <button class="btn" onclick="WretchingPage.restore()">Restore User</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="card" id="preview-card" style="display: none;">
                <h2 class="card-title">Preview</h2>
                <div id="preview-content"></div>
            </div>
            
            <div class="card" id="result-card" style="display: none;">
                <h2 class="card-title">Result</h2>
                <div id="result-content" class="output-box"></div>
            </div>
            
            <div class="card">
                <h2 class="card-title">Wretch Gallery</h2>
                <div id="avatars-container" class="avatars-grid">
                    <div class="empty-state">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WretchingPage = {
            token: null,
            currentPreview: null,
            
            async init() {
                this.token = localStorage.getItem('admin_token');
                if (!this.token) {
                    window.location.href = '/admin/login.html';
                    return;
                }
                await this.loadAvatars();
                console.log('üîÆ Wretching page initialized');
            },
            
            async apiCall(endpoint, options = {}) {
                const resp = await fetch(endpoint, {
                    ...options,
                    headers: {
                        'Authorization': 'Bearer ' + this.token,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                return { ok: resp.ok, status: resp.status, data: await resp.json() };
            },
            
            async preview() {
                const input = document.getElementById('user-input').value.trim();
                if (!input) return alert('Enter a handle or DID');
                
                console.log('üîÆ Preview requested for:', input);
                
                // Resolve handle to DID if needed
                let did = input;
                if (!input.startsWith('did:')) {
                    console.log('üîÆ Input is not a DID, looking up handle...');
                    
                    // Try to resolve via database lookup - endpoint returns { tables: { dreamers: [...] } }
                    const lookupResp = await fetch('/api/database/all');
                    console.log('üîÆ Database lookup response status:', lookupResp.status, lookupResp.ok);
                    
                    const lookupData = await lookupResp.json();
                    console.log('üîÆ Lookup response structure:', Object.keys(lookupData));
                    
                    // Extract dreamers from correct structure
                    const dreamers = (lookupData.tables && lookupData.tables.dreamers) || lookupData.dreamers || [];
                    console.log('üîÆ Total dreamers in database:', dreamers.length);
                    
                    if (dreamers.length === 0) {
                        console.error('üîÆ ZERO DREAMERS - API structure issue');
                        console.error('Full lookup response:', lookupData);
                        this.showResult({ 
                            error: 'Database error: No dreamers found. Check API response.',
                            api_response_keys: Object.keys(lookupData),
                            api_response: lookupData
                        }, true);
                        return;
                    }
                    
                    // Log all handles for debugging
                    const allHandles = dreamers.map(d => d.handle).filter(Boolean);
                    console.log('üîÆ All handles in database:', allHandles.slice(0, 10), `... (${allHandles.length} total)`);
                    
                    // Try multiple match strategies
                    const exactMatch = dreamers.find(d => d.handle === input);
                    const withSuffix = dreamers.find(d => d.handle === input + '.reverie.house');
                    const endsWithMatch = dreamers.find(d => d.handle && d.handle.endsWith(input));
                    const startsWithMatch = dreamers.find(d => d.handle && d.handle.startsWith(input));
                    const caseInsensitive = dreamers.find(d => d.handle && d.handle.toLowerCase() === input.toLowerCase());
                    
                    console.log('üîÆ Match attempts:', {
                        input: input,
                        exactMatch: exactMatch ? exactMatch.handle : null,
                        withSuffix: withSuffix ? withSuffix.handle : null,
                        endsWith: endsWithMatch ? endsWithMatch.handle : null,
                        startsWith: startsWithMatch ? startsWithMatch.handle : null,
                        caseInsensitive: caseInsensitive ? caseInsensitive.handle : null
                    });
                    
                    // Use best match
                    const user = exactMatch || withSuffix || caseInsensitive || endsWithMatch;
                    
                    if (user) {
                        did = user.did;
                        console.log('üîÆ ‚úÖ Found user:', { handle: user.handle, did: user.did });
                    } else {
                        const searchKey = input.split('.')[0].toLowerCase();
                        const similar = allHandles.filter(h => h && h.toLowerCase().includes(searchKey)).slice(0, 10);
                        console.error('üîÆ ‚ùå User not found. Input was:', input);
                        console.error('üîÆ Search key:', searchKey);
                        console.error('üîÆ Similar handles:', similar);
                        this.showResult({ 
                            error: 'User not found: ' + input,
                            searched_for: input,
                            search_key: searchKey,
                            total_users: dreamers.length,
                            database_dreamers_sample: allHandles.slice(0, 10),
                            similar_handles: similar
                        }, true);
                        return;
                    }
                } else {
                    console.log('üîÆ Input is already a DID:', did);
                }
                
                const { ok, data } = await this.apiCall('/api/admin/wretch/preview?did=' + encodeURIComponent(did));
                
                if (data.error) {
                    this.showResult(data, true);
                    document.getElementById('preview-card').style.display = 'none';
                    document.getElementById('execute-btn').disabled = true;
                    return;
                }
                
                this.currentPreview = data;
                this.renderPreview(data);
                
                // Enable execute button if user can be wretched
                document.getElementById('execute-btn').disabled = !data.can_execute;
                document.getElementById('restore-did').value = did;
            },
            
            renderPreview(data) {
                const card = document.getElementById('preview-card');
                const content = document.getElementById('preview-content');
                
                let statusHtml = '';
                if (data.already_wretched) {
                    statusHtml = '<span class="status-badge error">Already Wretched</span>';
                } else if (!data.has_app_password) {
                    statusHtml = '<span class="status-badge warning">No App Password</span>';
                } else if (data.can_execute) {
                    statusHtml = '<span class="status-badge success">Ready to Wretch</span>';
                }
                
                // Generate wretched color algorithmically from DID
                // Dark cold tones: hue 180-240 (cyan to blue), low sat 15-35%, low light 10-20%
                const didHash = data.did.split('').reduce((a, c) => ((a << 5) - a + c.charCodeAt(0)) | 0, 0);
                const hue = 180 + (Math.abs(didHash) % 61);  // 180-240 (cyan to blue range)
                const sat = 15 + (Math.abs(didHash >> 8) % 21);  // 15-35%
                const light = 10 + (Math.abs(didHash >> 16) % 11);  // 10-20%
                const wretchedColor = `hsl(${hue}, ${sat}%, ${light}%)`;
                
                // Capitalize first letter of name
                const capitalizedName = (data.name || '').charAt(0).toUpperCase() + (data.name || '').slice(1);
                
                // Build system changes list
                const systemChanges = [
                    'Account marked as wretched',
                    `Soothe timer started: ${data.soothe_hours} hours`,
                    `Avatar assigned: ${data.would_become?.avatar || 'pending'}`
                ];
                
                // Build the wretch post preview
                const wretchPost = `‚ö†Ô∏è I HAVE BECOME WRETCHED ‚ö†Ô∏è

The shadows have claimed me. My dreams have turned to ash.

Those who knew me may still soothe my spirit. Compose a dream and call my name.

https://reverie.house/wretched/${data.handle}

Until the darkness lifts, I am ${capitalizedName} the Wretch.`;
                
                content.innerHTML = `
                    <div style="margin-bottom: 1rem;">${statusHtml}</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div style="padding: 1.5rem; background: ${data.current_color || '#f0f0f0'}22; border: 2px solid ${data.current_color || '#ccc'}; border-radius: 4px;">
                            <h4 style="margin: 0 0 1rem 0; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary);">Current Profile</h4>
                            <img class="preview-avatar" src="${data.current_rh?.avatar || '/assets/default-avatar.png'}" alt="">
                            <div style="margin-top: 0.75rem;">
                                <div class="preview-name">${data.display_name || data.name}</div>
                                <div class="preview-bio">${(data.current_description || '').substring(0, 80) || '(no bio)'}</div>
                            </div>
                        </div>
                        <div style="padding: 1.5rem; background: ${wretchedColor}33; border: 2px solid ${wretchedColor}; border-radius: 4px;">
                            <h4 style="margin: 0 0 1rem 0; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary);">Wretched Form</h4>
                            <img class="preview-avatar" src="${data.would_become?.avatar_url || '/assets/default-avatar.png'}" alt="">
                            <div style="margin-top: 0.75rem;">
                                <div class="preview-name" style="color: ${wretchedColor};">${capitalizedName} the Wretch</div>
                                <div class="preview-bio">${data.would_become?.description}</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin: 1.5rem 0; text-align: left;">
                        <h4 style="margin: 0 0 0.75rem 0; color: var(--active-border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">System Changes</h4>
                        <ul style="margin: 0; padding-left: 1.5rem; list-style: disc; font-size: 0.8rem; line-height: 1.8; color: var(--text-secondary); text-align: left;">
                            ${systemChanges.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="margin: 1.5rem 0; text-align: left;">
                        <h4 style="margin: 0 0 0.75rem 0; color: var(--danger-color); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">üì¢ Will Be Posted</h4>
                        <div style="background: #1a1a1a; color: #e0e0e0; padding: 1rem; border-radius: 4px; font-size: 0.8rem; white-space: pre-wrap; font-family: -apple-system, system-ui, sans-serif; line-height: 1.5;">${wretchPost}</div>
                    </div>
                    <div style="margin-top: 1rem; font-size: 0.7rem; color: var(--text-dim); text-align: right;">
                        ${data.did}
                    </div>
                `;
                
                card.style.display = 'block';
            },
            
            async execute() {
                if (!this.currentPreview || !this.currentPreview.can_execute) {
                    return alert('Cannot execute - preview first or user not eligible');
                }
                
                const did = this.currentPreview.did;
                const reason = document.getElementById('wretch-reason').value;
                
                if (!confirm(`‚ö†Ô∏è REALLY WRETCH THIS USER?\n\n${this.currentPreview.handle}\n\nThis will:\n‚Ä¢ Change their Bluesky profile\n‚Ä¢ Post a wretch announcement\n‚Ä¢ Mark them as wretched\n\nThis is reversible but significant!`)) {
                    return;
                }
                
                document.getElementById('execute-btn').disabled = true;
                document.getElementById('execute-btn').textContent = 'Executing...';
                
                const { ok, data } = await this.apiCall('/api/admin/wretch/execute', {
                    method: 'POST',
                    body: JSON.stringify({ did, reason })
                });
                
                document.getElementById('execute-btn').textContent = '‚ö†Ô∏è Execute Wretch';
                this.showResult(data, !ok);
                
                if (ok && data.success) {
                    await this.loadAvatars();
                    this.currentPreview = null;
                    document.getElementById('execute-btn').disabled = true;
                }
            },
            
            async restore() {
                const did = document.getElementById('restore-did').value.trim();
                if (!did) return alert('Enter a DID');
                if (!did.startsWith('did:')) return alert('Must be a DID (did:plc:...)');
                
                if (!confirm(`Restore this user from wretched state?\n\n${did}`)) return;
                
                const { ok, data } = await this.apiCall('/api/admin/wretch/restore', {
                    method: 'POST',
                    body: JSON.stringify({ did })
                });
                
                this.showResult(data, !ok);
                if (ok && data.success) {
                    await this.loadAvatars();
                }
            },
            
            showResult(data, isError) {
                const card = document.getElementById('result-card');
                const content = document.getElementById('result-content');
                content.textContent = JSON.stringify(data, null, 2);
                content.style.background = isError ? 'var(--danger-bg)' : 'var(--success-bg)';
                content.style.borderColor = isError ? 'var(--danger-color)' : 'var(--success-color)';
                card.style.display = 'block';
            },
            
            async loadAvatars() {
                const container = document.getElementById('avatars-container');
                
                // Try to load wretched profiles first
                const { ok: wretchOk, data: wretchData } = await this.apiCall('/api/admin/wretched/profiles');
                
                if (wretchOk && wretchData.profiles && wretchData.profiles.length > 0) {
                    // Show existing wretches
                    container.innerHTML = wretchData.profiles.map(w => `
                        <div style="text-align: center; padding: 0.75rem; background: #f5f5f5; border: 2px solid #e0e0e0; border-radius: 4px;">
                            <img src="${w.wretched_avatar_url || '/assets/wretched/' + w.wretched_avatar}" alt="" style="width: 64px; height: 64px; border-radius: 50%; border: 2px solid #666; margin-bottom: 0.5rem;">
                            <div class="name" style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem;">${w.handle}</div>
                            <div class="status" style="font-size: 0.65rem; color: #999; margin-bottom: 0.25rem;">@${w.handle}</div>
                            <div class="status" style="font-size: 0.6rem; color: #aaa;">Wretched: ${new Date(w.wretched_at).toLocaleDateString()}</div>
                        </div>
                    `).join('');
                    return;
                }
                
                // Fall back to available avatars
                const { ok, data } = await this.apiCall('/api/admin/wretch/avatars');
                
                if (!ok || data.error) {
                    container.innerHTML = `<div class="empty-state" style="color:var(--danger-color)">Error: ${data.error || 'Failed to load'}</div>`;
                    return;
                }
                
                if (!data.avatars || data.avatars.length === 0) {
                    container.innerHTML = '<div class="empty-state">No wretches or avatars yet. Add wretch*.png to /assets/wretched/</div>';
                    return;
                }
                
                container.innerHTML = data.avatars.map(av => `
                    <div class="avatar-item ${av.assigned ? 'assigned' : ''}">
                        <img src="/assets/wretched/${av.filename}" alt="${av.filename}">
                        <div class="name">${av.filename}</div>
                        <div class="status ${av.assigned ? 'taken' : 'available'}">
                            ${av.assigned ? '‚õî Assigned' : '‚úì Available'}
                        </div>
                    </div>
                `).join('');
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => WretchingPage.init());
    </script>
</body>
</html>
