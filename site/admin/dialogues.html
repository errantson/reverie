
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dialogues - Reverie House Admin</title>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/heraldry.css">
    <link rel="stylesheet" href="/css/widgets/dialogue.css">
    <link rel="stylesheet" href="/css/widgets/login.css">
    <link rel="stylesheet" href="/css/widgets/createdreamer.css">
    
    <!-- Favicon and Icons -->
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    
    <!-- Core utilities -->
    <script src="/js/core/world-config-cache.js"></script>
    <script src="/js/core/color-manager.js"></script>
    <script src="/js/utils/shadowbox.js"></script>
    <script src="/js/utils/heraldry.js"></script>
    
    <!-- Header and widgets -->
    <script src="/js/widgets/header.js" defer></script>
    <script type="module" src="/js/widgets/oauth-manager.js"></script>
    <script src="/js/widgets/drawer.js" defer></script>
    <script src="/js/widgets/dialogue.js" defer></script>
    <script src="/js/widgets/login.js" defer></script>
    <script src="/js/widgets/createdreamer.js" defer></script>
    <script src="/js/widgets/spectrumcalculator-modal.js" defer></script>
    <script src="/js/widgets/bskyexplain-modal.js" defer></script>
    
    <style>
        :root {
            --card-bg: #ffffff;
            --card-border: #e5e5e5;
            --text-primary: #171717;
            --text-secondary: #6b7280;
            --text-dim: #9ca3af;
            --hover-bg: #f9fafb;
        }
        
        * {
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            background: var(--page-background-color);
            line-height: 1.6;
        }
        
        /* Scope Georgia font to dialogues page only */
        .page-layout,
        .dialogue-sidebar,
        .dialogue-main,
        .dialogue-editor {
            font-family: Georgia, 'Times New Roman', serif;
        }
        
        /* Simple Single-Page Layout - matches quests.html */
        .page-layout {
            width: 100%;
            margin: 0;
            padding: 0;
        }
        
        /* Page layout adjusted for standard header */
        .page-layout {
            padding-top: 60px;
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar - Fixed between header and drawer with 10px margins */
        .dialogue-sidebar {
            width: 280px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            position: fixed;
            left: 10px;
            top: 80px; /* 60px header + 20px margin to avoid cutoff */
            bottom: 74px; /* 64px drawer + 10px margin */
            overflow-y: auto;
            z-index: 100;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .sidebar-header {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
            background: #0d0d0d;
        }
        
        .sidebar-title {
            font-size: 0.625rem;
            text-transform: uppercase;
            font-weight: 700;
            color: #666;
            margin-bottom: 0.5rem;
            letter-spacing: 0.1em;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .sidebar-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.625rem;
            color: #888;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .sidebar-stat {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }
        
        .sidebar-stat-value {
            font-size: 0.875rem;
            font-weight: 700;
            color: #999;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .sidebar-actions {
            display: flex;
            gap: 0.375rem;
        }
        
        .sidebar-btn {
            flex: 1;
            padding: 0.375rem 0.5rem;
            font-size: 0.625rem;
            font-weight: 600;
            border: 1px solid #333;
            background: #262626;
            color: #999;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
            font-family: 'SF Mono', Monaco, monospace;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .sidebar-btn:hover {
            background: #333;
            border-color: #444;
            color: #ccc;
        }
        
        .sidebar-btn.primary {
            background: #2d7a3e;
            color: white;
            border-color: #2d7a3e;
        }
        
        .sidebar-btn.primary:hover {
            background: #3d8a4e;
            border-color: #3d8a4e;
        }
        
        /* Sidebar Tabs */
        
        /* Filter Toggle */
        .filter-toggle-container {
            padding: 0.5rem 1rem 0.75rem;
            border-bottom: 1px solid #333;
        }
        
        .filter-toggle-buttons {
            display: flex;
            gap: 0.25rem;
        }
        
        .filter-toggle-btn {
            flex: 1;
            padding: 0.375rem 0.5rem;
            font-size: 0.625rem;
            font-weight: 600;
            border: 1px solid #333;
            background: #0d0d0d;
            color: #666;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.15s;
            font-family: 'SF Mono', Monaco, monospace;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .filter-toggle-btn:hover {
            background: #1a1a1a;
            border-color: #444;
            color: #888;
        }
        
        .filter-toggle-btn.active {
            background: #1a1a1a;
            border-color: #444;
            color: #aaa;
            font-weight: 700;
        }
        
        .filter-status {
            margin-top: 0.375rem;
            text-align: center;
            font-size: 0.6rem;
            color: #555;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .filter-status-highlight {
            color: #888;
            font-weight: 600;
        }
        
        
        .sidebar-tree-container {
            flex: 1;
            overflow-y: auto;
            padding: 0.375rem;
        }
        
        .sidebar-tree {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .tree-group {
            margin-bottom: 0.125rem;
        }
        
        .tree-group-label {
            font-size: 0.6875rem;
            font-weight: 600;
            color: #888;
            padding: 0.25rem 0.375rem;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            user-select: none;
            font-family: 'SF Mono', Monaco, monospace;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .tree-group-label:hover {
            background: #2a2a2a;
            color: #aaa;
        }
        
        .tree-group-icon {
            font-size: 0.5rem;
            transition: transform 0.15s;
            width: 0.625rem;
            text-align: center;
            color: #666;
        }
        
        .tree-group.collapsed .tree-group-icon {
            transform: rotate(-90deg);
        }
        
        .tree-group-count {
            font-size: 0.5625rem;
            color: #555;
            font-weight: 500;
            margin-left: auto;
        }
        
        .tree-items {
            list-style: none;
            padding: 0 0 0 0.75rem;
            margin: 0.125rem 0 0 0.5rem;
            border-left: 1px solid #2a2a2a;
        }
        
        .tree-group.collapsed .tree-items {
            display: none;
        }
        
        .tree-subgroup {
            margin-bottom: 0.125rem;
        }
        
        .tree-subgroup-label {
            font-size: 0.625rem;
            font-weight: 600;
            color: #777;
            padding: 0.25rem 0.375rem;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            user-select: none;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .tree-subgroup-label:hover {
            background: #262626;
            color: #aaa;
        }
        
        .tree-subgroup-icon {
            font-size: 0.5rem;
            transition: transform 0.15s;
            width: 0.5rem;
            text-align: center;
            color: #555;
        }
        
        .tree-subgroup.collapsed .tree-subgroup-icon {
            transform: rotate(-90deg);
        }
        
        .tree-subitems {
            list-style: none;
            padding: 0 0 0 0.625rem;
            margin: 0.125rem 0 0 0.5rem;
            border-left: 1px solid #222;
        }
        
        .tree-subgroup.collapsed .tree-subitems {
            display: none;
        }
        
        .tree-item {
            padding: 0.25rem 0.375rem;
            padding-left: 2rem; /* Space for gripper */
            font-size: 0.625rem;
            color: #888;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-family: 'SF Mono', Monaco, monospace;
            position: relative; /* For absolute positioning of gripper */
        }
        
        /* Drag gripper */
        .dialogue-drag-handle {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 1.5rem;
            background: #2a2a2a;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        
        .dialogue-drag-handle:active {
            cursor: grabbing;
        }
        
        .dialogue-drag-handle::before {
            content: '‚ãÆ‚ãÆ';
            font-size: 0.75rem;
            color: #555;
            letter-spacing: -2px;
        }
        
        .dialogue-drag-handle:hover::before {
            color: #888;
        }
        
        .tree-item.dragging {
            opacity: 0.4;
        }
        
        .tree-item.drag-over {
            background: #333;
            border-top: 2px solid #734ba1;
        }
        
        .tree-item:hover {
            background: #2a2a2a;
            color: #aaa;
        }
        
        .tree-item.active {
            background: #333;
            color: #fff;
            font-weight: 600;
        }
        
        .tree-item-label {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .tree-item-count {
            font-size: 0.5625rem;
            color: #555;
            font-weight: 500;
            flex-shrink: 0;
            margin-left: auto;
        }
        
        .tree-item.active .tree-item-count {
            color: rgba(255,255,255,0.8);
        }
        
        /* Tree group styles */
        .tree-group {
            margin-bottom: 0.5rem;
        }
        
        .tree-group-header {
            padding: 0.375rem 0.5rem;
            background: #252525;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.7rem;
            color: #999;
            font-weight: 600;
            transition: all 0.15s;
            user-select: none;
        }
        
        .tree-group-header:hover {
            background: #2a2a2a;
            color: #bbb;
        }
        
        .tree-group-arrow {
            font-size: 0.6rem;
            transition: transform 0.2s;
            display: inline-block;
            width: 0.8rem;
        }
        
        .tree-group.collapsed .tree-group-arrow {
            transform: rotate(-90deg);
        }
        
        .tree-group-label {
            flex: 1;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .tree-group-count {
            font-size: 0.55rem;
            background: #333;
            color: #777;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .tree-group-items {
            padding-top: 0.25rem;
            transition: all 0.2s;
        }
        
        .tree-group.collapsed .tree-group-items {
            display: none;
        }
        
        /* Tree item content wrapper */
        .tree-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
            min-width: 0;
        }
        
        .tree-item-key {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.625rem;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .tree-item.active .tree-item-key {
            color: #fff;
        }
        
        .tree-item:hover .tree-item-key {
            color: #aaa;
        }
        
        .tree-item-title {
            font-size: 0.5625rem;
            color: #666;
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .tree-item.active .tree-item-title {
            color: rgba(255,255,255,0.6);
        }
        
        .tree-item:hover .tree-item-title {
            color: #777;
        }
        
        /* Main Content with sidebar offset and drawer spacing */
        .dialogue-main {
            margin-left: 300px; /* 280px sidebar + 10px left margin + 10px gap */
            margin-right: 10px;
            margin-top: 10px; /* 10px from header */
            margin-bottom: 74px; /* 64px drawer + 10px margin */
            flex: 1;
            min-width: 0;
        }
        
        /* Header Section - simplified */
        .page-header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--card-border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .page-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* Main Content */
        .dialogue-section {
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .dialogue-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        /* Dialogue Group Card */
        .dialogue-group {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.2s;
        }
        
        .dialogue-group:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .dialogue-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--card-border);
            gap: 1rem;
        }
        
        .dialogue-key {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
            cursor: text;
            outline: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background 0.2s;
            flex: 1;
            text-align: left;
        }
        
        .dialogue-key:hover {
            background: var(--hover-bg);
        }
        
        .dialogue-key:focus {
            background: #fff7ed;
            box-shadow: 0 0 0 2px rgba(var(--primary-color), 0.2);
        }
        
        .dialogue-header-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .dialogue-header-btn {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 4px;
            border: 1px solid;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'SF Mono', Monaco, monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .dialogue-header-btn.save {
            background: #dcfce7;
            border-color: #16a34a;
            color: #15803d;
        }
        
        .dialogue-header-btn.save:hover {
            background: #bbf7d0;
            transform: translateY(-1px);
        }
        
        .dialogue-header-btn.test {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }
        
        .dialogue-header-btn.test:hover {
            background: #bfdbfe;
            transform: translateY(-1px);
        }
        
        .dialogue-header-btn.delete {
            background: #fee2e2;
            border-color: #dc2626;
            color: #991b1b;
        }
        
        .dialogue-header-btn.delete:hover {
            background: #fecaca;
            transform: translateY(-1px);
        }
        
        /* Dialogue metadata section - two column layout like quests */
        .dialogue-metadata {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 1rem 0;
            font-size: 0.8rem;
        }
        
        .dialogue-conditions-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .dialogue-section-title {
            font-weight: 700;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .dialogue-condition-card {
            padding: 0.6rem 0.75rem;
            background: #fef9c3;
            border-left: 4px solid #ca8a04;
            font-size: 0.8rem;
            color: #713f12;
            word-break: break-word;
            border-radius: 2px;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            position: relative;
        }
        
        .dialogue-condition-card code {
            background: rgba(255, 255, 255, 0.8);
            padding: 0.2rem 0.4rem;
            font-size: 0.75rem;
            color: #854d0e;
            font-weight: 700;
            border-radius: 2px;
        }
        
        .dialogue-condition-card .remove-condition {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #dc2626;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            line-height: 1;
            padding: 0;
        }
        
        .dialogue-condition-card .remove-condition:hover {
            background: #b91c1c;
        }
        
        .add-item-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.75rem;
            background: #f9fafb;
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            color: #6b7280;
            font-size: 0.8125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.75rem;
            font-family: 'SF Mono', Monaco, monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .add-item-btn:hover {
            background: #e0f2fe;
            border-color: #3b82f6;
            color: #1e40af;
            transform: translateY(-1px);
        }
        
        .dialogue-code-section {
            background: #1e1e1e;
            border-radius: 4px;
            padding: 1rem;
            overflow: auto;
            max-height: 400px;
        }
        
        .dialogue-code-section pre {
            margin: 0;
            color: #d4d4d4;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.75rem;
            line-height: 1.6;
        }
        
        .dialogue-code-section .code-key {
            color: #9cdcfe;
        }
        
        .dialogue-code-section .code-value {
            color: #ce9178;
        }
        
        .dialogue-code-section .code-boolean {
            color: #569cd6;
        }
        
        /* Placeholder toolbar for message editing */
        .placeholder-toolbar {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .placeholder-toolbar-label {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #6b7280;
            font-family: 'SF Mono', monospace;
            margin-right: 0.375rem;
            letter-spacing: 0.5px;
        }
        
        .placeholder-chip {
            padding: 0.25rem 0.5rem;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-family: 'SF Mono', monospace;
            font-size: 0.65rem;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
        }
        
        .placeholder-chip:hover {
            background: #734ba1;
            color: white;
            border-color: #734ba1;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(115, 75, 161, 0.2);
        }
        
        .placeholder-chip:active {
            transform: translateY(0) scale(0.98);
        }
        
        /* Dropdown menu for adding conditions */
        .add-item-dropdown {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid var(--card-border);
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            width: 90%;
            max-width: 500px;
            max-height: 500px;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .add-item-dropdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .add-item-dropdown-item {
            padding: 0.6rem 0.75rem;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.75rem;
            border-bottom: 1px solid var(--hover-bg);
        }
        
        .add-item-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .add-item-dropdown-item:hover {
            background: var(--hover-bg);
        }
        
        .add-item-dropdown-item-title {
            font-weight: 600;
            color: var(--text-primary);
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .add-item-dropdown-item-desc {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            line-height: 1.4;
        }
        
        /* Button section improvements */
        .button-metadata {
            background: #f0f9ff;
            border-left: 4px solid #0284c7;
            padding: 0.75rem;
            margin-top: 0.75rem;
            border-radius: 2px;
        }
        
        .button-metadata-title {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #075985;
            margin-bottom: 0.5rem;
            font-family: 'SF Mono', monospace;
        }
        
        /* Message Cards */
        .dialogue-messages {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: center; /* Center all message cards */
        }
        
        .message-card {
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
            width: 100%;
            max-width: 900px; /* Wider for two-column layout */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s;
        }
        
        .message-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .message-card:hover .message-controls {
            opacity: 1;
        }
        
        .message-main-layout {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 1.5rem;
        }
        
        .message-left-content {
            min-width: 0; /* Allow content to shrink */
        }
        
        .message-right-sidebar {
            border-left: 2px solid #f3f4f6;
            padding-left: 1.5rem;
        }
        
        .message-conditions-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .message-conditions-title {
            font-weight: 700;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .message-condition-card {
            padding: 0.5rem 0.65rem;
            background: #fef9c3;
            border-left: 3px solid #ca8a04;
            font-size: 0.7rem;
            color: #713f12;
            word-break: break-word;
            border-radius: 2px;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            position: relative;
        }
        
        .message-condition-card code {
            background: rgba(255, 255, 255, 0.8);
            padding: 0.15rem 0.3rem;
            font-size: 0.65rem;
            color: #854d0e;
            font-weight: 700;
            border-radius: 2px;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .message-condition-card .remove-condition {
            position: absolute;
            top: 0.4rem;
            right: 0.4rem;
            background: #dc2626;
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.65rem;
            line-height: 1;
            padding: 0;
        }
        
        .message-condition-card .remove-condition:hover {
            background: #b91c1c;
        }
        
        .message-add-condition-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            width: 100%;
            padding: 0.5rem;
            background: #fef9c3;
            border: 2px dashed #ca8a04;
            border-radius: 4px;
            color: #854d0e;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'SF Mono', Monaco, monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .message-add-condition-btn:hover {
            background: #fde68a;
            border-color: #92400e;
            color: #92400e;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f3f4f6;
        }
        
        .message-sequence {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.875rem;
            font-weight: 700;
            color: #6b7280;
            background: #f9fafb;
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            letter-spacing: 0.5px;
        }
        
        .message-controls {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .message-control-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .message-control-btn.move-up,
        .message-control-btn.move-down {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .message-control-btn.delete {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .message-control-btn:hover {
            transform: translateY(-1px);
            filter: brightness(0.95);
        }
        
        .message-text-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin: 1.5rem 0;
        }
        
        .message-text {
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 18px;
            line-height: 1.6;
            color: #1f2937;
            white-space: pre-wrap;
            min-height: calc(18px * 1.6 * 5.5); /* 5.5 lines (1.5 lines taller than before) */
            max-height: calc(18px * 1.6 * 16); /* Max 16 lines */
            width: 100%;
            max-width: 500px; /* Comfortable reading width */
            padding: 24px 30px;
            background: #ffffff;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            outline: none;
            overflow-y: auto;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            resize: vertical;
        }
        
        .message-text:hover {
            border-color: #734ba1;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05), 0 0 0 3px rgba(115, 75, 161, 0.1);
        }
        
        .message-text:focus {
            border-color: #734ba1;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05), 0 0 0 3px rgba(115, 75, 161, 0.15);
        }
        
        .message-text::placeholder {
            color: #9ca3af;
            font-style: italic;
            font-size: 16px;
        }
        
        .message-align-toggle {
            display: flex;
            justify-content: center;
            margin-top: 0.375rem;
        }
        
        .align-toggle-btn {
            padding: 0.25rem 0.5rem;
            background: #f9fafb;
            border: 1px solid #d1d5db;
            color: #6b7280;
            font-size: 0.65rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            font-family: 'SF Mono', Monaco, monospace;
            border-radius: 3px;
        }
        
        .align-toggle-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            color: #374151;
        }
        
        /* Buttons Section */
        .message-buttons {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #f3f4f6;
        }
        
        .message-buttons-header {
            font-size: 0.75rem;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .button-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .button-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 0.875rem;
            display: grid;
            grid-template-columns: 24px minmax(0, 2fr) 70px minmax(0, 0.8fr) minmax(0, 1.5fr) auto auto auto;
            gap: 0.75rem;
            align-items: center;
            transition: all 0.2s;
            position: relative;
        }
        
        .button-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        .button-item.dragging {
            opacity: 0.5;
            background: #e0e7ff;
        }
        
        .button-drag-handle {
            cursor: grab;
            color: #9ca3af;
            font-size: 18px;
            text-align: center;
            user-select: none;
            transition: color 0.2s;
        }
        
        .button-drag-handle:hover {
            color: #6b7280;
        }
        
        .button-drag-handle:active {
            cursor: grabbing;
        }
        
        .button-text-input,
        .button-action-input {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 12px;
            border: 1.5px solid #cbd5e1;
            border-radius: 4px;
            outline: none;
            background: white;
            transition: all 0.2s;
        }
        
        .button-rotation-speed {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            font-weight: 600;
            padding: 8px 6px;
            border: 1.5px solid #cbd5e1;
            border-radius: 4px;
            outline: none;
            background: white;
            text-align: center;
            width: 70px;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
        }
        
        .button-action-type {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            padding: 8px 10px;
            border: 1.5px solid #cbd5e1;
            border-radius: 4px;
            outline: none;
            background: white;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .button-text-input:focus,
        .button-action-input:focus,
        .button-rotation-speed:focus,
        .button-action-type:focus {
            border-color: #734ba1;
            box-shadow: 0 0 0 3px rgba(115, 75, 161, 0.1);
        }
        
        .button-secondary-toggle {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 11px;
            color: #6b7280;
            cursor: pointer;
            font-family: 'SF Mono', Monaco, monospace;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            user-select: none;
        }
        
        .button-secondary-toggle input {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }
        
        .button-goto-btn {
            padding: 0.5rem 0.75rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .button-goto-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .button-delete-btn {
            padding: 0.5rem 0.75rem;
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 4px;
            color: #991b1b;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .button-delete-btn:hover {
            background: #fecaca;
            border-color: #fca5a5;
            transform: translateY(-1px);
        }
        
        .add-button-btn {
            width: 100%;
            padding: 0.75rem;
            background: #f9fafb;
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            color: #6b7280;
            font-size: 0.8125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 0.5rem;
            font-family: 'SF Mono', Monaco, monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .add-button-btn:hover {
            background: #e0f2fe;
            border-color: #3b82f6;
            color: #1e40af;
            transform: translateY(-1px);
        }
        
        /* Add Message Button */
        .add-message-btn {
            width: 100%;
            max-width: 700px;
            margin: 1.5rem auto 0;
            padding: 1rem;
            background: #f9fafb;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: block;
            font-family: 'SF Mono', Monaco, monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .add-message-btn:hover {
            background: #dcfce7;
            border-color: #16a34a;
            color: #15803d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(22, 163, 74, 0.15);
        }
        
        /* Group Actions */
        .dialogue-group-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--card-border);
        }
        
        .dialogue-action-btn {
            flex: 1;
            padding: 0.6rem 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 4px;
            border: 1px solid;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .dialogue-action-btn.save {
            background: #dcfce7;
            border-color: #16a34a;
            color: #15803d;
        }
        
        .dialogue-action-btn.save:hover {
            background: #bbf7d0;
            transform: translateY(-1px);
        }
        
        .dialogue-action-btn.delete {
            background: #fee2e2;
            border-color: #dc2626;
            color: #991b1b;
        }
        
        .dialogue-action-btn.delete:hover {
            background: #fecaca;
            transform: translateY(-1px);
        }
        
        /* Create Dialogue Button */
        .create-dialogue-section {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 100;
        }
        
        .create-dialogue-btn {
            padding: 1rem 2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        
        .create-dialogue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--card-border);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            text-align: center;
            padding: 2rem;
            color: #991b1b;
            background: #fee2e2;
            border-radius: 8px;
            margin: 2rem;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex !important;
            align-items: center;
            justify-content: center;
            z-index: 99999 !important;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            z-index: 100000;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--card-border);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-dim);
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-form-group {
            margin-bottom: 1.25rem;
        }
        
        .modal-form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .modal-form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: 'SF Mono', Monaco, monospace;
            outline: none;
        }
        
        .modal-form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(115, 75, 161, 0.1);
        }
        
        .modal-form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
        }
        
        .modal-form-select:focus {
            border-color: var(--primary-color);
        }
        
        .modal-footer {
            display: flex;
            gap: 0.75rem;
            padding: 1.5rem;
            border-top: 1px solid var(--card-border);
        }
        
        .modal-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-btn.primary {
            background: var(--primary-color);
            color: white;
            border: none;
        }
        
        .modal-btn.primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .modal-btn.primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .modal-btn.secondary {
            background: white;
            color: var(--text-secondary);
            border: 1px solid var(--card-border);
        }
        
        .modal-btn.secondary:hover {
            background: var(--hover-bg);
        }
        
        /* Stats Header */
        .dialogue-stats {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'SF Mono', Monaco, monospace;
        }
    </style>
</head>
<body>
    <div class="page-layout">
        <!-- Sidebar -->
        <div class="dialogue-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Message Admin Suite</div>
                <div class="sidebar-stats">
                    <div class="sidebar-stat">
                        <div class="sidebar-stat-value" id="stat-templates">0</div>
                        <div>Templates</div>
                    </div>
                    <div class="sidebar-stat">
                        <div class="sidebar-stat-value" id="stat-sent">0</div>
                        <div>Sent</div>
                    </div>
                </div>
                
                <!-- Main Tabs -->
                <div class="sidebar-tabs" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.25rem; margin-top: 0.75rem; margin-bottom: 0.75rem;">
                    <button class="sidebar-tab active" onclick="switchMainTab('templates')" style="padding: 0.5rem 0.375rem; font-size: 0.625rem; font-weight: 600; background: #2a2a2a; color: #ccc; border: 1px solid #444; border-radius: 2px; cursor: pointer; font-family: 'SF Mono', Monaco, monospace; transition: all 0.15s;">üìù Templates</button>
                    <button class="sidebar-tab" onclick="switchMainTab('pigeons')" style="padding: 0.5rem 0.375rem; font-size: 0.625rem; font-weight: 600; background: #0d0d0d; color: #666; border: 1px solid #333; border-radius: 2px; cursor: pointer; font-family: 'SF Mono', Monaco, monospace; transition: all 0.15s;">üïäÔ∏è Pigeons</button>
                    <button class="sidebar-tab" onclick="switchMainTab('messages')" style="padding: 0.5rem 0.375rem; font-size: 0.625rem; font-weight: 600; background: #0d0d0d; color: #666; border: 1px solid #333; border-radius: 2px; cursor: pointer; font-family: 'SF Mono', Monaco, monospace; transition: all 0.15s;">üì® Messages</button>
                </div>
                
                <div class="sidebar-actions">
                    <button class="sidebar-btn primary" onclick="showCreateDialogueModal()">+ New</button>
                    <button class="sidebar-btn" onclick="showHeaderRotatorModal()">üîÑ Rotator</button>
                    <button class="sidebar-btn" onclick="saveAllDialogues()" style="background: #1a2d1a; color: #22c55e; border-color: #16a34a;">üíæ Save</button>
                </div>
            </div>
            
            <!-- Tree View (Templates Tab - default) -->
            <div class="sidebar-tree-container" id="sidebar-tree-view">
                <ul class="sidebar-tree" id="dialogue-tree">
                    <li style="padding: 1rem; text-align: center; color: var(--text-dim); font-size: 0.875rem;">
                        Loading...
                    </li>
                </ul>
            </div>
            
            <!-- Pigeons Tab -->
            <div class="sidebar-pigeons-container" id="sidebar-pigeons-view" style="display: none; padding: 0.75rem; overflow-y: auto;">
                <!-- Create Button at TOP -->
                <button onclick="showCreatePigeonModal()" style="
                    width: 100%;
                    padding: 0.75rem;
                    background: #2d7a3e;
                    color: white;
                    border: none;
                    border-radius: 3px;
                    font-size: 0.7rem;
                    font-weight: 600;
                    cursor: pointer;
                    font-family: 'SF Mono', Monaco, monospace;
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                    margin-bottom: 1rem;
                ">+ Create Pigeon</button>
                
                <div style="font-size: 0.625rem; font-weight: 700; color: #888; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em;">Filters & Search</div>
                
                <!-- Search Box -->
                <input type="text" 
                       id="pigeon-search" 
                       placeholder="Search pigeons..."
                       oninput="filterPigeons()"
                       style="
                           width: 100%;
                           padding: 0.5rem;
                           margin-bottom: 0.75rem;
                           background: #0d0d0d;
                           border: 1px solid #333;
                           border-radius: 3px;
                           color: #ccc;
                           font-size: 0.7rem;
                           font-family: 'SF Mono', Monaco, monospace;
                       ">
                
                <!-- Status Filter -->
                <div style="margin-bottom: 0.75rem;">
                    <div style="font-size: 0.625rem; color: #666; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.05em;">Status</div>
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                        <label style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.7rem; color: #888; cursor: pointer;">
                            <input type="checkbox" id="filter-active" checked onchange="filterPigeons()" style="cursor: pointer;">
                            <span>üü¢ Active</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.7rem; color: #888; cursor: pointer;">
                            <input type="checkbox" id="filter-paused" checked onchange="filterPigeons()" style="cursor: pointer;">
                            <span>‚è∏Ô∏è Paused</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.7rem; color: #888; cursor: pointer;">
                            <input type="checkbox" id="filter-draft" checked onchange="filterPigeons()" style="cursor: pointer;">
                            <span>üìù Draft</span>
                        </label>
                    </div>
                </div>
                
                <!-- Sort By -->
                <div style="margin-bottom: 0.75rem;">
                    <div style="font-size: 0.625rem; color: #666; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.05em;">Sort By</div>
                    <select id="pigeon-sort" onchange="filterPigeons()" style="
                        width: 100%;
                        padding: 0.5rem;
                        background: #0d0d0d;
                        border: 1px solid #333;
                        border-radius: 3px;
                        color: #ccc;
                        font-size: 0.7rem;
                        font-family: 'SF Mono', Monaco, monospace;
                        cursor: pointer;
                    ">
                        <option value="name">Name</option>
                        <option value="status">Status</option>
                        <option value="trigger">Trigger Type</option>
                        <option value="created">Created Date</option>
                    </select>
                </div>
            </div>
            
            <!-- Messages Tab (Send + Monitor combined) -->
            <div class="sidebar-messages-container" id="sidebar-messages-view" style="display: none; padding: 0.75rem; overflow-y: auto;">
                <!-- Send Form Section -->
                <div style="font-size: 0.625rem; font-weight: 700; color: #888; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em;">Send Message</div>
                <div id="send-form-container" style="margin-bottom: 1.5rem;">
                    <!-- Send form will be rendered here -->
                </div>
                
                <!-- Monitor Section -->
                <div style="font-size: 0.625rem; font-weight: 700; color: #888; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em;">Monitor</div>
                <div id="monitor-stats-container" style="margin-bottom: 1rem;">
                    <!-- Stats will be rendered here -->
                </div>
                <div style="font-size: 0.625rem; color: #666; text-align: center; padding: 1rem; background: #0d0d0d; border: 1px solid #333; border-radius: 3px;">
                    View full message table ‚Üí
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="dialogue-main">
            <div class="dialogue-section">
                <!-- Templates View -->
                <div id="dialogue-list" class="dialogue-list">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div>Loading dialogues...</div>
                    </div>
                </div>
                
                <!-- Pigeons Grid View -->
                <div id="pigeons-grid-view" style="display: none;">
                    <div id="pigeons-grid-container" style="
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(280px, 320px));
                        gap: 1rem;
                        padding: 1rem 0;
                        justify-content: start;
                    ">
                        <!-- Pigeon cards will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // SUBTLE TOAST NOTIFICATION SYSTEM
        // ============================================================================
        
        /**
         * Show a subtle toast notification
         * @param {string} message - Message to display
         * @param {string} type - 'info', 'success', or 'error'
         */
        function showAlert(message, type = 'info') {
            return new Promise((resolve) => {
                const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : 'i';
                const bgColor = type === 'success' ? '#dcfce7' : type === 'error' ? '#fee2e2' : '#dbeafe';
                const textColor = type === 'success' ? '#15803d' : type === 'error' ? '#991b1b' : '#1e40af';
                const borderColor = type === 'success' ? '#16a34a' : type === 'error' ? '#dc2626' : '#3b82f6';
                
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: ${bgColor};
                    border: 2px solid ${borderColor};
                    border-radius: 4px;
                    padding: 0.875rem 1.25rem;
                    max-width: 400px;
                    font-family: 'SF Mono', Monaco, monospace;
                    color: ${textColor};
                    font-size: 0.75rem;
                    font-weight: 600;
                    z-index: 20000;
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    animation: slideIn 0.3s ease-out;
                    cursor: pointer;
                `;
                
                toast.innerHTML = `
                    <span style="
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        background: ${textColor};
                        color: white;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: 700;
                        flex-shrink: 0;
                    ">${icon}</span>
                    <div style="flex: 1;">${message}</div>
                `;
                
                // Add slide-in animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(120%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(120%); opacity: 0; }
                    }
                `;
                
        /**
         * Show a small "saved" indicator next to an element
         * @param {HTMLElement} element - Element to show indicator next to
         */
        function showSavedIndicator(element) {
            const indicator = document.createElement('span');
            indicator.textContent = '‚úì Saved';
            indicator.style.cssText = `
                margin-left: 8px;
                color: #16a34a;
                font-size: 0.7rem;
                font-weight: 600;
                opacity: 1;
                transition: opacity 0.3s;
            `;
            
            element.appendChild(indicator);
            
            setTimeout(() => {
                indicator.style.opacity = '0';
                setTimeout(() => indicator.remove(), 300);
            }, 1500);
        }
        document.head.appendChild(style);
                
                document.body.appendChild(toast);
                
                const remove = () => {
                    toast.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => {
                        toast.remove();
                        style.remove();
                        resolve();
                    }, 300);
                };
                
                // Auto-dismiss after 3 seconds
                setTimeout(remove, 3000);
                
                // Click to dismiss
                toast.addEventListener('click', remove);
            });
        }
        
        /**
         * Show a confirm-style modal
         * @param {string} message - Message to display
         * @returns {Promise<boolean>} - True if confirmed, false if cancelled
         */
        /**
         * Show a subtle inline input prompt
         * @param {string} message - Message to display
         * @param {string} defaultValue - Default input value
         * @returns {Promise<string|null>} - Input value or null if cancelled
         */
        function showPrompt(message, defaultValue = '') {
            return new Promise((resolve) => {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: #dbeafe;
                    border: 2px solid #3b82f6;
                    border-radius: 4px;
                    padding: 0.875rem 1.25rem;
                    max-width: 400px;
                    min-width: 300px;
                    font-family: 'SF Mono', Monaco, monospace;
                    color: #1e40af;
                    font-size: 0.75rem;
                    font-weight: 600;
                    z-index: 20000;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    animation: slideIn 0.3s ease-out;
                `;
                
                const inputId = 'prompt-input-' + Date.now();
                toast.innerHTML = `
                    <div style="margin-bottom: 0.75rem; line-height: 1.4;">${message}</div>
                    <input type="text" 
                           id="${inputId}"
                           value="${defaultValue.replace(/"/g, '&quot;')}" 
                           style="
                               width: 100%;
                               padding: 0.5rem;
                               font-family: 'SF Mono', monospace;
                               font-size: 0.75rem;
                               background: white;
                               border: 1px solid #93c5fd;
                               color: #1e40af;
                               border-radius: 3px;
                               margin-bottom: 0.75rem;
                               box-sizing: border-box;
                           ">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button id="btn-cancel" style="
                            padding: 0.5rem;
                            background: white;
                            color: #6b7280;
                            border: 1px solid #d1d5db;
                            border-radius: 3px;
                            cursor: pointer;
                            font-family: 'SF Mono', monospace;
                            font-size: 0.7rem;
                            text-transform: uppercase;
                            font-weight: 600;
                        ">Cancel</button>
                        <button id="btn-ok" style="
                            padding: 0.5rem;
                            background: #3b82f6;
                            color: white;
                            border: none;
                            border-radius: 3px;
                            cursor: pointer;
                            font-family: 'SF Mono', monospace;
                            font-size: 0.7rem;
                            text-transform: uppercase;
                            font-weight: 700;
                        ">OK</button>
                    </div>
                `;
                
                document.body.appendChild(toast);
                
                const input = document.getElementById(inputId);
                input.focus();
                input.select();
                
                const remove = (value) => {
                    toast.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => {
                        toast.remove();
                        resolve(value);
                    }, 300);
                };
                
                toast.querySelector('#btn-ok').onclick = () => remove(input.value);
                toast.querySelector('#btn-cancel').onclick = () => remove(null);
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        remove(input.value);
                    } else if (e.key === 'Escape') {
                        remove(null);
                    }
                });
            });
        }
        
        /**
         * Show a subtle inline confirmation
         * @param {string} message - Message to display
         * @returns {Promise<boolean>} - True if confirmed, false if cancelled
         */
        function showConfirm(message) {
            return new Promise((resolve) => {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: #fef9c3;
                    border: 2px solid #ca8a04;
                    border-radius: 4px;
                    padding: 0.875rem 1.25rem;
                    max-width: 400px;
                    font-family: 'SF Mono', Monaco, monospace;
                    color: #713f12;
                    font-size: 0.75rem;
                    font-weight: 600;
                    z-index: 20000;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    animation: slideIn 0.3s ease-out;
                `;
                
                toast.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <span style="
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            background: #ca8a04;
                            color: white;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: 700;
                            flex-shrink: 0;
                        ">?</span>
                        <div style="flex: 1; line-height: 1.4;">${message}</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button id="confirmCancel" style="
                            padding: 0.5rem;
                            background: white;
                            color: #6b7280;
                            border: 1px solid #d1d5db;
                            border-radius: 3px;
                            font-family: 'SF Mono', Monaco, monospace;
                            font-size: 0.7rem;
                            text-transform: uppercase;
                            cursor: pointer;
                            letter-spacing: 0.05em;
                            font-weight: 600;
                        ">Cancel</button>
                        <button id="confirmOk" style="
                            padding: 0.5rem;
                            background: #ca8a04;
                            color: white;
                            border: none;
                            border-radius: 3px;
                            font-family: 'SF Mono', Monaco, monospace;
                            font-size: 0.7rem;
                            text-transform: uppercase;
                            cursor: pointer;
                            letter-spacing: 0.05em;
                            font-weight: 700;
                        ">Confirm</button>
                    </div>
                `;
                
                document.body.appendChild(toast);
                
                const remove = (result) => {
                    toast.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => {
                        toast.remove();
                        resolve(result);
                    }, 300);
                };
                
                toast.querySelector('#confirmCancel').addEventListener('click', () => remove(false));
                toast.querySelector('#confirmOk').addEventListener('click', () => remove(true));
                
                // Focus the confirm button
                toast.querySelector('#confirmOk').focus();
            });
        }
        
        // ============================================================================
        // DATA & STATE
        // ============================================================================
        
        let dialogueData = {};
        let selectedKey = null; // Track currently selected dialogue key
        let currentMainTab = 'templates'; // Track current main tab
        
        // ============================================================================
        // TAB SWITCHING
        // ============================================================================
        
        function switchMainTab(tab) {
            console.log(`üîÑ Switching to tab: ${tab}`);
            currentMainTab = tab;
            
            // Save active tab to localStorage for persistence
            localStorage.setItem('dialogues_active_tab', tab);
            
            // Update tab button styles
            document.querySelectorAll('.sidebar-tab').forEach(btn => {
                btn.style.background = '#0d0d0d';
                btn.style.color = '#666';
                btn.style.borderColor = '#333';
            });
            event.target.style.background = '#2a2a2a';
            event.target.style.color = '#ccc';
            event.target.style.borderColor = '#444';
            
            // Hide all sidebar tab content
            document.getElementById('sidebar-tree-view').style.display = 'none';
            document.getElementById('sidebar-pigeons-view').style.display = 'none';
            const messagesView = document.getElementById('sidebar-messages-view');
            if (messagesView) messagesView.style.display = 'none';
            
            // Hide all main content panels
            const dialogueList = document.getElementById('dialogue-list');
            const pigeonsGrid = document.getElementById('pigeons-grid-view');
            
            // Show selected tab and update main panel
            if (tab === 'templates') {
                document.getElementById('sidebar-tree-view').style.display = 'block';
                dialogueList.style.display = 'block';
                pigeonsGrid.style.display = 'none';
                renderDialogues(); // Show template editor
            } else if (tab === 'pigeons') {
                document.getElementById('sidebar-pigeons-view').style.display = 'block';
                dialogueList.style.display = 'none';
                pigeonsGrid.style.display = 'block';
                loadPigeons();
                // Load triggers first, then render grid after triggers are loaded
                loadTriggerTypes().then(() => {
                    renderPigeonsGrid();
                });
            } else if (tab === 'messages') {
                if (messagesView) messagesView.style.display = 'block';
                dialogueList.style.display = 'block';
                pigeonsGrid.style.display = 'none';
                renderSendForm();
                loadMonitorData();
                showMonitorPanel(); // Show the full message monitor, not the placeholder
            }
        }
        
        function restoreActiveTab() {
            // Restore the previously active tab from localStorage
            const savedTab = localStorage.getItem('dialogues_active_tab');
            if (savedTab && ['templates', 'pigeons', 'messages'].includes(savedTab)) {
                console.log(`üîÑ Restoring saved tab: ${savedTab}`);
                currentMainTab = savedTab;
                
                // Update button styles
                document.querySelectorAll('.sidebar-tab').forEach(btn => {
                    const btnTab = btn.textContent.toLowerCase().includes('templates') ? 'templates' :
                                   btn.textContent.toLowerCase().includes('pigeon') ? 'pigeons' :
                                   btn.textContent.toLowerCase().includes('message') ? 'messages' : null;
                    
                    if (btnTab === savedTab) {
                        btn.style.background = '#2a2a2a';
                        btn.style.color = '#ccc';
                        btn.style.borderColor = '#444';
                    } else {
                        btn.style.background = '#0d0d0d';
                        btn.style.color = '#666';
                        btn.style.borderColor = '#333';
                    }
                });
                
                // Get sidebar views
                const treeView = document.getElementById('sidebar-tree-view');
                const pigeonsView = document.getElementById('sidebar-pigeons-view');
                const messagesView = document.getElementById('sidebar-messages-view');
                
                // Hide all sidebar views (only if they exist)
                if (treeView) treeView.style.display = 'none';
                if (pigeonsView) pigeonsView.style.display = 'none';
                if (messagesView) messagesView.style.display = 'none';
                
                // Get main content panels
                const dialogueList = document.getElementById('dialogue-list');
                const pigeonsGrid = document.getElementById('pigeons-grid-view');
                
                // Show the saved tab
                if (savedTab === 'templates') {
                    if (treeView) treeView.style.display = 'block';
                    if (dialogueList) dialogueList.style.display = 'block';
                    if (pigeonsGrid) pigeonsGrid.style.display = 'none';
                    renderDialogues();
                } else if (savedTab === 'pigeons') {
                    if (pigeonsView) pigeonsView.style.display = 'block';
                    if (dialogueList) dialogueList.style.display = 'none';
                    if (pigeonsGrid) pigeonsGrid.style.display = 'block';
                    loadPigeons();
                    // Load triggers first, then render grid after triggers are loaded
                    loadTriggerTypes().then(() => {
                        renderPigeonsGrid();
                    });
                } else if (savedTab === 'messages') {
                    if (messagesView) messagesView.style.display = 'block';
                    if (dialogueList) dialogueList.style.display = 'block';
                    if (pigeonsGrid) pigeonsGrid.style.display = 'none';
                    renderSendForm();
                    loadMonitorData();
                    showMonitorPanel();
                }
            } else {
                // Default to templates tab
                console.log('üîÑ No saved tab, defaulting to templates');
                currentMainTab = 'templates';
            }
        }
        
        // ============================================================================
        // LOAD DATA
        // ============================================================================
        
        async function loadDialogues() {
            console.log('üîÑ [Dialogues] Loading dialogue templates from dialogues table...');
            try {
                console.log('üì° [Dialogues] Fetching from /api/dialogues/templates');
                const response = await authenticatedFetch('/api/dialogues/templates');
                console.log('üì° [Dialogues] Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Failed to load dialogue templates (${response.status})`);
                }
                
                const result = await response.json();
                const templates = result.data || [];
                console.log('‚úÖ [Dialogues] Loaded', templates.length, 'dialogue templates');
                console.log('üìä [Dialogues] Raw data:', templates);
                
                // Convert to dialogue data format
                dialogueData = {};
                templates.forEach(template => {
                    dialogueData[template.key] = {
                        key: template.key,
                        title: template.title || '',
                        messages: template.messages
                    };
                });
                
                console.log('üìä [Dialogues] Converted into', Object.keys(dialogueData).length, 'dialogue templates');
                console.log('üìä [Dialogues] Dialogue keys:', Object.keys(dialogueData));
                
                // Restore previously selected dialogue from localStorage
                const savedKey = localStorage.getItem('dialogues_selected_key');
                if (savedKey && dialogueData[savedKey]) {
                    console.log('üîÑ Restoring selected dialogue:', savedKey);
                    selectedKey = savedKey;
                } else if (Object.keys(dialogueData).length > 0) {
                    // Default to first dialogue if no saved selection
                    selectedKey = Object.keys(dialogueData).sort()[0];
                }
                
                console.log('‚úÖ [Dialogues] Rendering dialogues...');
                renderDialogues();
                renderSidebar();
                updateStats();
                console.log('‚úÖ [Dialogues] Load complete');
            } catch (error) {
                console.error('‚ùå [Dialogues] Error loading dialogues:', error);
                console.error('‚ùå [Dialogues] Error stack:', error.stack);
                document.getElementById('dialogue-list').innerHTML = `
                    <div class="error">Failed to load dialogue templates: ${error.message}</div>
                `;
            }
        }
        
        // Render dialogues
        function renderDialogues() {
            const container = document.getElementById('dialogue-list');
            const keys = Object.keys(dialogueData).sort();
            
            if (keys.length === 0) {
                container.innerHTML = '<div class="loading">No dialogues found. Create your first one!</div>';
                return;
            }
            
            // Only render the selected key, or show a message if none selected
            if (!selectedKey || !dialogueData[selectedKey]) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 4rem 2rem; color: var(--text-dim);">
                        <div style="font-size: 1.5rem; margin-bottom: 1rem;">‚Üê</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace;">Select a dialogue from the sidebar</div>
                    </div>
                `;
                return;
            }
            
            const key = selectedKey;
            const dialogue = dialogueData[key];
            
            container.innerHTML = `
                <div class="dialogue-group" data-key="${key}">
                    <div class="dialogue-group-header">
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; flex: 1;">
                            <input type="text" 
                                   class="dialogue-title-input" 
                                   placeholder="Dialogue Title (optional)" 
                                   value="${dialogue.title || ''}"
                                   data-key="${key}"
                                   onblur="updateDialogueTitle(this)"
                                   style="background: transparent; border: none; border-bottom: 2px solid #ddd; padding: 0.5rem 0; font-size: 1.25rem; color: #111; font-weight: 600; text-align: left;">
                            <div contenteditable="true" 
                                 class="dialogue-key" 
                                 data-original-key="${key}"
                                 onblur="updateDialogueKey(this)"
                                 style="font-family: 'SF Mono', Monaco, monospace; font-size: 0.85rem; color: #555; text-align: left;">${key}</div>
                        </div>
                        <div class="dialogue-header-actions">
                            <button class="dialogue-header-btn save" onclick="saveDialogue('${key}')">üíæ Save</button>
                            <button class="dialogue-header-btn test" onclick="testDialogue('${key}')">üß™ Test</button>
                            <button class="dialogue-header-btn" onclick="duplicateDialogue('${key}')" style="background: #dbeafe; border-color: #3b82f6; color: #1e40af;">üìã Clone</button>
                            <button class="dialogue-header-btn delete" onclick="deleteDialogue('${key}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    
                    <!-- MESSAGES -->
                    <div class="dialogue-messages">
                        ${dialogue.messages.map((msg, idx) => renderMessage(key, msg, idx)).join('')}
                    </div>
                    <button class="add-message-btn" onclick="addMessage('${key}')">+ Add Message</button>
                </div>
            `;
            
            // After rendering, scroll into view if this is the selected dialogue
            setTimeout(() => {
                const selectedItem = document.querySelector(`.tree-item[data-key="${selectedKey}"]`);
                if (selectedItem && !selectedItem.classList.contains('active')) {
                    selectedItem.scrollIntoView({ block: 'nearest' });
                }
            }, 0);
        }
        
        // Render conditions display (site-standard style matching quests.html)
        
        // Render both dialogues and sidebar
        function renderAll() {
            renderDialogues();
            renderSidebar();
        }
        
        // Render single message
        function renderMessage(key, msg, idx) {
            console.log(`üîç [Dialogues] renderMessage ${key} msg ${idx} buttons_json:`, typeof msg.buttons_json, msg.buttons_json);
            
            // Parse buttons - handle both string and already-parsed array
            let buttons = [];
            if (msg.buttons_json) {
                if (typeof msg.buttons_json === 'string') {
                    try {
                        buttons = JSON.parse(msg.buttons_json);
                        console.log(`‚úÖ [Dialogues] Parsed ${buttons.length} buttons from string`);
                    } catch (e) {
                        console.error('Failed to parse buttons_json:', e);
                        buttons = [];
                    }
                } else if (Array.isArray(msg.buttons_json)) {
                    buttons = msg.buttons_json;
                    console.log(`‚úÖ [Dialogues] Using ${buttons.length} buttons from array`);
                }
            }
            console.log(`üîç [Dialogues] Final buttons array for msg ${idx}:`, buttons);
            
            // Parse conditions for this message
            let conditions = {};
            if (msg.conditions) {
                if (typeof msg.conditions === 'string') {
                    try {
                        conditions = JSON.parse(msg.conditions);
                    } catch (e) {
                        console.error('Failed to parse message conditions:', e);
                    }
                } else if (typeof msg.conditions === 'object') {
                    conditions = msg.conditions;
                }
            }
            
            // Build condition cards HTML
            let conditionCardsHTML = '';
            const conditionKeys = Object.keys(conditions);
            conditionKeys.forEach((condKey) => {
                const condValue = conditions[condKey];
                let displayValue = condValue;
                if (typeof condValue === 'boolean') {
                    displayValue = condValue ? 'true' : 'false';
                } else if (typeof condValue === 'string') {
                    displayValue = `"${condValue}"`;
                }
                
                conditionCardsHTML += `
                    <div class="message-condition-card" data-condition-key="${condKey}">
                        <button class="remove-condition" onclick="removeMessageCondition('${key}', ${idx}, '${condKey}')" title="Remove condition">√ó</button>
                        <div><code>${condKey}</code> = <code>${displayValue}</code></div>
                    </div>
                `;
            });
            
            // Text for display - escape HTML entities but preserve newlines
            const displayText = msg.text || '';
            const escapedText = displayText
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            
            return `
                <div class="message-card" data-sequence="${msg.sequence}">
                    <div class="message-header">
                        <div class="message-sequence">Message #${idx + 1}</div>
                        <div class="message-controls">
                            ${idx > 0 ? `<button class="message-control-btn move-up" onclick="moveMessage('${key}', ${idx}, -1)">‚Üë</button>` : ''}
                            ${idx < dialogueData[key].messages.length - 1 ? `<button class="message-control-btn move-down" onclick="moveMessage('${key}', ${idx}, 1)">‚Üì</button>` : ''}
                            <button class="message-control-btn" onclick="duplicateMessage('${key}', ${idx})" style="background: #dbeafe; color: #1e40af;" title="Clone this message">üìã</button>
                            <button class="message-control-btn" onclick="testFromMessage('${key}', ${idx})" style="background: #fef3c7; color: #92400e;" title="Test from this message">üß™</button>
                            <button class="message-control-btn delete" onclick="deleteMessage('${key}', ${idx})">‚úï</button>
                        </div>
                    </div>
                    
                    <div class="message-main-layout">
                        <div class="message-left-content">
                            <!-- PLACEHOLDER TOOLBAR -->
                            <div class="placeholder-toolbar">
                                <span class="placeholder-toolbar-label">Insert:</span>
                                <span class="placeholder-chip" onclick="insertPlaceholder(this, '{name}')" title="User's display name">{name}</span>
                                <span class="placeholder-chip" onclick="insertPlaceholder(this, '{handle}')">{handle}</span>
                                <span class="placeholder-chip" onclick="insertPlaceholder(this, '{username}')">{username}</span>
                                <span class="placeholder-chip" onclick="insertPlaceholder(this, '{origin}')">{origin}</span>
                                <span class="placeholder-chip" onclick="insertPlaceholder(this, '{zone}')">{zone}</span>
                                <span class="placeholder-chip" onclick="insertPlaceholder(this, '{octant}')">{octant}</span>
                                <span class="placeholder-chip" onclick="insertPlaceholder(this, '{residence}')">{residence}</span>
                                <span class="placeholder-chip" onclick="insertPlaceholder(this, '{status}')">{status}</span>
                                <span class="placeholder-chip" onclick="insertPlaceholder(this, '{canon_X}')" title="Any canon key">{canon_X}</span>
                                <span class="placeholder-chip" onclick="insertPlaceholder(this, '**bold**')" style="background: #dbeafe; border-color: #3b82f6; color: #1e3a8a;" title="Bold text">**bold**</span>
                                <span class="placeholder-chip" onclick="insertPlaceholder(this, '__italic__')" style="background: #fef3c7; border-color: #f59e0b; color: #92400e;" title="Italic text">__italic__</span>
                            </div>
                            
                            <div class="message-text-container">
                                <textarea class="message-text" 
                                          data-key="${key}" 
                                          data-idx="${idx}"
                                          placeholder="Enter message text here...&#10;&#10;Press Enter for line breaks.&#10;Text will appear exactly as you type it.&#10;&#10;Use **bold** and __italic__ for formatting."
                                          oninput="updateMessageText(this)">${escapedText}</textarea>
                                <div class="message-align-toggle">
                                    <button class="align-toggle-btn active" 
                                            data-key="${key}" 
                                            data-idx="${idx}"
                                            data-align="${msg.align || 'left'}"
                                            onclick="cycleMessageAlign(this)">${(msg.align || 'left') === 'left' ? 'Left Align' : (msg.align === 'center' ? 'Center Align' : 'Right Align')}</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="message-right-sidebar">
                            <div class="message-conditions-section">
                                <div class="message-conditions-title">Conditions</div>
                                <button class="message-add-condition-btn" onclick="showMessageConditionDropdown(this, '${key}', ${idx})">
                                    <span>+</span><span>Add</span>
                                </button>
                                ${conditionCardsHTML || '<div style="font-size: 0.65rem; color: #9ca3af; font-style: italic; padding: 0.5rem; text-align: center;">No conditions</div>'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- BUTTONS SECTION (full width below message and conditions) -->
                    <div class="message-buttons">
                        <div class="message-buttons-header">Buttons (${buttons.length})</div>
                        <div class="button-list">
                            ${buttons.map((btn, btnIdx) => renderButton(key, idx, btn, btnIdx)).join('')}
                        </div>
                        <button class="add-button-btn" onclick="addButton('${key}', ${idx})">+ Add Button</button>
                    </div>
                </div>
            `;
        }
        
        // Render button
        function renderButton(key, msgIdx, btn, btnIdx) {
            const actionType = btn.goto ? 'goto' : btn.newtab ? 'newtab' : btn.url ? 'url' : btn.popup ? 'popup' : btn.drawer ? 'drawer' : 'callback';
            const actionValue = btn.goto || btn.newtab || btn.url || btn.popup || btn.drawer || btn.callback || '';
            
            // Generate action input based on type
            let actionInput;
            
            if (actionType === 'goto') {
                // Build dynamic suggestions for current dialogue messages
                const currentDialogue = dialogueData[key] || { messages: [] };
                const messageCount = currentDialogue.messages ? currentDialogue.messages.length : 0;
                const messageSuggestions = [];
                
                // Add suggestions for each message in current dialogue (using dialogue:index format)
                for (let i = 0; i < messageCount; i++) {
                    const msg = currentDialogue.messages[i];
                    const preview = msg.text ? msg.text.substring(0, 40).replace(/"/g, '&quot;') : '';
                    messageSuggestions.push(`<option value="${key}:${i}">${key}:${i} - ${preview}...</option>`);
                }
                
                // Text input for goto with dynamic autocomplete
                actionInput = `
                    <input type="text" 
                           class="button-action-input" 
                           value="${actionValue}" 
                           data-key="${key}" 
                           data-msg="${msgIdx}" 
                           data-btn="${btnIdx}"
                           data-action-type="goto"
                           onblur="updateButton(this, 'goto')"
                           placeholder="${key}:0, other-dialogue:5, etc"
                           list="goto-suggestions-${key}-${msgIdx}-${btnIdx}">
                    <datalist id="goto-suggestions-${key}-${msgIdx}-${btnIdx}">
                        ${messageSuggestions.join('')}
                        <option value="" disabled>‚îÄ‚îÄ‚îÄ‚îÄ Other Dialogues ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                        ${Object.keys(dialogueData).filter(k => k !== key).sort().map(k => 
                            `<option value="${k}">${k}</option>`
                        ).join('')}
                    </datalist>
                `;
            } else if (actionType === 'popup') {
                // Dropdown of popup options
                actionInput = `
                    <select class="button-action-input" 
                            data-key="${key}" 
                            data-msg="${msgIdx}" 
                            data-btn="${btnIdx}"
                            data-action-type="popup"
                            onchange="updateButton(this, 'popup')">
                        <option value="">Select...</option>
                        <option value="directory" ${actionValue === 'directory' ? 'selected' : ''}>Directory</option>
                        <option value="sharelore" ${actionValue === 'sharelore' ? 'selected' : ''}>ShareLore</option>
                        <option value="createdreamer" ${actionValue === 'createdreamer' ? 'selected' : ''}>CreateDreamer</option>
                        <option value="spectrumcalculator" ${actionValue === 'spectrumcalculator' ? 'selected' : ''}>Spectrum Calculator</option>
                        <option value="spectrumdeluxe" ${actionValue === 'spectrumdeluxe' ? 'selected' : ''}>Spectrum Calculator (Deluxe)</option>
                        <option value="login" ${actionValue === 'login' ? 'selected' : ''}>Login</option>
                        <option value="bskyexplain" ${actionValue === 'bskyexplain' ? 'selected' : ''}>Bluesky Explanation</option>
                    </select>
                `;
            } else if (actionType === 'drawer') {
                // Dropdown of drawer options
                actionInput = `
                    <select class="button-action-input" 
                            data-key="${key}" 
                            data-msg="${msgIdx}" 
                            data-btn="${btnIdx}"
                            data-action-type="drawer"
                            onchange="updateButton(this, 'drawer')">
                        <option value="">Select...</option>
                        <option value="dreamviewer" ${actionValue === 'dreamviewer' ? 'selected' : ''}>Dreamviewer</option>
                        <option value="spectrum" ${actionValue === 'spectrum' ? 'selected' : ''}>Spectrum</option>
                        <option value="souvenirs" ${actionValue === 'souvenirs' ? 'selected' : ''}>Souvenirs</option>
                    </select>
                `;
            } else if (actionType === 'callback') {
                // Text input for callback (supports continue, end, pause, custom callbacks)
                actionInput = `
                    <input type="text" 
                           class="button-action-input" 
                           value="${actionValue}" 
                           data-key="${key}" 
                           data-msg="${msgIdx}" 
                           data-btn="${btnIdx}"
                           data-action-type="callback"
                           onblur="updateButton(this, 'callback')"
                           placeholder="continue, end, pause, etc"
                           list="callback-suggestions">
                    <datalist id="callback-suggestions">
                        <option value="continue">Continue to next message</option>
                        <option value="end">End dialogue</option>
                        <option value="pause">Pause</option>
                    </datalist>
                `;
            } else {
                // Text input for URL and NewTab
                actionInput = `
                    <input type="text" 
                           class="button-action-input" 
                           value="${actionValue}" 
                           data-key="${key}" 
                           data-msg="${msgIdx}" 
                           data-btn="${btnIdx}"
                           data-action-type="${actionType}"
                           onblur="updateButton(this, '${actionType}')"
                           placeholder="${actionType === 'url' ? '/page' : 'https://...'}">
                `;
            }
            
            return `
                <div class="button-item" draggable="true" 
                     data-key="${key}" 
                     data-msg="${msgIdx}" 
                     data-btn="${btnIdx}"
                     ondragstart="handleButtonDragStart(event)"
                     ondragover="handleButtonDragOver(event)"
                     ondrop="handleButtonDrop(event)"
                     ondragend="handleButtonDragEnd(event)">
                    <div class="button-drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</div>
                    <input type="text" 
                           class="button-text-input" 
                           value="${btn.text}" 
                           data-key="${key}" 
                           data-msg="${msgIdx}" 
                           data-btn="${btnIdx}"
                           onblur="updateButton(this, 'text')"
                           placeholder="Button text (use | for rotating text)">
                    <select class="button-rotation-speed" 
                           data-key="${key}" 
                           data-msg="${msgIdx}" 
                           data-btn="${btnIdx}"
                           onchange="updateButton(this, 'rotationSpeed')"
                           title="Title rotation speed">
                        <option value="1" ${(btn.rotationSpeed || 3) == 1 ? 'selected' : ''}>Hyper</option>
                        <option value="2" ${(btn.rotationSpeed || 3) == 2 ? 'selected' : ''}>Fast</option>
                        <option value="3" ${(btn.rotationSpeed || 3) == 3 ? 'selected' : ''}>Med</option>
                        <option value="5" ${(btn.rotationSpeed || 3) == 5 ? 'selected' : ''}>Slow</option>
                    </select>
                    <select class="button-action-type" 
                            data-key="${key}" 
                            data-msg="${msgIdx}" 
                            data-btn="${btnIdx}"
                            onchange="updateButtonActionType(this)">
                        <option value="goto" ${actionType === 'goto' ? 'selected' : ''}>GOTO</option>
                        <option value="callback" ${actionType === 'callback' ? 'selected' : ''}>Action</option>
                        <option value="url" ${actionType === 'url' ? 'selected' : ''}>Link</option>
                        <option value="newtab" ${actionType === 'newtab' ? 'selected' : ''}>NewTab</option>
                        <option value="popup" ${actionType === 'popup' ? 'selected' : ''}>Popup</option>
                        <option value="drawer" ${actionType === 'drawer' ? 'selected' : ''}>Drawer</option>
                    </select>
                    ${actionInput}
                    ${(actionType === 'goto' && btn.goto && dialogueData[btn.goto]) || (actionType === 'callback' && btn.callback && dialogueData[btn.callback]) ? `
                        <button class="button-goto-btn" onclick="scrollToDialogue('${btn.goto || btn.callback}')" title="Jump to ${btn.goto || btn.callback}">
                            ‚è©
                        </button>
                    ` : ''}
                    <label class="button-secondary-toggle">
                        <input type="checkbox" 
                               ${btn.secondary ? 'checked' : ''} 
                               data-key="${key}" 
                               data-msg="${msgIdx}" 
                               data-btn="${btnIdx}"
                               onchange="updateButton(this, 'secondary')">
                        Dissuade
                    </label>
                    <button class="button-delete-btn" onclick="deleteButton('${key}', ${msgIdx}, ${btnIdx})">‚úï</button>
                </div>
            `;
        }
        
        // Render sidebar tree
        // Load priorities from dialogue_conditions - DEPRECATED (tag-based system)
        async function loadDialoguePriorities() {
            // No-op
            return;
        }
        
        function renderSidebar() {
            const tree = document.getElementById('dialogue-tree');
            let keys = Object.keys(dialogueData);
            
            // Sort by display_order if available
            keys.sort((a, b) => {
                const orderA = dialogueData[a].display_order || 0;
                const orderB = dialogueData[b].display_order || 0;
                return orderA - orderB;
            });
            
            if (keys.length === 0) {
                tree.innerHTML = `<li style="padding: 1rem; text-align: center; color: var(--text-dim); font-size: 0.875rem;">No dialogues</li>`;
                return;
            }
            
            // Group dialogues by prefix (before the first ':')
            const groups = {};
            const ungrouped = [];
            
            keys.forEach(key => {
                const colonIndex = key.indexOf(':');
                if (colonIndex > 0) {
                    const prefix = key.substring(0, colonIndex);
                    if (!groups[prefix]) {
                        groups[prefix] = [];
                    }
                    groups[prefix].push(key);
                } else {
                    ungrouped.push(key);
                }
            });
            
            let html = '';
            
            // Render groups
            const sortedPrefixes = Object.keys(groups).sort();
            sortedPrefixes.forEach(prefix => {
                const groupKeys = groups[prefix];
                html += `
                    <div class="tree-group">
                        <div class="tree-group-label" onclick="toggleTreeGroup(this)">
                            <span class="tree-group-icon">‚ñº</span>
                            <span>${prefix}</span>
                            <span class="tree-group-count">${groupKeys.length}</span>
                        </div>
                        <ul class="tree-items">
                `;
                
                groupKeys.forEach((key, index) => {
                    const dialogue = dialogueData[key];
                    const msgCount = dialogue.messages.length;
                    const title = dialogue.title || '';
                    const keyWithoutPrefix = key.substring(prefix.length + 1); // Remove "prefix:"
                    
                    html += `
                        <li class="tree-item ${selectedKey === key ? 'active' : ''}" 
                            data-key="${key}" 
                            data-index="${index}">
                            <div class="dialogue-drag-handle" draggable="true"></div>
                            <div class="tree-item-content" onclick="scrollToDialogue('${key}')">
                                <code class="tree-item-key">${keyWithoutPrefix}</code>
                                ${title ? `<span class="tree-item-title">${title}</span>` : ''}
                            </div>
                            <span class="tree-item-count">${msgCount}</span>
                        </li>
                    `;
                });
                
                html += `
                        </ul>
                    </div>
                `;
            });
            
            // Render ungrouped items
            if (ungrouped.length > 0) {
                html += `
                    <div class="tree-group">
                        <div class="tree-group-label" onclick="toggleTreeGroup(this)">
                            <span class="tree-group-icon">‚ñº</span>
                            <span>Other</span>
                            <span class="tree-group-count">${ungrouped.length}</span>
                        </div>
                        <ul class="tree-items">
                `;
                
                ungrouped.forEach((key, index) => {
                    const dialogue = dialogueData[key];
                    const msgCount = dialogue.messages.length;
                    const title = dialogue.title || '';
                    
                    html += `
                        <li class="tree-item ${selectedKey === key ? 'active' : ''}" 
                            data-key="${key}" 
                            data-index="${index}">
                            <div class="dialogue-drag-handle" draggable="true"></div>
                            <div class="tree-item-content" onclick="scrollToDialogue('${key}')">
                                <code class="tree-item-key">${key}</code>
                                ${title ? `<span class="tree-item-title">${title}</span>` : ''}
                            </div>
                            <span class="tree-item-count">${msgCount}</span>
                        </li>
                    `;
                });
                
                html += `
                        </ul>
                    </div>
                `;
            }
            
            tree.innerHTML = html;
            
            // Setup drag and drop
            setupDialogueDragAndDrop();
        }
        
        // Toggle tree group
        function toggleTreeGroup(el) {
            const group = el.closest('.tree-group');
            group.classList.toggle('collapsed');
        }
        
        // Toggle tree subgroup
        function toggleTreeSubgroup(el) {
            const subgroup = el.closest('.tree-subgroup');
            subgroup.classList.toggle('collapsed');
        }
        
        // Scroll to dialogue
        function scrollToDialogue(key) {
            // Set selected key and re-render
            selectedKey = key;
            
            // Save selected dialogue to localStorage for persistence
            localStorage.setItem('dialogues_selected_key', key);
            
            renderDialogues();
            
            // Remove active state from all items
            document.querySelectorAll('.tree-item').forEach(item => item.classList.remove('active'));
            
            // Add active state to clicked item
            const treeItem = document.querySelector(`.tree-item[data-key="${key}"]`);
            if (treeItem) {
                treeItem.classList.add('active');
            }
        }
        
        // Update message text
        function updateMessageText(el) {
            const key = el.dataset.key;
            const idx = parseInt(el.dataset.idx);
            // Use .value for textarea - it naturally preserves all whitespace and line breaks
            dialogueData[key].messages[idx].text = el.value;
        }
        
        // Cycle through message text alignment options
        function cycleMessageAlign(btn) {
            const key = btn.dataset.key;
            const idx = parseInt(btn.dataset.idx);
            const currentAlign = btn.dataset.align || 'left';
            
            // Cycle: left -> center -> right -> left
            const alignments = ['left', 'center', 'right'];
            const currentIndex = alignments.indexOf(currentAlign);
            const nextIndex = (currentIndex + 1) % alignments.length;
            const nextAlign = alignments[nextIndex];
            
            // Update data
            dialogueData[key].messages[idx].align = nextAlign;
            btn.dataset.align = nextAlign;
            
            // Update button text
            const labels = {
                'left': 'Left Align',
                'center': 'Center Align',
                'right': 'Right Align'
            };
            btn.textContent = labels[nextAlign];
            
            // Show saved indicator
            showSavedIndicator(btn);
            
            // Auto-save the dialogue
            saveDialogue(key);
        }
        
        // Update button
        function updateButton(el, field) {
            const key = el.dataset.key;
            const msgIdx = parseInt(el.dataset.msg);
            const btnIdx = parseInt(el.dataset.btn);
            
            // Parse buttons from JSON string (or use existing array)
            let buttonsJson = dialogueData[key].messages[msgIdx].buttons_json;
            let buttons = [];
            if (buttonsJson) {
                if (typeof buttonsJson === 'string') {
                    buttons = JSON.parse(buttonsJson);
                } else if (Array.isArray(buttonsJson)) {
                    buttons = buttonsJson;
                }
            }
            
            if (field === 'text') {
                buttons[btnIdx].text = el.value;
            } else if (field === 'rotationSpeed') {
                const speed = parseInt(el.value) || 3;
                buttons[btnIdx].rotationSpeed = Math.max(1, Math.min(9, speed)); // Clamp between 1-9
            } else if (field === 'goto' || field === 'callback' || field === 'url' || field === 'newtab' || field === 'popup' || field === 'drawer') {
                // Clear all action types first
                delete buttons[btnIdx].goto;
                delete buttons[btnIdx].callback;
                delete buttons[btnIdx].url;
                delete buttons[btnIdx].newtab;
                delete buttons[btnIdx].popup;
                delete buttons[btnIdx].drawer;
                // Set the current action type
                if (el.value) {
                    buttons[btnIdx][field] = el.value;
                }
            } else if (field === 'secondary') {
                buttons[btnIdx].secondary = el.checked;
            }
            
            dialogueData[key].messages[msgIdx].buttons_json = JSON.stringify(buttons);
        }
        
        // Update button action type (when dropdown changes)
        function updateButtonActionType(el) {
            const key = el.dataset.key;
            const msgIdx = parseInt(el.dataset.msg);
            const btnIdx = parseInt(el.dataset.btn);
            const newType = el.value;
            
            // Parse buttons from JSON string (or use existing array)
            let buttonsJson = dialogueData[key].messages[msgIdx].buttons_json;
            let buttons = [];
            if (buttonsJson) {
                if (typeof buttonsJson === 'string') {
                    buttons = JSON.parse(buttonsJson);
                } else if (Array.isArray(buttonsJson)) {
                    buttons = buttonsJson;
                }
            }
            
            const btn = buttons[btnIdx];
            
            // Get current value from any existing action type
            const currentValue = btn.goto || btn.callback || btn.url || btn.newtab || btn.popup || btn.drawer || '';
            
            // Clear all action types
            delete btn.goto;
            delete btn.callback;
            delete btn.url;
            delete btn.newtab;
            delete btn.popup;
            delete btn.drawer;
            
            // Set new action type with preserved value
            if (currentValue) {
                btn[newType] = currentValue;
            }
            
            dialogueData[key].messages[msgIdx].buttons_json = JSON.stringify(buttons);
            
            // Re-render to update the input field
            renderDialogues();
        }
        
        // Add button
        function addButton(key, msgIdx) {
            // Parse buttons from JSON string (or use existing array)
            let buttonsJson = dialogueData[key].messages[msgIdx].buttons_json;
            let buttons = [];
            if (buttonsJson) {
                if (typeof buttonsJson === 'string') {
                    buttons = JSON.parse(buttonsJson);
                } else if (Array.isArray(buttonsJson)) {
                    buttons = buttonsJson;
                }
            }
            
            buttons.push({ text: 'NEW BUTTON', callback: 'end', secondary: false });
            dialogueData[key].messages[msgIdx].buttons_json = JSON.stringify(buttons);
            renderDialogues();
        }
        
        // Delete button
        async function deleteButton(key, msgIdx, btnIdx) {
            // Parse buttons from JSON string (or use existing array)
            let buttonsJson = dialogueData[key].messages[msgIdx].buttons_json;
            let buttons = [];
            if (buttonsJson) {
                if (typeof buttonsJson === 'string') {
                    buttons = JSON.parse(buttonsJson);
                } else if (Array.isArray(buttonsJson)) {
                    buttons = buttonsJson;
                }
            }
            
            buttons.splice(btnIdx, 1);
            dialogueData[key].messages[msgIdx].buttons_json = JSON.stringify(buttons);
            renderDialogues();
        }
        
        // Add message
        function addMessage(key) {
            const newSequence = dialogueData[key].messages.length;
            dialogueData[key].messages.push({
                key: key,
                sequence: newSequence,
                speaker: 'errantson',
                avatar: '/souvenirs/dream/strange/icon.png',
                text: 'New message text',
                buttons_json: null
            });
            renderDialogues();
        }
        
        // Insert placeholder into message text
        function insertPlaceholder(chip, placeholder) {
            // Find the message card and textarea
            const card = chip.closest('.message-card');
            const textarea = card.querySelector('.message-text');
            
            if (!textarea) return;
            
            // Focus the textarea
            textarea.focus();
            
            // Get current cursor position
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            // Insert placeholder at cursor position (or replace selection)
            textarea.value = text.substring(0, start) + placeholder + text.substring(end);
            
            // Move cursor after the inserted placeholder
            const newPosition = start + placeholder.length;
            textarea.selectionStart = newPosition;
            textarea.selectionEnd = newPosition;
            
            // Trigger update
            updateMessageText(textarea);
            
            // Visual feedback on the chip
            const originalBg = chip.style.background;
            const originalColor = chip.style.color;
            chip.style.background = '#734ba1';
            chip.style.color = 'white';
            chip.style.transform = 'scale(0.95)';
            
            setTimeout(() => {
                chip.style.background = originalBg;
                chip.style.color = originalColor;
                chip.style.transform = '';
            }, 150);
        }
        
        // Show condition dropdown menu
        function showConditionDropdown(button, dialogueKey, pigeonId = null, messageIdx = null) {
            // Remove any existing dropdowns
            document.querySelectorAll('.add-item-dropdown').forEach(d => d.remove());
            document.querySelectorAll('.add-item-dropdown-overlay').forEach(d => d.remove());
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'add-item-dropdown-overlay';
            
            const dropdown = document.createElement('div');
            dropdown.className = 'add-item-dropdown';
            dropdown.style.maxHeight = '80vh';
            dropdown.style.maxWidth = '700px';
            dropdown.style.width = '90%';
            dropdown.style.overflowY = 'auto';
            
            // Create header
            const header = document.createElement('div');
            header.style.cssText = 'font-size: 0.85rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary); border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem;';
            header.textContent = 'Add Condition';
            dropdown.appendChild(header);
            
            // Grid container for conditions - very compact
            const gridContainer = document.createElement('div');
            gridContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.4rem;';
            
            // DELIVERY CONDITIONS - Only functional conditions supported by aviary.py
            const conditions = [
                // User Authentication
                { key: 'authenticated', type: 'boolean', label: 'Authenticated', desc: 'User is logged in' },
                
                // User Roles
                { key: 'is_greeter', type: 'boolean', label: 'Is Greeter', desc: 'User has active Greeter role' },
                { key: 'is_mapper', type: 'boolean', label: 'Is Mapper', desc: 'User has active Mapper role' },
                { key: 'is_patron', type: 'boolean', label: 'Is Patron', desc: 'User has made contributions' },
                { key: 'is_dreamer', type: 'boolean', label: 'Is Dreamer', desc: 'User is registered' },
                { key: 'is_keeper', type: 'boolean', label: 'Is Keeper', desc: 'User is world admin' },
                
                // User Content
                { key: 'has_canon', type: 'boolean', label: 'Has Canon', desc: 'User has canon contributions' },
                { key: 'has_lore', type: 'boolean', label: 'Has Lore', desc: 'User has lore contributions' },
                { key: 'has_spectrum', type: 'boolean', label: 'Has Spectrum', desc: 'User has calculated spectrum' },
                { key: 'has_avatar', type: 'boolean', label: 'Has Avatar', desc: 'User has custom avatar' },
                
                // User Activity
                { key: 'has_messages', type: 'boolean', label: 'Has Messages', desc: 'User has unread messages' },
                { key: 'message_count', type: 'number', label: 'Message Count', desc: 'Specific message count', placeholder: '5' },
                
                // System Stats
                { key: 'has_newcomers', type: 'boolean', label: 'Has Newcomers', desc: 'New dreamers joined today' },
                { key: 'newcomer_count', type: 'number', label: 'Newcomer Count', desc: 'Specific newcomer count', placeholder: '10' },
                
                // Time-Based
                { key: 'is_morning', type: 'boolean', label: 'Is Morning', desc: '5am-12pm' },
                { key: 'is_afternoon', type: 'boolean', label: 'Is Afternoon', desc: '12pm-5pm' },
                { key: 'is_evening', type: 'boolean', label: 'Is Evening', desc: '5pm-10pm' },
                { key: 'is_night', type: 'boolean', label: 'Is Night', desc: '10pm-5am' },
                
                // Legacy Canon Conditions (for backwards compatibility)
                { key: 'canon_key', type: 'text', label: 'Has Canon Key', desc: 'User has this canon key set', placeholder: 'arrival' },
                { key: 'canon_equals', type: 'text', label: 'Canon Equals Value', desc: 'Canon key=value (e.g., zone=1)', placeholder: 'zone=1' },
                
                // Page Context
                { key: 'page', type: 'select', label: 'Page Context', desc: 'Current page user is on', options: ['work', 'home', 'library', 'spectrum', 'souvenirs', 'dreamer', 'order'] },
                
                // Legacy Role Condition
                { key: 'has_role', type: 'select', label: 'Has Role', desc: 'User has this role', options: ['greeter', 'resident', 'mapper'] }
            ];
            
            // Render each condition as a card - COMPACT SINGLE ROW
            conditions.forEach(cond => {
                const card = document.createElement('div');
                card.style.cssText = 'background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 3px; padding: 0.4rem 0.5rem; display: flex; align-items: center; gap: 0.5rem; min-height: 32px;';
                
                // Label (compact, no description)
                const label = document.createElement('div');
                label.style.cssText = 'font-weight: 500; font-size: 0.7rem; color: #374151; flex-shrink: 0; min-width: 80px;';
                label.textContent = cond.label;
                label.title = cond.desc; // Tooltip for description
                
                // Controls container - flex-grow to fill space
                const controlsDiv = document.createElement('div');
                controlsDiv.style.cssText = 'display: flex; gap: 0.3rem; flex: 1; align-items: center;';
                
                if (cond.type === 'boolean') {
                    // Compact true/false buttons
                    [{ label: 'T', value: true }, { label: 'F', value: false }].forEach(opt => {
                        const btn = document.createElement('button');
                        btn.textContent = opt.label;
                        btn.title = opt.label === 'T' ? 'True' : 'False';
                        btn.style.cssText = 'flex: 1; padding: 0.25rem 0.4rem; background: white; border: 1px solid #d1d5db; border-radius: 3px; cursor: pointer; font-size: 0.7rem; font-weight: 600;';
                        btn.onmouseover = () => btn.style.background = '#f3f4f6';
                        btn.onmouseout = () => btn.style.background = 'white';
                        btn.onclick = () => {
                            if (messageIdx !== null && messageIdx !== undefined) {
                                addMessageCondition(dialogueKey, messageIdx, cond.key, opt.value);
                            } else if (pigeonId) {
                                addPigeonCondition(pigeonId, cond.key, opt.value);
                            } else {
                                addCondition(dialogueKey, cond.key, opt.value);
                            }
                            dropdown.remove();
                            overlay.remove();
                        };
                        controlsDiv.appendChild(btn);
                    });
                    
                } else if (cond.type === 'select') {
                    // Compact dropdown
                    const select = document.createElement('select');
                    select.style.cssText = 'flex: 1; padding: 0.25rem 0.4rem; border: 1px solid #d1d5db; border-radius: 3px; font-size: 0.7rem; font-family: "SF Mono", monospace;';
                    
                    const customOpt = document.createElement('option');
                    customOpt.value = '__custom__';
                    customOpt.textContent = '(custom value)';
                    select.appendChild(customOpt);
                    
                    cond.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        select.appendChild(option);
                    });
                    
                    const addBtn = document.createElement('button');
                    addBtn.textContent = '+';
                    addBtn.style.cssText = 'padding: 0.25rem 0.5rem; background: #3b82f6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.7rem; font-weight: 600; flex-shrink: 0;';
                    addBtn.onclick = async () => {
                        let value = select.value;
                        if (value === '__custom__') {
                            value = await showPrompt(`Enter custom ${cond.label}:`);
                            if (!value) return;
                        }
                        if (messageIdx !== null && messageIdx !== undefined) {
                            addMessageCondition(dialogueKey, messageIdx, cond.key, value);
                        } else if (pigeonId) {
                            addPigeonCondition(pigeonId, cond.key, value);
                        } else {
                            addCondition(dialogueKey, cond.key, value);
                        }
                        dropdown.remove();
                        overlay.remove();
                    };
                    
                    controlsDiv.appendChild(select);
                    controlsDiv.appendChild(addBtn);
                    
                } else if (cond.type === 'text') {
                    // Compact text input
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = cond.placeholder || '';
                    input.style.cssText = 'flex: 1; padding: 0.25rem 0.4rem; border: 1px solid #d1d5db; border-radius: 3px; font-size: 0.7rem; font-family: "SF Mono", monospace;';
                    
                    const addBtn = document.createElement('button');
                    addBtn.textContent = '+';
                    addBtn.style.cssText = 'padding: 0.25rem 0.5rem; background: #3b82f6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.7rem; font-weight: 600; flex-shrink: 0;';
                    
                    const addValue = () => {
                        const value = input.value.trim();
                        if (value) {
                            if (messageIdx !== null && messageIdx !== undefined) {
                                addMessageCondition(dialogueKey, messageIdx, cond.key, value);
                            } else if (pigeonId) {
                                addPigeonCondition(pigeonId, cond.key, value);
                            } else {
                                addCondition(dialogueKey, cond.key, value);
                            }
                            dropdown.remove();
                            overlay.remove();
                        }
                    };
                    
                    addBtn.onclick = addValue;
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') addValue();
                    });
                    
                    controlsDiv.appendChild(input);
                    controlsDiv.appendChild(addBtn);
                    
                } else if (cond.type === 'number') {
                    // Compact number input
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.placeholder = cond.placeholder || '0';
                    input.style.cssText = 'flex: 1; padding: 0.25rem 0.4rem; border: 1px solid #d1d5db; border-radius: 3px; font-size: 0.7rem; font-family: "SF Mono", monospace;';
                    
                    const addBtn = document.createElement('button');
                    addBtn.textContent = '+';
                    addBtn.style.cssText = 'padding: 0.25rem 0.5rem; background: #3b82f6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.7rem; font-weight: 600; flex-shrink: 0;';
                    
                    const addValue = () => {
                        const value = parseInt(input.value);
                        if (!isNaN(value)) {
                            if (messageIdx !== null && messageIdx !== undefined) {
                                addMessageCondition(dialogueKey, messageIdx, cond.key, value);
                            } else if (pigeonId) {
                                addPigeonCondition(pigeonId, cond.key, value);
                            } else {
                                addCondition(dialogueKey, cond.key, value);
                            }
                            dropdown.remove();
                            overlay.remove();
                        }
                    };
                    
                    addBtn.onclick = addValue;
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') addValue();
                    });
                    
                    controlsDiv.appendChild(input);
                    controlsDiv.appendChild(addBtn);
                    
                } else if (cond.type === 'fixed') {
                    // Compact fixed value button
                    const btn = document.createElement('button');
                    btn.textContent = `+ ${cond.label}`;
                    btn.style.cssText = 'flex: 1; padding: 0.25rem 0.4rem; background: #3b82f6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.7rem; font-weight: 600;';
                    btn.onmouseover = () => btn.style.background = '#2563eb';
                    btn.onmouseout = () => btn.style.background = '#3b82f6';
                    btn.onclick = () => {
                        if (messageIdx !== null && messageIdx !== undefined) {
                            addMessageCondition(dialogueKey, messageIdx, cond.key, cond.value);
                        } else if (pigeonId) {
                            addPigeonCondition(pigeonId, cond.key, cond.value);
                        } else {
                            addCondition(dialogueKey, cond.key, cond.value);
                        }
                        dropdown.remove();
                        overlay.remove();
                    };
                    controlsDiv.appendChild(btn);
                }
                
                card.appendChild(label);
                card.appendChild(controlsDiv);
                gridContainer.appendChild(card);
            });
            
            dropdown.appendChild(gridContainer);
            document.body.appendChild(overlay);
            document.body.appendChild(dropdown);
            
            // Close on overlay click
            overlay.onclick = () => {
                dropdown.remove();
                overlay.remove();
            };
        }


        
        // Add condition to dialogue
        async function addCondition(key, condKey, condValue) {
            // Get current conditions
            let conditions = {};
            if (dialogueData[key].conditions) {
                try {
                    conditions = typeof dialogueData[key].conditions === 'string' 
                        ? JSON.parse(dialogueData[key].conditions) 
                        : dialogueData[key].conditions;
                } catch (e) {
                    console.error('Failed to parse conditions:', e);
                }
            }
            
            // Add new condition (condValue is already the correct type)
            conditions[condKey] = condValue;
            
            // Save
            try {
                const response = await authenticatedFetch('/api/dialogues/update_metadata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        key: key,
                        conditions: JSON.stringify(conditions)
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Save failed');
                }
                
                // Update local data
                dialogueData[key].conditions = conditions;
                
                await showAlert('Condition added!', 'success');
                renderDialogues();
            } catch (error) {
                console.error('‚ùå Save error:', error);
                await showAlert('Save failed: ' + error.message, 'error');
            }
        }
        
        // Remove condition from dialogue
        async function removeCondition(key, condKey) {
            // Get current conditions
            let conditions = {};
            if (dialogueData[key].conditions) {
                try {
                    conditions = typeof dialogueData[key].conditions === 'string' 
                        ? JSON.parse(dialogueData[key].conditions) 
                        : dialogueData[key].conditions;
                } catch (e) {
                    console.error('Failed to parse conditions:', e);
                }
            }
            
            // Remove condition
            delete conditions[condKey];
            
            // Save
            try {
                const response = await authenticatedFetch('/api/dialogues/update_metadata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        key: key,
                        conditions: Object.keys(conditions).length > 0 ? JSON.stringify(conditions) : null
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Save failed');
                }
                
                // Update local data
                dialogueData[key].conditions = conditions;
                
                await showAlert('Condition removed!', 'success');
                renderDialogues();
            } catch (error) {
                console.error('‚ùå Save error:', error);
                await showAlert('Save failed: ' + error.message, 'error');
            }
        }
        
        // ============================================================================
        // MESSAGE-LEVEL CONDITIONS
        // ============================================================================
        
        function showMessageConditionDropdown(button, dialogueKey, messageIdx) {
            // Reuse the same dropdown but modify behavior for message-level
            showConditionDropdown(button, dialogueKey, null, messageIdx);
        }
        
        async function addMessageCondition(key, msgIdx, condKey, condValue) {
            // Get current message
            const msg = dialogueData[key].messages[msgIdx];
            
            // Get current conditions
            let conditions = {};
            if (msg.conditions) {
                try {
                    conditions = typeof msg.conditions === 'string' 
                        ? JSON.parse(msg.conditions) 
                        : msg.conditions;
                } catch (e) {
                    console.error('Failed to parse message conditions:', e);
                }
            }
            
            // Add new condition
            conditions[condKey] = condValue;
            
            // Update local data
            msg.conditions = conditions;
            
            await showAlert('Message condition added!', 'success');
            renderDialogues();
        }
        
        async function removeMessageCondition(key, msgIdx, condKey) {
            // Get current message
            const msg = dialogueData[key].messages[msgIdx];
            
            // Get current conditions
            let conditions = {};
            if (msg.conditions) {
                try {
                    conditions = typeof msg.conditions === 'string' 
                        ? JSON.parse(msg.conditions) 
                        : msg.conditions;
                } catch (e) {
                    console.error('Failed to parse message conditions:', e);
                }
            }
            
            // Remove condition
            delete conditions[condKey];
            
            // Update local data
            msg.conditions = Object.keys(conditions).length > 0 ? conditions : null;
            
            await showAlert('Message condition removed!', 'success');
            renderDialogues();
        }
        
        // Delete message
        async function deleteMessage(key, idx) {
            if (!await showConfirm('Delete this message?')) return;
            
            dialogueData[key].messages.splice(idx, 1);
            // Re-sequence
            dialogueData[key].messages.forEach((msg, i) => {
                msg.sequence = i;
            });
            renderDialogues();
        }
        
        // Duplicate message
        function duplicateMessage(key, idx) {
            console.log('üìã [MESSAGES] Duplicating message:', key, idx);
            
            const original = dialogueData[key].messages[idx];
            
            // Deep copy the message
            const duplicate = {
                ...original,
                sequence: idx + 1, // Insert after current message
                text: original.text, // Copy text as-is
                buttons_json: original.buttons_json ? JSON.parse(JSON.stringify(
                    typeof original.buttons_json === 'string' 
                        ? JSON.parse(original.buttons_json) 
                        : original.buttons_json
                )) : null,
                conditions: original.conditions ? JSON.parse(JSON.stringify(original.conditions)) : null
            };
            
            // Insert after the current message
            dialogueData[key].messages.splice(idx + 1, 0, duplicate);
            
            // Re-sequence all messages
            dialogueData[key].messages.forEach((msg, i) => {
                msg.sequence = i;
            });
            
            console.log('‚úÖ [MESSAGES] Message cloned');
            showAlert('Message cloned!', 'success');
            renderDialogues();
        }
        
        // Move message
        function moveMessage(key, idx, direction) {
            const messages = dialogueData[key].messages;
            const newIdx = idx + direction;
            
            if (newIdx < 0 || newIdx >= messages.length) return;
            
            [messages[idx], messages[newIdx]] = [messages[newIdx], messages[idx]];
            
            // Re-sequence
            messages.forEach((msg, i) => {
                msg.sequence = i;
            });
            
            renderAll();
        }
        
        // Update dialogue key
        async function updateDialogueKey(el) {
            const oldKey = el.dataset.originalKey;
            const newKey = el.textContent.trim();
            
            if (newKey === oldKey) return;
            if (!newKey) {
                el.textContent = oldKey;
                return;
            }
            
            if (dialogueData[newKey]) {
                await showAlert('A dialogue with that key already exists!', 'error');
                el.textContent = oldKey;
                return;
            }
            
            // Update all messages
            dialogueData[oldKey].messages.forEach(msg => {
                msg.key = newKey;
            });
            
            // Move in data structure
            dialogueData[newKey] = dialogueData[oldKey];
            dialogueData[newKey].key = newKey;
            delete dialogueData[oldKey];
            
            renderAll();
        }
        
        // Update dialogue title
        function updateDialogueTitle(el) {
            const key = el.dataset.key;
            const newTitle = el.value.trim();
            
            if (dialogueData[key]) {
                dialogueData[key].title = newTitle;
                // Update sidebar to show new title
                renderSidebar();
            }
        }
        
        // Save dialogue
        // Save dialogue conditions
        async function saveDialogueConditions(textarea) {
            const key = textarea.dataset.key;
            const rawText = textarea.value.trim();
            
            console.log('üíæ [Dialogues] Saving conditions for:', key);
            console.log('üìù [Dialogues] Raw input:', rawText);
            
            // Parse and validate JSON
            let conditions = null;
            if (rawText) {
                try {
                    conditions = JSON.parse(rawText);
                    console.log('‚úÖ [Dialogues] Parsed conditions:', conditions);
                } catch (e) {
                    console.error('‚ùå [Dialogues] Invalid JSON:', e);
                    await showAlert('Invalid JSON format. Please check syntax.', 'error');
                    return;
                }
            }
            
            try {
                const response = await authenticatedFetch('/api/dialogues/update_metadata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        key: key,
                        conditions: conditions ? JSON.stringify(conditions) : null
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Save failed');
                }
                
                // Update local data
                if (dialogueData[key]) {
                    dialogueData[key].conditions = conditions;
                }
                
                console.log('‚úÖ [Dialogues] Conditions saved');
                await showAlert('Conditions saved!', 'success');
            } catch (error) {
                console.error('‚ùå [Dialogues] Save error:', error);
                await showAlert('Save failed: ' + error.message, 'error');
            }
        }
        
        // Save dialogue rotating text
        async function saveDialogueRotatingText(textarea) {
            const key = textarea.dataset.key;
            const rawText = textarea.value.trim();
            
            console.log('üíæ [Dialogues] Saving rotating_text for:', key);
            console.log('üìù [Dialogues] Raw input:', rawText);
            
            // Parse and validate JSON array
            let rotatingText = null;
            if (rawText) {
                try {
                    rotatingText = JSON.parse(rawText);
                    if (!Array.isArray(rotatingText)) {
                        throw new Error('Must be an array');
                    }
                    console.log('‚úÖ [Dialogues] Parsed rotating_text:', rotatingText);
                } catch (e) {
                    console.error('‚ùå [Dialogues] Invalid JSON array:', e);
                    await showAlert('Invalid JSON array format. Use ["text1", "text2", ...]', 'error');
                    return;
                }
            }
            
            try {
                const response = await authenticatedFetch('/api/dialogues/update_metadata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        key: key,
                        rotating_text: rotatingText ? JSON.stringify(rotatingText) : null
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Save failed');
                }
                
                // Update local data
                if (dialogueData[key]) {
                    dialogueData[key].rotating_text = rotatingText;
                }
                
                console.log('‚úÖ [Dialogues] Rotating text saved');
                await showAlert('Rotating text saved!', 'success');
            } catch (error) {
                console.error('‚ùå [Dialogues] Save error:', error);
                await showAlert('Save failed: ' + error.message, 'error');
            }
        }
        
        async function saveDialogue(key) {
            console.log('üíæ [Dialogues] Saving dialogue:', key);
            console.log('üíæ [Dialogues] Message count:', dialogueData[key].messages.length);
            console.log('üíæ [Dialogues] FULL dialogueData[key]:', JSON.parse(JSON.stringify(dialogueData[key])));
            
            try {
                const payload = {
                    key: key,
                    title: dialogueData[key].title || null,
                    messages: dialogueData[key].messages.map((msg, idx) => {
                        // Debug: Log the text content with escaped newlines visible
                        console.log(`üìù [Dialogues] Message ${idx} text:`, JSON.stringify(msg.text));
                        console.log(`üìù [Dialogues] Message ${idx} text length:`, msg.text.length);
                        console.log(`üìù [Dialogues] Message ${idx} has newlines:`, msg.text.includes('\n'));
                        
                        // Ensure buttons_json is a string (or null)
                        let buttonsJson = msg.buttons_json;
                        console.log(`üîç [Dialogues] Message ${idx} buttons_json BEFORE stringify:`, typeof buttonsJson, buttonsJson);
                        if (buttonsJson && typeof buttonsJson !== 'string') {
                            buttonsJson = JSON.stringify(buttonsJson);
                        }
                        console.log(`üîç [Dialogues] Message ${idx} buttons_json AFTER stringify:`, typeof buttonsJson, buttonsJson);
                        
                        return {
                            sequence: msg.sequence,
                            speaker: msg.speaker,
                            avatar: msg.avatar,
                            text: msg.text,
                            align: msg.align || 'left',
                            buttons_json: buttonsJson
                        };
                    })
                };
                
                console.log('üì° [Dialogues] Payload:', payload);
                
                const response = await authenticatedFetch('/api/dialogues/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('üì° [Dialogues] Save response:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå [Dialogues] Save failed:', errorText);
                    throw new Error('Save failed');
                }
                
                const result = await response.json();
                console.log('‚úÖ [Dialogues] Save result:', result);
                
                await showAlert('Saved successfully!', 'success');
                await loadDialogues(); // Reload to get IDs
            } catch (error) {
                console.error('‚ùå [Dialogues] Save error:', error);
                await showAlert('Save failed: ' + error.message, 'error');
            }
        }
        
        // Save all dialogues
        async function saveAllDialogues() {
            console.log('üíæ [Dialogues] Saving all dialogues...');
            
            const keys = Object.keys(dialogueData);
            if (keys.length === 0) {
                await showAlert('No dialogues to save', 'info');
                return;
            }
            
            if (!await showConfirm(`Save all ${keys.length} dialogue(s)?`)) return;
            
            let successCount = 0;
            let failCount = 0;
            
            for (const key of keys) {
                try {
                    const payload = {
                        key: key,
                        title: dialogueData[key].title || null,
                        messages: dialogueData[key].messages.map((msg) => {
                            let buttonsJson = msg.buttons_json;
                            if (buttonsJson && typeof buttonsJson !== 'string') {
                                buttonsJson = JSON.stringify(buttonsJson);
                            }
                            
                            return {
                                sequence: msg.sequence,
                                speaker: msg.speaker,
                                avatar: msg.avatar,
                                text: msg.text,
                                align: msg.align || 'left',
                                buttons_json: buttonsJson
                            };
                        })
                    };
                    
                    const response = await authenticatedFetch('/api/dialogues/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        console.error(`‚ùå [Dialogues] Save failed for ${key}`);
                        failCount++;
                    } else {
                        console.log(`‚úÖ [Dialogues] Saved ${key}`);
                        successCount++;
                    }
                } catch (error) {
                    console.error(`‚ùå [Dialogues] Save error for ${key}:`, error);
                    failCount++;
                }
            }
            
            if (failCount === 0) {
                await showAlert(`All ${successCount} dialogue(s) saved successfully!`, 'success');
            } else {
                await showAlert(`Saved ${successCount}, failed ${failCount}`, failCount > successCount ? 'error' : 'warning');
            }
            
            await loadDialogues(); // Reload all
        }
        
        // Delete dialogue
        async function deleteDialogue(key) {
            if (!await showConfirm(`Delete entire dialogue sequence "${key}"?`)) return;
            
            console.log('üóëÔ∏è [Dialogues] Deleting dialogue:', key);
            
            try {
                const response = await authenticatedFetch(`/api/dialogues/delete/${encodeURIComponent(key)}`, {
                    method: 'DELETE'
                });
                
                console.log('üì° [Dialogues] Delete response:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå [Dialogues] Delete failed:', errorText);
                    throw new Error('Delete failed');
                }
                
                const result = await response.json();
                console.log('‚úÖ [Dialogues] Delete result:', result);
                
                delete dialogueData[key];
                renderAll();
                updateStats();
                await showAlert('Deleted successfully!', 'success');
            } catch (error) {
                console.error('‚ùå [Dialogues] Delete error:', error);
                await showAlert('Delete failed: ' + error.message, 'error');
            }
        }
        
        // Duplicate dialogue
        async function duplicateDialogue(key) {
            console.log('üìã [Dialogues] Duplicating dialogue:', key);
            
            // Prompt for new key
            const newKey = await showPrompt(`Enter new key for clone of "${key}":`, key + '_copy');
            
            if (!newKey) {
                console.log('‚ÑπÔ∏è [Dialogues] Clone cancelled');
                return;
            }
            
            if (dialogueData[newKey]) {
                await showAlert(`A dialogue with key "${newKey}" already exists!`, 'error');
                return;
            }
            
            // Deep copy the dialogue
            const original = dialogueData[key];
            const duplicate = {
                key: newKey,
                title: original.title ? `${original.title} (Copy)` : '',
                messages: original.messages.map(msg => ({
                    ...msg,
                    key: newKey
                })),
                conditions: original.conditions ? JSON.parse(JSON.stringify(original.conditions)) : null
            };
            
            // Add to local data
            dialogueData[newKey] = duplicate;
            
            // Save to backend
            try {
                const payload = {
                    key: newKey,
                    title: duplicate.title,
                    messages: duplicate.messages.map((msg, idx) => ({
                        sequence: idx,
                        speaker: msg.speaker,
                        avatar: msg.avatar,
                        text: msg.text,
                        align: msg.align || 'left',
                        buttons_json: msg.buttons_json
                    }))
                };
                
                const response = await authenticatedFetch('/api/dialogues/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error('Save failed');
                }
                
                console.log('‚úÖ [Dialogues] Clone created:', newKey);
                await showAlert(`Cloned as "${newKey}"!`, 'success');
                
                // Select the new dialogue
                selectedKey = newKey;
                localStorage.setItem('dialogues_selected_key', newKey);
                
                renderAll();
                updateStats();
            } catch (error) {
                console.error('‚ùå [Dialogues] Clone error:', error);
                delete dialogueData[newKey]; // Rollback
                await showAlert('Failed to clone: ' + error.message, 'error');
            }
        }
        
        // Test dialogue (show it in dialogue widget)
        async function testDialogue(key) {
            console.log('üß™ [Dialogues] Testing dialogue:', key);
            console.log('üß™ [Dialogues] window.dialogue:', typeof window.dialogue);
            console.log('üß™ [Dialogues] window.dialogue:', window.dialogue);
            
            // Check if dialogue widget is available
            if (typeof window.dialogue === 'undefined') {
                console.error('‚ùå [Dialogues] dialogue widget not found on window object');
                console.log('üîç [Dialogues] Available on window:', Object.keys(window).filter(k => k.toLowerCase().includes('dialogue')));
                await showAlert('Dialogue widget not loaded', 'error');
                return;
            }
            
            console.log('‚úÖ [Dialogues] dialogue widget found');
            
            // Get dialogue data
            const dialogue = dialogueData[key];
            console.log('üß™ [Dialogues] Dialogue data:', dialogue);
            
            if (!dialogue || !dialogue.messages || dialogue.messages.length === 0) {
                console.error('‚ùå [Dialogues] No messages found');
                await showAlert('No messages to test', 'error');
                return;
            }
            
            console.log('üß™ [Dialogues] Formatting', dialogue.messages.length, 'messages');
            
            // Format messages for the widget
            const messages = dialogue.messages.map((msg, idx) => {
                console.log(`üß™ [Dialogues] Message ${idx}:`, msg);
                console.log(`üìù [Dialogues] Message ${idx} raw text:`, JSON.stringify(msg.text));
                console.log(`üìù [Dialogues] Message ${idx} has \\n:`, msg.text.includes('\n'));
                const formatted = {
                    speaker: msg.speaker,
                    avatar: msg.avatar,
                    text: msg.text,
                    buttons: msg.buttons_json ? (typeof msg.buttons_json === 'string' ? JSON.parse(msg.buttons_json) : msg.buttons_json) : []
                };
                console.log(`üß™ [Dialogues] Formatted ${idx}:`, formatted);
                console.log(`üìù [Dialogues] Formatted ${idx} text:`, JSON.stringify(formatted.text));
                return formatted;
            });
            
            console.log('üß™ [Dialogues] Final messages array:', messages);
            console.log('üß™ [Dialogues] Calling dialogue.start()...');
            
            // Show dialogue with key for same-dialogue GOTO support
            try {
                window.dialogue.start(messages, key);
                console.log('‚úÖ [Dialogues] dialogue.start() called successfully');
            } catch (error) {
                console.error('‚ùå [Dialogues] Error calling dialogue.start():', error);
                await showAlert('Error showing dialogue: ' + error.message, 'error');
            }
        }
        
        // Test dialogue starting from a specific message
        async function testFromMessage(key, startIdx) {
            console.log('üß™ [Dialogues] Testing from message:', key, 'index:', startIdx);
            
            // Check if dialogue widget is available
            if (typeof window.dialogue === 'undefined') {
                console.error('‚ùå [Dialogues] dialogue widget not found on window object');
                await showAlert('Dialogue widget not loaded', 'error');
                return;
            }
            
            // Get dialogue data
            const dialogue = dialogueData[key];
            
            if (!dialogue || !dialogue.messages || dialogue.messages.length === 0) {
                console.error('‚ùå [Dialogues] No messages found');
                await showAlert('No messages to test', 'error');
                return;
            }
            
            if (startIdx < 0 || startIdx >= dialogue.messages.length) {
                console.error('‚ùå [Dialogues] Invalid message index');
                await showAlert('Invalid message index', 'error');
                return;
            }
            
            console.log('üß™ [Dialogues] Formatting messages from index', startIdx);
            
            // Format messages starting from the specified index
            const messages = dialogue.messages.slice(startIdx).map((msg, idx) => {
                const formatted = {
                    speaker: msg.speaker,
                    avatar: msg.avatar,
                    text: msg.text,
                    buttons: msg.buttons_json ? (typeof msg.buttons_json === 'string' ? JSON.parse(msg.buttons_json) : msg.buttons_json) : []
                };
                return formatted;
            });
            
            console.log('üß™ [Dialogues] Testing with', messages.length, 'messages');
            
            // Show dialogue with key for same-dialogue GOTO support
            try {
                window.dialogue.start(messages, key);
                console.log('‚úÖ [Dialogues] dialogue.start() called successfully');
            } catch (error) {
                console.error('‚ùå [Dialogues] Error calling dialogue.start():', error);
                await showAlert('Error showing dialogue: ' + error.message, 'error');
            }
        }
        
        // ============================================================================
        // CONDITION MANAGEMENT
        // ============================================================================
        
        
        // Create new dialogue
        function showCreateDialogueModal() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            overlay.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Create New Dialogue</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-form-group">
                            <label class="modal-form-label">Dialogue Key *</label>
                            <input type="text" class="modal-form-input" id="new-dialogue-key" 
                                   placeholder="e.g., header:welcome or homepage:greeting">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="modal-btn primary" onclick="createDialogue()">Create</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        // Create dialogue
        async function createDialogue() {
            const key = document.getElementById('new-dialogue-key').value.trim();
            
            if (!key) {
                await showAlert('Please enter a dialogue key', 'error');
                return;
            }
            
            if (dialogueData[key]) {
                await showAlert('A dialogue with that key already exists!', 'error');
                return;
            }
            
            dialogueData[key] = {
                key: key,
                messages: [
                    {
                        key: key,
                        sequence: 0,
                        speaker: 'errantson',
                        avatar: '/souvenirs/dream/strange/icon.png',
                        text: 'New dialogue message',
                        buttons_json: null
                    }
                ]
            };
            
            document.querySelector('.modal-overlay').remove();
            renderAll();
            updateStats();
        }
        
        // Test Errantson - Preview dialogue in live mode
        
        // ============================================================================
        // HEADER ROTATOR MODAL
        // ============================================================================
        
        async function showHeaderRotatorModal() {
            // Fetch current rotator messages from API
            let messages = [];
            try {
                const response = await fetch('/api/header-rotator');
                const data = await response.json();
                messages = data.messages || [];
            } catch (error) {
                console.error('Failed to load rotator messages:', error);
                await showAlert('Failed to load rotator messages.', 'error');
                return;
            }
            
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 20000;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow-y: auto;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: #1a1a1a;
                border: 2px solid #555;
                border-radius: 4px;
                padding: 1.5rem;
                width: 90%;
                max-width: 600px;
                max-height: 90vh;
                overflow-y: auto;
                font-family: 'SF Mono', Monaco, monospace;
                color: #ccc;
            `;
            
            const messagesHTML = messages.map((msg, idx) => `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #0d0d0d; border: 1px solid #333; border-radius: 3px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.7rem; color: #888;">Message ${idx + 1}</span>
                        <button onclick="deleteRotatorMessage(${idx})" style="
                            background: #d94848;
                            color: white;
                            border: none;
                            padding: 2px 6px;
                            font-size: 0.65rem;
                            cursor: pointer;
                            border-radius: 2px;
                        ">Delete</button>
                    </div>
                    <div contenteditable="true" id="rotator-line1-${idx}" style="
                        background: #222;
                        border: 1px solid #444;
                        padding: 0.5rem;
                        margin-bottom: 0.25rem;
                        font-size: 0.75rem;
                        color: #fff;
                        border-radius: 2px;
                        outline: none;
                    ">${msg.lines[0]}</div>
                    <div contenteditable="true" id="rotator-line2-${idx}" style="
                        background: #222;
                        border: 1px solid #444;
                        padding: 0.5rem;
                        font-size: 0.75rem;
                        color: #fff;
                        border-radius: 2px;
                        outline: none;
                    ">${msg.lines[1]}</div>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #333;">
                    <h3 style="margin: 0; font-size: 0.875rem; color: #fff;">üîÑ Header Text Rotator</h3>
                    <button onclick="this.closest('.modal-overlay').remove()" style="
                        background: transparent;
                        border: 1px solid #555;
                        color: #ccc;
                        padding: 4px 8px;
                        font-size: 0.7rem;
                        cursor: pointer;
                        border-radius: 2px;
                    ">‚úï</button>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <div style="font-size: 0.7rem; color: #888; margin-bottom: 0.75rem;">
                        Edit the rotating messages that appear in the site header. Each message has two lines.
                    </div>
                    <div id="rotator-messages-container">
                        ${messagesHTML}
                    </div>
                    <button onclick="addRotatorMessage()" style="
                        width: 100%;
                        padding: 0.5rem;
                        background: #333;
                        color: #ccc;
                        border: 1px dashed #555;
                        font-size: 0.7rem;
                        cursor: pointer;
                        border-radius: 3px;
                        margin-bottom: 1rem;
                    ">+ Add Message</button>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="saveRotatorMessages()" style="
                        flex: 1;
                        padding: 0.75rem;
                        background: #2d7a3e;
                        color: white;
                        border: none;
                        font-size: 0.75rem;
                        text-transform: uppercase;
                        cursor: pointer;
                        border-radius: 3px;
                        letter-spacing: 0.05em;
                    ">Save Changes</button>
                    <button onclick="this.closest('.modal-overlay').remove()" style="
                        flex: 1;
                        padding: 0.75rem;
                        background: #555;
                        color: white;
                        border: none;
                        font-size: 0.75rem;
                        text-transform: uppercase;
                        cursor: pointer;
                        border-radius: 3px;
                        letter-spacing: 0.05em;
                    ">Cancel</button>
                </div>
            `;
            
            overlay.className = 'modal-overlay';
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }
        
        function addRotatorMessage() {
            const container = document.getElementById('rotator-messages-container');
            const count = container.children.length;
            
            const newMessage = document.createElement('div');
            newMessage.style.cssText = 'margin-bottom: 1rem; padding: 0.75rem; background: #0d0d0d; border: 1px solid #333; border-radius: 3px;';
            newMessage.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.7rem; color: #888;">Message ${count + 1}</span>
                    <button onclick="this.closest('div[style*=\"margin-bottom: 1rem\"]').remove()" style="
                        background: #d94848;
                        color: white;
                        border: none;
                        padding: 2px 6px;
                        font-size: 0.65rem;
                        cursor: pointer;
                        border-radius: 2px;
                    ">Delete</button>
                </div>
                <div contenteditable="true" id="rotator-line1-${count}" style="
                    background: #222;
                    border: 1px solid #444;
                    padding: 0.5rem;
                    margin-bottom: 0.25rem;
                    font-size: 0.75rem;
                    color: #fff;
                    border-radius: 2px;
                    outline: none;
                ">New line 1</div>
                <div contenteditable="true" id="rotator-line2-${count}" style="
                    background: #222;
                    border: 1px solid #444;
                    padding: 0.5rem;
                    font-size: 0.75rem;
                    color: #fff;
                    border-radius: 2px;
                    outline: none;
                ">New line 2</div>
            `;
            container.appendChild(newMessage);
        }
        
        function deleteRotatorMessage(index) {
            const container = document.getElementById('rotator-messages-container');
            if (container.children.length <= 1) {
                showAlert('You must have at least one message.', 'error');
                return;
            }
            container.children[index].remove();
        }
        
        async function saveRotatorMessages() {
            const container = document.getElementById('rotator-messages-container');
            const messages = [];
            
            Array.from(container.children).forEach((msgDiv, idx) => {
                const line1El = msgDiv.querySelector('[id^="rotator-line1-"]');
                const line2El = msgDiv.querySelector('[id^="rotator-line2-"]');
                
                if (line1El && line2El) {
                    const line1 = line1El.textContent.trim();
                    const line2 = line2El.textContent.trim();
                    
                    if (line1 && line2) {
                        messages.push({ lines: [line1, line2] });
                    }
                }
            });
            
            if (messages.length === 0) {
                await showAlert('Please add at least one complete message.', 'error');
                return;
            }
            
            console.log('üíæ Saving rotator messages:', messages);
            
            // Save to backend
            try {
                const response = await authenticatedFetch('/api/header-rotator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ messages })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                // Close the modal first
                const modalOverlay = document.querySelector('.modal-overlay');
                if (modalOverlay) {
                    modalOverlay.remove();
                }
                
                await showAlert(`‚úÖ Saved ${result.count} header messages successfully!`, 'success');
                
            } catch (error) {
                console.error('Failed to save rotator messages:', error);
                await showAlert('Failed to save messages. Please try again.', 'error');
            }
        }
        
        // Update stats
        function updateStats() {
            const templates = Object.keys(dialogueData).length;
            const messages = Object.values(dialogueData).reduce((sum, d) => sum + d.messages.length, 0);
            
            document.getElementById('stat-templates').textContent = templates;
            // stat-sent will be updated when monitor loads
        }
        
        // ============================================================================
        // SEND TAB
        // ============================================================================
        
        // Store dreamers data globally for the send form
        let sendFormDreamers = [];
        
        async function renderSendForm() {
            console.log('üìù [SEND] Rendering send form...');
            
            // Fetch dreamers for user selection
            sendFormDreamers = [];
            try {
                console.log('üåê [SEND] Fetching /api/dreamers...');
                const response = await authenticatedFetch('/api/dreamers');
                console.log('üì° [SEND] Response status:', response.status);
                const result = await response.json();
                console.log('üìä [SEND] Response data:', result);
                console.log('üìä [SEND] Response type:', typeof result);
                console.log('üìä [SEND] Is array?', Array.isArray(result));
                
                // Handle different response formats
                if (Array.isArray(result)) {
                    // Direct array response
                    sendFormDreamers = result;
                    console.log(`‚úÖ [SEND] Loaded ${sendFormDreamers.length} dreamers (direct array)`);
                } else if (result.status === 'success' && result.data) {
                    // Wrapped response
                    sendFormDreamers = result.data;
                    console.log(`‚úÖ [SEND] Loaded ${sendFormDreamers.length} dreamers (wrapped)`);
                } else if (result.dreamers) {
                    // Alternative wrapper
                    sendFormDreamers = result.dreamers;
                    console.log(`‚úÖ [SEND] Loaded ${sendFormDreamers.length} dreamers (dreamers key)`);
                } else {
                    console.warn('‚ö†Ô∏è [SEND] Unexpected response format:', result);
                }
                
                if (sendFormDreamers.length > 0) {
                    console.log('üìã [SEND] First dreamer sample:', {
                        handle: sendFormDreamers[0].handle,
                        name: sendFormDreamers[0].name,
                        display_name: sendFormDreamers[0].display_name,
                        did: sendFormDreamers[0].did?.substring(0, 30)
                    });
                }
            } catch (error) {
                console.error('‚ùå [SEND] Failed to load dreamers:', error);
            }
            
            const container = document.getElementById('send-form-container');
            
            // Sort dreamers by handle
            sendFormDreamers.sort((a, b) => (a.handle || '').localeCompare(b.handle || ''));
            console.log(`üìä [SEND] Sorted ${sendFormDreamers.length} dreamers`);
            
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <!-- Template Selection -->
                    <div style="position: relative;">
                        <label style="font-size: 0.625rem; color: #888; text-transform: uppercase; display: block; margin-bottom: 0.375rem;">Dialogue Template</label>
                        <input type="text" 
                               id="send-template-search" 
                               placeholder="Type to search dialogues..."
                               autocomplete="off"
                               oninput="filterDialogues(this.value)"
                               onfocus="showDialogueDropdown()"
                               style="width: 100%; padding: 0.5rem; font-family: 'SF Mono', Monaco, monospace; font-size: 0.75rem; background: #0d0d0d; border: 1px solid #333; color: #ccc; border-radius: 2px;">
                        <div id="dialogue-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: #1a1a1a; border: 1px solid #333; border-top: none; border-radius: 0 0 2px 2px; z-index: 1000; margin-top: -1px;"></div>
                    </div>
                    
                    <!-- Target Type -->
                    <div>
                        <label style="font-size: 0.625rem; color: #888; text-transform: uppercase; display: block; margin-bottom: 0.375rem;">Send To</label>
                        <select id="send-target-type" onchange="toggleTargetInput()" style="width: 100%; padding: 0.5rem; font-family: 'SF Mono', Monaco, monospace; font-size: 0.75rem; background: #0d0d0d; border: 1px solid #333; color: #ccc; border-radius: 2px;">
                            <option value="user">Single User</option>
                            <option value="all">All Users (Broadcast)</option>
                        </select>
                    </div>
                    
                    <!-- User Selection (shown for single user) -->
                    <div id="send-user-container" style="position: relative;">
                        <label style="font-size: 0.625rem; color: #888; text-transform: uppercase; display: block; margin-bottom: 0.375rem;">User (type handle)</label>
                        <input type="text" 
                               id="send-user-search" 
                               placeholder="Type handle or name..."
                               autocomplete="off"
                               oninput="filterUsers(this.value)"
                               onfocus="showUserDropdown()"
                               style="width: 100%; padding: 0.5rem; font-family: 'SF Mono', Monaco, monospace; font-size: 0.75rem; background: #0d0d0d; border: 1px solid #333; color: #ccc; border-radius: 2px;">
                        <div id="user-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: #1a1a1a; border: 1px solid #333; border-top: none; border-radius: 0 0 2px 2px; z-index: 1000; margin-top: -1px;"></div>
                        <div style="font-size: 0.625rem; color: #666; margin-top: 0.25rem; font-style: italic;">
                            ${sendFormDreamers.length} users available
                        </div>
                    </div>
                    
                    <!-- Send Button -->
                    <button onclick="sendMessage()" style="width: 100%; padding: 0.75rem; font-size: 0.75rem; font-weight: 600; background: #2d7a3e; color: white; border: none; border-radius: 3px; cursor: pointer; font-family: 'SF Mono', Monaco, monospace; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.5rem;">
                        üì§ Send Message
                    </button>
                </div>
            `;
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#send-template-search') && !e.target.closest('#dialogue-dropdown')) {
                    document.getElementById('dialogue-dropdown').style.display = 'none';
                }
                if (!e.target.closest('#send-user-search') && !e.target.closest('#user-dropdown')) {
                    document.getElementById('user-dropdown').style.display = 'none';
                }
            });
        }
        
        function filterDialogues(searchTerm) {
            console.log('üîç [DIALOGUE-FILTER] Called with searchTerm:', searchTerm);
            const dropdown = document.getElementById('dialogue-dropdown');
            
            if (!dropdown) {
                console.error('‚ùå [DIALOGUE-FILTER] Dropdown element not found!');
                return;
            }
            
            console.log('üìä [DIALOGUE-FILTER] dialogueData keys:', Object.keys(dialogueData).length);
            const keys = Object.keys(dialogueData).sort();
            console.log('üìã [DIALOGUE-FILTER] First 5 keys:', keys.slice(0, 5));
            
            if (!searchTerm) {
                console.log('üìù [DIALOGUE-FILTER] No search term, showing all', keys.length, 'dialogues');
                // Show all dialogues
                const html = keys.map(key => {
                    const title = dialogueData[key].title || '';
                    return `
                        <div class="autocomplete-item" onclick="selectDialogue('${key}')" style="padding: 0.5rem; cursor: pointer; font-family: 'SF Mono', Monaco, monospace; font-size: 0.7rem; border-bottom: 1px solid #252525;">
                            <div style="color: #ccc;">${key}</div>
                            ${title ? `<div style="color: #666; font-size: 0.65rem; font-style: italic;">${title}</div>` : ''}
                        </div>
                    `;
                }).join('');
                console.log('üì§ [DIALOGUE-FILTER] Generated HTML length:', html.length);
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
                console.log('‚úÖ [DIALOGUE-FILTER] Dropdown displayed');
                return;
            }
            
            // Filter dialogues
            const searchLower = searchTerm.toLowerCase();
            console.log('üîé [DIALOGUE-FILTER] Searching for:', searchLower);
            const matches = keys.filter(key => {
                const title = dialogueData[key].title || '';
                return key.toLowerCase().includes(searchLower) || 
                       title.toLowerCase().includes(searchLower);
            });
            
            console.log('‚ú® [DIALOGUE-FILTER] Found', matches.length, 'matches');
            
            if (matches.length === 0) {
                dropdown.innerHTML = '<div style="padding: 0.5rem; color: #666; font-size: 0.7rem;">No matches found</div>';
                dropdown.style.display = 'block';
                console.log('üì≠ [DIALOGUE-FILTER] No matches, showing message');
                return;
            }
            
            const html = matches.map(key => {
                const title = dialogueData[key].title || '';
                return `
                    <div class="autocomplete-item" onclick="selectDialogue('${key}')" style="padding: 0.5rem; cursor: pointer; font-family: 'SF Mono', Monaco, monospace; font-size: 0.7rem; border-bottom: 1px solid #252525;">
                        <div style="color: #ccc;">${key}</div>
                        ${title ? `<div style="color: #666; font-size: 0.65rem; font-style: italic;">${title}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            console.log('üì§ [DIALOGUE-FILTER] Generated HTML for', matches.length, 'items, length:', html.length);
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
            console.log('‚úÖ [DIALOGUE-FILTER] Dropdown displayed with matches');
            
            // Add hover effect via CSS
            const items = dropdown.querySelectorAll('.autocomplete-item');
            items.forEach(item => {
                item.addEventListener('mouseenter', () => {
                    item.style.background = '#252525';
                });
                item.addEventListener('mouseleave', () => {
                    item.style.background = '';
                });
            });
        }
        
        function showDialogueDropdown() {
            console.log('üëÅÔ∏è [DIALOGUE-DROPDOWN] showDialogueDropdown called');
            const input = document.getElementById('send-template-search');
            if (!input) {
                console.error('‚ùå [DIALOGUE-DROPDOWN] Input element not found!');
                return;
            }
            console.log('üìù [DIALOGUE-DROPDOWN] Input value:', input.value);
            filterDialogues(input.value);
        }
        
        function selectDialogue(key) {
            console.log('‚úÖ [DIALOGUE-SELECT] Selected:', key);
            document.getElementById('send-template-search').value = key;
            document.getElementById('dialogue-dropdown').style.display = 'none';
        }
        
        function filterUsers(searchTerm) {
            console.log('üîç [USER-FILTER] Called with searchTerm:', searchTerm);
            const dropdown = document.getElementById('user-dropdown');
            
            if (!dropdown) {
                console.error('‚ùå [USER-FILTER] Dropdown element not found!');
                return;
            }
            
            console.log('üë• [USER-FILTER] sendFormDreamers count:', sendFormDreamers.length);
            if (sendFormDreamers.length > 0) {
                console.log('üìã [USER-FILTER] First user sample:', {
                    handle: sendFormDreamers[0].handle,
                    name: sendFormDreamers[0].name,
                    display_name: sendFormDreamers[0].display_name,
                    did: sendFormDreamers[0].did?.substring(0, 30)
                });
            }
            
            if (!searchTerm) {
                console.log('üìù [USER-FILTER] No search term, showing first 50 users');
                // Show all users
                const html = sendFormDreamers.slice(0, 50).map(d => {
                    const handle = d.handle || d.name || d.did.substring(0, 20);
                    const displayName = d.display_name || '';
                    return `
                        <div class="autocomplete-item" onclick="selectUser('${handle.replace(/'/g, "\\\'")}')" style="padding: 0.5rem; cursor: pointer; font-family: 'SF Mono', Monaco, monospace; font-size: 0.7rem; border-bottom: 1px solid #252525;">
                            <div style="color: #ccc;">${handle}</div>
                            ${displayName ? `<div style="color: #666; font-size: 0.65rem;">${displayName}</div>` : ''}
                        </div>
                    `;
                }).join('');
                const finalHtml = html + (sendFormDreamers.length > 50 ? '<div style="padding: 0.5rem; color: #666; font-size: 0.65rem; text-align: center;">Type to see more...</div>' : '');
                console.log('üì§ [USER-FILTER] Generated HTML length:', finalHtml.length);
                dropdown.innerHTML = finalHtml;
                dropdown.style.display = 'block';
                console.log('‚úÖ [USER-FILTER] Dropdown displayed with', Math.min(50, sendFormDreamers.length), 'users');
                
                // Add hover effect
                addHoverEffect(dropdown);
                return;
            }
            
            // Filter users
            const searchLower = searchTerm.toLowerCase();
            console.log('üîé [USER-FILTER] Searching for:', searchLower);
            const matches = sendFormDreamers.filter(d => {
                const handle = d.handle || d.name || '';
                const displayName = d.display_name || '';
                const matchesHandle = handle.toLowerCase().includes(searchLower);
                const matchesDisplay = displayName.toLowerCase().includes(searchLower);
                return matchesHandle || matchesDisplay;
            }).slice(0, 50);
            
            console.log('‚ú® [USER-FILTER] Found', matches.length, 'matches');
            if (matches.length > 0) {
                console.log('üìã [USER-FILTER] First match:', {
                    handle: matches[0].handle,
                    display_name: matches[0].display_name
                });
            }
            
            if (matches.length === 0) {
                dropdown.innerHTML = '<div style="padding: 0.5rem; color: #666; font-size: 0.7rem;">No matches found</div>';
                dropdown.style.display = 'block';
                console.log('üì≠ [USER-FILTER] No matches, showing message');
                return;
            }
            
            const html = matches.map(d => {
                const handle = d.handle || d.name || d.did.substring(0, 20);
                const displayName = d.display_name || '';
                return `
                    <div class="autocomplete-item" onclick="selectUser('${handle.replace(/'/g, "\\\'")}')" style="padding: 0.5rem; cursor: pointer; font-family: 'SF Mono', Monaco, monospace; font-size: 0.7rem; border-bottom: 1px solid #252525;">
                        <div style="color: #ccc;">${handle}</div>
                        ${displayName ? `<div style="color: #666; font-size: 0.65rem;">${displayName}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            console.log('üì§ [USER-FILTER] Generated HTML for', matches.length, 'items, length:', html.length);
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
            console.log('‚úÖ [USER-FILTER] Dropdown displayed with matches');
            
            // Add hover effect
            addHoverEffect(dropdown);
        }
        
        function addHoverEffect(dropdown) {
            const items = dropdown.querySelectorAll('.autocomplete-item');
            items.forEach(item => {
                item.addEventListener('mouseenter', () => {
                    item.style.background = '#252525';
                });
                item.addEventListener('mouseleave', () => {
                    item.style.background = '';
                });
            });
        }
        
        function showUserDropdown() {
            console.log('üëÅÔ∏è [USER-DROPDOWN] showUserDropdown called');
            const input = document.getElementById('send-user-search');
            if (!input) {
                console.error('‚ùå [USER-DROPDOWN] Input element not found!');
                return;
            }
            console.log('üìù [USER-DROPDOWN] Input value:', input.value);
            console.log('üë• [USER-DROPDOWN] Available dreamers:', sendFormDreamers.length);
            filterUsers(input.value);
        }
        
        function selectUser(handle) {
            console.log('‚úÖ [USER-SELECT] Selected:', handle);
            document.getElementById('send-user-search').value = handle;
            document.getElementById('user-dropdown').style.display = 'none';
        }
        
        function toggleTargetInput() {
            const targetType = document.getElementById('send-target-type').value;
            const userContainer = document.getElementById('send-user-container');
            userContainer.style.display = targetType === 'user' ? 'block' : 'none';
        }
        
        async function sendMessage() {
            console.log('üì§ [SEND] Starting message send...');
            
            const template = document.getElementById('send-template-search').value.trim();
            const targetType = document.getElementById('send-target-type').value;
            const userSearch = document.getElementById('send-user-search')?.value.trim();
            
            console.log('üìù [SEND] Form values:', {
                template,
                targetType,
                userSearch
            });
            
            if (!template) {
                console.warn('‚ö†Ô∏è [SEND] No template selected');
                await showAlert('Please select a dialogue template', 'error');
                return;
            }
            
            // Verify template exists
            if (!dialogueData[template]) {
                console.warn('‚ö†Ô∏è [SEND] Invalid template:', template);
                await showAlert(`Template "${template}" not found. Please select from the list.`, 'error');
                return;
            }
            
            let userDid = null;
            if (targetType === 'user') {
                if (!userSearch) {
                    console.warn('‚ö†Ô∏è [SEND] User target selected but no user provided');
                    await showAlert('Please select a user', 'error');
                    return;
                }
                
                // Look up DID from handle/name in sendFormDreamers
                const dreamer = sendFormDreamers.find(d => 
                    (d.handle && d.handle.toLowerCase() === userSearch.toLowerCase()) ||
                    (d.name && d.name.toLowerCase() === userSearch.toLowerCase()) ||
                    (d.display_name && d.display_name.toLowerCase() === userSearch.toLowerCase()) ||
                    d.did === userSearch
                );
                
                if (dreamer) {
                    userDid = dreamer.did;
                    console.log(`‚úÖ [SEND] Found user: ${dreamer.handle || dreamer.name} (${userDid.substring(0, 30)}...)`);
                } else {
                    console.warn('‚ö†Ô∏è [SEND] User not found:', userSearch);
                    await showAlert(`User "${userSearch}" not found. Please select from the list.`, 'error');
                    return;
                }
            }
            
            const payload = {
                dialogue_key: template,
                priority: 50  // Default normal priority
            };
            
            if (userDid) payload.user_did = userDid;
            
            console.log('üì¶ [SEND] Request payload:', payload);
            
            try {
                console.log('üåê [SEND] Sending POST to /api/messages/send');
                const response = await authenticatedFetch('/api/messages/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('üì° [SEND] Response status:', response.status);
                
                const result = await response.json();
                console.log('üìä [SEND] Response data:', result);
                
                if (result.status === 'success') {
                    const count = result.data.sent || 1;
                    console.log(`‚úÖ [SEND] Successfully sent to ${count} user(s)`);
                    await showAlert(`‚úÖ Message sent to ${count} user${count > 1 ? 's' : ''}!`, 'success');
                    // Clear form
                    document.getElementById('send-template-search').value = '';
                    if (document.getElementById('send-user-search')) {
                        document.getElementById('send-user-search').value = '';
                    }
                } else {
                    console.error('‚ùå [SEND] Server error:', result.error);
                    await showAlert('Failed to send: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('‚ùå [SEND] Exception caught:', error);
                await showAlert('Network error: ' + error.message, 'error');
            }
        }
        
        function showSendPanel() {
            const container = document.getElementById('dialogue-list');
            container.innerHTML = `
                <div style="text-align: center; padding: 4rem 2rem; color: var(--text-dim);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üì®</div>
                    <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 1.25rem; margin-bottom: 0.5rem;">Send Messages</div>
                    <div style="font-size: 0.875rem; color: #888;">Use the form on the left to send a message template to users</div>
                </div>
            `;
        }
        
        // ============================================================================
        // MONITOR TAB
        // ============================================================================
        
        async function loadMonitorData() {
            console.log('üìä Loading monitor data...');
            try {
                // Load analytics
                const statsResponse = await authenticatedFetch('/api/messages/analytics');
                const statsResult = await statsResponse.json();
                
                if (statsResult.status === 'success') {
                    renderMonitorStats(statsResult.data);
                    // Update header stat
                    document.getElementById('stat-sent').textContent = statsResult.data.total || 0;
                }
            } catch (error) {
                console.error('‚ùå Error loading monitor data:', error);
            }
        }
        
        function renderMonitorStats(stats) {
            const container = document.getElementById('monitor-stats-container');
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; padding: 0.75rem; background: #0d0d0d; border: 1px solid #333; border-radius: 3px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: #4a9eff;">${stats.total || 0}</div>
                        <div style="font-size: 0.5625rem; color: #666; text-transform: uppercase; margin-top: 0.125rem;">Total</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: #f4a261;">${stats.unread || 0}</div>
                        <div style="font-size: 0.5625rem; color: #666; text-transform: uppercase; margin-top: 0.125rem;">Unread</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: #2a9d8f;">${stats.read || 0}</div>
                        <div style="font-size: 0.5625rem; color: #666; text-transform: uppercase; margin-top: 0.125rem;">Read</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: #666;">${stats.dismissed || 0}</div>
                        <div style="font-size: 0.5625rem; color: #666; text-transform: uppercase; margin-top: 0.125rem;">Dismissed</div>
                    </div>
                </div>
            `;
        }
        
        function showMonitorPanel() {
            const container = document.getElementById('dialogue-list');
            container.innerHTML = `
                <div style="padding: 1rem; height: calc(100vh - 140px); display: flex; flex-direction: column;">
                    <!-- Header with filters -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h2 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-primary);">Message Monitor</h2>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: var(--text-secondary);">All sent messages across the system</p>
                        </div>
                        <button onclick="loadMonitorMessages()" style="padding: 0.375rem 0.75rem; background: #734ba1; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem; font-weight: 600;">
                            üîÑ Refresh
                        </button>
                    </div>
                    
                    <!-- Stats Summary -->
                    <div id="monitor-summary" style="display: flex; gap: 1rem; margin-bottom: 0.75rem; font-size: 0.6875rem; color: var(--text-secondary);">
                        <div>Total: <strong id="monitor-total" style="color: var(--text-primary);">0</strong></div>
                        <div>Unread: <strong id="monitor-unread" style="color: #f4a261;">0</strong></div>
                        <div>Read: <strong id="monitor-read" style="color: #2a9d8f;">0</strong></div>
                        <div>Dismissed: <strong id="monitor-dismissed" style="color: #999;">0</strong></div>
                    </div>
                    
                    <!-- Filters and Search -->
                    <div style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 4px; padding: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="display: grid; grid-template-columns: 1fr 140px 200px 160px; gap: 0.75rem;">
                            <input type="text" id="filter-user" placeholder="Search user DID..." onkeyup="filterMessages()" style="padding: 0.375rem 0.5rem; border: 1px solid var(--card-border); border-radius: 3px; font-family: 'SF Mono', Monaco, monospace; font-size: 0.75rem;">
                            <select id="filter-status" onchange="filterMessages()" style="padding: 0.375rem 0.5rem; border: 1px solid var(--card-border); border-radius: 3px; font-size: 0.75rem;">
                                <option value="">All Status</option>
                                <option value="unread">Unread</option>
                                <option value="read">Read</option>
                                <option value="dismissed">Dismissed</option>
                            </select>
                            <select id="filter-template" onchange="filterMessages()" style="padding: 0.375rem 0.5rem; border: 1px solid var(--card-border); border-radius: 3px; font-size: 0.75rem; font-family: 'SF Mono', Monaco, monospace;">
                                <option value="">All Templates</option>
                            </select>
                            <select id="filter-sort" onchange="filterMessages()" style="padding: 0.375rem 0.5rem; border: 1px solid var(--card-border); border-radius: 3px; font-size: 0.75rem;">
                                <option value="created_desc">Newest First</option>
                                <option value="created_asc">Oldest First</option>
                                <option value="priority_desc">Priority ‚Üì</option>
                                <option value="priority_asc">Priority ‚Üë</option>
                                <option value="status">By Status</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Messages Table -->
                    <div style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 4px; overflow: hidden; flex: 1; display: flex; flex-direction: column;">
                        <!-- Table Header -->
                        <div style="display: grid; grid-template-columns: 200px 1fr 100px 100px; gap: 0.75rem; padding: 0.5rem 0.75rem; background: #f9fafb; border-bottom: 1px solid var(--card-border); font-size: 0.625rem; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px;">
                            <div>User</div>
                            <div>Message</div>
                            <div>Status</div>
                            <div>Actions</div>
                        </div>
                        
                        <!-- Table Body -->
                        <div id="monitor-table-body" style="flex: 1; overflow-y: auto;">
                            <div style="padding: 2rem; text-align: center; color: var(--text-dim); font-size: 0.875rem;">
                                Loading messages...
                            </div>
                        </div>
                        
                        <!-- Pagination Footer -->
                        <div id="monitor-pagination" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; border-top: 1px solid var(--card-border); background: #f9fafb; font-size: 0.75rem;">
                            <!-- Pagination will be rendered here -->
                        </div>
                    </div>
                </div>
            `;
            
            // Load the data
            loadMonitorMessages();
        }
        
        let allMonitorMessages = [];
        let currentMonitorPage = 1;
        const messagesPerPage = 20;
        
        async function loadMonitorMessages() {
            console.log('üìä [Monitor] Loading messages...');
            try {
                // Load all messages (we'll do client-side filtering for better UX)
                const response = await authenticatedFetch('/api/messages/recent?limit=500');
                console.log('üìä [Monitor] Messages response status:', response.status);
                
                if (!response.ok) {
                    console.error('üìä [Monitor] API error:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log('üìä [Monitor] Messages result:', result);
                
                if (result.status === 'success') {
                    // Backend returns 'messages' key, not 'data'
                    allMonitorMessages = result.messages || result.data || [];
                    console.log('‚úÖ [Monitor] Loaded', allMonitorMessages.length, 'messages');
                    
                    // Populate template filter
                    const templates = [...new Set(allMonitorMessages.map(m => m.dialogue_key))].sort();
                    const filterTemplate = document.getElementById('filter-template');
                    if (filterTemplate) {
                        // Clear existing options except first (All Templates)
                        while (filterTemplate.options.length > 1) {
                            filterTemplate.remove(1);
                        }
                        templates.forEach(template => {
                            const option = document.createElement('option');
                            option.value = template;
                            option.textContent = template;
                            filterTemplate.appendChild(option);
                        });
                    }
                    
                    filterMessages();
                }
                
                // Load stats
                console.log('üìä [Monitor] Loading analytics...');
                const statsResponse = await authenticatedFetch('/api/messages/analytics');
                console.log('üìä [Monitor] Analytics response status:', statsResponse.status);
                
                if (!statsResponse.ok) {
                    console.error('üìä [Monitor] Analytics API error:', statsResponse.status);
                } else {
                    const statsResult = await statsResponse.json();
                    console.log('üìä [Monitor] Analytics result:', statsResult);
                    
                    if (statsResult.status === 'success') {
                        const total = document.getElementById('monitor-total');
                        const unread = document.getElementById('monitor-unread');
                        const read = document.getElementById('monitor-read');
                        const dismissed = document.getElementById('monitor-dismissed');
                        
                        if (total) total.textContent = statsResult.data.total || 0;
                        if (unread) unread.textContent = statsResult.data.unread || 0;
                        if (read) read.textContent = statsResult.data.read || 0;
                        if (dismissed) dismissed.textContent = statsResult.data.dismissed || 0;
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading monitor messages:', error);
                allMonitorMessages = []; // Ensure it's at least an empty array
                const tbody = document.getElementById('monitor-table-body');
                if (tbody) {
                    tbody.innerHTML = `
                        <div style="padding: 3rem; text-align: center; color: #dc2626;">
                            Failed to load messages: ${error.message}
                        </div>
                    `;
                }
            }
        }
        
        function filterMessages() {
            // Safety check
            if (!allMonitorMessages || !Array.isArray(allMonitorMessages)) {
                console.warn('‚ö†Ô∏è [Monitor] allMonitorMessages not ready, skipping filter');
                return;
            }
            
            const userFilter = document.getElementById('filter-user')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('filter-status')?.value || '';
            const templateFilter = document.getElementById('filter-template')?.value || '';
            const sortBy = document.getElementById('filter-sort')?.value || 'created_desc';
            
            console.log('üîç [Monitor] Filtering', allMonitorMessages.length, 'messages');
            
            // Filter
            let filtered = allMonitorMessages.filter(msg => {
                if (userFilter && !msg.user_did.toLowerCase().includes(userFilter)) return false;
                if (statusFilter && msg.status !== statusFilter) return false;
                if (templateFilter && msg.dialogue_key !== templateFilter) return false;
                return true;
            });
            
            // Sort
            filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'created_desc': return b.created_at - a.created_at;
                    case 'created_asc': return a.created_at - b.created_at;
                    case 'priority_desc': return b.priority - a.priority;
                    case 'priority_asc': return a.priority - b.priority;
                    case 'status': return a.status.localeCompare(b.status);
                    default: return 0;
                }
            });
            
            renderMonitorTable(filtered);
        }
        
        function renderMonitorTable(messages) {
            const tbody = document.getElementById('monitor-table-body');
            
            if (messages.length === 0) {
                tbody.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--text-dim); font-size: 0.875rem;">
                        No messages found
                    </div>
                `;
                return;
            }
            
            // Pagination
            const totalPages = Math.ceil(messages.length / messagesPerPage);
            const startIdx = (currentMonitorPage - 1) * messagesPerPage;
            const endIdx = startIdx + messagesPerPage;
            const pageMessages = messages.slice(startIdx, endIdx);
            
            // Render rows
            tbody.innerHTML = pageMessages.map(msg => {
                const statusColors = {
                    'unread': '#f4a261',
                    'read': '#2a9d8f',
                    'dismissed': '#999'
                };
                const statusColor = statusColors[msg.status] || '#666';
                
                const statusLabels = {
                    'unread': 'Unread',
                    'read': 'Read',
                    'dismissed': 'Dismissed'
                };
                const statusLabel = statusLabels[msg.status] || msg.status;
                
                const createdAt = new Date(msg.created_at * 1000).toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
                
                // Extract DID parts (first 6 and last 6 chars after did:plc:)
                const didPart = msg.user_did.replace('did:plc:', '');
                const shortDid = didPart.substring(0, 6) + '...' + didPart.slice(-6);
                
                // Use avatar, fallback to default
                const avatarUrl = msg.avatar || '/static/images/default-avatar.png';
                const handleDisplay = msg.handle || 'Unknown User';
                
                // Debug avatar issues
                if (!msg.avatar || msg.avatar.startsWith('blob:')) {
                    console.warn(`‚ö†Ô∏è [Monitor] Message ${msg.id} has invalid avatar:`, msg.avatar, '| Handle:', msg.handle);
                }
                
                // Use title if available, otherwise use dialogue_key
                const titleDisplay = msg.title || msg.dialogue_key;
                
                return `
                    <div style="display: grid; grid-template-columns: 200px 1fr 100px 100px; gap: 0.75rem; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--card-border); transition: background 0.1s; cursor: pointer; align-items: center;" 
                         onmouseover="this.style.background='#f9fafb'" 
                         onmouseout="this.style.background='white'"
                         onclick="viewMessage(${msg.id})">
                        <div style="display: flex; align-items: center; gap: 0.5rem; min-width: 0;">
                            <img src="${avatarUrl}" style="width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover;" onerror="this.src='/static/images/default-avatar.png'">
                            <div style="min-width: 0; flex: 1;">
                                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; font-weight: 600; font-size: 0.8125rem; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@${handleDisplay}</div>
                                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; font-size: 0.625rem; color: var(--text-dim);">${shortDid}</div>
                            </div>
                        </div>
                        <div style="min-width: 0;">
                            <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; font-size: 0.875rem; font-weight: 500; color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 0.125rem;">${titleDisplay}</div>
                            ${msg.title ? `<div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; color: var(--text-dim); font-size: 0.6875rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${msg.dialogue_key}</div>` : ''}
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                            <span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; display: inline-block; padding: 0.125rem 0.375rem; border-radius: 2px; font-size: 0.625rem; font-weight: 600; text-transform: uppercase; background: ${statusColor}; color: white; letter-spacing: 0.3px;">
                                ${statusLabel}
                            </span>
                            <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; font-size: 0.625rem; color: var(--text-secondary); text-align: center; line-height: 1.2;">
                                ${createdAt}
                            </div>
                        </div>
                        <div onclick="event.stopPropagation();" style="display: flex; flex-direction: column; gap: 0.25rem; align-items: stretch;">
                            ${msg.status !== 'dismissed' ? `<button onclick="dismissMessage(${msg.id})" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; padding: 0.25rem 0.5rem; background: #f59e0b; color: white; border: none; border-radius: 2px; cursor: pointer; font-size: 0.625rem; font-weight: 600; white-space: nowrap;" title="Dismiss for user">DISMISS</button>` : ''}
                            <button onclick="deleteMessageInstance(${msg.id})" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; padding: 0.25rem 0.5rem; background: #dc3545; color: white; border: none; border-radius: 2px; cursor: pointer; font-size: 0.625rem; font-weight: 600; white-space: nowrap;" title="Permanently delete">DELETE</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Render pagination
            const pagination = document.getElementById('monitor-pagination');
            if (pagination) {
                const pages = [];
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentMonitorPage - 2 && i <= currentMonitorPage + 2)) {
                        pages.push(i);
                    } else if (pages[pages.length - 1] !== '...') {
                        pages.push('...');
                    }
                }
                
                pagination.innerHTML = `
                    <div style="color: var(--text-secondary); font-size: 0.6875rem;">
                        ${startIdx + 1}-${Math.min(endIdx, messages.length)} of ${messages.length}
                    </div>
                    <div style="display: flex; gap: 0.25rem;">
                        <button onclick="changeMonitorPage(${currentMonitorPage - 1})" ${currentMonitorPage === 1 ? 'disabled' : ''} style="padding: 0.25rem 0.5rem; background: ${currentMonitorPage === 1 ? '#eee' : '#734ba1'}; color: ${currentMonitorPage === 1 ? '#999' : 'white'}; border: none; border-radius: 2px; cursor: ${currentMonitorPage === 1 ? 'not-allowed' : 'pointer'}; font-size: 0.625rem; font-weight: 600;">
                            ‚Üê
                        </button>
                        ${pages.map(page => {
                            if (page === '...') {
                                return `<span style="padding: 0.25rem 0.375rem; color: var(--text-dim); font-size: 0.625rem;">‚Ä¶</span>`;
                            }
                            const isActive = page === currentMonitorPage;
                            return `
                                <button onclick="changeMonitorPage(${page})" style="padding: 0.25rem 0.5rem; background: ${isActive ? '#734ba1' : 'white'}; color: ${isActive ? 'white' : '#734ba1'}; border: 1px solid ${isActive ? '#734ba1' : '#ddd'}; border-radius: 2px; cursor: pointer; font-size: 0.625rem; font-weight: 600; min-width: 1.5rem;">
                                    ${page}
                                </button>
                            `;
                        }).join('')}
                        <button onclick="changeMonitorPage(${currentMonitorPage + 1})" ${currentMonitorPage === totalPages ? 'disabled' : ''} style="padding: 0.25rem 0.5rem; background: ${currentMonitorPage === totalPages ? '#eee' : '#734ba1'}; color: ${currentMonitorPage === totalPages ? '#999' : 'white'}; border: none; border-radius: 2px; cursor: ${currentMonitorPage === totalPages ? 'not-allowed' : 'pointer'}; font-size: 0.625rem; font-weight: 600;">
                            ‚Üí
                        </button>
                    </div>
                `;
            }
        }
        
        function changeMonitorPage(page) {
            currentMonitorPage = page;
            filterMessages();
        }
        
        async function viewMessage(messageId) {
            try {
                const response = await authenticatedFetch(`/api/messages/${messageId}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const msg = result.data;
                    const messages = JSON.parse(msg.messages_json);
                    
                    // Show in shadowbox using dialogue data format
                    const shadowbox = new Shadowbox({
                        showCloseButton: true,
                        onClose: () => {
                            console.log('Message view closed');
                        }
                    });
                    
                    // Format as dialogue data
                    const dialogueData = {
                        key: msg.dialogue_key,
                        title: msg.title,
                        messages: messages
                    };
                    
                    await shadowbox.showDialogueData(dialogueData);
                } else {
                    await showAlert('Failed to load message', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error viewing message:', error);
                await showAlert('Failed to load message', 'error');
            }
        }
        
        async function dismissMessage(messageId) {
            if (!await showConfirm('Dismiss this message for the user?')) {
                return;
            }
            
            try {
                const response = await authenticatedFetch(`/api/messages/${messageId}/dismiss`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    await showAlert('Message dismissed', 'success');
                    loadMonitorMessages(); // Reload
                } else {
                    await showAlert('Failed to dismiss message', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error dismissing message:', error);
                await showAlert('Failed to dismiss message', 'error');
            }
        }
        
        async function deleteMessageInstance(messageId) {
            if (!await showConfirm('‚ö†Ô∏è Permanently DELETE this message record? This cannot be undone!')) {
                return;
            }
            
            try {
                const response = await authenticatedFetch(`/api/messages/${messageId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    await showAlert('Message deleted permanently', 'success');
                    loadMonitorMessages(); // Reload
                } else {
                    await showAlert('Failed to delete message', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error deleting message:', error);
                await showAlert('Failed to delete message', 'error');
            }
        }
        
        
        
        // ============================================================================
        // PIGEONS (AUTOMATION) TAB
        // ============================================================================
        
        let pigeonsData = [];
        let selectedPigeonId = null;
        
        async function loadPigeons() {
            console.log('üïäÔ∏è [PIGEONS] Loading automation pigeons...');
            try {
                const response = await authenticatedFetch('/api/pigeons/list');
                console.log('üïäÔ∏è [PIGEONS] API response status:', response.status, response.statusText);
                
                // Check if response is OK before trying to parse JSON
                if (!response.ok) {
                    console.error('üïäÔ∏è [PIGEONS] API error:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log('üïäÔ∏è [PIGEONS] API result:', result);
                
                if (result.status === 'success') {
                    pigeonsData = result.pigeons || [];
                    console.log('‚úÖ [PIGEONS] Loaded', pigeonsData.length, 'pigeons from backend');
                    console.log('üïäÔ∏è [PIGEONS] Pigeons data:', pigeonsData);
                    renderPigeonsList();
                } else {
                    console.error('üïäÔ∏è [PIGEONS] API returned error:', result.error);
                }
            } catch (error) {
                console.error('‚ö†Ô∏è [PIGEONS] Backend error:', error);
                console.error('‚ö†Ô∏è [PIGEONS] Error stack:', error.stack);
                // If endpoint doesn't exist yet, show empty state
                pigeonsData = [];
                renderPigeonsList();
            }
        }
        
        let triggerTypesCache = [];
        
        async function loadTriggerTypes() {
            console.log('üîß [TRIGGERS] Loading trigger types from API...');
            try {
                const response = await authenticatedFetch('/api/pigeons/triggers');
                
                if (!response.ok) {
                    console.error('üîß [TRIGGERS] API error:', response.status);
                    return;
                }
                
                const result = await response.json();
                
                if (result.status === 'success' && result.triggers) {
                    triggerTypesCache = result.triggers;
                    console.log('‚úÖ [TRIGGERS] Loaded', triggerTypesCache.length, 'trigger types');
                    
                    // Update filter dropdown
                    const filterSelect = document.getElementById('filter-trigger');
                    if (filterSelect) {
                        const currentValue = filterSelect.value;
                        filterSelect.innerHTML = '<option value="">All triggers</option>' +
                            triggerTypesCache.map(t => `<option value="${t.type}">${t.name}</option>`).join('');
                        filterSelect.value = currentValue;
                    }
                    
                    // Re-render grid to update trigger dropdowns in cards
                    if (currentMainTab === 'pigeons') {
                        renderPigeonsGrid();
                    }
                } else {
                    console.error('üîß [TRIGGERS] API returned error:', result.error);
                }
            } catch (error) {
                console.error('‚ö†Ô∏è [TRIGGERS] Error loading trigger types:', error);
            }
        }
        
        function renderTriggerSelectOptions(selectedTrigger) {
            // Only use cached trigger types from API - show nothing if unavailable
            const triggers = triggerTypesCache.length > 0 ? triggerTypesCache : [];
            
            // If no triggers loaded from API, return empty placeholder
            if (triggers.length === 0) {
                return '<option value="">Loading triggers...</option>';
            }
            
            // Separate stable and experimental triggers
            const stableTriggers = triggers.filter(t => t.status === 'stable');
            const experimentalTriggers = triggers.filter(t => t.status === 'experimental');
            
            // Group stable triggers by category
            const categories = {
                'Canon Events': [],
                'Role Events': [],
                'User Activity': [],
                'Admin': []
            };
            
            stableTriggers.forEach(t => {
                const cat = t.category || 'Other';
                if (categories[cat]) {
                    categories[cat].push(t);
                } else {
                    if (!categories['Other']) categories['Other'] = [];
                    categories['Other'].push(t);
                }
            });
            
            // Build optgroups
            let html = '';
            
            // Add stable triggers
            for (const [category, items] of Object.entries(categories)) {
                if (items.length > 0) {
                    html += `<optgroup label="${category}">`;
                    items.forEach(t => {
                        const selected = t.type === selectedTrigger ? 'selected' : '';
                        const configHint = t.config_fields && t.config_fields.length > 0 
                            ? ` [needs: ${t.config_fields.join(', ')}]` 
                            : '';
                        html += `<option value="${t.type}" ${selected} title="${t.description || t.name}${configHint}">${t.name}</option>`;
                    });
                    html += '</optgroup>';
                }
            }
            
            // Add experimental triggers in separate group
            if (experimentalTriggers.length > 0) {
                html += '<optgroup label="‚ö†Ô∏è Experimental">';
                experimentalTriggers.forEach(t => {
                    const selected = t.type === selectedTrigger ? 'selected' : '';
                    html += `<option value="${t.type}" ${selected} title="${t.description || t.name}">${t.name}</option>`;
                });
                html += '</optgroup>';
            }
            
            return html;
        }
        
        function renderTriggerConfigFields(pigeon) {
            const triggerType = pigeon.trigger_type;
            const config = pigeon.trigger_config || {};
            
            const fieldStyle = `
                width: 100%;
                background: #0d0d0d;
                border: 1px solid #333;
                color: #ccc;
                padding: 0.375rem;
                font-size: 0.7rem;
                border-radius: 3px;
                font-family: 'SF Mono', Monaco, monospace;
            `;
            
            const labelStyle = `
                display: block;
                font-size: 0.625rem;
                font-weight: 600;
                color: #888;
                margin-bottom: 0.25rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            `;
            
            const hintStyle = `
                font-size: 0.625rem;
                color: #666;
                margin-top: 0.25rem;
                font-style: italic;
            `;
            
            switch(triggerType) {
                case 'canon_set':
                    return `
                        <div style="margin-top: 0.5rem;">
                            <label style="${labelStyle}">Canon Key</label>
                            <input type="text" 
                                   value="${config.canon_key || ''}"
                                   onchange="updatePigeonTriggerConfig(${pigeon.id}, 'canon_key', this.value)"
                                   placeholder="e.g., name, origin, zone"
                                   style="${fieldStyle}">
                            <div style="${hintStyle}">Triggers when user sets this canon key to any value</div>
                        </div>
                    `;
                
                case 'canon_equals':
                    return `
                        <div style="margin-top: 0.5rem;">
                            <label style="${labelStyle}">Canon Key</label>
                            <input type="text" 
                                   value="${config.canon_key || ''}"
                                   onchange="updatePigeonTriggerConfig(${pigeon.id}, 'canon_key', this.value)"
                                   placeholder="e.g., origin"
                                   style="${fieldStyle}">
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <label style="${labelStyle}">Value</label>
                            <input type="text" 
                                   value="${config.value || ''}"
                                   onchange="updatePigeonTriggerConfig(${pigeon.id}, 'value', this.value)"
                                   placeholder="e.g., dream"
                                   style="${fieldStyle}">
                            <div style="${hintStyle}">Triggers when canon key equals this exact value</div>
                        </div>
                    `;
                
                case 'role_granted':
                case 'role_revoked':
                    return `
                        <div style="margin-top: 0.5rem;">
                            <label style="${labelStyle}">Role</label>
                            <input type="text" 
                                   value="${config.role || ''}"
                                   onchange="updatePigeonTriggerConfig(${pigeon.id}, 'role', this.value)"
                                   placeholder="e.g., greeter, mapper, resident"
                                   style="${fieldStyle}">
                            <div style="${hintStyle}">Triggers when user ${triggerType === 'role_granted' ? 'receives' : 'loses'} this role</div>
                        </div>
                    `;
                
                case 'return_visit':
                    return `
                        <div style="margin-top: 0.5rem;">
                            <label style="${labelStyle}">Days Away</label>
                            <input type="number" 
                                   value="${config.days_away || 7}"
                                   min="1"
                                   onchange="updatePigeonTriggerConfig(${pigeon.id}, 'days_away', parseInt(this.value))"
                                   placeholder="7"
                                   style="${fieldStyle}">
                            <div style="${hintStyle}">Triggers when user returns after being away this many days</div>
                        </div>
                    `;
                
                case 'idle_duration':
                    return `
                        <div style="margin-top: 0.5rem;">
                            <label style="${labelStyle}">Idle Days</label>
                            <input type="number" 
                                   value="${config.days || 14}"
                                   min="1"
                                   onchange="updatePigeonTriggerConfig(${pigeon.id}, 'days', parseInt(this.value))"
                                   placeholder="14"
                                   style="${fieldStyle}">
                            <div style="${hintStyle}">Triggers when user has been inactive for this many days</div>
                        </div>
                    `;
                
                case 'user_login':
                    return `
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #1a1a1a; border: 1px solid #333; border-radius: 3px;">
                            <div style="font-size: 0.65rem; color: #888;">No configuration needed</div>
                            <div style="${hintStyle}">Auto-triggers on every user login</div>
                        </div>
                    `;
                
                case 'manual':
                    return `
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #1a1a1a; border: 1px solid #333; border-radius: 3px;">
                            <div style="font-size: 0.65rem; color: #888;">No configuration needed</div>
                            <div style="${hintStyle}">Trigger manually from admin panel</div>
                        </div>
                    `;
                
                default:
                    return '';
            }
        }
        
        function renderPigeonsList() {
            // This function now just triggers the grid render
            renderPigeonsGrid();
        }
        
        function renderPigeonsGrid() {
            const container = document.getElementById('pigeons-grid-container');
            
            if (!container) return;
            
            // Apply filters
            let filteredPigeons = filterPigeonsData();
            
            if (filteredPigeons.length === 0) {
                container.innerHTML = `
                    <div style="
                        grid-column: 1 / -1;
                        text-align: center;
                        padding: 4rem 2rem;
                        color: #666;
                    ">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üïäÔ∏è</div>
                        <div style="font-family: 'SF Mono', Monaco, monospace; font-size: 1.25rem; margin-bottom: 0.5rem; color: #888;">
                            ${pigeonsData.length === 0 ? 'No Pigeons Yet' : 'No Matching Pigeons'}
                        </div>
                        <div style="font-size: 0.875rem; color: #666; max-width: 500px; margin: 1rem auto; line-height: 1.6;">
                            ${pigeonsData.length === 0 
                                ? 'Pigeons are automated message delivery systems. Create triggers and conditions to automatically deliver messages to users.' 
                                : 'Try adjusting your filters to see more pigeons.'}
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            filteredPigeons.forEach(pigeon => {
                // Parse conditions
                let conditions = [];
                try {
                    if (pigeon.conditions) {
                        conditions = typeof pigeon.conditions === 'string' 
                            ? JSON.parse(pigeon.conditions) 
                            : pigeon.conditions;
                    }
                    if (!Array.isArray(conditions)) {
                        conditions = [];
                    }
                } catch (e) {
                    conditions = [];
                }
                
                // Build condition cards
                let conditionCardsHTML = '';
                conditions.forEach((cond, idx) => {
                    const condType = cond.type || 'unknown';
                    let displayText = '';
                    
                    // Canon conditions
                    if (condType === 'has_canon') {
                        displayText = `Has canon: <code>${cond.key || '?'}</code>`;
                    } else if (condType === 'hasnt_canon') {
                        displayText = `Doesn't have canon: <code>${cond.key || '?'}</code>`;
                    } else if (condType === 'canon_equals') {
                        displayText = `Canon <code>${cond.key || '?'}</code> = <code>${cond.value || '?'}</code>`;
                    } else if (condType === 'user_canon_equals') {
                        displayText = `User canon <code>${cond.key || '?'}</code> = <code>${cond.value || '?'}</code>`;
                    } else if (condType === 'user_canon_not_equals') {
                        displayText = `User canon <code>${cond.key || '?'}</code> ‚â† <code>${cond.value || '?'}</code>`;
                    } else if (condType === 'user_in_canon_list') {
                        const values = (cond.value || '').split(',').map(v => `<code>${v.trim()}</code>`).join(', ');
                        displayText = `Canon <code>${cond.key || '?'}</code> in [${values}]`;
                    } else if (condType === 'count_canon') {
                        displayText = `Canon count: <code>${cond.value || '?'}</code>`;
                    }
                    // Role conditions
                    else if (condType === 'has_role') {
                        displayText = `Has role: <code>${cond.role || cond.value || '?'}</code>`;
                    }
                    // Souvenir conditions
                    else if (condType === 'user_has_souvenir') {
                        displayText = `Has souvenir: <code>${cond.key || cond.value || '?'}</code>`;
                    } else if (condType === 'user_missing_souvenir') {
                        displayText = `Missing souvenir: <code>${cond.key || cond.value || '?'}</code>`;
                    } else if (condType === 'souvenir_exists_anywhere') {
                        displayText = `Souvenir exists: <code>${cond.key || cond.value || '?'}</code>`;
                    }
                    // Reading/Biblio conditions
                    else if (condType === 'has_read') {
                        displayText = `Has read: <code>${cond.value || '?'}</code>`;
                    } else if (condType === 'has_read_book') {
                        displayText = `Has read book: <code>${cond.value || '?'}</code>`;
                    } else if (condType === 'has_read_author') {
                        displayText = `Has read author: <code>${cond.value || '?'}</code>`;
                    } else if (condType === 'has_biblio_stamp') {
                        displayText = `Has biblio stamp: <code>${cond.value || '?'}</code>`;
                    } else if (condType === 'book_count_min') {
                        displayText = `Min ${cond.value || '?'} books read`;
                    }
                    // Reply conditions
                    else if (condType === 'any_reply') {
                        displayText = `Any reply`;
                    } else if (condType === 'new_reply') {
                        displayText = `New reply`;
                    } else if (condType === 'dreamer_replies') {
                        displayText = `Dreamer has replied`;
                    } else if (condType === 'reply_contains') {
                        displayText = `Reply contains: <code>${cond.value || '?'}</code>`;
                    } else if (condType === 'contains_hashtags') {
                        const tags = (cond.value || '').split(',').map(t => `#${t.trim()}`).join(', ');
                        displayText = `Contains hashtags: ${tags}`;
                    } else if (condType === 'contains_mentions') {
                        displayText = `Contains mentions: <code>${cond.value || '?'}</code>`;
                    }
                    // Fallback
                    else {
                        displayText = `<code>${JSON.stringify(cond)}</code>`;
                    }
                    
                    conditionCardsHTML += `
                        <div class="dialogue-condition-card" style="margin-bottom: 0.5rem;">
                            <button class="remove-condition" onclick="removePigeonCondition(${pigeon.id}, ${idx})" title="Remove condition">√ó</button>
                            <div>${displayText}</div>
                        </div>
                    `;
                });
                
                const statusColors = {
                    'active': '#2d7a3e',
                    'paused': '#f59e0b',
                    'draft': '#666'
                };
                const statusColor = statusColors[pigeon.status] || '#666';
                
                const statusIcons = {
                    'active': 'üü¢',
                    'paused': '‚è∏Ô∏è',
                    'draft': 'üìù'
                };
                const statusIcon = statusIcons[pigeon.status] || '‚ö™';
                
                html += `
                    <div class="pigeon-column" style="
                        background: #1a1a1a;
                        border: 1px solid #333;
                        border-top: 4px solid ${statusColor};
                        border-radius: 6px;
                        padding: 1rem;
                        display: flex;
                        flex-direction: column;
                        gap: 1rem;
                        min-height: 500px;
                    ">
                        <!-- Header -->
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid #2a2a2a;">
                            <input type="text" 
                                   value="${pigeon.name}" 
                                   onchange="updatePigeonField(${pigeon.id}, 'name', this.value)"
                                   placeholder="Pigeon name"
                                   style="
                                       flex: 1;
                                       background: transparent;
                                       border: none;
                                       color: #fff;
                                       font-size: 0.875rem;
                                       font-weight: 700;
                                       padding: 0;
                                       outline: none;
                                   ">
                            <select onchange="updatePigeonField(${pigeon.id}, 'status', this.value)" 
                                    style="
                                        background: #0d0d0d;
                                        border: 1px solid #333;
                                        color: #999;
                                        padding: 0.125rem 0.25rem;
                                        font-size: 0.5625rem;
                                        border-radius: 3px;
                                        font-family: 'SF Mono', Monaco, monospace;
                                        text-transform: uppercase;
                                        letter-spacing: 0.025em;
                                    ">
                                <option value="active" ${pigeon.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="paused" ${pigeon.status === 'paused' ? 'selected' : ''}>Paused</option>
                                <option value="draft" ${pigeon.status === 'draft' ? 'selected' : ''}>Draft</option>
                            </select>
                        </div>
                        
                        <!-- Trigger -->
                        <div>
                            <div style="font-size: 0.625rem; font-weight: 700; color: #888; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.05em;">Trigger</div>
                            <select onchange="updatePigeonTriggerType(${pigeon.id}, this.value)"
                                    style="
                                        width: 100%;
                                        background: #0d0d0d;
                                        border: 1px solid #333;
                                        color: #ccc;
                                        padding: 0.375rem;
                                        font-size: 0.7rem;
                                        border-radius: 3px;
                                        font-family: 'SF Mono', Monaco, monospace;
                                    ">
                                ${renderTriggerSelectOptions(pigeon.trigger_type)}
                            </select>
                            ${renderTriggerConfigFields(pigeon)}
                        </div>
                        
                        <!-- Conditions -->
                        <div style="flex: 1;">
                            <div style="font-size: 0.625rem; font-weight: 700; color: #888; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.05em;">Conditions (all must match)</div>
                            <div style="display: flex; gap: 0.25rem; margin-bottom: 0.5rem;">
                                <select id="pigeon-condition-type-${pigeon.id}" style="
                                    flex: 1;
                                    background: #0d0d0d;
                                    border: 1px solid #333;
                                    color: #ccc;
                                    padding: 0.375rem;
                                    font-size: 0.625rem;
                                    border-radius: 3px;
                                    font-family: 'SF Mono', Monaco, monospace;
                                ">
                                    <option value="">Select condition...</option>
                                    <optgroup label="Canon Conditions">
                                        <option value="has_canon">Has Canon Key</option>
                                        <option value="hasnt_canon">Hasn't Canon Key</option>
                                        <option value="canon_equals">Canon Equals Value</option>
                                        <option value="user_canon_equals">User Canon Equals</option>
                                        <option value="user_canon_not_equals">User Canon Not Equals</option>
                                        <option value="user_in_canon_list">User In Canon List</option>
                                        <option value="count_canon">Count Canon</option>
                                    </optgroup>
                                    <optgroup label="Role & User">
                                        <option value="has_role">Has Role</option>
                                        <option value="dreamer_replies">Dreamer Has Replied</option>
                                    </optgroup>
                                    <optgroup label="Souvenirs">
                                        <option value="user_has_souvenir">Has Souvenir</option>
                                        <option value="user_missing_souvenir">Missing Souvenir</option>
                                        <option value="souvenir_exists_anywhere">Souvenir Exists</option>
                                    </optgroup>
                                    <optgroup label="Reading & Biblio">
                                        <option value="has_read">Has Read Book</option>
                                        <option value="has_read_author">Has Read Author</option>
                                        <option value="has_read_book">Has Read Specific Book</option>
                                        <option value="has_biblio_stamp">Has Biblio Stamp</option>
                                        <option value="book_count_min">Min Book Count</option>
                                    </optgroup>
                                    <optgroup label="Reply Content">
                                        <option value="any_reply">Any Reply</option>
                                        <option value="new_reply">New Reply</option>
                                        <option value="reply_contains">Reply Contains Text</option>
                                        <option value="contains_hashtags">Contains Hashtags</option>
                                        <option value="contains_mentions">Contains Mentions</option>
                                    </optgroup>
                                </select>
                                <button onclick="addConditionFromDropdown(${pigeon.id})" style="
                                    padding: 0.375rem 0.625rem;
                                    background: #fef9c3;
                                    border: 1px solid #ca8a04;
                                    border-radius: 3px;
                                    color: #854d0e;
                                    font-size: 0.625rem;
                                    font-weight: 600;
                                    cursor: pointer;
                                    font-family: 'SF Mono', Monaco, monospace;
                                    text-transform: uppercase;
                                    white-space: nowrap;
                                ">Add</button>
                            </div>
                            <div id="pigeon-condition-fields-${pigeon.id}" style="margin-bottom: 0.5rem;"></div>
                            ${conditionCardsHTML || '<div style="font-size: 0.65rem; color: #555; font-style: italic; text-align: center; padding: 0.75rem; background: #0d0d0d; border-radius: 3px;">No conditions - will trigger for all users</div>'}
                        </div>
                        
                        <!-- Template -->
                        <div>
                            <div style="font-size: 0.625rem; font-weight: 700; color: #888; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.05em;">Message Template</div>
                            <select onchange="updatePigeonField(${pigeon.id}, 'dialogue_key', this.value)"
                                    style="
                                        width: 100%;
                                        background: #0d0d0d;
                                        border: 1px solid #333;
                                        color: #ccc;
                                        padding: 0.375rem;
                                        font-size: 0.7rem;
                                        border-radius: 3px;
                                        font-family: 'SF Mono', Monaco, monospace;
                                    ">
                                <option value="">No template</option>
                                ${Object.keys(dialogueData).sort().map(k => 
                                    `<option value="${k}" ${pigeon.dialogue_key === k ? 'selected' : ''}>${k}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <!-- Behavior -->
                        <div>
                            <div style="font-size: 0.625rem; font-weight: 700; color: #888; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.05em;">Behavior</div>
                            <button onclick="togglePigeonRepeating(${pigeon.id})" 
                                    style="
                                        padding: 0.375rem 0.5rem;
                                        background: ${pigeon.repeating ? '#dcfce7' : '#fef3c7'};
                                        border: 1px solid ${pigeon.repeating ? '#16a34a' : '#ca8a04'};
                                        color: ${pigeon.repeating ? '#15803d' : '#854d0e'};
                                        border-radius: 3px;
                                        cursor: pointer;
                                        font-size: 0.625rem;
                                        font-weight: 600;
                                        font-family: 'SF Mono', Monaco, monospace;
                                        text-transform: uppercase;
                                        letter-spacing: 0.05em;
                                    ">
                                ${pigeon.repeating ? 'Repeating' : 'Once Per User'}
                            </button>
                            <div style="font-size: 0.625rem; color: #666; margin-top: 0.25rem; font-style: italic;">
                                ${pigeon.repeating ? 'Sends every time trigger fires' : 'Self-destructs after first use'}
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div style="
                            padding-top: 0.75rem;
                            border-top: 1px solid #2a2a2a;
                            display: flex;
                            gap: 0.5rem;
                        ">
                            <button onclick="savePigeon(${pigeon.id})" 
                                    style="
                                        flex: 1;
                                        padding: 0.625rem;
                                        background: #dcfce7;
                                        border: 1px solid #16a34a;
                                        color: #15803d;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 0.7rem;
                                        font-weight: 600;
                                        font-family: 'SF Mono', Monaco, monospace;
                                        text-transform: uppercase;
                                    ">üíæ Save</button>
                            <button onclick="duplicatePigeon(${pigeon.id})" 
                                    style="
                                        padding: 0.625rem 0.75rem;
                                        background: #dbeafe;
                                        border: 1px solid #3b82f6;
                                        color: #1e40af;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 0.7rem;
                                        font-weight: 600;
                                        font-family: 'SF Mono', Monaco, monospace;
                                    " title="Clone this pigeon">üìã</button>
                            <button onclick="deletePigeon(${pigeon.id})" 
                                    style="
                                        padding: 0.625rem 0.75rem;
                                        background: #fee2e2;
                                        border: 1px solid #fecaca;
                                        color: #991b1b;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 0.7rem;
                                        font-weight: 600;
                                        font-family: 'SF Mono', Monaco, monospace;
                                    ">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function filterPigeonsData() {
            let filtered = [...pigeonsData];
            
            // Search filter
            const searchTerm = document.getElementById('pigeon-search')?.value.toLowerCase() || '';
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.dialogue_key?.toLowerCase().includes(searchTerm) ||
                    p.trigger_type.toLowerCase().includes(searchTerm)
                );
            }
            
            // Status filter
            const showActive = document.getElementById('filter-active')?.checked !== false;
            const showPaused = document.getElementById('filter-paused')?.checked !== false;
            const showDraft = document.getElementById('filter-draft')?.checked !== false;
            
            filtered = filtered.filter(p => {
                if (p.status === 'active' && !showActive) return false;
                if (p.status === 'paused' && !showPaused) return false;
                if (p.status === 'draft' && !showDraft) return false;
                return true;
            });
            
            // Trigger type filter
            const triggerFilter = document.getElementById('filter-trigger')?.value || '';
            if (triggerFilter) {
                filtered = filtered.filter(p => p.trigger_type === triggerFilter);
            }
            
            // Sort
            const sortBy = document.getElementById('pigeon-sort')?.value || 'name';
            filtered.sort((a, b) => {
                if (sortBy === 'name') return a.name.localeCompare(b.name);
                if (sortBy === 'status') return a.status.localeCompare(b.status);
                if (sortBy === 'trigger') return a.trigger_type.localeCompare(b.trigger_type);
                if (sortBy === 'created') return (b.created_at || '').localeCompare(a.created_at || '');
                return 0;
            });
            
            return filtered;
        }
        
        function filterPigeons() {
            // Re-render with current filters
            renderPigeonsGrid();
        }
        
        function selectPigeon(pigeonId) {
            selectedPigeonId = pigeonId;
            renderPigeonsGrid();
            renderPigeonEditor();
        }
        
        function showPigeonsPanel() {
            // Hide templates view, show pigeons grid
            document.getElementById('dialogue-list').style.display = 'none';
            document.getElementById('pigeons-grid-view').style.display = 'block';
            
            // Render pigeons in grid
            renderPigeonsGrid();
        }
        
        function renderPigeonEditor() {
            const pigeon = pigeonsData.find(p => p.id === selectedPigeonId);
            if (!pigeon) {
                showPigeonsPanel();
                return;
            }
            
            const container = document.getElementById('dialogue-list');
            
            // Parse conditions (should be array format for aviary.py)
            let conditions = [];
            try {
                if (pigeon.conditions) {
                    conditions = typeof pigeon.conditions === 'string' 
                        ? JSON.parse(pigeon.conditions) 
                        : pigeon.conditions;
                }
                // Ensure it's an array
                if (!Array.isArray(conditions)) {
                    conditions = [];
                }
            } catch (e) {
                console.error('Failed to parse pigeon conditions:', e);
                conditions = [];
            }
            
            const conditionsJSON = JSON.stringify(conditions, null, 2);
            const codeHTML = conditionsJSON
                .replace(/"([^"]+)":/g, '<span class="code-key">"$1"</span>:')
                .replace(/: "([^"]+)"/g, ': <span class="code-value">"$1"</span>')
                .replace(/: (true|false)/g, ': <span class="code-boolean">$1</span>');
            
            // Build condition cards from array
            let conditionCardsHTML = '';
            conditions.forEach((cond, idx) => {
                const condType = cond.type || 'unknown';
                let displayText = '';
                
                if (condType === 'has_canon') {
                    displayText = `Has canon key: <code>${cond.key || '?'}</code>`;
                } else if (condType === 'canon_equals') {
                    displayText = `Canon <code>${cond.key || '?'}</code> = <code>${cond.value || '?'}</code>`;
                } else if (condType === 'has_role') {
                    displayText = `Has role: <code>${cond.role || '?'}</code>`;
                } else {
                    displayText = `<code>${JSON.stringify(cond)}</code>`;
                }
                
                conditionCardsHTML += `
                    <div class="dialogue-condition-card">
                        <button class="remove-condition" onclick="removePigeonCondition(${pigeon.id}, ${idx})" title="Remove condition">√ó</button>
                        <div>${displayText}</div>
                    </div>
                `;
            });
            
            const statusOptions = ['active', 'paused', 'draft'];
            const statusLabels = {
                'active': 'Active',
                'paused': 'Paused',
                'draft': 'Draft'
            };
            
            const triggerTypes = [
                { value: 'quest_started', label: 'Quest Started', desc: 'When user starts a specific quest' },
                { value: 'quest_completed', label: 'Quest Completed', desc: 'When user completes a specific quest' },
                { value: 'quest_abandoned', label: 'Quest Abandoned', desc: 'When user abandons a quest' },
                { value: 'canon_set', label: 'Canon Key Set', desc: 'When a canon key is set to any value' },
                { value: 'canon_equals', label: 'Canon Value Match', desc: 'When canon key equals specific value' },
                { value: 'canon_changed', label: 'Canon Value Changed', desc: 'When canon value changes' },
                { value: 'role_granted', label: 'Role Granted', desc: 'When user receives a new role (greeter, resident, mapper)' },
                { value: 'role_revoked', label: 'Role Revoked', desc: 'When user loses a role' },
                { value: 'first_login', label: 'First Login', desc: 'User\'s very first login to the system' },
                { value: 'return_visit', label: 'Return Visit', desc: 'User returns after N days away' },
                { value: 'page_visit', label: 'Page Visited', desc: 'User visits a specific page' },
                { value: 'dream_posted', label: 'Dream Posted', desc: 'User posts to dreamstream' },
                { value: 'reaction_received', label: 'Reaction Received', desc: 'User receives a reaction on their dream' },
                { value: 'message_read', label: 'Message Read', desc: 'User reads a specific message' },
                { value: 'message_dismissed', label: 'Message Dismissed', desc: 'User dismisses a message' },
                { value: 'stat_threshold', label: 'Stat Threshold', desc: 'Database stat crosses threshold' },
                { value: 'time_based', label: 'Time-Based (Cron)', desc: 'Specific time/schedule' },
                { value: 'idle_duration', label: 'Idle Duration', desc: 'User inactive for N days' },
                { value: 'manual', label: 'Manual Trigger', desc: 'Manually triggered only' }
            ];
            
            container.innerHTML = `
                <div class="dialogue-section">
                    <div class="dialogue-group">
                        <!-- Header -->
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #333;">
                            <input type="text" 
                                   value="${pigeon.name}" 
                                   onblur="updatePigeonField(${pigeon.id}, 'name', this.value)"
                                   style="font-family: 'SF Mono', Monaco, monospace; font-size: 1rem; font-weight: 700; color: var(--primary-color); border: none; outline: none; padding: 0.25rem 0.5rem; background: transparent; flex: 1;">
                            <select onchange="updatePigeonField(${pigeon.id}, 'status', this.value)" 
                                    style="padding: 0.25rem 0.5rem; border: 1px solid #333; background: #0d0d0d; color: #e0e0e0; font-size: 0.65rem; font-family: 'SF Mono', Monaco, monospace; text-transform: uppercase; font-weight: 600;">
                                ${statusOptions.map(opt => `<option value="${opt}" ${pigeon.status === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                        
                        <!-- Trigger -->
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: #1a1a1a; border: 1px solid #333;">
                            ${renderTriggerConfig(pigeon)}
                        </div>
                        
                        <!-- Message Template -->
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.65rem; font-weight: 600; color: #888; margin-bottom: 0.375rem; text-transform: uppercase; font-family: 'SF Mono', Monaco, monospace;">Message</label>
                            <select onchange="updatePigeonField(${pigeon.id}, 'dialogue_key', this.value)" 
                                    style="width: 100%; padding: 0.375rem 0.5rem; border: 1px solid #333; background: #0d0d0d; color: #e0e0e0; font-size: 0.75rem; font-family: 'SF Mono', Monaco, monospace;">
                                <option value="">Select template...</option>
                                ${Object.keys(dialogueData).sort().map(key => `<option value="${key}" ${pigeon.dialogue_key === key ? 'selected' : ''}>${key}</option>`).join('')}
                            </select>
                        </div>
                        
                        <!-- Settings (Compact Grid) -->
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: #1a1a1a; border: 1px solid #333;">
                            <div style="font-size: 0.65rem; font-weight: 700; color: #999; margin-bottom: 0.5rem; text-transform: uppercase; font-family: 'SF Mono', Monaco, monospace;">‚öôÔ∏è Settings</div>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; align-items: center; font-size: 0.7rem;">
                                <label style="color: #888; font-size: 0.65rem; font-family: 'SF Mono', Monaco, monospace;">Priority</label>
                                <div>
                                    <input type="number" value="${pigeon.priority || 50}" min="0" max="100" onblur="updatePigeonField(${pigeon.id}, 'priority', parseInt(this.value))" style="width: 70px; padding: 0.25rem 0.375rem; border: 1px solid #333; background: #0d0d0d; color: #e0e0e0; font-size: 0.7rem; font-family: 'SF Mono', Monaco, monospace;">
                                    <span style="font-size: 0.6rem; color: #666; margin-left: 0.375rem;">0-100</span>
                                </div>
                                
                                <label style="color: #888; font-size: 0.65rem; font-family: 'SF Mono', Monaco, monospace;">Once Per User?</label>
                                <label style="display: inline-flex; align-items: center; gap: 0.375rem; cursor: pointer;">
                                    <input type="checkbox" ${!pigeon.repeating ? 'checked' : ''} onchange="updatePigeonField(${pigeon.id}, 'repeating', !this.checked)" style="width: 14px; height: 14px;">
                                    <span style="font-size: 0.65rem; color: #aaa; font-family: 'SF Mono', Monaco, monospace;">${!pigeon.repeating ? 'Yes' : 'No (unlimited)'}</span>
                                </label>
                                
                                <label style="color: #888; font-size: 0.65rem; font-family: 'SF Mono', Monaco, monospace;">Max Sends</label>
                                <div>
                                    <input type="number" value="${pigeon.max_deliveries || 0}" min="0" placeholder="0" onblur="updatePigeonField(${pigeon.id}, 'max_deliveries', parseInt(this.value) || 0)" style="width: 70px; padding: 0.25rem 0.375rem; border: 1px solid #333; background: #0d0d0d; color: #e0e0e0; font-size: 0.7rem; font-family: 'SF Mono', Monaco, monospace;">
                                    <span style="font-size: 0.6rem; color: #666; margin-left: 0.375rem;">0=‚àû</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conditions -->
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: #1a1a1a; border: 1px solid #333;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-size: 0.65rem; font-weight: 700; color: #999; text-transform: uppercase; font-family: 'SF Mono', Monaco, monospace;">üéØ Conditions</div>
                                <button onclick="showPigeonConditionDropdown(${pigeon.id})" style="padding: 0.25rem 0.5rem; background: #2d7a3e; color: white; border: none; font-size: 0.6rem; font-weight: 600; cursor: pointer; font-family: 'SF Mono', Monaco, monospace; text-transform: uppercase;">+ Add</button>
                            </div>
                            ${conditionCardsHTML || '<div style="font-size: 0.65rem; color: #666; font-style: italic; padding: 0.5rem; text-align: center; background: #0d0d0d; border: 1px dashed #444;">No conditions</div>'}
                        </div>
                            
                        <!-- Actions -->
                        <div style="display: flex; gap: 0.5rem; padding-top: 0.75rem; border-top: 1px solid #333;">
                            <button onclick="savePigeon(${pigeon.id})" style="flex: 1; padding: 0.5rem; background: #1a2d1a; color: #22c55e; border: 1px solid #16a34a; font-size: 0.7rem; font-weight: 600; cursor: pointer; font-family: 'SF Mono', Monaco, monospace; text-transform: uppercase;">üíæ Save</button>
                            <button onclick="testPigeon(${pigeon.id})" style="flex: 1; padding: 0.5rem; background: #1a1a1a; color: #3b82f6; border: 1px solid #3b82f6; font-size: 0.7rem; font-weight: 600; cursor: pointer; font-family: 'SF Mono', Monaco, monospace; text-transform: uppercase;">üß™ Test</button>
                            <button onclick="deletePigeon(${pigeon.id})" style="flex: 1; padding: 0.5rem; background: #2d1a1a; color: #ef4444; border: 1px solid #7f1d1d; font-size: 0.7rem; font-weight: 600; cursor: pointer; font-family: 'SF Mono', Monaco, monospace; text-transform: uppercase;">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function showCreatePigeonModal() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            overlay.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Create New Automation Pigeon</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-form-group">
                            <label class="modal-form-label">Pigeon Name *</label>
                            <input type="text" class="modal-form-input" id="new-pigeon-name" 
                                   placeholder="e.g., Welcome New Residents, Quest Watson Reward, Daily Zone Check">
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.375rem;">
                                Give your pigeon a descriptive name to identify its purpose
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="modal-btn primary" onclick="createPigeon()">Create & Configure</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Focus the input
            setTimeout(() => {
                document.getElementById('new-pigeon-name').focus();
            }, 100);
        }
        
        async function createPigeon() {
            const name = document.getElementById('new-pigeon-name').value.trim();
            
            console.log('üïäÔ∏è [CREATE] Creating new pigeon:', name);
            
            if (!name) {
                console.warn('üïäÔ∏è [CREATE] Name validation failed - empty name');
                await showAlert('Please enter a pigeon name', 'error');
                return;
            }
            
            // Create locally first since backend doesn't exist yet
            const newPigeon = {
                id: Date.now(), // Temporary ID
                name: name,
                status: 'paused',
                trigger_type: 'manual',
                dialogue_key: null,
                priority: 50,
                repeating: true,
                max_deliveries: 0,
                conditions: {},
                trigger_config: {}
            };
            
            const payload = {
                name: name,
                status: 'paused',
                trigger_type: 'manual',
                priority: 50,
                repeating: true
            };
            
            console.log('üïäÔ∏è [CREATE] Sending payload to API:', payload);
            
            try {
                const response = await authenticatedFetch('/api/pigeons/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('üïäÔ∏è [CREATE] API response status:', response.status, response.statusText);
                
                // Check if response is OK before parsing JSON
                if (!response.ok) {
                    console.error('üïäÔ∏è [CREATE] API error:', response.status);
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log('üïäÔ∏è [CREATE] API result:', result);
                
                if (result.status === 'success') {
                    newPigeon.id = result.pigeon.id;
                    pigeonsData.push(newPigeon);
                    console.log('‚úÖ [CREATE] Pigeon created successfully with ID:', newPigeon.id);
                    console.log('üïäÔ∏è [CREATE] Updated pigeonsData:', pigeonsData);
                    document.querySelector('.modal-overlay').remove();
                    selectedPigeonId = newPigeon.id;
                    renderPigeonsList();
                    renderPigeonEditor();
                    await showAlert('Pigeon created successfully!', 'success');
                } else {
                    console.error('üïäÔ∏è [CREATE] API returned error:', result.error);
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('‚ùå [CREATE] Error creating pigeon:', error);
                console.error('‚ùå [CREATE] Error stack:', error.stack);
                await showAlert(`Failed to create pigeon: ${error.message}`, 'error');
            }
        }
        
        
        function renderTriggerConfig(pigeon) {
            const config = pigeon.trigger_config || {};
            const triggerType = pigeon.trigger_type || 'manual';
            
            // Common field styles - matching site standards
            const selectStyle = 'width: 100%; padding: 0.5rem; border: 1px solid #333; background: #0d0d0d; color: #e0e0e0; font-size: 0.75rem; font-family: "SF Mono", Monaco, monospace;';
            const inputStyle = 'width: 100%; padding: 0.5rem; border: 1px solid #333; background: #0d0d0d; color: #e0e0e0; font-size: 0.75rem; font-family: "SF Mono", Monaco, monospace;';
            const labelStyle = 'display: block; font-size: 0.625rem; font-weight: 600; color: #888; margin-bottom: 0.4rem; font-family: "SF Mono", Monaco, monospace; text-transform: uppercase; letter-spacing: 0.05em;';
            const hintStyle = 'font-size: 0.6rem; color: #666; margin-top: 0.3rem; line-height: 1.4; font-family: "SF Mono", Monaco, monospace;';
            
            // Use cached trigger types from API, or fall back to minimal list
            let triggerTypes = triggerTypesCache.length > 0 ? triggerTypesCache : [
                { type: 'manual', name: 'Manual Only', description: 'Admin-triggered only' },
                { type: 'first_login', name: 'First Login', description: "User's first login ever" },
                { type: 'gained_role', name: 'Gained Role', description: 'When user receives a role' }
            ];
            
            // Group triggers by category if available, otherwise use simple list
            let triggerSelectHTML = '';
            
            if (triggerTypes[0] && triggerTypes[0].description) {
                // New API format with descriptions
                const categories = {
                    'User Journey': [],
                    'Quest Events': [],
                    'Canon Events': [],
                    'Role Events': [],
                    'Activity': [],
                    'Scheduled': [],
                    'Other': []
                };
                
                // Categorize triggers
                triggerTypes.forEach(t => {
                    let category = 'Other';
                    if (t.type.includes('quest')) category = 'Quest Events';
                    else if (t.type.includes('canon')) category = 'Canon Events';
                    else if (t.type.includes('role')) category = 'Role Events';
                    else if (t.type.includes('login') || t.type.includes('visit') || t.type.includes('page')) category = 'User Journey';
                    else if (t.type.includes('posted') || t.type.includes('reaction') || t.type.includes('message')) category = 'Activity';
                    else if (t.type.includes('time') || t.type.includes('idle')) category = 'Scheduled';
                    
                    categories[category].push(t);
                });
                
                // Build select HTML with optgroups
                triggerSelectHTML = `
                    <select onchange="changePigeonTriggerType(${pigeon.id}, this.value)" style="${selectStyle}">
                        ${Object.keys(categories).filter(cat => categories[cat].length > 0).map(cat => `
                            <optgroup label="${cat}">
                                ${categories[cat].map(t => `
                                    <option value="${t.type}" ${triggerType === t.type ? 'selected' : ''} title="${t.description}">
                                        ${t.name}
                                    </option>
                                `).join('')}
                            </optgroup>
                        `).join('')}
                    </select>
                `;
            } else {
                // Simple format
                triggerSelectHTML = `
                    <select onchange="changePigeonTriggerType(${pigeon.id}, this.value)" style="${selectStyle}">
                        ${triggerTypes.map(t => `
                            <option value="${t.type}" ${triggerType === t.type ? 'selected' : ''}>
                                ${t.name}
                            </option>
                        `).join('')}
                    </select>
                `;
            }
            
            let specificConfigHTML = '';
            
            switch(triggerType) {
                case 'canon_set':
                    specificConfigHTML = `
                        <div style="margin-top: 1rem;">
                            <label style="${labelStyle}">Canon Key</label>
                            <input type="text" 
                                   value="${config.canon_key || ''}" 
                                   placeholder="e.g., name, zone, residence"
                                   onblur="updateTriggerConfigField(${pigeon.id}, 'canon_key', this.value)"
                                   style="${inputStyle}">
                            <div style="${hintStyle}">Triggers when this canon key is set to any value</div>
                        </div>
                    `;
                    break;
                    
                case 'canon_equals':
                    specificConfigHTML = `
                        <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="${labelStyle}">Canon Key</label>
                                <input type="text" 
                                       value="${config.canon_key || ''}" 
                                       placeholder="e.g., zone"
                                       onblur="updateTriggerConfigField(${pigeon.id}, 'canon_key', this.value)"
                                       style="${inputStyle}">
                            </div>
                            <div>
                                <label style="${labelStyle}">Value</label>
                                <input type="text" 
                                       value="${config.value || ''}" 
                                       placeholder="e.g., 1"
                                       onblur="updateTriggerConfigField(${pigeon.id}, 'value', this.value)"
                                       style="${inputStyle}">
                            </div>
                        </div>
                        <div style="${hintStyle}; margin-top: 0.5rem;">Triggers when canon key equals this exact value</div>
                    `;
                    break;
                    
                case 'role_granted':
                case 'role_revoked':
                    specificConfigHTML = `
                        <div style="margin-top: 1rem;">
                            <label style="${labelStyle}">Role</label>
                            <select onchange="updateTriggerConfigField(${pigeon.id}, 'role', this.value)" style="${selectStyle}">
                                <option value="">Select role...</option>
                                <option value="greeter" ${config.role === 'greeter' ? 'selected' : ''}>Greeter</option>
                                <option value="resident" ${config.role === 'resident' ? 'selected' : ''}>Resident</option>
                                <option value="mapper" ${config.role === 'mapper' ? 'selected' : ''}>Mapper</option>
                            </select>
                            <div style="${hintStyle}">Which role to monitor for ${triggerType === 'role_granted' ? 'granting' : 'revocation'}</div>
                        </div>
                    `;
                    break;
                    
                case 'first_login':
                    specificConfigHTML = `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: #1a1a1a; border: 1px solid #333;">
                            <div style="font-size: 0.7rem; color: #999; font-family: 'SF Mono', Monaco, monospace;">No configuration needed</div>
                            <div style="font-size: 0.625rem; color: #666; margin-top: 0.25rem; font-family: 'SF Mono', Monaco, monospace;">
                                Automatically triggers when a user logs in for the very first time
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'return_visit':
                    specificConfigHTML = `
                        <div style="margin-top: 1rem;">
                            <label style="${labelStyle}">Days Away</label>
                            <input type="number" 
                                   value="${config.days_away || 7}" 
                                   min="1"
                                   placeholder="7"
                                   onblur="updateTriggerConfigField(${pigeon.id}, 'days_away', parseInt(this.value))"
                                   style="${inputStyle}">
                            <div style="${hintStyle}">Triggers when user returns after being inactive for this many days</div>
                        </div>
                    `;
                    break;
                    
                case 'time_based':
                    specificConfigHTML = `
                        <div style="margin-top: 1rem;">
                            <label style="${labelStyle}">Schedule Type</label>
                            <select onchange="updateTriggerConfigField(${pigeon.id}, 'schedule', this.value); renderPigeonEditor();" style="${selectStyle}">
                                <option value="daily" ${config.schedule === 'daily' ? 'selected' : ''}>Daily</option>
                                <option value="weekly" ${config.schedule === 'weekly' ? 'selected' : ''}>Weekly</option>
                                <option value="monthly" ${config.schedule === 'monthly' ? 'selected' : ''}>Monthly</option>
                            </select>
                        </div>
                        ${config.schedule === 'weekly' ? `
                            <div style="margin-top: 1rem;">
                                <label style="${labelStyle}">Day of Week</label>
                                <select onchange="updateTriggerConfigField(${pigeon.id}, 'day', this.value)" style="${selectStyle}">
                                    <option value="monday" ${config.day === 'monday' ? 'selected' : ''}>Monday</option>
                                    <option value="tuesday" ${config.day === 'tuesday' ? 'selected' : ''}>Tuesday</option>
                                    <option value="wednesday" ${config.day === 'wednesday' ? 'selected' : ''}>Wednesday</option>
                                    <option value="thursday" ${config.day === 'thursday' ? 'selected' : ''}>Thursday</option>
                                    <option value="friday" ${config.day === 'friday' ? 'selected' : ''}>Friday</option>
                                    <option value="saturday" ${config.day === 'saturday' ? 'selected' : ''}>Saturday</option>
                                    <option value="sunday" ${config.day === 'sunday' ? 'selected' : ''}>Sunday</option>
                                </select>
                            </div>
                        ` : ''}
                        ${config.schedule === 'monthly' ? `
                            <div style="margin-top: 1rem;">
                                <label style="${labelStyle}">Day of Month</label>
                                <input type="number" 
                                       value="${config.day || 1}" 
                                       min="1"
                                       max="31"
                                       onblur="updateTriggerConfigField(${pigeon.id}, 'day', parseInt(this.value))"
                                       style="${inputStyle}">
                                <div style="${hintStyle}">Day of month (1-31)</div>
                            </div>
                        ` : ''}
                        <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="${labelStyle}">Hour (24h)</label>
                                <input type="number" 
                                       value="${config.hour || 9}" 
                                       min="0"
                                       max="23"
                                       onblur="updateTriggerConfigField(${pigeon.id}, 'hour', parseInt(this.value))"
                                       style="${inputStyle}">
                            </div>
                            <div>
                                <label style="${labelStyle}">Minute</label>
                                <input type="number" 
                                       value="${config.minute || 0}" 
                                       min="0"
                                       max="59"
                                       onblur="updateTriggerConfigField(${pigeon.id}, 'minute', parseInt(this.value))"
                                       style="${inputStyle}">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'idle_duration':
                    specificConfigHTML = `
                        <div style="margin-top: 1rem;">
                            <label style="${labelStyle}">Idle Days</label>
                            <input type="number" 
                                   value="${config.days || 7}" 
                                   min="1"
                                   placeholder="7"
                                   onblur="updateTriggerConfigField(${pigeon.id}, 'days', parseInt(this.value))"
                                   style="${inputStyle}">
                            <div style="${hintStyle}">Triggers when user has been inactive (no login) for this many days</div>
                        </div>
                    `;
                    break;
                    
                case 'manual':
                    specificConfigHTML = `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: #1a1a1a; border: 1px solid #333;">
                            <div style="font-size: 0.7rem; color: #999; font-family: 'SF Mono', Monaco, monospace;">Manual Trigger Only</div>
                            <div style="font-size: 0.625rem; color: #666; margin-top: 0.25rem; font-family: 'SF Mono', Monaco, monospace;">
                                This pigeon will not fire automatically. Must be manually triggered via API.
                            </div>
                        </div>
                    `;
                    break;
            }
            
            return `
                <div>
                    <label style="${labelStyle}">Trigger Type</label>
                    ${triggerSelectHTML}
                </div>
                ${specificConfigHTML}
            `;
        }
        
        function changePigeonTriggerType(pigeonId, newType) {
            console.log(`üïäÔ∏è [TRIGGER_TYPE] Changing pigeon ${pigeonId} trigger type to: ${newType}`);
            
            updatePigeonField(pigeonId, 'trigger_type', newType);
            // Reset trigger config when changing types
            const pigeon = pigeonsData.find(p => p.id === pigeonId);
            if (pigeon) {
                pigeon.trigger_config = {};
                console.log(`üïäÔ∏è [TRIGGER_TYPE] Resetting trigger_config to empty object`);
                updatePigeonField(pigeonId, 'trigger_config', {});
            }
            renderPigeonEditor();
        }
        
        function updateTriggerConfigField(pigeonId, field, value) {
            console.log(`üïäÔ∏è [TRIGGER_CONFIG] Updating field '${field}' for pigeon ${pigeonId} to:`, value);
            
            const pigeon = pigeonsData.find(p => p.id === pigeonId);
            if (!pigeon) {
                console.error(`üïäÔ∏è [TRIGGER_CONFIG] Pigeon ${pigeonId} not found`);
                return;
            }
            
            if (!pigeon.trigger_config) pigeon.trigger_config = {};
            pigeon.trigger_config[field] = value;
            
            console.log(`üïäÔ∏è [TRIGGER_CONFIG] Updated trigger_config:`, pigeon.trigger_config);
            
            // Send as object, not JSON string
            updatePigeonField(pigeonId, 'trigger_config', pigeon.trigger_config);
        }
        
        function getTriggerConfigHelp(triggerType) {
            const examples = {
                'quest_started': '<strong>Quest Started</strong><br>{"quest_key": "quest_watson"}<br>Triggers when user starts the specified quest',
                'quest_completed': '<strong>Quest Completed</strong><br>{"quest_key": "quest_watson"}<br>Triggers when user completes the specified quest',
                'quest_abandoned': '<strong>Quest Abandoned</strong><br>{"quest_key": "quest_watson"}<br>Triggers when user abandons the quest',
                'canon_set': '<strong>Canon Key Set</strong><br>{"canon_key": "zone"}<br>Triggers when the specified canon key gets any value',
                'canon_equals': '<strong>Canon Value Match</strong><br>{"canon_key": "zone", "value": "1"}<br>Triggers when canon equals specific value',
                'canon_changed': '<strong>Canon Value Changed</strong><br>{"canon_key": "zone", "from": "0", "to": "1"}<br>Triggers on specific value change (from/to optional)',
                'role_granted': '<strong>Role Granted</strong><br>{"role": "greeter"}<br>Triggers when user receives the role (greeter/resident/mapper)',
                'role_revoked': '<strong>Role Revoked</strong><br>{"role": "greeter"}<br>Triggers when user loses the role',
                'first_login': '<strong>First Login</strong><br>{}<br>No config needed - triggers on user\'s first ever login',
                'return_visit': '<strong>Return Visit</strong><br>{"days_away": 7}<br>Triggers when user returns after N days of inactivity',
                'page_visit': '<strong>Page Visited</strong><br>{"page": "spectrum"}<br>Triggers when user visits the specified page',
                'dream_posted': '<strong>Dream Posted</strong><br>{"min_length": 100}<br>Triggers when user posts a dream (optional min_length)',
                'reaction_received': '<strong>Reaction Received</strong><br>{"reaction_type": "share"}<br>Triggers when dream gets a reaction (optional type filter)',
                'message_read': '<strong>Message Read</strong><br>{"message_id": 123}<br>Triggers when user reads specific message (or any if omitted)',
                'message_dismissed': '<strong>Message Dismissed</strong><br>{"message_id": 123}<br>Triggers when user dismisses message',
                'stat_threshold': '<strong>Stat Threshold</strong><br>{"stat": "newcomer_count", "operator": ">", "value": 100}<br>Triggers when stat crosses threshold (operators: >, <, >=, <=, ==)',
                'time_based': '<strong>Time-Based (Cron)</strong><br>{"schedule": "daily", "hour": 9, "minute": 0}<br>OR {"schedule": "weekly", "day": "monday", "hour": 10}<br>OR {"schedule": "monthly", "day": 1, "hour": 12}',
                'idle_duration': '<strong>Idle Duration</strong><br>{"days": 30}<br>Triggers when user has been inactive for N days',
                'manual': '<strong>Manual Trigger</strong><br>{}<br>No automatic trigger - must be manually invoked via API or admin'
            };
            
            return examples[triggerType] || 'Configure trigger-specific parameters in JSON format';
        }
        
        function updateTriggerConfigHelp(triggerType) {
            // Find the current pigeon ID from the select element
            const selectElement = document.querySelector(`select[id^="pigeon-trigger-type-"]`);
            if (!selectElement) return;
            
            const pigeonId = selectElement.id.replace('pigeon-trigger-type-', '');
            const helpDiv = document.getElementById(`trigger-config-help-${pigeonId}`);
            const descDiv = document.getElementById(`trigger-type-desc-${pigeonId}`);
            
            if (helpDiv) {
                helpDiv.innerHTML = getTriggerConfigHelp(triggerType);
            }
            
            if (descDiv) {
                const triggerTypes = [
                    { value: 'quest_started', label: 'Quest Started', desc: 'When user starts a specific quest' },
                    { value: 'quest_completed', label: 'Quest Completed', desc: 'When user completes a specific quest' },
                    { value: 'quest_abandoned', label: 'Quest Abandoned', desc: 'When user abandons a quest' },
                    { value: 'canon_set', label: 'Canon Key Set', desc: 'When a canon key is set to any value' },
                    { value: 'canon_equals', label: 'Canon Value Match', desc: 'When canon key equals specific value' },
                    { value: 'canon_changed', label: 'Canon Value Changed', desc: 'When canon value changes' },
                    { value: 'role_granted', label: 'Role Granted', desc: 'When user receives a new role (greeter, resident, mapper)' },
                    { value: 'role_revoked', label: 'Role Revoked', desc: 'When user loses a role' },
                    { value: 'first_login', label: 'First Login', desc: 'User\'s very first login to the system' },
                    { value: 'return_visit', label: 'Return Visit', desc: 'User returns after N days away' },
                    { value: 'page_visit', label: 'Page Visited', desc: 'User visits a specific page' },
                    { value: 'dream_posted', label: 'Dream Posted', desc: 'User posts to dreamstream' },
                    { value: 'reaction_received', label: 'Reaction Received', desc: 'User receives a reaction on their dream' },
                    { value: 'message_read', label: 'Message Read', desc: 'User reads a specific message' },
                    { value: 'message_dismissed', label: 'Message Dismissed', desc: 'User dismisses a message' },
                    { value: 'stat_threshold', label: 'Stat Threshold', desc: 'Database stat crosses threshold' },
                    { value: 'time_based', label: 'Time-Based (Cron)', desc: 'Specific time/schedule' },
                    { value: 'idle_duration', label: 'Idle Duration', desc: 'User inactive for N days' },
                    { value: 'manual', label: 'Manual Trigger', desc: 'Manually triggered only' }
                ];
                const trigger = triggerTypes.find(t => t.value === triggerType);
                if (trigger) {
                    descDiv.textContent = trigger.desc;
                }
            }
        }
        
        async function updatePigeonField(pigeonId, field, value) {
            console.log(`üïäÔ∏è [UPDATE] Updating pigeon ${pigeonId} field '${field}' to:`, value);
            
            const payload = {
                id: pigeonId,
                [field]: value
            };
            
            console.log('üïäÔ∏è [UPDATE] Payload:', payload);
            
            try {
                const response = await authenticatedFetch('/api/pigeons/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('üïäÔ∏è [UPDATE] API response:', response.status, response.statusText);
                
                // Check if response is OK
                if (!response.ok) {
                    console.error('üïäÔ∏è [UPDATE] API error:', response.status);
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log('üïäÔ∏è [UPDATE] API result:', result);
                
                if (result.status === 'success') {
                    // Update local data
                    const pigeon = pigeonsData.find(p => p.id === pigeonId);
                    if (pigeon) {
                        pigeon[field] = value;
                        console.log('‚úÖ [UPDATE] Local data updated:', pigeon);
                    }
                    renderPigeonsList();
                } else {
                    console.error('üïäÔ∏è [UPDATE] API returned error:', result.error);
                    await showAlert('Failed to update: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è [UPDATE] Backend error, updating locally:', error);
                // Update locally anyway for design testing
                const pigeon = pigeonsData.find(p => p.id === pigeonId);
                if (pigeon) {
                    pigeon[field] = value;
                    console.log('üïäÔ∏è [UPDATE] Updated locally:', pigeon);
                }
                renderPigeonsList();
            }
        }
        
        function updatePigeonTriggerType(pigeonId, triggerType) {
            // Update trigger type and re-render to show/hide config fields
            updatePigeonField(pigeonId, 'trigger_type', triggerType);
            // Clear trigger config when changing type
            const pigeon = pigeonsData.find(p => p.id === pigeonId);
            if (pigeon) {
                pigeon.trigger_config = {};
                updatePigeonField(pigeonId, 'trigger_config', {});
            }
            setTimeout(() => renderPigeonsGrid(), 100);
        }
        
        function updatePigeonTriggerConfig(pigeonId, field, value) {
            const pigeon = pigeonsData.find(p => p.id === pigeonId);
            if (!pigeon) return;
            
            if (!pigeon.trigger_config) pigeon.trigger_config = {};
            pigeon.trigger_config[field] = value;
            
            updatePigeonField(pigeonId, 'trigger_config', pigeon.trigger_config);
        }
        
        function togglePigeonRepeating(pigeonId) {
            const pigeon = pigeonsData.find(p => p.id === pigeonId);
            if (!pigeon) return;
            
            // Toggle the repeating value
            const newValue = !pigeon.repeating;
            pigeon.repeating = newValue;
            
            // Update backend and re-render
            updatePigeonField(pigeonId, 'repeating', newValue);
            setTimeout(() => renderPigeonsGrid(), 100);
        }
        
        async function addConditionFromDropdown(pigeonId) {
            const typeSelect = document.getElementById(`pigeon-condition-type-${pigeonId}`);
            const type = typeSelect?.value;
            
            if (!type) {
                await showAlert('Please select a condition type', 'error');
                return;
            }
            
            const fieldsContainer = document.getElementById(`pigeon-condition-fields-${pigeonId}`);
            
            const inputStyle = `
                width: 100%;
                background: #0d0d0d;
                border: 1px solid #333;
                color: #ccc;
                padding: 0.375rem;
                font-size: 0.625rem;
                border-radius: 3px;
                font-family: 'SF Mono', Monaco, monospace;
                margin-top: 0.25rem;
            `;
            
            const labelStyle = `
                display: block;
                font-size: 0.5625rem;
                font-weight: 600;
                color: #888;
                margin-top: 0.375rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            `;
            
            // Show appropriate input fields based on condition type
            if (type === 'has_canon' || type === 'hasnt_canon') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Canon Key</label>
                    <input type="text" id="condition-input-${pigeonId}" placeholder="e.g., zone, faction, name" style="${inputStyle}">
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'canon_equals' || type === 'user_canon_equals' || type === 'user_canon_not_equals') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Canon Key</label>
                    <input type="text" id="condition-key-${pigeonId}" placeholder="e.g., zone" style="${inputStyle}">
                    <label style="${labelStyle}">Value</label>
                    <input type="text" id="condition-value-${pigeonId}" placeholder="e.g., 1, forest" style="${inputStyle}">
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'user_in_canon_list') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Canon Key</label>
                    <input type="text" id="condition-key-${pigeonId}" placeholder="e.g., faction" style="${inputStyle}">
                    <label style="${labelStyle}">Values (comma-separated)</label>
                    <input type="text" id="condition-value-${pigeonId}" placeholder="e.g., mystic, sage, dream" style="${inputStyle}">
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'count_canon') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Canon Condition</label>
                    <input type="text" id="condition-input-${pigeonId}" placeholder="e.g., zone>=5" style="${inputStyle}">
                    <div style="font-size: 0.5rem; color: #666; margin-top: 0.25rem;">Format: key>=value or key<=value</div>
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'has_role') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Role Name</label>
                    <input type="text" id="condition-input-${pigeonId}" placeholder="e.g., admin, vip, resident" style="${inputStyle}">
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'user_has_souvenir' || type === 'user_missing_souvenir' || type === 'souvenir_exists_anywhere') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Souvenir Key</label>
                    <input type="text" id="condition-input-${pigeonId}" placeholder="e.g., namecard, badge_veteran" style="${inputStyle}">
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'has_read' || type === 'has_read_book') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Book Title</label>
                    <input type="text" id="condition-input-${pigeonId}" placeholder="e.g., The Dispossessed" style="${inputStyle}">
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'has_read_author') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Author Name</label>
                    <input type="text" id="condition-input-${pigeonId}" placeholder="e.g., Ursula K. Le Guin" style="${inputStyle}">
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'has_biblio_stamp') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">List Identifier</label>
                    <input type="text" id="condition-input-${pigeonId}" placeholder="e.g., rkey or at:// URI" style="${inputStyle}">
                    <div style="font-size: 0.5rem; color: #666; margin-top: 0.25rem;">Enter list rkey or full at:// URI</div>
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'book_count_min') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Minimum Book Count</label>
                    <input type="number" id="condition-input-${pigeonId}" placeholder="e.g., 5" min="1" style="${inputStyle}">
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'reply_contains') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Search Text</label>
                    <input type="text" id="condition-input-${pigeonId}" placeholder="e.g., hello world" style="${inputStyle}">
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'contains_hashtags') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Hashtags (comma-separated)</label>
                    <input type="text" id="condition-input-${pigeonId}" placeholder="e.g., books, reading, scifi" style="${inputStyle}">
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'contains_mentions') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Mentions (comma-separated)</label>
                    <input type="text" id="condition-input-${pigeonId}" placeholder="e.g., did:plc:abc123, handle.bsky.social" style="${inputStyle}">
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'any_reply' || type === 'new_reply' || type === 'dreamer_replies') {
                fieldsContainer.innerHTML = `
                    <div style="font-size: 0.5625rem; color: #666; margin: 0.5rem 0;">This condition requires no additional configuration.</div>
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'day_of_week') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Day</label>
                    <select id="condition-input-${pigeonId}" style="${inputStyle}">
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                        <option value="Sunday">Sunday</option>
                    </select>
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            } else if (type === 'time_range') {
                fieldsContainer.innerHTML = `
                    <label style="${labelStyle}">Start Time</label>
                    <input type="time" id="condition-start-${pigeonId}" style="${inputStyle}">
                    <label style="${labelStyle}">End Time</label>
                    <input type="time" id="condition-end-${pigeonId}" style="${inputStyle}">
                    <button onclick="submitCondition(${pigeonId}, '${type}')" style="
                        width: 100%;
                        margin-top: 0.5rem;
                        padding: 0.375rem;
                        background: #dcfce7;
                        border: 1px solid #16a34a;
                        color: #15803d;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.625rem;
                        font-weight: 600;
                        font-family: 'SF Mono', Monaco, monospace;
                        text-transform: uppercase;
                    ">Add Condition</button>
                `;
            }
        }
        
        async function submitCondition(pigeonId, type) {
            let condValue = '';
            
            // Simple input conditions (single value)
            if (['has_canon', 'hasnt_canon', 'has_role', 'user_has_souvenir', 'user_missing_souvenir', 
                 'souvenir_exists_anywhere', 'has_read', 'has_read_book', 'has_read_author', 
                 'has_biblio_stamp', 'book_count_min', 'reply_contains', 'count_canon'].includes(type)) {
                condValue = document.getElementById(`condition-input-${pigeonId}`)?.value.trim();
                if (!condValue) {
                    await showAlert('Please enter a value', 'error');
                    return;
                }
            }
            // Key-value pair conditions
            else if (['canon_equals', 'user_canon_equals', 'user_canon_not_equals', 'user_in_canon_list'].includes(type)) {
                const key = document.getElementById(`condition-key-${pigeonId}`)?.value.trim();
                const value = document.getElementById(`condition-value-${pigeonId}`)?.value.trim();
                if (!key || !value) {
                    await showAlert('Please enter both key and value', 'error');
                    return;
                }
                condValue = `${key}=${value}`;
            }
            // List conditions (comma-separated)
            else if (['contains_hashtags', 'contains_mentions'].includes(type)) {
                condValue = document.getElementById(`condition-input-${pigeonId}`)?.value.trim();
                if (!condValue) {
                    await showAlert('Please enter at least one value', 'error');
                    return;
                }
            }
            // No-config conditions
            else if (['any_reply', 'new_reply', 'dreamer_replies'].includes(type)) {
                condValue = '';  // No value needed
            }
            // Legacy time-based conditions (still supported but not recommended)
            else if (type === 'day_of_week') {
                condValue = document.getElementById(`condition-input-${pigeonId}`)?.value;
            } else if (type === 'time_range') {
                const start = document.getElementById(`condition-start-${pigeonId}`)?.value;
                const end = document.getElementById(`condition-end-${pigeonId}`)?.value;
                if (!start || !end) {
                    await showAlert('Please enter both start and end times', 'error');
                    return;
                }
                condValue = `${start}-${end}`;
            }
            
            // Clear the form
            document.getElementById(`pigeon-condition-type-${pigeonId}`).value = '';
            document.getElementById(`pigeon-condition-fields-${pigeonId}`).innerHTML = '';
            
            // Add the condition
            await addPigeonCondition(pigeonId, type, condValue);
        }
        
        async function updatePigeonTriggerConfigFromJSON(pigeonId, jsonString) {
            try {
                const config = JSON.parse(jsonString);
                
                const response = await authenticatedFetch('/api/pigeons/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: pigeonId,
                        trigger_config: JSON.stringify(config)
                    })
                });
                
                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const pigeon = pigeonsData.find(p => p.id === pigeonId);
                    if (pigeon) {
                        pigeon.trigger_config = config;
                    }
                    await showAlert('Trigger config updated!', 'success');
                } else {
                    await showAlert('Failed to update: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                if (error instanceof SyntaxError) {
                    await showAlert('Invalid JSON format', 'error');
                } else {
                    console.log('‚ö†Ô∏è Backend not ready, updating locally');
                    // Update locally for design testing
                    try {
                        const config = JSON.parse(jsonString);
                        const pigeon = pigeonsData.find(p => p.id === pigeonId);
                        if (pigeon) {
                            pigeon.trigger_config = config;
                        }
                        await showAlert('Trigger config updated locally!', 'info');
                    } catch (parseError) {
                        await showAlert('Invalid JSON format', 'error');
                    }
                }
            }
        }
        
        function showPigeonConditionModal(pigeonId) {
            const modal = document.createElement('div');
            modal.className = 'condition-modal-overlay';
            modal.innerHTML = `
                <div class="condition-modal" style="
                    background: #1a1a1a;
                    border: 1px solid #333;
                    border-radius: 8px;
                    padding: 1.5rem;
                    width: 90%;
                    max-width: 420px;
                    position: relative;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; color: #fff; font-size: 1rem; font-weight: 600;">Add Condition</h3>
                        <button onclick="this.closest('.condition-modal-overlay').remove()" style="
                            background: none;
                            border: none;
                            color: #888;
                            font-size: 1.5rem;
                            cursor: pointer;
                            padding: 0;
                            line-height: 1;
                        ">√ó</button>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: #888; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.05em;">
                                Condition Type
                            </label>
                            <select id="condition-type-select" style="
                                width: 100%;
                                background: #0d0d0d;
                                border: 1px solid #333;
                                color: #ccc;
                                padding: 0.5rem;
                                font-size: 0.875rem;
                                border-radius: 4px;
                                font-family: 'SF Mono', Monaco, monospace;
                                cursor: pointer;
                            " onchange="updateConditionFields()">
                                <option value="">Select type...</option>
                                <option value="has_canon">Has Canon Key</option>
                                <option value="canon_equals">Canon Equals Value</option>
                                <option value="has_role">Has Role</option>
                                <option value="day_of_week">Day of Week</option>
                                <option value="time_range">Time Range</option>
                            </select>
                        </div>
                        
                        <div id="condition-fields" style="display: none;"></div>
                        
                        <div style="display: flex; gap: 0.5rem; padding-top: 0.5rem;">
                            <button onclick="submitPigeonCondition(${pigeonId})" style="
                                flex: 1;
                                padding: 0.625rem;
                                background: #dcfce7;
                                border: 1px solid #16a34a;
                                color: #15803d;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 0.75rem;
                                font-weight: 600;
                                font-family: 'SF Mono', Monaco, monospace;
                                text-transform: uppercase;
                            ">Add Condition</button>
                            <button onclick="this.closest('.condition-modal-overlay').remove()" style="
                                padding: 0.625rem 1rem;
                                background: #2a2a2a;
                                border: 1px solid #333;
                                color: #888;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 0.75rem;
                                font-weight: 600;
                                font-family: 'SF Mono', Monaco, monospace;
                                text-transform: uppercase;
                            ">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function updateConditionFields() {
            const typeSelect = document.getElementById('condition-type-select');
            const fieldsContainer = document.getElementById('condition-fields');
            const type = typeSelect.value;
            
            if (!type) {
                fieldsContainer.style.display = 'none';
                return;
            }
            
            fieldsContainer.style.display = 'block';
            
            const inputStyle = `
                width: 100%;
                background: #0d0d0d;
                border: 1px solid #333;
                color: #ccc;
                padding: 0.5rem;
                font-size: 0.875rem;
                border-radius: 4px;
                font-family: 'SF Mono', Monaco, monospace;
            `;
            
            const labelStyle = `
                display: block;
                font-size: 0.75rem;
                font-weight: 600;
                color: #888;
                margin-bottom: 0.375rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            `;
            
            if (type === 'has_canon') {
                fieldsContainer.innerHTML = `
                    <div>
                        <label style="${labelStyle}">Canon Key</label>
                        <input type="text" id="condition-key" placeholder="e.g., zone, faction, status" style="${inputStyle}">
                        <div style="font-size: 0.625rem; color: #666; margin-top: 0.25rem; font-style: italic;">
                            Checks if user has this key in their canon
                        </div>
                    </div>
                `;
            } else if (type === 'canon_equals') {
                fieldsContainer.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div>
                            <label style="${labelStyle}">Canon Key</label>
                            <input type="text" id="condition-key" placeholder="e.g., zone" style="${inputStyle}">
                        </div>
                        <div>
                            <label style="${labelStyle}">Value</label>
                            <input type="text" id="condition-value" placeholder="e.g., 1, forest, active" style="${inputStyle}">
                        </div>
                        <div style="font-size: 0.625rem; color: #666; font-style: italic;">
                            Checks if user's canon key equals this value
                        </div>
                    </div>
                `;
            } else if (type === 'has_role') {
                fieldsContainer.innerHTML = `
                    <div>
                        <label style="${labelStyle}">Role Name</label>
                        <input type="text" id="condition-role" placeholder="e.g., admin, moderator, vip" style="${inputStyle}">
                        <div style="font-size: 0.625rem; color: #666; margin-top: 0.25rem; font-style: italic;">
                            Checks if user has this role
                        </div>
                    </div>
                `;
            } else if (type === 'day_of_week') {
                fieldsContainer.innerHTML = `
                    <div>
                        <label style="${labelStyle}">Day</label>
                        <select id="condition-day" style="${inputStyle}">
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                        <div style="font-size: 0.625rem; color: #666; margin-top: 0.25rem; font-style: italic;">
                            Triggers only on this day of the week
                        </div>
                    </div>
                `;
            } else if (type === 'time_range') {
                fieldsContainer.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div>
                            <label style="${labelStyle}">Start Time (24h)</label>
                            <input type="time" id="condition-start" style="${inputStyle}">
                        </div>
                        <div>
                            <label style="${labelStyle}">End Time (24h)</label>
                            <input type="time" id="condition-end" style="${inputStyle}">
                        </div>
                        <div style="font-size: 0.625rem; color: #666; font-style: italic;">
                            Triggers only within this time range
                        </div>
                    </div>
                `;
            }
        }
        
        async function submitPigeonCondition(pigeonId) {
            const type = document.getElementById('condition-type-select')?.value;
            if (!type) {
                await showAlert('Please select a condition type', 'error');
                return;
            }
            
            let condKey = type;
            let condValue = '';
            
            if (type === 'has_canon') {
                const key = document.getElementById('condition-key')?.value.trim();
                if (!key) {
                    await showAlert('Please enter a canon key', 'error');
                    return;
                }
                condValue = key;
            } else if (type === 'canon_equals') {
                const key = document.getElementById('condition-key')?.value.trim();
                const value = document.getElementById('condition-value')?.value.trim();
                if (!key || !value) {
                    await showAlert('Please enter both key and value', 'error');
                    return;
                }
                condValue = `${key}=${value}`;
            } else if (type === 'has_role') {
                const role = document.getElementById('condition-role')?.value.trim();
                if (!role) {
                    await showAlert('Please enter a role name', 'error');
                    return;
                }
                condValue = role;
            } else if (type === 'day_of_week') {
                condValue = document.getElementById('condition-day')?.value;
            } else if (type === 'time_range') {
                const start = document.getElementById('condition-start')?.value;
                const end = document.getElementById('condition-end')?.value;
                if (!start || !end) {
                    await showAlert('Please enter both start and end times', 'error');
                    return;
                }
                condValue = `${start}-${end}`;
            }
            
            // Close modal
            document.querySelector('.condition-modal-overlay')?.remove();
            
            // Add condition
            await addPigeonCondition(pigeonId, condKey, condValue);
        }
        
        function showPigeonConditionDropdown(pigeonId) {
            // Legacy function - redirect to new modal
            showPigeonConditionModal(pigeonId);
        }
        
        async function addPigeonCondition(pigeonId, condKey, condValue) {
            const pigeon = pigeonsData.find(p => p.id === pigeonId);
            if (!pigeon) return;
            
            // Parse existing conditions (should be array format for aviary.py)
            let conditions = [];
            try {
                if (pigeon.conditions) {
                    conditions = typeof pigeon.conditions === 'string' 
                        ? JSON.parse(pigeon.conditions) 
                        : pigeon.conditions;
                }
                // Ensure it's an array
                if (!Array.isArray(conditions)) {
                    conditions = [];
                }
            } catch (e) {
                console.error('Failed to parse conditions:', e);
                conditions = [];
            }
            
            // Format condition for aviary.py based on type
            let newCondition = { type: condKey };
            
            if (condKey === 'has_canon') {
                // condValue is the canon key name
                newCondition.key = condValue;
            } else if (condKey === 'canon_equals') {
                // condValue should be "key=value" format
                const parts = condValue.split('=');
                if (parts.length !== 2) {
                    await showAlert('Format should be key=value (e.g., zone=1)', 'error');
                    return;
                }
                newCondition.key = parts[0].trim();
                newCondition.value = parts[1].trim();
            } else if (condKey === 'has_role') {
                // condValue is the role name
                newCondition.role = condValue;
            }
            
            // Add to conditions array
            conditions.push(newCondition);
            
            try {
                const response = await authenticatedFetch('/api/pigeons/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: pigeonId,
                        conditions: JSON.stringify(conditions)
                    })
                });
                
                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    pigeon.conditions = conditions;
                    await showAlert('Condition added!', 'success');
                    renderPigeonEditor();
                } else {
                    await showAlert('Failed to add condition', 'error');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Backend not ready, updating locally');
                // Update locally for design testing
                pigeon.conditions = conditions;
                await showAlert('Condition added locally!', 'info');
                renderPigeonEditor();
            }
        }
        
        async function removePigeonCondition(pigeonId, condIndex) {
            const pigeon = pigeonsData.find(p => p.id === pigeonId);
            if (!pigeon) return;
            
            let conditions = [];
            try {
                if (pigeon.conditions) {
                    conditions = typeof pigeon.conditions === 'string' 
                        ? JSON.parse(pigeon.conditions) 
                        : pigeon.conditions;
                }
                if (!Array.isArray(conditions)) {
                    conditions = [];
                }
            } catch (e) {
                console.error('Failed to parse conditions:', e);
                conditions = [];
            }
            
            // Remove by index
            conditions.splice(condIndex, 1);
            
            try {
                const response = await authenticatedFetch('/api/pigeons/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: pigeonId,
                        conditions: conditions.length > 0 ? JSON.stringify(conditions) : null
                    })
                });
                
                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    pigeon.conditions = conditions;
                    await showAlert('Condition removed!', 'success');
                    renderPigeonEditor();
                } else {
                    await showAlert('Failed to remove condition', 'error');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Backend not ready, updating locally');
                // Update locally for design testing
                pigeon.conditions = conditions;
                await showAlert('Condition removed locally!', 'info');
                renderPigeonEditor();
            }
        }
        
        async function savePigeon(pigeonId) {
            const pigeon = pigeonsData.find(p => p.id === pigeonId);
            if (!pigeon) return;
            
            try {
                // Save pigeon data to backend
                const response = await authenticatedFetch('/api/pigeons/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: pigeonId,
                        name: pigeon.name,
                        trigger_type: pigeon.trigger_type,
                        trigger_config: pigeon.trigger_config,
                        dialogue_key: pigeon.dialogue_key,
                        conditions: pigeon.conditions,
                        condition_operator: pigeon.condition_operator,
                        priority: pigeon.priority,
                        repeating: pigeon.repeating,
                        max_deliveries: pigeon.max_deliveries,
                        status: pigeon.status
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    await showAlert('‚úÖ Pigeon saved!', 'success');
                } else {
                    await showAlert('Failed to save pigeon', 'error');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Backend not ready, changes saved locally');
                await showAlert('üíæ Changes saved locally (backend not ready)', 'info');
            }
        }
        
        async function testPigeon(pigeonId) {
            try {
                const response = await authenticatedFetch(`/api/pigeons/${pigeonId}/test`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    await showAlert(`Test completed! ${result.data.matches || 0} users matched, ${result.data.sent || 0} messages sent.`, 'success');
                } else {
                    await showAlert('Test failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Backend not ready - test functionality not available yet');
                await showAlert('‚ö†Ô∏è Backend not ready - test functionality will be available once the pigeon API is implemented', 'info');
            }
        }
        
        async function deletePigeon(pigeonId) {
            if (!await showConfirm('‚ö†Ô∏è Permanently DELETE this pigeon? This cannot be undone!')) return;
            
            try {
                const response = await authenticatedFetch(`/api/pigeons/${pigeonId}`, {
                    method: 'DELETE'
                });
                
                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    await showAlert('Pigeon deleted!', 'success');
                    selectedPigeonId = null;
                    await loadPigeons();
                    showPigeonsPanel();
                } else {
                    await showAlert('Failed to delete pigeon', 'error');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Backend not ready, deleting locally');
                // Delete locally for design testing
                const index = pigeonsData.findIndex(p => p.id === pigeonId);
                if (index > -1) {
                    pigeonsData.splice(index, 1);
                }
                selectedPigeonId = null;
                renderPigeonsList();
                showPigeonsPanel();
                await showAlert('Pigeon deleted locally!', 'info');
            }
        }
        
        // Duplicate pigeon
        async function duplicatePigeon(pigeonId) {
            console.log('üìã [PIGEONS] Duplicating pigeon:', pigeonId);
            
            // Find the pigeon to duplicate
            const originalPigeon = pigeonsData.find(p => p.id === pigeonId);
            if (!originalPigeon) {
                await showAlert('Pigeon not found!', 'error');
                return;
            }
            
            // Prompt for new name
            const newName = await showPrompt(
                `Enter name for duplicate of "${originalPigeon.name}":`, 
                `${originalPigeon.name} (Copy)`
            );
            
            if (!newName) {
                console.log('‚ÑπÔ∏è [PIGEONS] Duplicate cancelled');
                return;
            }
            
            // Create duplicate data
            const duplicateData = {
                name: newName,
                status: 'draft', // Start as draft
                trigger_type: originalPigeon.trigger_type,
                trigger_config: originalPigeon.trigger_config ? JSON.parse(JSON.stringify(originalPigeon.trigger_config)) : null,
                dialogue_key: originalPigeon.dialogue_key,
                conditions: originalPigeon.conditions ? JSON.parse(JSON.stringify(originalPigeon.conditions)) : null,
                condition_operator: originalPigeon.condition_operator || 'AND',
                repeating: originalPigeon.repeating || false
            };
            
            console.log('üì¶ [PIGEONS] Duplicate data:', duplicateData);
            
            try {
                const response = await authenticatedFetch('/api/pigeons/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(duplicateData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    console.log('‚úÖ [PIGEONS] Duplicate created:', result);
                    await showAlert(`Duplicated as "${newName}"!`, 'success');
                    await loadPigeons();
                } else {
                    await showAlert('Failed to duplicate: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('‚ùå [PIGEONS] Duplicate error:', error);
                await showAlert('Failed to duplicate: ' + error.message, 'error');
            }
        }
        
        // ============================================================================
        // AUTHENTICATION & AUTHORIZATION
        // ============================================================================
        
        console.log('üîê [Dialogues] Checking authentication...');
        
        // Check authentication on page load
        const adminToken = localStorage.getItem('admin_token');
        
        if (!adminToken) {
            console.log('‚ùå [Dialogues] No token found, redirecting to login');
            // No token - redirect to login
            window.location.href = '/admin/login.html';
        } else {
            console.log('‚úÖ [Dialogues] Token found, verifying...');
            // Verify token is still valid and get user info
            fetch('/api/admin/verify', {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            }).then(response => {
                console.log('üì° [Dialogues] Verify response:', response.status, response.statusText);
                if (!response.ok) {
                    console.log('‚ùå [Dialogues] Token invalid, redirecting to login');
                    // Token invalid - redirect to login
                    localStorage.removeItem('admin_token');
                    window.location.href = '/admin/login.html';
                } else {
                    return response.json();
                }
            }).then(async data => {
                if (data) {
                    console.log('‚úÖ [Dialogues] Authenticated as:', data.handle);
                    // Create admin session for drawer
                    const adminSession = {
                        did: data.did,
                        handle: data.handle,
                        displayName: data.handle,
                        isAdmin: true
                    };
                    
                    // Store session data
                    sessionStorage.setItem('admin_session', JSON.stringify(adminSession));
                    
                    // Dispatch login event for drawer
                    window.dispatchEvent(new CustomEvent('oauth:login', {
                        detail: { session: adminSession }
                    }));
                    
                    console.log('üöÄ [Dialogues] Loading dialogues...');
                    // Load dialogues after successful authentication
                    await loadDialogues();
                    
                    console.log('üöÄ [Pigeons] Loading pigeons...');
                    // Also load pigeons data
                    await loadPigeons();
                    
                    // Restore the previously active tab after data is loaded
                    setTimeout(() => {
                        restoreActiveTab();
                    }, 100);
                }
            }).catch(error => {
                console.error('‚ùå [Dialogues] Auth check failed:', error);
                // On network error, redirect to login
                localStorage.removeItem('admin_token');
                window.location.href = '/admin/login.html';
            });
        }
        
        // Helper function to make authenticated API calls
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('admin_token');
            
            if (!token) {
                throw new Error('No authentication token');
            }
            
            // Add authorization header
            options.headers = options.headers || {};
            options.headers['Authorization'] = `Bearer ${token}`;
            
            const response = await fetch(url, options);
            
            // If unauthorized, redirect to login
            if (response.status === 401) {
                localStorage.removeItem('admin_token');
                window.location.href = '/admin/login.html';
                throw new Error('Session expired');
            }
            
            return response;
        }
        
        // ============================================================================
        // DRAG AND DROP REORDERING
        // ============================================================================
        
        let draggedElement = null;
        let draggedKey = null;
        let draggedIndex = null;
        
        function setupDialogueDragAndDrop() {
            const items = document.querySelectorAll('.tree-item');
            
            items.forEach(item => {
                const handle = item.querySelector('.dialogue-drag-handle');
                
                handle.addEventListener('dragstart', function(e) {
                    draggedElement = item;
                    draggedKey = item.dataset.key;
                    draggedIndex = parseInt(item.dataset.index);
                    
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', draggedKey);
                });
                
                item.addEventListener('dragend', function(e) {
                    item.classList.remove('dragging');
                    document.querySelectorAll('.drag-over').forEach(el => {
                        el.classList.remove('drag-over');
                    });
                });
                
                item.addEventListener('dragover', function(e) {
                    if (e.preventDefault) {
                        e.preventDefault();
                    }
                    
                    if (this !== draggedElement) {
                        e.dataTransfer.dropEffect = 'move';
                        this.classList.add('drag-over');
                    }
                    
                    return false;
                });
                
                item.addEventListener('dragleave', function(e) {
                    this.classList.remove('drag-over');
                });
                
                item.addEventListener('drop', async function(e) {
                    if (e.stopPropagation) {
                        e.stopPropagation();
                    }
                    
                    this.classList.remove('drag-over');
                    
                    if (this === draggedElement) {
                        return false;
                    }
                    
                    const dropIndex = parseInt(this.dataset.index);
                    
                    console.log('=== REORDERING DIALOGUES ===');
                    console.log('From:', draggedKey, 'index:', draggedIndex);
                    console.log('To index:', dropIndex);
                    
                    // Reorder the keys array
                    let keys = Object.keys(dialogueData);
                    keys.sort((a, b) => {
                        const orderA = dialogueData[a].display_order || 0;
                        const orderB = dialogueData[b].display_order || 0;
                        return orderA - orderB;
                    });
                    
                    // Move the dragged item
                    const [removed] = keys.splice(draggedIndex, 1);
                    keys.splice(dropIndex, 0, removed);
                    
                    // Update display_order for all dialogues
                    const updates = keys.map((key, idx) => ({
                        key: key,
                        display_order: idx
                    }));
                    
                    // Save to API
                    try {
                        const response = await authenticatedFetch('/api/dialogues/reorder', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ updates })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            console.log('‚úÖ Order saved successfully');
                            
                            // Update local data
                            updates.forEach(update => {
                                if (dialogueData[update.key]) {
                                    dialogueData[update.key].display_order = update.display_order;
                                }
                            });
                            
                            // Re-render sidebar
                            renderSidebar();
                            
                            // Visual feedback
                            await showAlert('Dialogue order saved!', 'success');
                        } else {
                            console.error('‚ùå Failed to save order:', result);
                            await showAlert('Failed to save order: ' + (result.error || 'Unknown error'), 'error');
                        }
                    } catch (err) {
                        console.error('‚ùå Error saving order:', err);
                        await showAlert('Network error: ' + err.message, 'error');
                    }
                    
                    return false;
                });
            });
        }
        
        // === Drag and Drop Handlers for Button Reordering ===
        let draggedButton = null;
        
        function handleButtonDragStart(event) {
            const buttonItem = event.target.closest('.button-item');
            const key = buttonItem.dataset.key;
            const msgIdx = parseInt(buttonItem.dataset.msg, 10);
            const btnIdx = parseInt(buttonItem.dataset.btn, 10);
            
            draggedButton = { key, msgIdx, btnIdx };
            buttonItem.classList.add('dragging');
            
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', buttonItem.innerHTML);
        }
        
        function handleButtonDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const buttonItem = event.target.closest('.button-item');
            if (buttonItem && draggedButton) {
                const afterElement = getDragAfterElement(buttonItem.parentElement, event.clientY);
                const draggingElement = document.querySelector('.dragging');
                
                if (afterElement == null) {
                    buttonItem.parentElement.appendChild(draggingElement);
                } else {
                    buttonItem.parentElement.insertBefore(draggingElement, afterElement);
                }
            }
        }
        
        function handleButtonDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (!draggedButton) return;
            
            const dropTarget = event.target.closest('.button-item');
            if (!dropTarget) return;
            
            const dropKey = dropTarget.dataset.key;
            const dropMsgIdx = parseInt(dropTarget.dataset.msg, 10);
            const dropBtnIdx = parseInt(dropTarget.dataset.btn, 10);
            
            // Can only reorder buttons within same message
            if (draggedButton.key !== dropKey || draggedButton.msgIdx !== dropMsgIdx) {
                console.log('‚ùå Cannot reorder buttons across different messages');
                return;
            }
            
            // Reorder buttons in the data
            const dialogue = dialogueData[draggedButton.key];
            if (!dialogue || !dialogue.messages[draggedButton.msgIdx]) return;
            
            const buttons = dialogue.messages[draggedButton.msgIdx].buttons;
            const [movedButton] = buttons.splice(draggedButton.btnIdx, 1);
            buttons.splice(dropBtnIdx, 0, movedButton);
            
            // Re-render the dialogue to reflect new order
            renderDialogues();
            
            console.log('‚úÖ Button reordered successfully');
        }
        
        function handleButtonDragEnd(event) {
            const buttonItem = event.target.closest('.button-item');
            if (buttonItem) {
                buttonItem.classList.remove('dragging');
            }
            draggedButton = null;
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.button-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // Initialize on page load
        if (typeof initAuth === 'function') {
            initAuth();
        }
    </script>
</body>
</html>
