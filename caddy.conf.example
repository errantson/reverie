# =============================================================================
# CADDY CONFIGURATION TEMPLATE - REVERIE HOUSE
# =============================================================================
# This is a TEMPLATE file. Copy to caddy.conf and configure.
#
# SECURITY NOTE: caddy.conf is gitignored - it contains internal IP addresses
# and service routing configuration.
#
# Setup:
#   1. cp caddy.conf.example caddy.conf
#   2. Replace INTERNAL_IP with your Docker bridge IP (e.g., 172.23.0.1)
#   3. Update service ports to match your docker-compose.yml
#   4. Configure domain names
# =============================================================================

# OAuth authorization server
auth.reverie.house {
    import log_config
    
    # OAuth authorization server metadata
    handle /.well-known/oauth-authorization-server {
        # CONFIGURE: Replace INTERNAL_IP with your Docker network gateway
        reverse_proxy INTERNAL_IP:3333 {
            header_up Host auth.reverie.house
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto https
        }
    }
    
    # OAuth protected resource metadata
    handle /.well-known/oauth-protected-resource {
        reverse_proxy INTERNAL_IP:3333 {
            header_up Host auth.reverie.house
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto https
        }
    }
    
    # OAuth endpoints
    handle /oauth/* {
        reverse_proxy INTERNAL_IP:3333 {
            header_up Host auth.reverie.house
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto https
        }
    }
}

# Main domain
reverie.house {
    import log_config
    
    # CORS headers for all responses
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Access-Control-Max-Age "86400"
    }
    
    # Serve static site files
    root * /srv/site
    file_server
    encode gzip
    
    # API endpoints - proxy to backend service
    handle /api/* {
        # CONFIGURE: Update port to match your API service
        reverse_proxy INTERNAL_IP:4444 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }
}
